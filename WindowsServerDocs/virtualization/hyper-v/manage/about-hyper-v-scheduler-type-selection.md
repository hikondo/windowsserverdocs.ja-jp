---
title: Hyper-v ハイパーバイザースケジューラの種類の選択について
description: Hyper-v のスケジューラモードの使用に関する Hyper-v ホスト管理者向けの情報を提供します。
author: allenma
ms.author: allenma
ms.date: 08/14/2018
ms.topic: article
ms.prod: windows-server-hyper-v
ms.technology: virtualization
ms.localizationpriority: low
ms.assetid: 5fe163d4-2595-43b0-ba2f-7fad6e4ae069
ms.openlocfilehash: 128f9d734311f8eaf0f06204e114171fa8b0f750
ms.sourcegitcommit: acfdb7b2ad283d74f526972b47c371de903d2a3d
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/05/2020
ms.locfileid: "87768430"
---
# <a name="about-hyper-v-hypervisor-scheduler-type-selection"></a>Hyper-v ハイパーバイザースケジューラの種類の選択について

適用先:

* Windows Server 2016
* Windows Server バージョン 1709
* Windows Server バージョン 1803
* Windows Server 2019

このドキュメントでは、ハイパーバイザースケジューラの種類の Hyper-v の既定の推奨される使用に関する重要な変更点について説明します。 これらの変更は、システムセキュリティと仮想化の両方のパフォーマンスに影響します。 仮想化ホスト管理者は、このドキュメントで説明されている変更と影響を確認して理解し、急速に変化するセキュリティランドスケープの面で Hyper-v ホストを展開および管理する方法を理解するために必要な影響、推奨される展開ガイダンス、およびリスク要因を慎重に評価する必要があります。

>[!IMPORTANT]
>現在、複数のプロセッサアーキテクチャで sighted されている既知のサイドチャネルセキュリティの脆弱性は、マルチスレッド (SMT) が有効になっているホストで実行するときに、従来のハイパーバイザークラシックスケジューラの種類のスケジュール動作を通じて、悪意のあるゲスト VM によって悪用される可能性があります。  正常に利用できた場合、悪意のあるワークロードがパーティション境界の外部にあるデータを観察する可能性があります。 この種の攻撃は、ハイパーバイザーのコアスケジューラの種類を利用し、ゲスト Vm を再構成するように Hyper-v ハイパーバイザーを構成することで軽減できます。 コアスケジューラを使用すると、ハイパーバイザーはゲスト VM の VPs が同じ物理プロセッサコアで実行されるように制限します。そのため、データにアクセスする VM の機能が、実行されている物理コアの境界に厳密に分離されます。  これは、これらのサイドチャネル攻撃に対する非常に効果的な軽減策であり、ルートまたは別のゲストパーティションにかかわらず、他のパーティションからのアイテムを VM が監視しないようにします。  そのため、Microsoft では、仮想化ホストとゲスト Vm の既定の構成設定と推奨される構成設定を変更しています。

## <a name="background"></a>バックグラウンド

Windows Server 2016 以降、Hyper-v では、ハイパーバイザー scheduler の種類と呼ばれる仮想プロセッサのスケジュール設定と管理の方法がいくつかサポートされています。  すべてのハイパーバイザースケジューラの種類の詳細については、 [「hyper-v ハイパーバイザーのスケジューラの種類とその使用方法](https://docs.microsoft.com/windows-server/virtualization/hyper-v/manage/manage-hyper-v-scheduler-types)」を参照してください。

>[!NOTE]
>新しいハイパーバイザースケジューラの種類は、Windows Server 2016 で初めて導入されたものであり、以前のリリースでは利用できません。 Windows Server 2016 より前のすべてのバージョンの Hyper-v では、クラシックスケジューラのみがサポートされています。 コアスケジューラのサポートは最近公開されただけでした。

## <a name="about-hypervisor-scheduler-types"></a>ハイパーバイザースケジューラの種類について

この記事では、具体的には、新しいハイパーバイザーコアスケジューラの種類と従来の "従来の" スケジューラの使用について説明します。また、これらのスケジューラの種類が対称マルチスレッド (SMT) の使用とどのように交差するかについても取り上げます。  コアとクラシックのスケジューラの違いと、それぞれの場所が、基盤となるシステムプロセッサのゲスト Vm からどのように動作するかを理解することが重要です。

### <a name="the-classic-scheduler"></a>クラシックスケジューラ

クラシックスケジューラは、システム全体の仮想プロセッサ (VPs) での作業のスケジュール設定に関する公平なラウンドロビン方式 (ルート VPs を含む) と、ゲスト Vm に属する VPs を指します。 クラシックスケジューラは、すべてのバージョンの Hyper-v で使用される既定のスケジューラの種類です (ここで説明するように、Windows Server 2019 まで)。  クラシックスケジューラのパフォーマンス特性はよく理解されており、従来のスケジューラは、(仮想化されているワークロードの種類、全体的なリソース使用率などに応じて) 適度な余白によって、ホストの VP: LP 比に対する過剰な負荷 (ホストの VP: LP 比率によるオーバーサブスクリプション) を明確にサポートします。

SMT が有効になっている仮想化ホストで実行すると、クラシックスケジューラによって、コアに属する各 SMT スレッド上の任意の VM のゲスト VPs が個別にスケジュールされます。 そのため、複数の Vm を同時に同じコアで実行できます (1 つの VM がコアの1つのスレッドで実行され、もう一方の vm が別のスレッドで実行されている場合)。

### <a name="the-core-scheduler"></a>コアスケジューラ

コアスケジューラは、SMT のプロパティを利用して、ゲストワークロードを分離し、セキュリティとシステムの両方のパフォーマンスに影響を与えます。 コアスケジューラは、VM からの VPs が兄弟 SMT スレッドでスケジュールされていることを確認します。 これは対称的に行われます。そのため、LPs が2のグループに含まれる場合、VPs は2つのグループにまとめられ、システム CPU コアが Vm 間で共有されることはありません。

基になる SMT ペアでゲスト VPs をスケジュールすることで、コアスケジューラはワークロードの分離に強力なセキュリティ境界を提供し、待機時間に依存するワークロードのパフォーマンスの変動を軽減するためにも使用できます。

SMT が有効になっていない仮想マシンに対して VP がスケジュールされている場合、その VP は、実行時にコア全体を消費し、コアの兄弟 SMT スレッドはアイドル状態のままになることに注意してください。  これは、適切なワークロードの分離を提供するために必要ですが、システムの全体的なパフォーマンスに影響します。これは特に、総 VP: LP の比率が1:1 を超えた場合に、システムの全体的なパフォーマンスに影響します。 そのため、コアごとに複数のスレッドを使用せずに構成されたゲスト Vm を実行すると、構成が最適化されます。

### <a name="benefits-of-the-using-the-core-scheduler"></a>コアスケジューラを使用する利点

コアスケジューラには、次のような利点があります。

* ゲストワークロードの分離のための強力なセキュリティ境界-ゲスト VPs は、基盤となる物理コアペアで実行するように制約されているため、サイドチャネルの覗き見攻撃に対する脆弱性が軽減されます。

* ワークロードの可変性の削減-ゲストワークロードのスループットの変動が大幅に減少し、ワークロードの一貫性が向上します。

* ゲスト Vm での SMT の使用-ゲスト仮想マシンで実行されている OS とアプリケーションは、非仮想化を実行する場合と同様に、smt の動作とプログラミングインターフェイス (Api) を利用して、SMT スレッド間での作業の制御と分散を行うことができます。

コアスケジューラは、Azure 仮想化ホストで現在使用されています。特に、強力なセキュリティ境界と低いワークロードを活用します。 Microsoft では、コアスケジューラの種類はである必要があり、仮想化シナリオの大部分では既定のハイパーバイザースケジューリングの種類として引き続き使用されます。  そのため、お客様が既定でセキュリティで保護されていることを保証するために、Microsoft は Windows Server 2019 にこの変更を加えています。

### <a name="core-scheduler-performance-impacts-on-guest-workloads"></a>ゲストワークロードに対するコアスケジューラのパフォーマンスへの影響

特定のクラスの脆弱性を効果的に軽減する必要がありますが、コアスケジューラによってパフォーマンスが低下する可能性もあります。 お客様は、Vm のパフォーマンス特性と、仮想化ホストの全体的なワークロード容量に対する影響を確認できます。 コアスケジューラが SMT 以外の VP を実行する必要がある場合は、基になる論理コアの命令ストリームの1つだけが実行され、もう一方はアイドル状態のままである必要があります。 これにより、ゲストワークロードのホストの合計容量が制限されます。

このドキュメントの展開ガイダンスに従うことで、これらのパフォーマンスへの影響を最小限に抑えることができます。 ホスト管理者は、特定の仮想化展開シナリオを慎重に検討し、その許容範囲を、最大限のワークロード密度、仮想化ホストの過剰な統合などに対するセキュリティリスクに対して考慮する必要があります。

## <a name="changes-to-the-default-and-recommended-configurations-for-windows-server-2016-and-windows-server-2019"></a>Windows Server 2016 および Windows Server 2019 の既定の構成と推奨される構成への変更

最大のセキュリティ体制で Hyper-v ホストを展開するには、ハイパーバイザーのコアスケジューラの種類を使用する必要があります。 既定でお客様がセキュリティで保護されていることを確認するために、Microsoft では次の既定の設定と推奨設定を変更しています。

>[!NOTE]
>Windows Server 2016、Windows Server 1709、および Windows Server 1803 の最初のリリースには、ハイパーバイザーによるスケジューラの内部サポートが含まれていましたが、ハイパーバイザースケジューラの種類を選択できる構成コントロールにアクセスするには、更新プログラムが必要です。  これらの更新の詳細については[、「hyper-v ハイパーバイザー scheduler の種類と使用](https://docs.microsoft.com/windows-server/virtualization/hyper-v/manage/manage-hyper-v-scheduler-types)」を参照してください。

### <a name="virtualization-host-changes"></a>仮想化ホストの変更

* ハイパーバイザーは、既定では Windows Server 2019 以降のコアスケジューラを使用します。

* Microsoft reccommends、Windows Server 2016 のコアスケジューラの構成を終了します。 Windows Server 2016 では、ハイパーバイザーコアスケジューラの種類がサポートされていますが、既定値はクラシックスケジューラです。 コアスケジューラはオプションであり、Hyper-v ホスト管理者が明示的に有効にする必要があります。

### <a name="virtual-machine-configuration-changes"></a>仮想マシンの構成の変更

* Windows Server 2019 では、既定の VM バージョン9.0 を使用して作成された新しい仮想マシンは、仮想化ホストの SMT プロパティ (有効または無効) を自動的に継承します。 つまり、物理ホストで SMT が有効になっている場合は、新しく作成された Vm でも SMT が有効になり、既定ではホストの SMT トポロジが継承されるため、基になるシステムと同じ数のハードウェアスレッドがコアごとに保持されます。 これは、VM の構成に HwThreadCountPerCore = 0 で反映されます。0は、VM がホストの SMT 設定を継承する必要があることを示します。

* VM バージョンが8.2 以前の既存の仮想マシンでは、HwThreadCountPerCore の元の VM プロセッサ設定が保持され、8.2 VM バージョンのゲストの既定値は HwThreadCountPerCore = 1 です。 これらのゲストが Windows Server 2019 ホストで実行されている場合は、次のように扱われます。

    1. VM の VP 数が LP コアの数以下である場合、コアスケジューラによって VM が SMT 以外の VM として扱われます。 ゲスト VP が1つの SMT スレッドで実行されている場合、コアの兄弟 SMT スレッドは idled になります。 これは最適ではないため、全体的なパフォーマンスが低下します。

    2. VM の VPs が LP コアよりも多い場合、コアスケジューラによって VM が SMT VM として扱われます。 ただし、VM は、それが SMT VM であることを示すものではありません。 たとえば、CPUID 命令または Windows Api を使用して、OS またはアプリケーションによる CPU トポロジのクエリを実行すると、SMT が有効になっていることは示されません。

* Vm の更新操作によって既存の VM が明示的にバージョン9.0 からバージョンに更新されると、VM は HwThreadCountPerCore の現在の値を保持します。  VM では、SMT の強制が有効になりません。

* Windows Server 2016 では、ゲスト Vm に対して SMT を有効にすることをお勧めします。  既定では、Windows Server 2016 で作成された Vm の SMT は無効になります。明示的に変更しない限り、HwThreadCountPerCore は1に設定されます。

>[!NOTE]
>Windows Server 2016 では、HwThreadCountPerCore を0に設定することはできません。

#### <a name="managing-virtual-machine-smt-configuration"></a>仮想マシンの SMT 構成の管理

ゲスト仮想マシンの SMT 構成は、VM ごとに設定します。 ホスト管理者は、VM の SMT 構成を調べて構成し、次のオプションから選択できます。

1. SMT 対応として実行するように Vm を構成します。オプションでホストの SMT トポロジを自動的に継承します。

2. SMT 以外の Vm として実行するように Vm を構成する

VM の SMT 構成は、Hyper-v マネージャーコンソールの [概要] ペインに表示されます。  Vm の SMT 設定の構成は、VM の設定または PowerShell を使用して行うことができます。

#### <a name="configuring-vm-smt-settings-using-powershell"></a>PowerShell を使用した VM SMT 設定の構成

ゲスト仮想マシンの SMT 設定を構成するには、十分なアクセス許可がある PowerShell ウィンドウを開き、次のように入力します。

``` powershell
Set-VMProcessor -VMName <VMName> -HwThreadCountPerCore <0, 1, 2>
```

この場合、

- 0 = ホストから SMT トポロジを継承します (Windows Server 2016 では、HwThreadCountPerCore = 0 の設定はサポートされていません)

- 1 = SMT 以外

- 値 > 1 = コアあたりの SMT スレッドの必要数。 コアあたりの物理的な SMT スレッド数を超えることはできません。

ゲスト仮想マシンの SMT 設定を読み取るには、十分なアクセス許可がある PowerShell ウィンドウを開き、次のように入力します。

``` powershell
(Get-VMProcessor -VMName <VMName>).HwThreadCountPerCore
```

HwThreadCountPerCore = 0 で構成されているゲスト Vm は、そのゲストに対して SMT が有効になっていることを示します。また、基になる仮想化ホスト (通常は 2) の場合と同じ数の SMT スレッドをゲストに公開します。

### <a name="guest-vms-may-observe-changes-to-cpu-topology-across-vm-mobility-scenarios"></a>ゲスト Vm が VM モビリティシナリオ全体で CPU トポロジに対する変更を観察する場合がある

VM の OS とアプリケーションでは、ライブマイグレーション、保存、復元などの VM ライフサイクルイベントの前後に、ホストと VM の両方の設定が変更される場合があります。 VM の状態を保存および復元する操作中に、VM の HwThreadCountPerCore 設定と実現された値 (VM の設定とソースホストの構成の計算された組み合わせ) の両方が移行されます。 VM は、移行先ホストでこれらの設定を使用して実行を継続します。 VM がシャットダウンされ、再起動される時点で、VM によって監視される実現済みの値が変更される可能性があります。 OS およびアプリケーションレイヤーソフトウェアは、通常のスタートアップコードフローおよび初期化コードフローの一部として CPU トポロジ情報を検索する必要があるので、これは問題にはなりません。 ただし、これらのブート時の初期化シーケンスは、ライブマイグレーションまたは保存/復元操作中にスキップされるため、これらの状態遷移を実行する Vm は、シャットダウンして再起動するまで、最初に計算された実現値を観察することができます。

### <a name="alerts-regarding-non-optimal-vm-configurations"></a>最適でない VM 構成に関するアラート

ホスト上の物理コア数よりも多くの VPs が構成された仮想マシンは、最適ではない構成になります。 ハイパーバイザースケジューラは、これらの Vm を SMT 対応として扱います。 ただし、VM 内の OS およびアプリケーションソフトウェアには、SMT が無効になっていることを示す CPU トポロジが表示されます。 この状態が検出されると、Hyper-v ワーカープロセスは仮想化ホストのイベントをログに記録します。これは、VM の構成が最適ではないこと、および VM に対して SMT が有効になっていることが推奨されます。

#### <a name="how-to-identify-non-optimally-configured-vms"></a>最適に構成されていない Vm を識別する方法

非 SMT Vm を特定するには、Hyper-v ワーカープロセスイベント ID 3498 のイベントビューアーのシステムログを調べます。これは、VM の VPs の数が物理コア数よりも大きい場合は、VM に対してトリガーされます。 ワーカープロセスイベントは、イベントビューアーから、または PowerShell を使用して取得できます。

#### <a name="querying-the-hyper-v-worker-process-vm-event-using-powershell"></a>PowerShell を使用した Hyper-v ワーカープロセス VM イベントの照会

PowerShell を使用して Hyper-v ワーカープロセスイベント ID 3498 を照会するには、PowerShell プロンプトから次のコマンドを入力します。

``` powershell
Get-WinEvent -FilterHashTable @{ProviderName="Microsoft-Windows-Hyper-V-Worker"; ID=3498}
```

### <a name="impacts-of-guest-smt-configuaration-on-the-use-of-hypervisor-enlightenments-for-guest-operating-systems"></a>ゲストオペレーティングシステムのハイパーバイザー enlightenments の使用に関するゲスト SMT 構成の影響

Microsoft ハイパーバイザーでは、複数の enlightenments (ヒント) を提供しています。これは、ゲスト VM で実行されている OS がクエリを実行し、最適化をトリガーするために使用できます。たとえば、パフォーマンスを向上させたり、仮想化を実行する際にさまざまな条件の処理を改善したりできます。 最近導入された1つは、仮想プロセッサのスケジュール設定と、SMT を利用するサイドチャネル攻撃に対する OS の緩和策の使用に関するものです。

>[!NOTE]
>ホスト管理者は、ワークロードのパフォーマンスを最適化するために、ゲスト Vm の SMT を有効にすることをお勧めします。

このゲスト啓蒙の詳細については、以下を参照してください。ただし、仮想化ホスト管理者向けの重要な通じ重要は、仮想マシンがホストの物理的な SMT 構成と一致するように HwThreadCountPerCore を構成する必要があることです。 これにより、ハイパーバイザーは、非アーキテクチャコア共有がないことを報告できます。 そのため、啓蒙を必要とするすべてのゲスト OS が有効になっている可能性があります。 Windows Server 2019 では、新しい Vm を作成し、既定値の HwThreadCountPerCore (0) のままにします。 Windows Server 2016 ホストから移行された古い Vm は、Windows Server 2019 構成バージョンに更新できます。 その後、HwThreadCountPerCore = 0 を設定することをお勧めします。  Windows Server 2016 では、ホスト構成 (通常は 2) と一致するように HwThreadCountPerCore を設定することをお勧めします。

### <a name="nononarchitecturalcoresharing-enlightenment-details"></a>NoNonArchitecturalCoreSharing 啓蒙の詳細

Windows Server 2016 以降では、ハイパーバイザーは、VP スケジューリングとゲスト OS への配置の処理を記述する新しい啓蒙を定義します。 この啓蒙は、[ハイパーバイザーのトップレベル機能仕様である 5.0 c](https://docs.microsoft.com/virtualization/hyper-v-on-windows/reference/tlfs)で定義されています。

ハイパーバイザー合成 CPUID リーフ CPUID. 0x40000004。 EAX:18 [NoNonArchitecturalCoreSharing = 1] は、兄弟 SMT スレッドとして報告される仮想プロセッサを除き、仮想プロセッサが物理コアを別の仮想プロセッサと共有しないことを示します。 たとえば、ゲスト VP は、同じプロセッサコア上の兄弟 SMT スレッドで同時に実行されたルート VP と共に、SMT スレッドで実行されることはありません。 この条件は、仮想化を実行している場合にのみ可能であり、セキュリティに深刻な影響を与えるアーキテクチャ以外の SMT 動作を表します。 ゲスト OS は、NoNonArchitecturalCoreSharing = 1 を使用して最適化を安全に行うことができることを示すことができます。これにより、同じように設定することにより、パフォーマンスのオーバーヘッドを回避できます。

特定の構成では、ハイパーバイザーは NoNonArchitecturalCoreSharing = 1 を示しません。 たとえば、ホストで SMT が有効になっていて、ハイパーバイザークラシックスケジューラを使用するように構成されている場合、NoNonArchitecturalCoreSharing は0になります。 これにより、対応のゲストが特定の最適化を有効にできなくなる可能性があります。 そのため、SMT を使用するホスト管理者は、ハイパーバイザーコアスケジューラに依存し、仮想マシンがホストから SMT 構成を継承するように構成されており、ワークロードのパフォーマンスが最適であることを確認することをお勧めします。

## <a name="summary"></a>まとめ

セキュリティ上の脅威ランドスケープは進化し続けています。 Microsoft では、お客様が既定でセキュリティを確保するために、Windows Server 2019 Hyper-v 以降のハイパーバイザーと仮想マシンの既定の構成を変更し、Windows Server 2016 Hyper-v を実行しているお客様に関する最新のガイダンスと推奨事項を提供しています。 仮想化ホスト管理者:

* このドキュメントに記載されているガイダンスを読んで理解する

* 独自の要件に合わせてセキュリティ、パフォーマンス、仮想化の密度、およびワークロードの応答性の目標を満たすように、仮想化の展開を慎重に評価して調整します。

* ハイパーバイザーコアスケジューラによって提供される強力なセキュリティ上の利点を活用するために、既存の Windows Server 2016 Hyper-v ホストを再構成することを検討してください。

* 既存の SMT 以外の Vm を更新して、ハードウェアセキュリティの脆弱性に対処する VP 分離によって課せられるスケジューリングの制約によるパフォーマンスへの影響を軽減します。
