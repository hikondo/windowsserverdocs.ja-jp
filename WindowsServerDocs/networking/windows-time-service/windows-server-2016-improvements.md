---
title: Windows Server 2016 の機能強化
description: Windows Server 2016 では、時刻と条件を修正するために使用するアルゴリズムが改善され、UTC と同期するローカルクロックが使用されています。
author: dcuomo
ms.author: dacuo
manager: dougkim
ms.date: 10/17/2018
ms.topic: article
ms.prod: windows-server-threshold
ms.technology: networking
ms.openlocfilehash: 34d05a8058db366714c0ff4fed0b7d80b9150aa4
ms.sourcegitcommit: e2b565ce85a97c0c51f6dfe7041f875a265b35dd
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/19/2019
ms.locfileid: "69626356"
---
## <a name="windows-server-2016-improvements"></a>Windows Server 2016 の機能強化

### <a name="windows-time-service-and-ntp"></a>Windows タイムサービスと NTP
Windows Server 2016 では、時刻と条件を修正するために使用するアルゴリズムが改善され、UTC と同期するローカルクロックが使用されています。  NTP は4つの値を使用して、クライアントの要求/応答とサーバーの要求/応答のタイムスタンプに基づいて時間のオフセットを計算します。  ただし、ネットワークは雑音を伴い、ネットワークの輻輳やネットワーク待機時間に影響するその他の要因により、NTP からのデータが急増する可能性があります。  Windows 2016 アルゴリズムでは、安定した正確なクロックが生成されるさまざまな手法を使用して、このノイズを平均しています。  また、正確な時刻に使用するソースは、改善された API を参照します。これにより、より良い解決策が得られます。  これらの改善により、ドメイン全体の UTC に関して1ミリ秒の精度を実現できます。

### <a name="hyper-v"></a>Hyper-V
Windows 2016 では、Hyper-v TimeSync サービスが改善されました。 改良点としては、VM の開始時または VM の復元時の初期時間が長くなり、w32time に提供されるサンプルに対する中断待機時間の修正があります。  この機能強化により、75% の負荷のあるコンピューターでも、RMS (分散を示すルート平均二乗)、50μs の10μs をホストに継続的に持たせることができます。 詳細については、「 [hyper-v のアーキテクチャ](https://msdn.microsoft.com/library/cc768520.aspx)」を参照してください。

> [!NOTE]
> 負荷は、均衡プロファイルを使用して prime95 ベンチマークを使用して作成されました。

さらに、ホストがゲストに報告する階層レベルはより透過的になります。  以前は、ホストは、精度に関係なく、固定階層2を提示していました。  Windows Server 2016 の変更により、ホストは、ホストの階層よりも1つ大きい階層を報告します。これにより、仮想ゲストの時間が長くなります。  ホスト階層は、ソース時間に基づいて通常の方法で w32time によって決定されます。  ドメインに参加している Windows 2016 ゲストは、ホストを既定値としてではなく、最も正確な時刻を検索します。  この理由から、Windows 2012R2 以下のドメインに参加しているコンピューターの Hyper-v タイムプロバイダー設定を手動で無効にすることをお勧めしました。

### <a name="monitoring"></a>監視
パフォーマンスモニターカウンターが追加されました。  これにより、時間の精度のベースライン、監視、およびトラブルシューティングを行うことができます。  これらのカウンターは次のとおりです。

カウンター|説明|
----- | ----- |
計算された時間のオフセット|   W32Time サービスによって計算された、システムクロックから選択されたタイムソースまでの絶対時間オフセット (マイクロ秒単位)。 新しい有効なサンプルが使用可能になると、計算された時間が、サンプルで示されている時間オフセットで更新されます。 これは、ローカルクロックの実際の時間オフセットです。 W32time は、このオフセットを使用してクロックの修正を開始し、サンプル間の計算された時間を、ローカルクロックに適用する必要がある残りの時間オフセットで更新します。 このパフォーマンスカウンターを低ポーリング間隔 (256 秒以下など) で追跡し、必要なクロック精度制限より小さいカウンター値を検索することで、クロック精度を追跡できます。|
クロック周波数の調整| W32Time によってローカルシステムクロックに対して行われた絶対クロック周波数調整は、10億あたりの部分です。 このカウンターは、W32time によって実行されるアクションを視覚化するのに役立ちます。|
NTP ラウンドトリップ遅延|    NTP クライアントがサーバーからの応答をマイクロ秒で受信したときに発生した最新のラウンドトリップ遅延。 Ntp クライアントで、NTP サーバーに要求を送信してから、サーバーから有効な応答を受信するまでの経過時間です。 このカウンターは、NTP クライアントによって発生する遅延の特性を理解するのに役立ちます。 ラウンドトリップが大きくなったり変化したりすると、ntp 時間の計算にノイズが生じる可能性があります。これは、NTP による時間の同期の精度に影響を与える可能性があります。|
NTP クライアントのソース数|    NTP クライアントによって使用されているアクティブな NTP タイムソースの数。 これは、このクライアントの要求に応答している、タイムサーバーのアクティブで個別の IP アドレスの数です。 ピア名と現在のリーチ機能の DNS 解決によっては、構成されたピアよりも大きいまたは小さい値を指定できます。|
NTP サーバーの受信要求数|   NTP サーバーによって受信された要求の数 (要求数/秒)。|
NTP サーバーの発信応答|  NTP サーバー (応答/秒) によって応答された要求の数。|

最初の3つのカウンターは、精度の問題のトラブルシューティングのシナリオを対象としています。  次の「[ベストプラクティス](#BestPractices)」の「時間精度と NTP のトラブルシューティング」セクションでは、詳細について説明します。
最後の3つのカウンターは、NTP サーバーのシナリオに対応しており、負荷を特定し、現在のパフォーマンスを基準にしている場合に役立ちます。

### <a name="configuration-updates-per-environment"></a>環境ごとの構成の更新
以下では、各ロールの Windows 2016 と以前のバージョン間の既定の構成の変更について説明します。  Windows Server 2016 と Windows 10 記念日更新プログラム (ビルド 14393) の設定が一意になりました。これは、個別の列として表示されるためです。 

|ロール|設定|Windows Server 2016|Windows 10|Windows Server 2012 R2</br>Windows Server 2008 R2</br>Windows 10|
|---|---|---|---|---|
|**スタンドアロン/Nano Server**||||
| |*タイムサーバー*|time.windows.com|NA|time.windows.com|
| |*ポーリング頻度*|64-1024 秒|NA|週 1 回|
| |*クロック更新頻度*|1秒間|NA|1時間に1回|
|**スタンドアロンクライアント**||||
| |*タイムサーバー*|NA|time.windows.com|time.windows.com|
| |*ポーリング頻度*|NA|1 日 1 回|週 1 回|
| |*クロック更新頻度*|NA|1 日 1 回|週 1 回|
|**ドメインコントローラー**||||
| |*タイムサーバー*|PDC/GTIMESERV|NA|PDC/GTIMESERV|
| |*ポーリング頻度*|64-1024 秒|NA|1024-32768 秒|
| |*クロック更新頻度*|1 日 1 回|NA|週 1 回|
|**ドメインメンバーサーバー**||||
| |*タイムサーバー*|DC|NA|DC|
| |*ポーリング頻度*|64-1024 秒|NA|1024-32768 秒|
| |*クロック更新頻度*|1秒間|NA|5分ごとに1回|
|**ドメインメンバークライアント**||||
| |*タイムサーバー*|NA|DC|DC|
| |*ポーリング頻度*|NA|1204-32768 秒|1024-32768 秒|
| |*クロック更新頻度*|NA|5分ごとに1回|5分ごとに1回|
|**Hyper-v ゲスト**||||
| |*タイムサーバー*|ホストとタイムサーバーの階層に基づいて最適なオプションを選択します|ホストとタイムサーバーの階層に基づいて最適なオプションを選択します|既定値はホスト|
| |*ポーリング頻度*|上のロールに基づく|上のロールに基づく|上のロールに基づく|
| |*クロック更新頻度*|上のロールに基づく|上のロールに基づく|上のロールに基づく|

>[!NOTE]
>Hyper-v の Linux の場合は、後述の「Linux での[Hyper-v ホスト時間の使用を許可](#AllowingLinux)する」セクションを参照してください。

### <a name="impact-of-increased-polling-and-clock-update-frequency"></a>増加したポーリングとクロック更新頻度の影響
より正確な時間を提供するために、ポーリング頻度とクロック更新の既定値が増加しているため、小さな調整をより頻繁に行うことができます。  これにより UDP/NTP トラフィックが増加しますが、これらのパケットは小さいため、ブロードバンドリンクにはほとんど影響しません。 ただし、この利点は、さまざまなハードウェアと環境において時間がより適切であることです。

バッテリが使用されているデバイスの場合、ポーリング頻度を高くすると、問題が発生する可能性があります。  バッテリデバイスは、電源がオフになっている間は時刻を保存しません。  再開時に、時計を頻繁に修正することが必要になる場合があります。  ポーリング頻度を上げると、クロックが不安定になり、電力を消費する可能性もあります。  Microsoft では、クライアントの既定の設定を変更しないことをお勧めします。

AD ドメイン内の NTP クライアントからの増加した更新プログラムが影響を受ける場合でも、ドメインコントローラーの影響を最小限にする必要があります。  NTP のリソース消費量は、他のプロトコルや影響が少ない場合と比べてはるかに小さくなります。  Windows Server 2016 の強化された設定によって影響を受ける前に、他のドメイン機能の制限に近づいている可能性が高くなります。  Active Directory では、ntp を使用します。これは、単純な NTP よりも正確に同期時間が短くなることがありますが、クライアントには PDC から2階層離れてスケールアップすることを確認しました。

控えめな計画として、コアごとに 100 NTP 要求を1秒あたりに予約する必要があります。  たとえば、4つの Dc で構成されるドメインがそれぞれ4つある場合、1秒あたり1600の NTP 要求を処理できます。  10,000 台のクライアントが64秒ごとに時間を同期するように構成されており、要求が一定の時間にわたって一様に受信された場合、10,000/64 または約160要求/秒が、すべての Dc に分散していることがわかります。  これは、この例に基づいて、1600 NTP requests/sec の範囲内で簡単になります。  これらは控えめな計画の推奨事項であり、ネットワーク、プロセッサの速度、負荷に大きな依存関係があるため、環境内で常にベースラインとテストを行うことができます。

また、Dc が CPU 負荷が 40% を超えて実行されている場合は、ほぼ確実に NTP 応答にノイズを追加し、ドメインの時間の精度に影響を与えることに注意してください。  ここでも、実際の結果を理解するために、環境内でテストする必要があります。

## <a name="time-accuracy-measurements"></a>時間の精度の測定
### <a name="methodology"></a>手法
Windows Server 2016 の時刻の精度を測定するために、さまざまなツール、方法、および環境を使用しています。  これらの手法を使用して、環境を測定および調整し、精度の結果が要件を満たしているかどうかを判断できます。 

ドメインソースクロックは、GPS ハードウェアを搭載した2つの高精度 NTP サーバーで使用されています。  また、測定用に別の参照テストコンピューターを使用しています。これには、別の製造元からインストールされた高精度の GPS ハードウェアもありました。  一部のテストでは、ドメインクロックソースに加えて、正確で信頼性の高いクロックソースを参照として使用する必要があります。

物理マシンと仮想マシンの両方で精度を測定するために、4つの異なる方法を使用しています。 独立して提供された複数のメソッドは、結果を検証します。


1. 別の GPS ハードウェアを搭載した参照テスト用コンピューターに対して、w32tm によって決定されるローカルクロックを測定します。  
2.  Ntp "" という形式で、ntp サーバーからクライアントに NTP ping を測定する
3.  W32tm "" という形式で、NTP ping をクライアントから NTP サーバーに測定する
4.  Hyper-v の結果を、タイムスタンプカウンター (TSC) を使用してホストからゲストに測定します。  このカウンターは、両方のパーティションの両方のパーティションとシステム時刻の間で共有されます。  バーチャルマシンのホスト時間とクライアント時間の差を計算しています。  次に、TSC クロックを使用して、ホスト時間をゲストから補間します。これは、測定値が同時に発生しないためです。  また、API では、TSV のクロックファクターの遅延と待機時間を使用します。

W32tm は組み込まれていますが、テスト中に使用した他のツールは、テストと使用のためのオープンソースとして GitHub の Microsoft リポジトリで利用できます。  リポジトリの WIKI には、ツールを使用して測定を行う方法を説明する詳細情報が含まれています。

> [https://github.com/Microsoft/Windows-Time-Calibration-Tools](https://github.com/Microsoft/Windows-Time-Calibration-Tools)

次に示すテスト結果は、テスト環境の1つで行った測定値のサブセットです。  時間階層の開始時に維持される精度と、時間階層の最後に子ドメインクライアントを示します。  これは、比較のために2012ベースのトポロジ内の同じコンピューターと比較されます。

### <a name="topology"></a>トポロジ
比較のために、Windows Server 2012R2 と Windows Server 2016 ベースのトポロジの両方をテストしています。  どちらのトポロジも、GPS クロックハードウェアがインストールされている Windows Server 2016 コンピューターを参照する2つの物理 Hyper-v ホストコンピューターで構成されています。  各ホストは、次のトポロジに従って配置される3つのドメインに参加している windows ゲストを実行します。  線は、時間の階層、および使用されるプロトコル/トランスポートを表します。

![Windows タイム](../media/Windows-Time-Service/Windows-2016-Accurate-Time/topology1.png)

![Windows タイム](../media/Windows-Time-Service/Windows-2016-Accurate-Time/topology2.png)

### <a name="graphical-results-overview"></a>グラフィカルな結果の概要
次の2つのグラフは、上記のトポロジに基づいて、ドメイン内の2つの特定のメンバーの時刻の精度を表します。  各グラフには、Windows Server 2012R2 と2016の結果が重ねて表示されます。これは、視覚効果を視覚的に示します。  この精度は、ゲストマシンのとホストとの間で測定されました。  グラフィカルデータは、実行したテストのセット全体のサブセットを表し、最適なケースと最悪のシナリオを示しています。  

![Windows タイム](../media/Windows-Time-Service/Windows-2016-Accurate-Time/topology3.png)

### <a name="performance-of-the-root-domain-pdc"></a>ルートドメイン PDC のパフォーマンス
ルート PDC は、Hyper-v ホスト (VMIC を使用) に同期されます。これは、正確で安定した状態であることが実証されている Windows Server 2016 と GPS ハードウェアです。  これは、1ミリ秒の精度の重要な要件であり、緑の網掛け領域として表示されます。

![Windows タイム](../media/Windows-Time-Service/Windows-2016-Accurate-Time/chart1.png)

### <a name="performance-of-the-child-domain-client"></a>子ドメインクライアントのパフォーマンス
子ドメインクライアントは、ルート PDC と通信する子ドメイン PDC に接続されています。  また、この時間は1ミリ秒の要件内でもあります。

![Windows タイム](../media/Windows-Time-Service/Windows-2016-Accurate-Time/chart2.png)


### <a name="long-distance-test"></a>長距離テスト
次の表では、Windows Server 2016 での1つの仮想ネットワークホップと6つの物理ネットワークホップを比較しています。  2つのグラフは、重なり合うデータを示す透明度を使用して互いに重なっています。  ネットワークホップを増やすと、待機時間が長くなり、時間の偏差も大きくなります。  グラフが拡大されているため、緑色の領域で表される1ミリ秒の境界が大きくなります。  ご覧のように、この時間は、複数のホップを持つ1ミリ秒以内であることがわかります。  これは、ネットワーク asymmetry を示す、悪影響を及ぼします。  もちろん、すべてのネットワークが異なるため、測定値は環境要因の多くによって異なります。

![Windows タイム](../media/Windows-Time-Service/Windows-2016-Accurate-Time/chart3.png)

## <a name="BestPractices"></a>正確な timekeeping のベストプラクティス
### <a name="solid-source-clock"></a>ソリッドソースクロック
コンピューターの時刻は、同期元のクロックと同期するのと同じです。  1ミリ秒の精度を実現するためには、ネットワーク上に、マスターソースクロックとして参照する GPS ハードウェアまたはタイムアプライアンスが必要です。  既定の time.windows.com を使用すると、安定したローカルタイムソースを提供できない場合があります。  また、ソースクロックからさらに離れると、ネットワークが精度に影響を及ぼします。  最適な精度を得るには、各データセンターにマスターソースクロックを用意する必要があります。

### <a name="hardware-gps-options"></a>ハードウェア GPS オプション
正確な時間を提供できるさまざまなハードウェアソリューションがあります。  一般に、現在のソリューションは GPS アンテナに基づいています。  専用の線を使用して、無線およびダイヤルアップモデムのソリューションもあります。  これらのデバイスは、アプライアンスとして、または PC に接続します。たとえば、Windows の場合は、PCIe または USB デバイスを使用します。  オプションを変更すると、さまざまな精度レベルが提供され、常に環境によって異なります。  精度に影響を与える変数には、GPS の可用性、ネットワークの安定性と負荷、および PC ハードウェアがあります。  ここで説明したように、ソースクロックを選択する際の重要な要素は、安定した正確な時間の要件であることです。

### <a name="domain-and-synchronizing-time"></a>ドメインと同期時間
ドメインメンバーは、ドメイン階層を使用して、時間を同期するソースとして使用するコンピューターを決定します。  各ドメインメンバーは、同期する別のコンピューターを検出し、クロックソースとして保存します。  各種類のドメインメンバーは、時刻の同期のクロックソースを見つけるために、異なる規則のセットに従います。  フォレストルート内の PDC は、すべてのドメインの既定のクロックソースです。  次に示すのは、ソースの検索方法に関するさまざまなロールと高レベルの説明です。


- **PDC 役割を持つドメインコントローラー** –このコンピューターは、ドメインの権限のあるタイムソースです。 [GTIMESERV](#GTIMESERV)ロールが有効になっている場合を除き、ドメインで利用可能な時間が最も正確になり、親ドメインの DC と同期する必要があります。 
- **その他のドメインコントローラー** -このコンピューターは、ドメイン内のクライアントとメンバーサーバーのタイムソースとして機能します。 DC は、自身のドメインの PDC または親ドメイン内の任意の DC と同期できます。
- **クライアント/メンバーサーバー** –このコンピューターは、自身のドメインの任意の dc または pdc、または親ドメインの dc または pdc と同期できます。

使用可能な候補に基づいて、最適なタイムソースを見つけるためにスコアリングシステムが使用されます。  このシステムでは、タイムソースとその相対的な場所の信頼性が考慮されます。  これは、サービスが開始されたときに1回発生します。  時間の同期方法をより細かく制御する必要がある場合は、特定の場所に適切なタイムサーバーを追加したり、冗長性を追加したりできます。  詳細については、「 [GTIMESERV を使用してローカルの Reliable Time サービスを指定](#GTIMESERV)する」を参照してください。

#### <a name="mixed-os-environments-win2012r2-and-win2008r2"></a>混合 OS 環境 (Win2012R2 と Win2008R2)
最適な精度を得るには、純粋な Windows Server 2016 ドメイン環境が必要ですが、混在環境でもメリットがあります。  Windows Server 2016 Hyper-v を Windows 2012 ドメインに展開すると、上で説明した機能強化によってゲストの恩恵を受けることができます。ただし、ゲストが Windows Server 2016 でもある場合に限られます。  Windows Server 2016 PDC では、アルゴリズムが改善され、より安定したソースとなるため、より正確な時間を提供できます。  PDC を置き換えることができない場合は、代わりに、 [GTIMESERV](#GTIMESERV)ロールセットを使用して Windows SERVER 2016 DC を追加することができます。これは、ドメインの正確なアップグレードになります。  Windows Server 2016 DC は、ダウンストリームのタイムクライアントに対してより適切な時間を提供できますが、ソースの NTP 時間と同じように機能します。

また、前述のように、Windows Server 2016 では、クロックのポーリングと更新の頻度が変更されています。  これらは、ダウンレベルの Dc に手動で変更することも、グループポリシーを使用して適用することもできます。  これらの構成はテストしていませんが、Win2008R2 と Win2012R2 で適切に動作し、いくつかの利点を提供する必要があります。

Windows Server 2016 より前のバージョンでは、正確な時間を維持するために複数の問題が発生したため、調整が行われた直後にシステム時刻がませんされました。  このため、正確な NTP ソースから時刻のサンプルを頻繁に取得し、データを使用してローカルクロックを調整すると、サンプリング期間中のシステムクロックの誤差が小さくなるため、ダウンレベルの OS バージョンでの時間の短縮につながります。 高精度の設定で構成された Windows Server 2012R2 NTP クライアントが、正確な Windows 2016 NTP サーバーから時刻を同期している場合、おおよその精度は約5ミリ秒でした。

ゲストドメインコントローラーに関連する一部のシナリオでは、Hyper-v TimeSync のサンプルによって、ドメイン時間の同期が中断されることがあります。  これは、サーバー2016の Hyper-v ホストで実行されているサーバー2016ゲストでは問題になりません。

Hyper-v TimeSync サービスでサンプルを w32time に提供しないようにするには、次のゲストレジストリキーを設定します。

    HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\W32Time\TimeProviders\VMICTimeProvider 
    "Enabled"=dword:00000000

#### <a name="AllowingLinux"></a>Linux で Hyper-v ホスト時間を使用できるようにする
Hyper-v で実行されている Linux ゲストの場合、クライアントは通常、NTP サーバーに対する時刻の同期に NTP デーモンを使用するように構成されます。  Linux ディストリビューションで TimeSync version 4 プロトコルがサポートされており、Linux ゲストで TimeSync 統合サービスが有効になっている場合は、ホスト時間と同期されます。 このため、両方の方法が有効になっている場合、時間が一貫していない可能性があります。

ホスト時間に対して排他的に同期するには、次のいずれかの方法で NTP 時刻の同期を無効にすることをお勧めします。

- Ntp ファイル内の NTP サーバーを無効にする
- または NTP デーモンを無効にします。

この構成では、Time サーバーパラメーターはこのホストです。  ポーリングの頻度は5秒で、クロックの更新頻度も5秒です。

NTP で排他的に同期するには、ゲストで TimeSync 統合サービスを無効にすることをお勧めします。

> [!NOTE]
> 注:Linux ゲストでの正確な時刻のサポートには、最新のアップストリーム Linux カーネルでのみサポートされている機能が必要です。また、すべての Linux ディストリビューションで広く利用できるものではありません。 サポート配布の詳細については[、Windows 上の hyper-v でサポートされている Linux および FreeBSD の仮想マシン](https://technet.microsoft.com/windows-server-docs/virtualization/hyper-v/supported-linux-and-freebsd-virtual-machines-for-hyper-v-on-windows)を参照してください。

#### <a name="GTIMESERV"></a>GTIMESERV を使用してローカルの Reliable Time サービスを指定する
GTIMESERV、適切なタイムサーバー、フラグを使用して、1つまたは複数のドメインコントローラーを正確なソースクロックとして指定できます。  たとえば、GPS ハードウェアが搭載されている特定のドメインコントローラーに GTIMESERV というフラグを設定できます。  これにより、ドメインが GPS ハードウェアに基づく時計を参照することが保証されます。

> [!NOTE]
> ドメインフラグの詳細については、 [MS ADTS プロトコルのドキュメント](https://msdn.microsoft.com/library/mt226583.aspx)を参照してください。

TIMESERV は、コンピューターが現在権限を持っているかどうかを示す、もう1つの関連するドメインサービスフラグです。これは、DC が接続を失った場合に変更される可能性があります。  この状態の DC は、NTP を介してクエリを実行すると、"不明な階層" を返します。  複数回試行した後、DC はシステムイベントのタイムサービスイベント36をログに記録します。

DC を GTIMESERV として構成する場合は、次のコマンドを使用して手動で構成できます。  この場合、DC はマスタークロックとして別のマシンを使用しています。  アプライアンスまたは専用のコンピューターを使用できます。

    w32tm /config /manualpeerlist:”master_clock1,0x8 master_clock2,0x8” /syncfromflags:manual /reliable:yes /update

> [!NOTE]
> 詳細については、「 [Windows タイムサービスを構成する](https://technet.microsoft.com/library/cc731191.aspx)」を参照してください。

DC に GPS ハードウェアがインストールされている場合は、これらの手順を使用して NTP クライアントを無効にし、NTP サーバーを有効にする必要があります。

まず、NTP クライアントを無効にし、次のレジストリキーの変更を使用して NTP サーバーを有効にします。

    reg add HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\w32time\TimeProviders\NtpClient /v Enabled /t REG_DWORD /d 0 /f

    reg add HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\w32time\TimeProviders\NtpServer /v Enabled /t REG_DWORD /d 1 /f

次に、Windows タイムサービスを再起動します。

    net stop w32time && net start w32time

最後に、を使用して、このコンピューターに信頼性の高いタイムソースがあることを示します。
   
    w32tm /config /reliable:yes /update

変更が正しく行われたかどうかを確認するには、次のコマンドを実行します。これらのコマンドを実行すると、以下に示す結果に影響があります。 

    w32tm /query /configuration

値|設定が必要です|
----- | ----- |
AnnounceFlags|  5 (ローカル)|
NtpServer   |Lan|
DllName |C:\WINDOWS\SYSTEM32\w32time.DLL (ローカル)|
有効 |1 (ローカル)|
NtpClient|  Lan|

    w32tm /query /status /verbose

値|  設定が必要です|
----- | ----- |
階層|    1 (プライマリ参照-同期 cd (radio clock))|
ReferenceId|    0x4C4F434C (ソース名:"LOCAL")|
Source| ローカル CMOS クロック|
フェーズオフセット|   0.0000000 s|
サーバーの役割|    576 (Reliable Time サービス)|

#### <a name="windows-server-2016-on-3rd-party-virtual-platforms"></a>サードパーティの仮想プラットフォーム上の Windows Server 2016
Windows が仮想化されている場合、既定では、ハイパーバイザーは時間を提供する役割を担います。  ただし Active Directory が正常に機能するためには、ドメインに参加しているメンバーがドメインコントローラーと sychronized されている必要があります。  ゲストと、サードパーティの仮想プラットフォームのホストとの間で、いつでも仮想化を無効にすることをお勧めします。

#### <a name="discovering-the-hierarchy"></a>階層の検出
マスタークロックソースへの時間階層のチェーンはドメイン内で動的であるため、ネゴシエートされた場合は、特定のコンピューターの状態を照会して、タイムソースとマスターソースクロックのチェーンを理解する必要があります。  これは、時間同期の問題を診断するのに役立ちます。

特定のクライアントのトラブルシューティングを行う場合は、最初の手順は、この w32tm コマンドを使用して、タイムソースを理解することです。

    w32tm /query /status

結果には、他の項目の間にソースが表示されます。  ソースは、ドメイン内の時間を同期するユーザーを示します。  これは、このコンピューターの時間階層の最初の手順です。
次に、上記のソースエントリを使用し、/の pchart パラメーターを使用して、チェーン内の次のタイムソースを検索します。

    w32tm /stripchart /computer:MySourceEntry /packetinfo /samples:1

また、次のコマンドは、指定されたドメインで検出できる各ドメインコントローラーの一覧を表示し、各パートナーを特定できるように結果を出力します。  このコマンドには、手動で構成されたマシンが含まれます。
    
    w32tm /monitor /domain:my_domain

一覧を使用すると、ドメインを使用して結果をトレースし、各ステップの時間オフセットだけでなく、階層を理解することができます。  時間オフセットが著しく悪化する点を特定することで、誤った時刻のルートを特定できます。  そこから、 [w32tm ログ記録](#W32Logging)を有効にすることで、その時間が正しくない理由を理解することができます。 

#### <a name="using-group-policy"></a>グループポリシーの使用
グループポリシーを使用すると、たとえば、特定の NTP サーバーを使用するようにクライアントを割り当てたり、仮想化されたときにダウンレベルの OS を構成する方法を制御したりできます。  
考えられるシナリオと関連するグループポリシーの設定の一覧を次に示します。

**仮想化ドメイン**-Windows 2012R2 で仮想化されたドメインコントローラーを制御して、時刻を hyper-v ホストではなくドメインと同期させるために、このレジストリエントリを無効にすることができます。   PDC では、Hyper-v ホストが最も安定したタイムソースを提供するため、エントリを無効にする必要はありません。  レジストリエントリを変更した後は、w32time サービスを再起動する必要があります。

    [HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\W32Time\TimeProviders\VMICTimeProvider]
    "Enabled"=dword:00000000

**精度に依存する負荷**-時間の精度に依存するワークロードの場合、コンピューターのグループを構成して、NTP サーバーと、ポーリングやクロック更新頻度などの関連する時間の設定を設定できます。  これは通常、ドメインによって処理されますが、制御を強化するために、特定のコンピューターを対象として、マスタークロックを直接指すことができます。

グループ ポリシー設定|   新しい値|
----- | ----- |
NtpServer|  ClockMasterName、0x8|
MinPollInterval|    6 ~ 64 秒|
MaxPollInterval|    6|
UpdateInterval| 100–1秒あたり1回|
EventLogFlags|  3-すべての特別な時刻のログ記録|

> [!NOTE]
> NtpServer と EventLogFlags の設定は、[Windows NTP クライアント設定の構成] を使用して、System\Windows Time Service/time プロバイダーの下に配置されます。  その他の3つは、グローバル構成設定を使用して System\Windows Time Service の下にあります。

リモートの**精度に依存するリモート**-インスタンス小売および支払いクレジット業界 (PCI) のブランチドメイン内のシステムでは、手動の NTP タイムソースが構成されていない限り、Windows は現在のサイト情報と dc ロケーターを使用してローカル DC を検索します.  この環境では、精度が1秒である必要があります。これにより、適切な時間への収束が高速になります。  このオプションを使用すると、w32time サービスはクロックを後方に移動できます。  これが受け入れられ、要件を満たしている場合は、次のポリシーを作成できます。   すべての環境と同様に、はネットワークのテストとベースラインの作成を行います。 

グループ ポリシー設定|   新しい値|
----- | ----- |
MaxAllowedPhaseOffset|  1の場合は、クロックを正しい時刻に設定します。|

MaxAllowedPhaseOffset 設定は、グローバル構成設定を使用して System\Windows Time Service の下にあります。

> [!NOTE]
> グループポリシーと関連エントリの詳細については、TechNet の「 [Windows タイムサービスツール](windows-time-service-tools-and-settings.md)と設定」を参照してください。

## <a name="azure-and-windows-iaas-considerations"></a>Azure と Windows IaaS に関する考慮事項

### <a name="azure-virtual-machine-active-directory-domain-services"></a>Azure 仮想マシン:Active Directory Domain Services
Active Directory Domain Services を実行している Azure VM が既存のオンプレミス Active Directory フォレストの一部である場合は、TimeSync (VMIC) を無効にする必要があります。 これは、フォレスト内のすべての Dc (物理と仮想の両方) が1回限りの同期階層を使用できるようにするためです。 ベストプラクティスホワイトペーパー [「hyper-v でのドメインコントローラーの実行」](https://technet.microsoft.com/library/virtual_active_directory_domain_controller_virtualization_hyperv.aspx)を参照してください。

### <a name="azure-virtual-machine-domain-joined-machine"></a>Azure 仮想マシン:ドメインに参加しているコンピューター
既存の Active Directory フォレスト、仮想または物理マシンにドメイン参加しているコンピューターをホストしている場合、ベストプラクティスは、ゲストの TimeSync を無効にして、W32Time がドメインコントローラーと同期するように構成するために、時間を構成することです。Type = NTP5

### <a name="azure-virtual-machine-standalone-workgroup-machine"></a>Azure 仮想マシン:スタンドアロンワークグループコンピューター
Azure VM がドメインに参加していない場合、またはドメインコントローラーでない場合は、既定の時間構成を保持し、VM をホストと同期させることをお勧めします。

## <a name="windows-application-requiring-accurate-time"></a>正確な時間を必要とする Windows アプリケーション
### <a name="time-stamp-api"></a>タイムスタンプ API
UTC に関して最大の精度を必要とするプログラムで、時間の経過と共に、 [GETSYSTEMTIMEPRECISEASFILETIME API](https://msdn.microsoft.com/library/windows/desktop/Hh706895.aspx)を使用する必要があります。  これにより、アプリケーションは、Windows タイムサービスによって適用されるシステム時刻を取得できます。

### <a name="udp-performance"></a>UDP パフォーマンス
トランザクションに UDP 通信を使用するアプリケーションがあり、待機時間を最小限に抑えることが重要な場合は、ベースフィルターエンジンのポートから除外するポートの範囲を構成するために使用できる、関連するいくつかのレジストリエントリがあります。  これにより、待機時間が短縮され、スループットが向上します。  ただし、レジストリに対する変更は、経験豊富な管理者に限定する必要があります。  また、ファイアウォールによって保護されているポートを除外することもできます。  詳細については、以下の記事を参照してください。

Windows Server 2012 および Windows Server 2008 の場合は、まず修正プログラムをインストールする必要があります。  このサポート技術情報の記事を参照できます。[Windows 8 および Windows Server 2012 でマルチキャスト受信アプリケーションを実行すると、データグラムが失われる](https://support.microsoft.com/kb/2808584)

### <a name="update-network-drivers"></a>ネットワークドライバーの更新
一部のネットワークベンダーにはドライバーの更新プログラムがあり、ドライバーの待機時間と UDP パケットのバッファリングに関してパフォーマンスが向上します。  UDP スループットに関する更新プログラムがあるかどうかについては、ネットワークの製造元にお問い合わせください。

## <a name="logging-for-auditing-purposes"></a>監査目的のログ記録
時間トレースの規制に準拠するために、w32tm ログ、イベントログ、およびパフォーマンスモニターの情報を手動でアーカイブできます。  その後、アーカイブされた情報を使用して、過去の特定の時点でのコンプライアンスを証明できます。  精度を示すには、次の要素を使用します。


1. 計算された時間オフセットパフォーマンスモニターカウンターを使用したクロック精度。  これにより、の時計が必要な精度で表示されます。
2.  W32tm ログで "ピア応答から" を検索するクロックソース。   メッセージテキストの後に、IP アドレスまたは VMIC が示されます。これは、タイムソースと、検証する参照クロックのチェーンの次の部分を表します。
3.  W32tm ログを使用して、"ClockDispl 統制:\*傾斜\*時間\*が発生しています。  これは、その時点で w32tm がアクティブであることを示します。

### <a name="event-logging"></a>イベント ログ
完全なストーリーを得るには、イベントログ情報も必要です。  システムイベントログを収集し、タイムサーバー、Microsoft-Windows-kernel-Boot、Microsoft-Windows-Kernel-General を使用してフィルター処理することにより、サードパーティなど、時間が変更された他の影響があるかどうかを調べることができます。  外部からの干渉を除外するためにこれらのログが必要になる場合があります。  グループポリシーは、ログに書き込まれるイベントログに影響を与える可能性があります。  詳細については、グループポリシーの使用に関する前のセクションを参照してください。

### <a name="W32Logging"></a>W32time デバッグログ
監査のために w32tm を有効にするには、次のコマンドを使用してログ記録を有効にします。このログには、クロックの定期的な更新が表示され、ソースクロックが示されます。  サービスを再起動して、新しいログ記録を有効にします。  

詳細については、「 [Windows タイムサービスでデバッグログを有効にする方法](https://support.microsoft.com/kb/816043)」を参照してください。

    w32tm /debug /enable /file:C:\Windows\Temp\w32time-test.log /size:10000000 /entries:0-73,103,107,110

### <a name="performance-monitor"></a>パフォーマンス モニター
Windows Server 2016 の Windows タイムサービスでは、監査のログ記録を収集するために使用できるパフォーマンスカウンターが公開されています。  これらは、ローカルでもリモートでもログに記録できます。  コンピューター時間のオフセットおよびラウンドトリップ遅延カウンターを記録できます。  
また、パフォーマンスカウンターと同様に、リモートで監視したり、System Center Operations Manager を使用してアラートを作成したりすることができます。  たとえば、時間のオフセットが目的の精度からずれたときにアラートを使用して警告を表示できます。  詳細については、「 [System Center 管理パック」](https://social.technet.microsoft.com/wiki/contents/articles/15251.system-center-management-pack-authoring-guide.aspx)を参照してください。

### <a name="windows-traceability-example"></a>Windows 追跡可能性の例
W32tm ログファイルから、2つの情報を検証する必要があります。  1つ目は、ログファイルが現在条件時計であることを示しています。  これにより、Windows タイムサービスによって、お客様の時計が現在の時刻に条件を受けていることが証明されます。

    151802 20:18:32.9821765s - ClockDispln Discipline: *SKEW*TIME* - PhCRR:223 CR:156250 UI:100 phcT:65 KPhO:14307
    151802 20:18:33.9898460s - ClockDispln Discipline: *SKEW*TIME* - PhCRR:1 CR:156250 UI:100 phcT:64 KPhO:41
    151802 20:18:44.1090410s - ClockDispln Discipline: *SKEW*TIME* - PhCRR:1 CR:156250 UI:100 phcT:65 KPhO:38

主なポイントとして、"ClockDispln" というプレフィックスの付いたメッセージが表示されます。これは、プルーフ w32time がシステムクロックと対話しています。
 
次に、現在参照クロックとして使用されているソースコンピュータを報告する、争議時間の前にログに記録されている最後のレポートを検索する必要があります。  これは、IP アドレス、コンピューター名、または VMIC プロバイダーで、Hyper-v のホストと同期していることを示します。  次の例では、10.197.216.105 の IPv4 アドレスを提供します。

    151802 20:18:54.6531515s - Response from peer 10.197.216.105,0x8 (ntp.m|0x8|0.0.0.0:123->10.197.216.105:123), ofs: +00.0012218s

参照タイムチェーンの最初のシステムを検証したので、参照時のソースでログファイルを調査し、同じ手順を繰り返す必要があります。  これは、GPS や NIST などの既知のタイムソースなどの物理的なクロックに到達するまで続きます。  参照クロックが GPS ハードウェアの場合は、製造されたのログが必要になることもあります。

## <a name="network-considerations"></a>ネットワークに関する考慮事項
NTP プロトコルアルゴリズムは、ネットワークの対称に依存しています。  ネットワークホップの数が増えるにつれて、asymmetry の可能性が高くなります。  では、特定の環境でどのような種類の精度が表示されるかを予測するのは困難です。 

パフォーマンスモニターと Windows Server 2016 の新しい Windows Time カウンターを使用して、環境の精度を評価し、基準を作成することができます。 また、トラブルシューティングを実行して、ネットワーク上の任意のコンピューターの現在のオフセットを確認することもできます。

ネットワーク上の正確な時間には、2つの一般的な基準があります。  PTP ([有効桁数-IEEE 1588](https://www.nist.gov/el/intelligent-systems-division-73500/introduction-ieee-1588)) はネットワークインフラストラクチャの要件が厳しくなりますが、多くの場合、サブマイクロ秒の精度が得られます。  NTP ([ネットワークタイムプロトコル– RFC 1305](https://tools.ietf.org/html/rfc1305)) は、さまざまなネットワークや環境で動作するため、管理が容易になります。 

Windows では、ドメインに参加していないコンピューターでは、既定で Simple NTP (RFC2030) がサポートされています。  ドメインに参加しているコンピューターの場合は、 [MS-SNTP](https://msdn.microsoft.com/library/cc246877.aspx)と呼ばれる安全な ntp を使用します。これにより、RFC1305 および RFC5905 で説明されている認証済み ntp よりも管理上の利点が得られます。   

ドメインとドメインに参加していないプロトコルの両方に UDP ポート123が必要です。  NTP のベストプラクティスの詳細については、[ネットワークタイムプロトコルのベストプラクティス「IETF Draft](https://tools.ietf.org/html/draft-ietf-ntp-bcp-00)」を参照してください。

### <a name="reliable-hardware-clock-rtc"></a>Reliable Hardware Clock (RTC)
Windows は、特定の境界を超えていなくてもクロックを統制する場合を除き、時間をステップしません。  つまり、w32tm は、時計の更新頻度設定を使用して、時計の頻度を一定の間隔で調整します。既定値は、Windows Server 2016 では1秒に設定されます。  クロックが遅れている場合は、周波数が加速し、それが進むと周波数が遅くなります。  ただし、クロック周波数調整の間には、ハードウェアクロックが制御されます。  ファームウェアまたはハードウェアクロックに問題があると、コンピューター上の時刻が正確になります。

これは、環境でテストとベースラインを行う必要があるもう1つの理由です。  "計算された時間のオフセット" パフォーマンスカウンターがターゲットの精度に安定しない場合は、ファームウェアが最新の状態であることを確認する必要があります。  別のテストとして、重複するハードウェアによって同じ問題が再現されているかどうかを確認できます。

### <a name="troubleshooting-time-accuracy-and-ntp"></a>時間の精度と NTP のトラブルシューティング
上記の「階層の検出」セクションを使用すると、不正確な時間の原因を把握できます。  時間オフセットを確認するには、時間が NTP ソースから最も多くなる階層内のポイントを探します。  階層を理解したら、特定のタイムソースが正確な時間を受け取らない理由を理解してください。  

異なる time を使用してシステムに焦点を当てると、以下のツールを使用して、問題を特定し、解決策を見つけるのに役立つ詳細情報を収集できます。  以下の UpstreamClockSource 参照は、"w32tm/config/status" を使用して検出されたクロックです。


- システムイベントログ
- ログを有効にする: w32tm logs-w32tm/debug/enable C:\Windows\Temp\w32time-test.log:/size: 10000000/entries: 0 ~ 300
- w32Time レジストリキー HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\W32Time
- ローカルネットワークトレース
- パフォーマンスカウンター (ローカルコンピューターまたは UpstreamClockSource から)
- W32tm/the pchart/computer: UpstreamClockSource
- UpstreamClockSource に PING を送信し、待機時間とソースのホップ数を把握します。
- Tracert UpstreamClockSource

問題|    症状|   解決方法|
----- | ----- | ----- |
ローカル TSC クロックが安定していません。| Perfmon-物理コンピューター–同期クロック安定クロックを使用しますが、1-2 分ごとに数百米ドルの時間がかかることがわかります。 |   ファームウェアを更新したり、別のハードウェアを検証したりしても、同じ問題は表示されません。|
ネットワーク待機時間|    w32tm の pchart には、10ミリ秒を超える RoundTripDelay が表示されます。  遅延が変化すると、ラウンドトリップ時間の1/2 のようなノイズが発生します。たとえば、一方向の遅延が発生します。</br></br>UpstreamClockSource は、PING によって示される複数のホップです。  TTL は128に近い必要があります。</br></br>各ホップの待機時間を調べるには、Tracert を使用します。    | 時間の詳細なクロックソースを見つけます。  1つの解決策として、同じセグメントにソースクロックをインストールする方法と、地理的に近い場所にあるソースクロックを手動で指定する方法があります。  ドメインのシナリオでは、GTimeServ ロールを持つコンピューターを追加します。 |  
NTP ソースに確実に接続できない|    W32tm "要求がタイムアウトしました" が断続的に返される    |NTP ソースが応答しない|
NTP ソースが応答しない|    NTP クライアントソース数、ntp サーバーの着信要求、NTP サーバーの発信応答の Perfmon カウンターをチェックし、使用している基準と比較して使用状況を判断します。|    サーバーパフォーマンスカウンターを使用して、基準への参照で負荷が変化したかどうかを確認します。</br></br>ネットワークの輻輳に関する問題はありますか。|
ドメインコントローラが最も正確なクロックを使用していません|    トポロジの変更、または最近追加されたマスター時刻の時計。|   w32tm/再同期/再検出|
クライアントクロックはません| システムイベントログのタイムサービスイベント36、またはログファイル内のテキスト (またはその両方) で、次のことが説明されています。"NTP クライアント時間のソース数" カウンターが1から0になりました|アップストリームソースのトラブルシューティングを行い、パフォーマンスの問題が発生しているかどうかを把握します。|

### <a name="baselining-time"></a>基準時間
基準は、まず、ネットワークのパフォーマンスと精度を把握し、問題が発生したときのベースラインとの比較に使用できるようにするために重要です。  ルート PDC または GTIMESRV でマークされているすべてのマシンのベースラインを設定することをお勧めします。  また、すべてのフォレストで PDC のベースラインを作成することをお勧めします。  最後に、距離や高負荷、ベースラインなど、興味深い特性を持つ重要な Dc またはマシンを選択します。

また、Windows Server 2016 と 2012 R2 のベースラインにも役立ちますが、Windows Server 2012R2 にはパフォーマンスカウンターがないため、比較に使用できるツールとしては w32tm/の pchart しかありません。  同じ特性を持つ2台のマシンを選択するか、コンピューターをアップグレードして、更新後の結果を比較する必要があります。  Windows Time 測定の補遺には、2016と2012の間で詳細な測定を行う方法の詳細が記載されています。

すべての w32time パフォーマンスカウンターを使用して、少なくとも1週間のデータを収集します。  これにより、時間の経過と共にネットワーク内のさまざまな情報を考慮するための十分な情報が得られます。また、時間の精度が安定していることを自信を持って実行できます。

### <a name="ntp-server-redundancy"></a>NTP サーバーの冗長性
ドメインに参加していないコンピューターまたは PDC で使用される手動の NTP サーバー構成では、可用性の場合、複数のサーバーを使用することをお勧めします。  また、すべてのソースが正確で安定していると仮定すると、精度が向上します。  ただし、トポロジが適切に設計されていない場合や、タイムソースが安定していない場合は、結果の精度が悪くなる可能性があるため、注意が必要です。  サポートされるタイムサーバーの数の制限は、手動で参照できます10です。 

## <a name="leap-seconds"></a>うるう秒
地球の回転期間は、climatic および地質イベントによって発生する時間の経過と共に変化します。 通常、このバリエーションは 2 ~ 3 年にわたります。 アトミック時間のバリエーションが大きくなりすぎると、1秒 (上または下) の修正が、うるう秒と呼ばれるように挿入されます。 これは、差が0.9 秒を超えないようにするために行われます。 この修正は、実際の修正の6か月前に発表されています。 Windows Server 2016 より前では、Microsoft タイムサービスはうるう秒を認識していませんでしたが、これを行うために外部タイムサービスに依存していました。 Windows Server 2016 の時間精度の向上により、Microsoft は、うるう2の問題に対するより適切なソリューションに取り組んでいます。

## <a name="secure-time-seeding"></a>セキュリティで保護された時刻のシード処理
サーバー2016の W32time には、セキュリティで保護された時刻のシード処理機能が含まれています。 この機能は、発信 SSL 接続からのおおよその現在の時間を決定します。  この時間値は、ローカルシステムクロックを監視し、総エラーを修正するために使用されます。 この機能の詳細については、こちらの[ブログ記事](https://blogs.msdn.microsoft.com/w32time/2016/09/28/secure-time-seeding-improving-time-keeping-in-windows/)をご覧ください。  時間オフセットの監視を含む、信頼性の高いタイムソースと監視対象のコンピューターを使用したデプロイでは、セキュリティで保護されたタイムシード機能を使用しないことを選択し、代わりに既存のインフラストラクチャを利用することができます。 

この機能を無効にするには、次の手順を実行します。

1.  特定のコンピューターで、UtilizeSSLTimeData レジストリ構成値を0に設定します。

    reg add HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\w32time\Config/v UtilizeSslTimeData/t REG_DWORD/d 0/f


2.  何らかの理由によりコンピューターをすぐに再起動できない場合は、構成の更新について W32time サービスに通知できます。 これにより、SSL 接続から収集された時間データに基づいて、時間の監視と適用が停止されます。 

    W32tm/config/update

3.  コンピューターを再起動すると、設定は直ちに有効になります。また、SSL 接続からの時刻データの収集も停止されます。  後者の部分には非常に小さなオーバーヘッドがあるため、パフォーマンスの問題にはなりません。

4.  この設定をドメイン全体に適用するには、W32time グループポリシー設定の UtilizeSSLTimeData の値を0に設定し、設定を発行してください。  設定がグループポリシークライアントによって選択されると、W32time サービスに通知され、SSL 時間データを使用した監視と適用の時間が停止します。 各マシンが再起動されると、SSL time データ収集は停止します。 ドメインにポータブルスリムノート pc やタブレットなどのデバイスがある場合は、このようなコンピューターをこのポリシーの変更から除外することができます。 これらのデバイスは、最終的にバッテリ消耗に直面し、時間をブートストラップするために、セキュリティで保護された時刻のシード処理機能が必要になります。


