---
title: Windows Server 2016 での hyper-v ネットワーク仮想化の技術的な詳細
description: このトピックでは、Windows Server 2016 の Hyper-v ネットワーク仮想化に関する技術情報について説明します。
manager: brianlic
ms.custom: na
ms.prod: windows-server
ms.reviewer: na
ms.service: virtual-network
ms.suite: na
ms.technology: networking-sdn
ms.tgt_pltfrm: na
ms.topic: article
ms.assetid: 9efe0231-94c1-4de7-be8e-becc2af84e69
ms.author: pashort
author: shortpatti
ms.openlocfilehash: e692384e9416e21e00556af6ada9af8df1713a03
ms.sourcegitcommit: 6aff3d88ff22ea141a6ea6572a5ad8dd6321f199
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 09/27/2019
ms.locfileid: "71405860"
---
# <a name="hyper-v-network-virtualization-technical-details-in-windows-server-2016"></a>Windows Server 2016 での hyper-v ネットワーク仮想化の技術的な詳細

>適用対象:Windows Server 2016

サーバー仮想化を導入すると、複数のサーバー インスタンスを 1 つの物理ホストで同時に実行できます。ただし、サーバー インスタンスは互いに独立しています。 各仮想マシンは基本的に、その仮想マシンだけが物理コンピューター上で実行されているサーバーであるかのように動作します。  

ネットワークの仮想化は同様の機能を提供します。この機能は、複数の仮想ネットワーク (IP アドレスが重複する可能性があります) が同じ物理ネットワークインフラストラクチャ上で実行され、各仮想ネットワークがで実行される唯一の仮想ネットワークであるかのように動作します。共有ネットワークインフラストラクチャ。 この関係を示したのが図 1 です。  

![サーバー仮想化とネットワーク仮想化](../../../media/hyper-v-network-virtualization-technical-details-in-windows-server/VNetF1.gif)  

図 1: サーバー仮想化とネットワーク仮想化  

## <a name="hyper-v-network-virtualization-concepts"></a>Hyper-V ネットワーク仮想化の概念  
Hyper-v ネットワーク仮想化 (HNV) では、顧客またはテナントは、エンタープライズまたはデータセンターに展開される一連の IP サブネットの "所有者" として定義されます。 顧客は、ネットワークの分離を必要とするプライベートデータセンター内の複数の部門または事業単位を持つ企業または企業、またはサービスプロバイダーによってホストされるパブリックデータセンター内のテナントにすることができます。 各顧客はデータセンターに1つ以上の[仮想](#VirtualNetworks)ネットワークを持つことができ、各仮想ネットワークは1つ以上の[仮想サブネット](#VirtualSubnets)で構成されます。  

Windows Server 2016 では、次の2つの HNV 実装を使用できます。HNVv1 と HNVv2。  

-   **HNVv1**  

    HNVv1 は、Windows Server 2012 R2 および System Center 2012 R2 Virtual Machine Manager (VMM) と互換性があります。 HNVv1 の構成では、WMI 管理および Windows PowerShell コマンドレット (System Center VMM を通じて容易) を使用して、分離設定と顧客アドレス (CA) を定義します。これは、仮想ネットワークから物理アドレス (PA) へのマッピングとルーティングです。 Windows Server 2016 の HNVv1 に追加機能は追加されていません。新機能は計画されていません。  

    • SET チーミングと HNV V1 はプラットフォームと互換性がありません。

    o HA NVGRE ゲートウェイを使用するには、ユーザーが LBFO チームを使用するか、チームを使用する必要があります。 または

    o ネットワークコントローラーでデプロイされたゲートウェイを使用して、チーム化されたスイッチを設定します。


-   **HNVv2**  

    HNVv2 には、Hyper-v スイッチで Azure 仮想フィルタリングプラットフォーム (VFP) 転送拡張機能を使用して実装される多数の新機能が含まれています。 HNVv2 は、ソフトウェア定義ネットワーク (SDN) スタックの新しいネットワークコントローラーを含む Microsoft Azure Stack と完全に統合されています。  仮想ネットワークポリシーは、RESTful NorthBound (NB) API を使用して Microsoft[ネットワークコントローラー](../../../sdn/technologies/network-controller/Network-Controller.md)を介して定義され、を含む複数の SouthBound 整合性 (sbi) を介してホストエージェントに組み込まれます。 ホストエージェントプログラムポリシーは、Hyper-v スイッチが適用されている VFP 拡張機能に含まれています。  

    > [!IMPORTANT]  
    > このトピックでは、HNVv2 に重点を置いて説明します。  

### <a name="VirtualNetworks"></a>仮想ネットワーク  

-   各仮想ネットワークは、1つまたは複数の仮想サブネットで構成されます。 仮想ネットワークは、仮想ネットワーク内の仮想マシンが相互に通信できる分離境界を形成します。 従来、この分離は、分離された IP アドレス範囲と 802.1 q タグまたは VLAN ID を持つ Vlan を使用して実施されました。 ただし、HNV を使用すると、NVGRE または VXLAN カプセル化を使用して分離が適用され、ユーザーまたはテナント間で IP サブネットが重複する可能性があるオーバーレイネットワークが作成されます。  

-   各仮想ネットワークには、ホスト上で一意のルーティングドメイン ID (RDID) があります。 この RDID は、ネットワークコントローラー内の仮想ネットワーク REST リソースを識別するために、おおよそのリソース ID にマップされます。 仮想ネットワーク REST リソースは、追加されたリソース ID を持つ Uniform Resource Identifier (URI) 名前空間を使用して参照されます。  

### <a name="VirtualSubnets"></a>仮想サブネット  

-   仮想サブネットでは、同じサブネット内の仮想マシンにレイヤー 3 IP サブネット セマンティクスが実装されます。 仮想サブネットは、(VLAN と同様に) ブロードキャストドメインを形成し、NVGRE テナントネットワーク ID (TNI) フィールドまたは VXLAN Network Identifier (VNI) フィールドのいずれかを使用して分離が適用されます。  

-   各仮想サブネットは1つの仮想ネットワーク (RDID) に属し、カプセル化されたパケットヘッダーの TNI キーまたは VNI キーを使用して一意の仮想サブネット ID (VSID) が割り当てられます。 VSID はデータセンター内で一意であり、4096 ~ 2 ^ 24-2 の範囲である必要があります。  

仮想ネットワークとルーティングドメインの主な利点は、顧客が独自のネットワークトポロジ (IP サブネットなど) をクラウドに持ち込むことができることです。 図 2 の例では、Contoso Corp は R&D Net と Sales Net の 2 つの独立したネットワークを所有しています。 これらのネットワークはルーティング ドメイン ID が異なるため、干渉し合うことはありません。 つまり、Contoso R&D Net と Contoso Sales Net は共に Contoso Corp によって所有されていますが、Contoso R&D Net は Contoso Sales Net から切り離されています。Contoso R&D Net には 3 つの仮想サブネットが含まれています。 RDID と VSID の両方がデータセンター内で一意であることに注意してください。  

![カスタマー ネットワークと仮想サブネット](../../../media/hyper-v-network-virtualization-technical-details-in-windows-server/VNetF6.gif)  

図 2: カスタマー ネットワークと仮想サブネット  

**レイヤー2の転送**  

図2では、VSID 5001 の仮想マシンは、Hyper-v スイッチを介して VSID 5001 にもある仮想マシンにパケットを転送できます。 VSID 5001 の仮想マシンからの受信パケットは、Hyper-v スイッチの特定の VPort に送信されます。 受信規則 (例: encap) とマッピング (カプセル化ヘッダーなど) は、これらのパケットに対して Hyper-v スイッチによって適用されます。 その後、パケットは、Hyper-v スイッチの別の VPort (接続先のバーチャルマシンが同じホストに接続されている場合) または別のホスト上の別の Hyper-v スイッチ (宛先のバーチャルマシンが別のホストに配置されている場合) に転送されます。  

**レイヤー3のルーティング**  

同様に、VSID 5001 の仮想マシンは、各 Hyper-v ホストの VSwitch に存在する HNV 分散ルーターによって、VSID 5002 または VSID 5003 の仮想マシンにパケットをルーティングすることができます。 HNV は、パケットを Hyper-v スイッチに配信するときに、着信パケットの VSID を宛先の仮想マシンの VSID に更新します。 これは両方の VSID が同じ RDID 内にある場合にだけ行われます。  そのため、RDID1 を使用した仮想ネットワークアダプターは、ゲートウェイを走査せずには RDID2 を使用して仮想ネットワークアダプターにパケットを送信することはできません。  

> [!NOTE]  
> 上記のパケットフローの説明では、"仮想マシン" という用語は、実際には仮想マシン上の仮想ネットワークアダプターを意味します。 通常、仮想マシン上には仮想ネットワーク アダプターが 1 つしかありません。 この場合、"仮想マシン" と "仮想ネットワークアダプター" という言葉は、概念的には同じことを意味します。  

各仮想サブネットでは、レイヤー 3 IP サブネットと VLAN に似たレイヤー 2 (L2) ブロードキャスト ドメイン境界が定義されます。 仮想マシンがパケットをブロードキャストするとき、HNV はユニキャストレプリケーション (UR) を使用して元のパケットのコピーを作成し、宛先 IP と MAC を同じ VSID 内の各 VM のアドレスに置き換えます。  

> [!NOTE]  
> Windows Server 2016 が出荷されると、ユニキャストレプリケーションを使用してブロードキャストおよびサブネットのマルチキャストが実装されます。 クロスサブネットマルチキャストルーティングと IGMP はサポートされていません。  

VSID は、ブロードキャスト ドメインであるだけでなく、分離も提供します。 HNV の仮想ネットワークアダプターは、Hyper-v スイッチポートに接続されています。このポートは、ポート (virtualNetworkInterface REST リソース) に直接適用されるか、またはそのパートである仮想サブネット (VSID) に対して ACL 規則が適用されます。  

Hyper-v スイッチポートには、ACL 規則が適用されている必要があります。 この ACL では、すべてを許可するか、すべてを拒否するか、または、5組 (ソース IP、宛先 IP、発信元ポート、宛先ポート、プロトコル) に基づいて特定の種類のトラフィックのみを許可することができます。  

> [!NOTE]  
> Hyper-v スイッチ拡張機能は、新しいソフトウェア定義ネットワーク (SDN) スタックの HNVv2 では機能しません。 HNVv2 は、他のサードパーティ製スイッチ拡張機能と組み合わせて使用できない Azure 仮想フィルタリングプラットフォーム (VFP) スイッチ拡張機能を使用して実装されます。  

## <a name="switching-and-routing-in-hyper-v-network-virtualization"></a>Hyper-v ネットワーク仮想化での切り替えとルーティング  
HNVv2 は、物理的なスイッチやルーターと同じように動作する正しいレイヤー 2 (L2) とレイヤー 3 (L3) のルーティングセマンティクスを実装しています。 HNV 仮想ネットワークに接続されている仮想マシンが、同じ仮想サブネット (VSID) 内の別の仮想マシンとの接続を確立しようとすると、まず、リモート仮想マシンの CA MAC アドレスを知る必要があります。 移行元の仮想マシンの ARP テーブルに宛先の仮想マシンの IP アドレスの ARP エントリがある場合は、このエントリの MAC アドレスが使用されます。 エントリが存在しない場合、ソース仮想マシンは、返される宛先仮想マシンの IP アドレスに対応する MAC アドレスの要求と共に、ARP ブロードキャストを送信します。 Hyper-v スイッチはこの要求をインターセプトし、ホストエージェントに送信します。 ホストエージェントは、ローカルデータベースで、要求された宛先仮想マシンの IP アドレスに対応する MAC アドレスを検索します。  

> [!NOTE]  
> ホストエージェントは、このサーバーとして機能する VTEP スキーマのバリエーションを使用して、CA PA マッピングや MAC テーブルなどを格納します。  

MAC アドレスが使用可能な場合、ホストエージェントは ARP 応答を挿入し、それを仮想マシンに送り返します。 仮想マシンのネットワークスタックに必要な L2 ヘッダー情報がすべて含まれた後、フレームは V スイッチの対応する Hyper-v ポートに送信されます。 内部的には、Hyper-v スイッチは、このフレームを V ポートに割り当てられた N タプル一致ルールと照合してテストし、これらのルールに基づいて特定の変換をフレームに適用します。 最も重要なのは、ネットワークコントローラーで定義されているポリシーに応じて、NVGRE または VXLAN を使用してカプセル化ヘッダーを構築するために、一連のカプセル化変換が適用されることです。 ホストエージェントによってプログラムされたポリシーに基づいて、CA PA マッピングを使用して、移行先仮想マシンが存在する Hyper-v ホストの IP アドレスを特定します。 Hyper-v スイッチにより、正しいルーティング規則と VLAN タグが外部パケットに適用され、リモート PA アドレスに到達できるようになります。  

HNV 仮想ネットワークに接続されている仮想マシンが、別の仮想サブネット (VSID) 内の仮想マシンとの接続を作成しようとしている場合は、それに応じてパケットをルーティングする必要があります。 HNV は、すべての IP プレフィックス (つまり1つの既定のルート/ゲートウェイ) に到達するために、次ホップとして使用される CA 領域に1つの IP アドレスのみがあるスタートポロジを前提としています。 現時点では、これにより、単一の既定ルートに制限が適用され、既定以外のルートはサポートされません。  

### <a name="routing-between-virtual-subnets"></a>仮想サブネット間のルーティング  
物理ネットワークでは、IP サブネットは、コンピューター (仮想および物理) が相互に直接通信できるレイヤー 2 (L2) ドメインです。 L2 ドメインは、すべてのインターフェイスでブロードキャストされる ARP 要求によって ARP エントリ (IP: MAC アドレスマップ) が学習され、arp 応答が要求元のホストに送信されるブロードキャストドメインです。 コンピューターは、ARP 応答から得られた MAC 情報を使用して、イーサネットヘッダーを含む L2 フレームを完全に構築します。 ただし、IP アドレスが別の L3 サブネットにある場合、ARP 要求はこの L3 境界を超えません。 代わりに、ソースサブネットの IP アドレスを持つ L3 ルーターインターフェイス (次ホップまたはデフォルトゲートウェイ) は、独自の MAC アドレスを使用してこれらの ARP 要求に応答する必要があります。  

標準の Windows ネットワークでは、管理者は静的ルートを作成し、それらをネットワークインターフェイスに割り当てることができます。 また、通常、"既定のゲートウェイ" は、既定のルート (0.0.0.0/0) 宛てのパケットが送信されるインターフェイス上の次ホップ IP アドレスとして構成されます。 特定のルートが存在しない場合、パケットはこのデフォルトゲートウェイに送信されます。 これは通常、物理ネットワークのルーターです。  HNV は、すべてのホストの一部であり、すべての VSID にインターフェイスを備えた組み込みルーターを使用して、仮想ネットワークの分散ルーターを作成します。  

HNV はスタートポロジを前提としているため、HNV 分散ルーターは、同じ VSID ネットワークの一部である仮想サブネット間のすべてのトラフィックに対して1つのデフォルトゲートウェイとして機能します。 既定のゲートウェイとして使用されるアドレスは、既定で VSID 内の最も低い IP アドレスに設定され、HNV 分散ルーターに割り当てられます。 この分散ルーターを使用すると、各ホストが仲介を必要とすることなく適切なホストにトラフィックを直接ルーティングできるため、VSID ネットワーク内のすべてのトラフィックを適切にルーティングすることができます。  これは特に、同じ VM ネットワーク内の異なる仮想サブネットで、2 つの仮想マシンが同じ物理ホスト上にある場合に当てはまります。  このセクションで後ほど説明するように、この場合にパケットは物理ホストを離れる必要はありません。  

### <a name="routing-between-pa-subnets"></a>PA サブネット間のルーティング  
仮想サブネット (VSID) ごとに1つの PA IP アドレスが割り当てられた HNVv1 とは対照的に、HNVv2 は、スイッチ埋め込みチーミング (SET) NIC チームメンバーごとに1つの PA IP アドレスを使用するようになりました。 既定のデプロイでは、2つの NIC からなるチームが想定され、ホストごとに2つの PA IP アドレスが割り当てられます。 1つのホストで、同じプロバイダー (PA) 論理サブネットから割り当てられた PA Ip が同じ VLAN 上に存在する。 同じ仮想サブネット内の2つのテナント Vm は、2つの異なるプロバイダー論理サブネットに接続されている2つの異なるホスト上に存在することがあります。 HNV は、CA PA マッピングに基づいて、カプセル化されたパケットの外部 IP ヘッダーを構築します。 ただし、既定の PA ゲートウェイに対してはホストの TCP/IP スタックに依存し、ARP 応答に基づいて外部イーサネットヘッダーを作成します。 通常、この ARP 応答は、ホストが接続されている物理スイッチまたは L3 ルーターの SVI インターフェイスから取得されます。 このため、HNV は、プロバイダーの論理サブネットまたは Vlan 間でカプセル化されたパケットをルーティングするために、L3 ルーターに依存しています。  

### <a name="routing-outside-a-virtual-network"></a>仮想ネットワークの外側のルーティング  
ほとんどの顧客展開では、HNV 環境から HNV 環境の一部ではないリソースへの通信が必要になります。 2 つの環境間の通信を実現するためには、ネットワーク仮想化ゲートウェイが必要です。 HNV ゲートウェイを必要とするインフラストラクチャには、プライベートクラウドとハイブリッドクラウドが含まれます。 基本的に、HNV ゲートウェイは、内部および外部 (物理) ネットワーク (NAT を含む) 間、または IPSec VPN または GRE トンネルを使用する異なるサイトやクラウド (プライベートまたはパブリック) 間のレイヤー3ルーティングに必要です。  

ゲートウェイはさまざまな物理フォーム ファクターで提供されます。 Windows Server 2016 に組み込まれており、VXLAN ゲートウェイとして機能する上位ラック (TOR) スイッチに組み込まれており、ロードバランサーによって提供される仮想 IP (VIP) を介してアクセスしたり、他の既存のネットワークアプライアンスに配置したり、新しいスタンドアロンネットワークアプライアンスにすることができます.  

Windows RAS ゲートウェイのオプションの詳細については、「 [Ras gateway](../../../../remote/remote-access/ras-gateway/RAS-Gateway.md)」を参照してください。  

## <a name="packet-encapsulation"></a>パケット カプセル化  
HNV の各仮想ネットワーク アダプターは、次の 2 つの IP アドレスに関連付けられます。  

-   **カスタマーアドレス**(CA) イントラネットインフラストラクチャに基づいて、顧客によって割り当てられた IP アドレス。 このアドレスの存在によって、顧客は、パブリック クラウドまたはプライベート クラウドに移行されたことを意識せずに、仮想マシンとの間でネットワーク トラフィックをやり取りすることができます。 CA は、仮想マシンから見える、顧客が到達可能なアドレスです。  

-   **プロバイダーアドレス**(PA) ホストプロバイダーまたはデータセンター管理者が物理ネットワークインフラストラクチャに基づいて割り当てた IP アドレス。 PA は、仮想マシンをホストしている Hyper-V を実行するサーバーとの間で交換されるネットワーク上のパケットに格納されます。 PA は、物理ネットワーク上では見えますが、仮想マシンからは見えません。  

カスタマー ネットワークのトポロジは、CA によって保たれていますが、カスタマー ネットワークは仮想化され、その基になる (PA によって実現されている) 実際の物理ネットワークのトポロジとアドレスからは切り離されています。 次の図は、ネットワーク仮想化の結果としての仮想マシンの CA とネットワーク インフラストラクチャの PA の概念上の関係を示しています。  

![物理インフラストラクチャ上のネットワーク仮想化の概念図](../../../media/hyper-v-network-virtualization-technical-details-in-windows-server/VNetF2.gif)  

図 6: 物理インフラストラクチャ上のネットワーク仮想化の概念図  

この図では、顧客の仮想マシンが CA 空間でデータパケットを送信しています。これは、独自の仮想ネットワークまたは "トンネル" を介して物理ネットワークインフラストラクチャを走査します。 上記の例では、トンネルは、左側のソースホストから右側の送信先ホストに配信される、Contoso と Fabrikam のデータパケットの周囲の "エンベロープ" と考えることができます (PA アドレス)。 重要なのは、ホストが、Contoso と Fabrikam の CA に対応する "出荷先住所" (PA) を決定する方法、パケットの周囲に "エンベロープ" を配置する方法、および宛先ホストがパケットのラップを解除して Contoso と Fabrikam に配信する方法を決定する方法です。接続先の仮想マシンは正しくありません。  

この簡単な例では、次のようなネットワーク仮想化の主要な側面に焦点を当てました。  

-   各仮想マシンの CA は物理ホストの PA にマップされます。 同じ PA に関連付けられた複数の CA が存在する場合があります。  

-   仮想マシンは CA 空間内のデータパケットを送信します。これは、マッピングに基づいて PA ソースと宛先のペアを含む "エンベロープ" に入れられます。  

-   CA と PA のマッピングでは、ホストがさまざまなカスタマー仮想マシン宛てのパケットを区別できるようにする必要があります。  

そのため、ネットワークを仮想化するメカニズムは、仮想マシンで使用されるネットワーク アドレスを仮想化することになります。 ネットワークコントローラーはアドレスマッピングを担当し、ホストエージェントは MS_VTEP スキーマを使用してマッピングデータベースを管理します。 次のセクションでは、実際のアドレス仮想化メカニズムについて説明します。  

## <a name="network-virtualization-through-address-virtualization"></a>アドレス仮想化によるネットワーク仮想化  
HNV は、ネットワーク仮想化汎用ルーティングカプセル化 (NVGRE) または仮想拡張可能なローカルエリアネットワーク (VXLAN) のいずれかを使用して、オーバーレイテナントネットワークを実装します。  既定値は VXLAN です。  

### <a name="virtual-extensible-local-area-network-vxlan"></a>仮想拡張可能なローカルエリアネットワーク (VXLAN)  
仮想拡張可能なローカルエリアネットワーク (VXLAN) ([RFC 7348](https://www.rfc-editor.org/info/rfc7348)) プロトコルは、Cisco、Brocade、arista、DELL、HP などのベンダーからのサポートを通じて、マーケットプレースで広く採用されています。 VXLAN プロトコルでは、トランスポートとして UDP が使用されます。 VXLAN の IANA 割り当て UDP 宛先ポートは4789であり、UDP 発信元ポートは ECMP 拡散に使用される内部パケットからの情報のハッシュである必要があります。 UDP ヘッダーの後に、VXLAN ヘッダーがパケットに追加されます。これには、予約済みの4バイトのフィールドの後に、VXLAN ネットワーク識別子 (VNI) の3バイトのフィールドが続き、その後に別の予約済み1バイトフィールドが続きます。 VXLAN ヘッダーの後に、元の CA L2 フレーム (CA イーサネットフレームの FC を使用しない) が追加されます。  

![VXLAN packet ヘッダー](../../../media/hyper-v-network-virtualization-technical-details-in-windows-server/VXLAN-packet-header.png)  

### <a name="generic-routing-encapsulation-nvgre"></a>汎用ルーティングカプセル化 (NVGRE)  
このネットワーク仮想化メカニズムでは、汎用ルーティングカプセル化 (NVGRE) をトンネルヘッダーの一部として使用します。 NVGRE では、仮想マシンのパケットは別のパケット内にカプセル化されます。 この新しいパケットのヘッダーには、図 7 に示すように、GRE ヘッダーのキー フィールドに格納される仮想サブネット ID に加えて、該当する送信元と送信先の PA IP アドレスが格納されます。  

![NVGRE カプセル化](../../../media/hyper-v-network-virtualization-technical-details-in-windows-server/VNetF3.gif)  

図 7: ネットワーク仮想化 - NVGRE カプセル化  

仮想サブネット ID を使用すると、ホストは、パケット上の PA と CA が重複する場合でも、特定のパケットに対して顧客の仮想マシンを識別できます。 これにより、図 7 に示すように、同じホスト上のすべての仮想マシンが単一の PA を共有できます。  

PA の共有はネットワークのスケーラビリティに大きく影響します。 ネットワーク インフラストラクチャに覚えさせる必要がある IP アドレスと MAC アドレスの数を大幅に削減できます。 たとえば、すべてのエンド ホストに平均 30 個の仮想マシンがある場合、ネットワーク インフラストラクチャに覚えさせる必要がある IP アドレスと MAC アドレスの数は 30 の倍数だけ減少します。また、パケットに埋め込まれた仮想サブネット ID により、パケットを実際の顧客に簡単に関連付けることも可能になります。  

Windows Server 2012 R2 の PA 共有スキームは、ホストごとに VSID ごとに1つの PA です。 Windows Server 2016 のスキームは、NIC チームメンバーごとに1つの PA です。  

Windows Server 2016 以降では、HNV はそのままの状態で NVGRE と VXLAN を完全にサポートしています。Nic (ネットワークアダプター)、スイッチ、ルーターなどの新しいネットワークハードウェアをアップグレードまたは購入する必要はありません。 これは、ネットワーク上のこれらのパケットが、現在のネットワークインフラストラクチャと互換性のある PA 空間内の通常の IP パケットであるためです。  ただし、最適なパフォーマンスを得るには、タスクのオフロードをサポートする最新のドライバーでサポートされている Nic を使用します。  

## <a name="multi-tenant-deployment-example"></a>マルチテナント展開の例  
次の図は、ネットワークポリシーで CA と PA の関係が定義されているクラウドデータセンターにある2つの顧客の展開例を示しています。  

![マルチテナント展開の例](../../../media/hyper-v-network-virtualization-technical-details-in-windows-server/VNetF5.png)  

図 8: マルチテナント展開の例  

図 8 の例を考えてみます。 ホスティング プロバイダーの共有 IaaS サービスに移行する前は、次のようになっています。  

-   Contoso Corp は、**SQL** という名前の SQL Server を IP アドレス 10.1.1.11 で運用し、その SQL Server をデータベース トランザクションに使用していた **Web** という名前の Web サーバーを IP アドレス 10.1.1.12 で運用していました。  

-   Fabrikam Corp も、**SQL** という名前の SQL Server を IP アドレス 10.1.1.11 で運用し、その SQL Server をデータベース トランザクションに使用していた **Web** という名前の Web サーバーを IP アドレス 10.1.1.12 で運用していました。  

ホスティングサービスプロバイダーは、物理ネットワークトポロジに対応するために、ネットワークコントローラーを介してプロバイダー (PA) 論理ネットワークを事前に作成していることを前提としています。 ネットワークコントローラーは、ホストが接続されている論理サブネットの IP プレフィックスから2つの PA IP アドレスを割り当てます。 ネットワークコントローラーは、IP アドレスを適用するための適切な VLAN タグも示します。  

ネットワークコントローラー (Contoso Corp と Fabrikam Corp) を使用して、ホスティングサービスプロバイダーによって指定されたプロバイダー (PA) 論理ネットワークによって支えられている仮想ネットワークとサブネットを作成します。 Contoso Corp と Fabrikam Corp は、それぞれの SQL Server と Web サーバーを、同じホスティング プロバイダーの共有 IaaS サービスに移動し、偶然にも **SQL** 仮想マシンを Hyper-V ホスト 1 で、 **Web** (IIS7) 仮想マシンを Hyper-V ホスト 2 で運用します。 すべての仮想マシンには、元のイントラネット IP アドレス (各社の CA) が保たれます。  

両方の企業には、次に示すように、ネットワークコントローラーによって次の仮想サブネット ID (VSID) が割り当てられています。  各 Hyper-v ホスト上のホストエージェントは、割り当てられた PA IP アドレスをネットワークコントローラーから受け取り、既定以外のネットワークコンパートメントに2つの PA ホスト vNICs を作成します。 次に示すように、PA IP アドレスが割り当てられている各ホスト vNICs には、ネットワークインターフェイスが割り当てられます。  

-   Contoso Corp の仮想マシンの VSID と PAs:**VSID**は5001、 **SQL pa**は192.168.1.10、 **Web pa**は192.168.2.20  

-   Fabrikam Corp の仮想マシンの VSID と PAs:**VSID**は6001、 **SQL pa**は192.168.1.10、 **Web pa**は192.168.2.20  

ネットワークコントローラーは、(行いを含む) すべてのネットワークポリシーを SDN ホストエージェントに対して実行します。これにより、永続的なストア (データベーステーブル) にポリシーが保持されます。  

Hyper-v Host 2 の Contoso Corp Web 仮想マシン (10.1.1.12) が、10.1.1.11 の SQL Server への TCP 接続を作成すると、次のような結果になります。  

-   10.1.1.11 の宛先 MAC アドレスの VM ARPs  

-   VSwitch の VFP 拡張機能は、このパケットをインターセプトして SDN ホストエージェントに送信します。  

-   SDN ホストエージェントは、10.1.1.11 の MAC アドレスのポリシーストアを検索します。  

-   MAC が検出された場合、ホストエージェントは VM に ARP 応答を挿入します。  

-   MAC が見つからない場合、応答は送信されず、10.1.1.11 用の VM の ARP エントリは到達不能としてマークされます。  

-   VM は、正しい CA イーサネットと IP ヘッダーを使用して TCP パケットを構築し、vSwitch に送信するようになりました。  

-   VSwitch の VFP 転送拡張機能は、パケットが受信されたソース vSwitch ポートに割り当てられている VFP レイヤーを介してこのパケットを処理し、VFP 統合フローテーブルに新しいフローエントリを作成します。  

-   VFP エンジンは、IP およびイーサネットのヘッダーに基づいて、各レイヤー (例: 仮想ネットワークレイヤー) に対してルール一致またはフローテーブル検索を実行します。  

-   仮想ネットワークレイヤー内の一致するルールは、CA PA マッピング領域を参照し、カプセル化を実行します。  

-   カプセル化の種類 (VXLAN または NVGRE) は、VSID と共に VNet 層で指定されます。  

-   VXLAN カプセル化の場合、外部 UDP ヘッダーは VXLAN ヘッダーの5001の VSID を使用して構築されます。  
    外部 IP ヘッダーは、SDN ホストエージェントのポリシーストアに基づいて、Hyper-v Host 2 (192.168.2.20) と Hyper-v Host 1 (192.168.1.10) に割り当てられた送信元と送信先の PA アドレスを使用して作成されます。  

-   このパケットは、VFP の PA ルーティング層に送られます。  

-   VFP の PA ルーティングレイヤーは、PA スペーストラフィックと VLAN ID に使用されるネットワークコンパートメントを参照し、ホストの TCP/IP スタックを使用して PA パケットを Hyper-v ホスト1に正しく転送します。  

-   カプセル化されたパケットを受信すると、Hyper-v ホスト1は PA ネットワークコンパートメント内のパケットを受信して vSwitch に転送します。  

-   VFP は、VFP レイヤーを介してパケットを処理し、VFP 統合フローテーブルに新しいフローエントリを作成します。  

-   VFP エンジンは、仮想ネットワーク層の ingres 規則と一致し、外側のカプセル化されたパケットのイーサネット、IP、および VXLAN ヘッダーを除去します。  

-   次に、VFP エンジンは、宛先 VM が接続されている vSwitch ポートにパケットを転送します。  

同様のプロセスが、Fabrikam Corp の **Web** 仮想マシンと **SQL** 仮想マシン間のトラフィックで生じる場合には、Fabrikam Corp の HNV ポリシー設定が使用されます。その結果、Fabrikam Corp の仮想マシンと Contoso Corp の仮想マシンは、HNV により、それぞれの元のイントラネット上に存在するかのように振る舞います。 同じ IP アドレスを使用していても、決して干渉し合うことはありません。  

個別のアドレス (Ca と PAs)、Hyper-v ホストのポリシー設定、および CA と受信および送信の仮想マシントラフィックの PA との間のアドレス変換によって、NVGRE キーまたは VLXAN VNID を使用してこれらのサーバーセットが分離されます。 さらに、仮想化のマッピングと変換により、仮想ネットワーク アーキテクチャが物理ネットワーク インフラストラクチャから切り離されます。 Contoso の **SQL** および **Web** と Fabrikam の **SQL** および **Web** は独自の CA IP サブネット (10.1.1/24) 内にありますが、それぞれの物理的な展開は異なる PA サブネット (Contoso は 192.168.1/24、Fabrikam は 192.168.2/24) 内の 2 台のホスト上で行われます。 つまり、HNV では、サブネット間での仮想マシンのプロビジョニングとライブ マイグレーションが可能になります。  

## <a name="hyper-v-network-virtualization-architecture"></a>Hyper-V ネットワーク仮想化のアーキテクチャ  
Windows Server 2016 では、HNVv2 は Azure 仮想フィルタリングプラットフォーム (VFP) を使用して実装されます。これは、Hyper-v スイッチ内の NDIS フィルター拡張機能です。 VFP の主な概念は、ネットワークポリシーをプログラミングするために SDN ホストエージェントに公開される内部 API を使用した、一致アクションフローエンジンの概念です。 SDN ホストエージェント自体は、SouthBound と WCF の通信チャネルを介してネットワークコントローラーからネットワークポリシーを受け取ります。 VFP を使用してプログラミングされた仮想ネットワークポリシー (例: CA PA マッピング) だけでなく、Acl や QoS などの追加のポリシーもあります。  

VSwitch と VFP 転送拡張機能のオブジェクト階層は次のとおりです。  

-   vSwitch  

    -   外部 NIC 管理  

    -   NIC ハードウェアのオフロード  

    -   グローバル転送ルール  

    -   Port  

        -   ヘアピン留めの送信転送レイヤー  

        -   マッピングと NAT プールのスペース一覧  

        -   統合フローテーブル  

        -   VFP レイヤー  

            -   フローテーブル  

            -   グループ  

            -   Rule  

                -   ルールはスペースを参照できます  

VFP では、レイヤーはポリシーの種類 (Virtual Network など) ごとに作成され、ルール/フローテーブルの汎用セットになります。 このような機能を実装するために特定のルールがそのレイヤーに割り当てられるまでは、組み込みの機能はありません。 各レイヤーには優先順位が割り当てられ、レイヤーは優先順位の昇順でポートに割り当てられます。 ルールは、主に方向と IP アドレスファミリに基づいてグループ化されます。 また、グループには優先順位が割り当てられ、グループ内の1つのルールが特定のフローに一致することができます。  

VFP 拡張機能を使用した vSwitch の転送ロジックは次のとおりです。  

-   受信処理 (ポートに着信するパケットの観点から受信)  

-   ルーティング  

-   送信処理 (ポートから出るパケットの観点から送信)  

VFP は、NVGRE と VXLAN のカプセル化の種類の内部 MAC 転送だけでなく、MAC VLAN ベースの外部転送もサポートしています。  

VFP 拡張機能には、パケットトラバーサルの低速パスと高速パスがあります。 フロー内の最初のパケットは、各層のすべてのルールグループを走査し、負荷の高い操作であるルール参照を実行する必要があります。 ただし、(一致した規則に基づいて) アクションのリストを使用してフローが統合フローテーブルに登録されると、それ以降のすべてのパケットは、統合フローテーブルのエントリに基づいて処理されます。  

HNV ポリシーは、ホストエージェントによってプログラミングされます。 各仮想マシンネットワークアダプターは、IPv4 アドレスで構成されます。 これらは仮想マシンが相互通信に使用する CA で、仮想マシンから IP パケットで伝送されます。 HNV は、ホストエージェントのデータベースに格納されているネットワーク仮想化ポリシーに基づいて、PA フレームに CA フレームをカプセル化します。  

![HNV のアーキテクチャ](../../../media/hyper-v-network-virtualization-technical-details-in-windows-server/VNetF7.png)  

図 9:HNV のアーキテクチャ  

## <a name="summary"></a>まとめ  
クラウド ベースのデータセンターは、スケーラビリティの向上やリソース使用効率の改善など多数のメリットを提供します。 これらの潜在的メリットを実現するには、動的環境におけるマルチテナントのスケーラビリティの問題を根本的に解決するテクノロジが必要です。 HNV は、こうした問題を解決し、また物理ネットワーク トポロジに対して仮想ネットワーク トポロジを分離することによりデータセンターの運用効率を向上させるように設計されました。 既存の標準に基づいて構築された HNV は現在のデータセンターで実行され、既存の VXLAN インフラストラクチャで動作します。 HNV をご利用のお客様は、データセンターをプライベートクラウドに統合したり、ハイブリッドクラウドを使用してデータセンターをホスティングサーバープロバイダーの環境にシームレスに拡張したりできます。  

## <a name="BKMK_LINKS"></a>関連項目  
HNVv2 の詳細については、次のリンクを参照してください。  


|       コンテンツの種類       |                                                                                                                                              リファレンス                                                                                                                                              |
|--------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **コミュニティリソース**  |                                                                -   [プライベートクラウドアーキテクチャのブログ](https://blogs.technet.com/b/privatecloud)<br />-Ask 質問: [cloudnetfb@microsoft.com](mailto:%20cloudnetfb@microsoft.com)                                                                |
|         **RFC**          |                                                                   -   [Nvgre ドラフト RFC](https://www.ietf.org/id/draft-sridharan-virtualization-nvgre-07.txt)<br />-   [VXLAN-RFC 7348](https://www.rfc-editor.org/info/rfc7348)                                                                    |
| **関連テクノロジ** | -Windows Server 2012 R2 での Hyper-v ネットワーク仮想化の技術的な詳細については、「 [Hyper-v ネットワーク仮想化の技術的な詳細](https://technet.microsoft.com/library/jj134174.aspx)」を参照してください。<br />-   [ネットワークコントローラー](../../../sdn/technologies/network-controller/Network-Controller.md) |

