---
title: RAS ゲートウェイの高可用性
description: このトピックでは、Windows Server 2016 のソフトウェア定義ネットワーク (SDN) 用の RAS マルチテナントゲートウェイの高可用性構成について説明します。
manager: grcusanz
ms.prod: windows-server
ms.technology: networking-sdn
ms.topic: get-started-article
ms.assetid: 34d826c9-65bc-401f-889d-cf84e12f0144
ms.author: anpaul
author: AnirbanPaul
ms.openlocfilehash: 774f0f4299bb5acbe7314080dd1314f74574d16d
ms.sourcegitcommit: b00d7c8968c4adc8f699dbee694afe6ed36bc9de
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 04/08/2020
ms.locfileid: "80859615"
---
# <a name="ras-gateway-high-availability"></a>RAS ゲートウェイの高可用性

>適用対象: Windows Server (半期チャネル)、Windows Server 2016

このトピックでは、ソフトウェア定義ネットワーク (SDN) 用の RAS マルチテナントゲートウェイの高可用性構成について説明します。  
  
このトピックの内容は次のとおりです。  
  
-   [RAS ゲートウェイの概要](#bkmk_overview)  
  
-   [ゲートウェイプールの概要](#bkmk_pools)  
  
-   [RAS ゲートウェイの展開の概要](#bkmk_deployment)  
  
-   [RAS ゲートウェイとネットワークコントローラーの統合](#bkmk_integration)  
  
## <a name="ras-gateway-overview"></a><a name="bkmk_overview"></a>RAS ゲートウェイの概要  
組織が複数のテナントを持つクラウドサービスプロバイダー (CSP) またはエンタープライズの場合は、マルチテナントモードで RAS ゲートウェイを展開して、インターネットを含む仮想ネットワークと物理ネットワークとの間でネットワークトラフィックをルーティングすることができます。  
  
テナントの顧客ネットワークトラフィックをテナントの仮想ネットワークとリソースにルーティングするために、エッジゲートウェイとして RAS ゲートウェイをマルチテナントモードで展開できます。  
  
高可用性とフェールオーバーを提供する RAS ゲートウェイ Vm の複数のインスタンスを展開する場合は、ゲートウェイプールをデプロイします。 Windows Server 2012 R2 では、すべてのゲートウェイ Vm で1つのプールが形成されており、これにより、ゲートウェイの展開の論理的な分離が少し困難になりました。  Windows Server 2012 R2 ゲートウェイでは、ゲートウェイ Vm に対して1:1 冗長デプロイが提供されており、これにより、サイト間 (S2S) VPN 接続で使用可能な容量が使用率が低い状態になりました。  
  
この問題は、複数のゲートウェイプールを提供する Windows Server 2016 で解決されます。これは、論理的に分離するために異なる種類にすることができます。 新しいモードである M + N 冗長性を使用すると、より効率的なフェールオーバー構成が可能になります。  
  
RAS ゲートウェイの概要については、「 [Ras gateway](../../../../remote/remote-access/ras-gateway/RAS-Gateway.md)」を参照してください。  
  
## <a name="gateway-pools-overview"></a><a name="bkmk_pools"></a>ゲートウェイプールの概要  
Windows Server 2016 では、1つまたは複数のプールにゲートウェイを展開できます。  
  
次の図は、仮想ネットワーク間のトラフィックルーティングを提供するさまざまな種類のゲートウェイプールを示しています。  
  
![RAS ゲートウェイプール](../../../media/RAS-Gateway-High-Availability/ras_pools.png)  
  
各プールには、次のプロパティがあります。  
  
-   各プールは M + N 冗長です。 これは、"m" 個のアクティブなゲートウェイ Vm が、"N" 個のスタンバイゲートウェイ Vm によってバックアップされることを意味します。 N (スタンバイゲートウェイ) の値は、常に M (アクティブゲートウェイ) 以下です。  
  
-   プールは、個々のゲートウェイ機能 (インターネットキー交換バージョン 2 (IKEv2) S2S、レイヤー 3 (L3)、および汎用ルーティングカプセル化 (GRE) を実行できます。また、プールはこれらのすべての機能を実行できます。  
  
-   すべてのプールまたはプールのサブセットに1つのパブリック IP アドレスを割り当てることができます。 これにより、すべてのテナントが単一の IP アドレスでクラウドに接続する可能性があるため、使用する必要があるパブリック IP アドレスの数が大幅に削減されます。 高可用性と負荷分散に関する以下のセクションでは、そのしくみについて説明します。  
  
-   プール内のゲートウェイ Vm を追加または削除することで、ゲートウェイプールを簡単にスケールアップまたはスケールダウンできます。 ゲートウェイを削除または追加しても、プールによって提供されるサービスは中断されません。 また、ゲートウェイのプール全体を追加および削除することもできます。  
  
-   1つのテナントの接続は、プール内の複数のプールと複数のゲートウェイで終了できます。 ただし、テナントが**すべて**の種類のゲートウェイプールで終了する接続を保持している場合、他の**すべて**の種類のゲートウェイプールや個別の種類のゲートウェイプールにサブスクライブすることはできません。  
  
ゲートウェイプールでは、追加のシナリオを可能にする柔軟性も提供されます。  
  
-   シングルテナントプール-1 つのテナントで使用するプールを1つ作成できます。  
  
-   パートナー (再販業者) チャネルを通じてクラウドサービスを販売している場合は、リセラーごとに個別のプールセットを作成できます。  
  
-   複数のプールで同じゲートウェイ機能を提供できますが、容量は異なります。 たとえば、高スループットと低スループットの IKEv2 S2S 接続の両方をサポートするゲートウェイプールを作成できます。  
  
## <a name="ras-gateway-deployment-overview"></a><a name="bkmk_deployment"></a>RAS ゲートウェイの展開の概要  
次の図は、RAS ゲートウェイの一般的なクラウドサービスプロバイダー (CSP) の展開を示しています。  
  
![RAS ゲートウェイの展開の概要](../../../media/RAS-Gateway-High-Availability/ras_csp_deploy.png)  
  
この種類の展開では、ゲートウェイプールはソフトウェア Load Balancer (SLB) の背後に展開されます。これにより、CSP はデプロイ全体に1つのパブリック IP アドレスを割り当てることができます。 テナントの複数のゲートウェイ接続は、複数のゲートウェイプールで終了でき、プール内の複数のゲートウェイでも終了できます。 これは、上の図の IKEv2 S2S 接続で示されていますが、同様に、L3 や GRE ゲートウェイなどの他のゲートウェイ機能にも適用できます。  
  
この図では、MT BGP デバイスは、BGP を使用する RAS マルチテナントゲートウェイです。 マルチテナント BGP は動的ルーティングに使用されます。 テナントのルーティングは集中管理されています。ルートリフレクター (RR) と呼ばれる単一のポイントは、すべてのテナントサイトの BGP ピアリングを処理します。 RR 自体は、プール内のすべてのゲートウェイに分散されます。 この結果、テナント (データパス) の接続が複数のゲートウェイで終了しても、テナント (BGP ピアリングポイント制御パス) の RR はゲートウェイの1つのみになります。  
  
この集中化されたルーティングの概念を図示するために、BGP ルーターは図で区切られています。 ゲートウェイの BGP 実装は、転送ルーティングも提供します。これにより、クラウドは2つのテナントサイト間でルーティングを行うための転送ポイントとして機能できます。 これらの BGP 機能は、すべてのゲートウェイ機能に適用されます。  
  
## <a name="ras-gateway-integration-with-network-controller"></a><a name="bkmk_integration"></a>RAS ゲートウェイとネットワークコントローラーの統合  
RAS ゲートウェイは、Windows Server 2016 のネットワークコントローラーと完全に統合されています。 RAS ゲートウェイとネットワークコントローラーが展開されると、ネットワークコントローラーは次の機能を実行します。  
  
-   ゲートウェイプールの展開  
  
-   各ゲートウェイでのテナント接続の構成  
  
-   ゲートウェイで障害が発生した場合にネットワークトラフィックフローをスタンバイゲートウェイに切り替える  
  
次のセクションでは、RAS ゲートウェイとネットワークコントローラーの詳細について説明します。  
  
-   [ゲートウェイ接続 (IKEv2、L3、GRE) のプロビジョニングと負荷分散](#bkmk_provisioning)  
  
-   [IKEv2 S2S の高可用性](#bkmk_ike)  
  
-   [GRE の高可用性](#bkmk_gre)  
  
-   [L3 転送ゲートウェイの高可用性](#bkmk_l3)  
  
### <a name="provisioning-and-load-balancing-of-gateway-connections-ikev2-l3-and-gre"></a><a name="bkmk_provisioning"></a>ゲートウェイ接続 (IKEv2、L3、GRE) のプロビジョニングと負荷分散  
テナントがゲートウェイ接続を要求すると、ネットワークコントローラーに要求が送信されます。 ネットワークコントローラーは、すべてのゲートウェイプールに関する情報を使用して構成されます。各プールの容量やすべてのプールのすべてのゲートウェイが含まれます。 ネットワークコントローラーは、接続に適したプールとゲートウェイを選択します。 この選択は、接続の帯域幅の要件に基づいています。 ネットワークコントローラーは、"最適" アルゴリズムを使用して、プール内の接続を効率的に選択します。 この接続の BGP ピアリングポイントは、この時点でテナントの最初の接続である場合にも指定されます。  
  
ネットワークコントローラーが接続用の RAS ゲートウェイを選択すると、ネットワークコントローラーはゲートウェイでの接続に必要な構成をプロビジョニングします。 接続が IKEv2 S2S 接続の場合は、ネットワークコントローラーによって、SLB プールにネットワークアドレス変換 (NAT) 規則もプロビジョニングされます。SLB プールのこの NAT 規則は、テナントから指定されたゲートウェイへの接続要求を送信します。 テナントは、一意であると予想されるソース IP によって区別されます。  
  
> [!NOTE]  
> L3 および GRE 接続は SLB をバイパスし、指定された RAS ゲートウェイに直接接続します。  これらの接続では、リモートエンドポイントルーター (または他のサードパーティのデバイス) が RAS ゲートウェイと接続するように正しく構成されている必要があります。  
  
BGP ルーティングが接続に対して有効になっている場合、BGP ピアリングは RAS ゲートウェイによって開始され、ルートはオンプレミスとクラウドゲートウェイ間で交換されます。 BGP によって学習されたルート (BGP が使用されていない場合は静的に構成されたルート) は、ネットワークコントローラーに送信されます。 その後、ネットワークコントローラーは、テナント Vm がインストールされている Hyper-v ホストにルートを行いします。 この時点で、テナントトラフィックを適切なオンプレミスサイトにルーティングできます。 また、ネットワークコントローラーは、ゲートウェイの場所を指定する、関連付けられた Hyper-v ネットワーク仮想化ポリシーを作成し、Hyper-v ホストに行いします。  
  
### <a name="high-availability-for-ikev2-s2s"></a><a name="bkmk_ike"></a>IKEv2 S2S の高可用性  
プール内の RAS ゲートウェイは、異なるテナントの接続と BGP ピアリングの両方で構成されます。 すべてのプールには ' アクティブゲートウェイと ' N ' スタンバイゲートウェイがあります。  
  
ネットワークコントローラーは、次の方法でゲートウェイの障害を処理します。  
  
-   ネットワークコントローラーは、すべてのプールのゲートウェイに対して常に ping を実行し、障害が発生しているか失敗しているゲートウェイを検出できます。 ネットワークコントローラーは、次の種類の RAS ゲートウェイエラーを検出できます。  
  
    -   RAS ゲートウェイの VM エラー  
  
    -   RAS ゲートウェイが実行されている Hyper-v ホストの障害  
  
    -   RAS ゲートウェイサービスのエラー  
  
    ネットワークコントローラーは、デプロイされているすべてのアクティブなゲートウェイの構成を格納します。 構成は、接続設定とルーティング設定で構成されます。  
  
-   ゲートウェイで障害が発生すると、ゲートウェイ上のテナント接続だけでなく、他のゲートウェイに配置されているが、その RR が障害が発生したゲートウェイ上に存在するテナント接続にも影響します。 後者の接続のダウンタイムは、前者よりも小さくなっています。 ネットワークコントローラーは、障害が発生したゲートウェイを検出すると、次のタスクを実行します。  
  
    -   影響を受ける接続のルートをコンピューティングホストから削除します。  
  
    -   これらのホスト上の Hyper-v ネットワーク仮想化ポリシーを削除します。  
  
    -   スタンバイゲートウェイを選択し、アクティブなゲートウェイに変換して、ゲートウェイを構成します。  
  
    -   新しいゲートウェイへの接続をポイントするように、SLB プールの NAT マッピングを変更します。  
  
-   同時に、構成が新しいアクティブゲートウェイで起動すると、IKEv2 S2S 接続と BGP ピアリングが再確立されます。 接続と BGP ピアリングは、クラウドゲートウェイまたはオンプレミスゲートウェイのいずれかで開始できます。 ゲートウェイは、ルートを更新し、ネットワークコントローラーに送信します。 ネットワークコントローラーは、ゲートウェイによって検出された新しいルートを学習した後、ルートと関連付けられている Hyper-v ネットワーク仮想化ポリシーを、障害の影響を受けたテナントの Vm が存在する Hyper-v ホストに送信します。 このネットワークコントローラーの動作は、新しい接続設定の場合と似ていますが、これは大規模な環境でのみ発生します。  
  
### <a name="high-availability-for-gre"></a><a name="bkmk_gre"></a>GRE の高可用性  
ネットワークコントローラーによる RAS ゲートウェイのフェールオーバー応答 (障害検出、接続とルーティングの構成のスタンバイゲートウェイへのコピー、影響を受ける接続の BGP/静的ルーティングのフェールオーバー (コンピューティングホストと BGP の再ピアリングのルートの引き取りと再構成を含む)、およびコンピューティングホストでの Hyper-v ネットワーク仮想化ポリシーの再構成が含まれます。 ただし、GRE 接続の再確立は異なる動作をします。また、GRE の高可用性ソリューションには追加の要件があります。  
  
![GRE の高可用性](../../../media/RAS-Gateway-High-Availability/ras_ha.png)  
  
ゲートウェイの展開時に、すべての RAS ゲートウェイ VM に動的 IP アドレス (DIP) が割り当てられます。 さらに、すべてのゲートウェイ VM には、GRE 高可用性のための仮想 IP アドレス (VIP) も割り当てられています。 Vip は、gre 以外のプールではなく GRE 接続を受け入れることができるプール内のゲートウェイにのみ割り当てられます。 割り当てられた Vip は、BGP を使用してラック (TOR) スイッチの上位にアドバタイズされます。これにより、クラウド物理ネットワークに Vip がさらにアドバタイズされます。 これにより、ゲートウェイは、GRE 接続のもう一方の端が置かれているリモートルーターまたはサードパーティのデバイスから到達可能になります。 この BGP ピアリングは、テナントルートを交換するためのテナントレベルの BGP ピアリングとは異なります。  
  
GRE 接続プロビジョニングの時点で、ネットワークコントローラーはゲートウェイを選択し、選択したゲートウェイで GRE エンドポイントを構成し、割り当てられたゲートウェイの VIP アドレスを返します。 この VIP は、リモートルーター上の宛先 GRE トンネルアドレスとして構成されます。  
  
ゲートウェイに障害が発生すると、ネットワークコントローラーは、障害が発生したゲートウェイの VIP アドレスとその他の構成データをスタンバイゲートウェイにコピーします。 スタンバイゲートウェイは、アクティブになると、その TOR スイッチ、さらに物理ネットワークに VIP をアドバタイズします。 リモートルーターは GRE トンネルを同じ VIP に接続し続け、ルーティングインフラストラクチャによって、パケットが新しいアクティブなゲートウェイにルーティングされるようにします。  
  
### <a name="high-availability-for-l3-forwarding-gateways"></a><a name="bkmk_l3"></a>L3 転送ゲートウェイの高可用性  
Hyper-v ネットワーク仮想化 L3 転送ゲートウェイは、データセンター内の物理インフラストラクチャと Hyper-v ネットワーク仮想化クラウドの仮想化インフラストラクチャとの間の橋渡しをします。 マルチテナントの L3 転送ゲートウェイでは、テナントの物理ネットワークとの接続に、各テナントが独自の VLAN タグ論理ネットワークを使用します。  
  
新しいテナントが新しい L3 ゲートウェイを作成すると、ネットワークコントローラーゲートウェイ Service Manager は使用可能なゲートウェイ VM を選択し、高可用性カスタマーアドレス (CA) 空間 IP アドレス (テナントの VLAN タグが付けられた論理ネットワークから) を使用して、新しいテナントインターフェイスを構成します。). この IP アドレスは、リモート (物理ネットワーク) ゲートウェイのピア IP アドレスとして使用され、テナントの Hyper-v ネットワーク仮想化ネットワークに接続するための次ホップです。  
  
IPsec または GRE ネットワーク接続とは異なり、TOR スイッチはテナントの VLAN タグ付きネットワークを動的に学習しません。 エンドツーエンドの接続を確保するために、TOR スイッチと、物理インフラストラクチャとゲートウェイの間のすべての中間スイッチおよびルーターで、テナントのタグが付けられたネットワークのルーティングを構成する必要があります。  以下の図に示す CSP Virtual Network 構成の例を次に示します。  
  
|ネットワーク|［サブネット］|VLAN ID|既定のゲートウェイ|  
|-----------|----------|-----------|-------------------|  
|Contoso L3 論理ネットワーク|10.127.134.0/24|1001|10.127.134.1|  
|Woodgrove L3 論理ネットワーク|10.127.134.0/24|1002|10.127.134.1|  
  
次の図に示すように、テナントゲートウェイの構成例を次に示します。  
  
|テナント名|L3 ゲートウェイ IP アドレス|VLAN ID|ピア IP アドレス|  
|---------------|-------------------------|-----------|-------------------|  
|Contoso|10.127.134.50|1001|10.127.134.55|  
|社|10.127.134.60|1002|10.127.134.65|  
  
CSP データセンターでのこれらの構成の例を次に示します。  
  
![L3 転送ゲートウェイの高可用性](../../../media/RAS-Gateway-High-Availability/ras_fwdgw.png)  
  
L3 転送ゲートウェイのコンテキストでのゲートウェイのエラー、障害の検出、ゲートウェイのフェールオーバープロセスは、IKEv2 および GRE の RAS ゲートウェイのプロセスに似ています。 これらの違いは、外部 IP アドレスの処理方法にあります。  
  
ゲートウェイ VM の状態が異常になると、ネットワークコントローラーはプールからスタンバイゲートウェイの1つを選択し、スタンバイゲートウェイでネットワーク接続とルーティングを再プロビジョニングします。 接続の移動中に、L3 転送ゲートウェイの高可用性 CA スペースの IP アドレスも、テナントの CA 空間 BGP IP アドレスと共に新しいゲートウェイ VM に移動されます。  
  
L3 ピアリング IP アドレスはフェールオーバー中に新しいゲートウェイ VM に移動されるため、リモート物理インフラストラクチャは再びこの IP アドレスに接続し、その後 Hyper-v ネットワーク仮想化ワークロードにアクセスできるようになります。 BGP 動的ルーティングの場合、CA スペースの BGP IP アドレスが新しいゲートウェイ VM に移動されると、リモート BGP ルーターはピアリングを再確立し、すべての Hyper-v ネットワーク仮想化ルートを再度学習できます。  
  
> [!NOTE]  
> テナント通信用に VLAN のタグが付けられた論理ネットワークを使用するには、TOR スイッチとすべての中間ルーターを個別に構成する必要があります。 さらに、L3 フェールオーバーは、この方法で構成されているラックのみに制限されています。 このため、L3 ゲートウェイプールは慎重に構成する必要があり、手動による構成は個別に完了する必要があります。  
  


