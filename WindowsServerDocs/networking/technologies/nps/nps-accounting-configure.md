---
title: ネットワーク ポリシー サーバー アカウンティングを構成する
description: このトピックでは、Windows Server 2016 のネットワークポリシーサーバーのテキストファイルと SQL Server ログについて説明します。
manager: dougkim
ms.prod: windows-server
ms.technology: networking
ms.topic: article
ms.assetid: dfde2e21-f3d5-41e8-8492-cb3f0d028afb
ms.author: pashort
author: shortpatti
ms.date: 05/25/2018
ms.openlocfilehash: 0c154d4d4534f4c343107eecd158974b92903e39
ms.sourcegitcommit: 6aff3d88ff22ea141a6ea6572a5ad8dd6321f199
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 09/27/2019
ms.locfileid: "71405570"
---
# <a name="configure-network-policy-server-accounting"></a>ネットワーク ポリシー サーバー アカウンティングを構成する

ネットワークポリシーサーバー \(NPS\)には、次の3種類のログ記録があります。

- **イベントログ**。 主に、接続試行の監査とトラブルシューティングに使用されます。 Nps コンソールで nps のプロパティを取得して、NPS のイベントログを構成できます。

- **ユーザー認証およびアカウンティング要求をローカルファイルに記録**します。 主に、接続分析と課金のために使用されます。 また、セキュリティ調査ツールとしても役立ちます。これは、攻撃後に悪意のあるユーザーのアクティビティを追跡する方法を提供するためです。 ローカルファイルのログ記録は、アカウンティング構成ウィザードを使用して構成できます。

- **MICROSOFT SQL SERVER XML 準拠のデータベースに対するユーザー認証およびアカウンティング要求をログに記録**します。 NPS を実行する複数のサーバーが1つのデータソースを持つことができるようにするために使用します。 には、リレーショナルデータベースを使用する利点もあります。 SQL Server のログ記録は、アカウンティング構成ウィザードを使用して構成できます。

## <a name="use-the-accounting-configuration-wizard"></a>アカウンティング構成ウィザードの使用

アカウンティング構成ウィザードを使用すると、次の4つのアカウンティング設定を構成できます。

- **SQL ログのみ**。 この設定を使用すると、NPS が SQL Server に接続してアカウンティングデータを送信できるようにする、SQL Server へのデータリンクを構成できます。 また、データベースが NPS SQL Server ログと互換性があることを確認するために、SQL Server のデータベースを構成することもできます。
- **テキストログのみ**。 この設定を使用して、アカウンティングデータをテキストファイルに記録するように NPS を構成できます。
- **並列ログ**。 この設定を使用すると、SQL Server データリンクとデータベースを構成できます。 また、NPS がテキストファイルと SQL Server データベースに同時にログを記録するように、テキストファイルのログ記録を構成することもできます。 
- **バックアップを使用した SQL ログ**。 この設定を使用すると、SQL Server データリンクとデータベースを構成できます。 また、SQL Server のログ記録が失敗した場合に NPS が使用するテキストファイルのログ記録を構成することもできます。

これらの設定に加えて、SQL Server ログ記録とテキストログ記録の両方で、ログが失敗した場合に NPS が接続要求の処理を続行するかどうかを指定できます。 これは、アカウンティング構成ウィザードの実行中に、[ローカルファイルログのプロパティ]、[SQL server ログのプロパティ]、および [**ログエラーのアクション] セクション**で指定できます。

### <a name="to-run-the-accounting-configuration-wizard"></a>アカウンティング構成ウィザードを実行するには

アカウンティング構成ウィザードを実行するには、次の手順を実行します。

1. NPS コンソールまたは NPS Microsoft 管理コンソール (MMC) スナップインを開きます。
2. コンソールツリーで、 **[アカウンティング]** をクリックします。
3. 詳細ウィンドウの **[アカウンティング]** で、 **[アカウンティングの構成]** をクリックします。

## <a name="configure-nps-log-file-properties"></a>NPS のログファイルのプロパティを構成する

ネットワークポリシーサーバー (NPS) を構成して、ユーザー認証要求、アクセス許可メッセージ、アクセス拒否メッセージ、アカウンティング要求と応答、および定期的に、リモート認証ダイヤルインユーザーサービス (RADIUS) アカウンティングを実行することができます。状態の更新。 アカウンティングデータを格納するログファイルを構成するには、次の手順に従います。

ログファイルの解釈の詳細については、「 [NPS データベース形式のログファイルの解釈](https://technet.microsoft.com/library/cc771748.aspx)」を参照してください。

ログファイルによってハードドライブがいっぱいにならないようにするには、システムパーティションとは別のパーティションに保存することを強くお勧めします。 NPS のアカウンティングの構成の詳細については、次の情報を参照してください。

- コレクションのログファイルデータを別のプロセスで送信するには、名前付きパイプに書き込むように NPS を構成できます。 名前付きパイプを使用するには、ログファイルフォルダーを \\て .\pipe または \\ComputerName\pipe. に設定します。 名前付きパイプサーバープログラムは、データを受け入れるために \\.\pipe\iaslog.log という名前付きパイプを作成します。 [ローカルファイルのプロパティ] ダイアログボックスの [新しいログファイルの作成] で、名前付きパイプを使用する場合は [Never (ファイルサイズの制限なし)] を選択します。

- ログファイルディレクトリは、% systemdrive%、% systemroot%、% windir% などのシステム環境変数 (ユーザー変数ではなく) を使用して作成できます。 たとえば、次のパスでは、環境変数% windir% を使用して、サブフォルダー \System32\Logs (つまり、%windir%\System32\Logs\)のシステムディレクトリにあるログファイルを検索します。

- ログファイルの形式を切り替えると、新しいログが作成されません。 ログファイルの形式を変更すると、変更時にアクティブになっているファイルには、2つの形式が混在します (ログの先頭のレコードは前の形式になり、ログの末尾のレコードは新しい形式になります)。

- ハードディスクドライブがいっぱいになったことが原因で RADIUS アカウンティングが失敗した場合、NPS は接続要求の処理を停止し、ユーザーがネットワークリソースにアクセスできないようにします。

- NPS では、ローカルファイルに対して、またはその代わりに、Microsoft® SQL Server™データベースにログを記録することができます。

この手順を実行するには、 **Domain Admins**グループのメンバーシップが最低限必要です。


### <a name="to-configure-nps-log-file-properties"></a>NPS のログファイルのプロパティを構成するには

1. NPS コンソールまたは NPS Microsoft 管理コンソール (MMC) スナップインを開きます。
2. コンソールツリーで、 **[アカウンティング]** をクリックします。
3. 詳細ウィンドウの **[ログファイルのプロパティ]** で、 **[ログファイルのプロパティの変更]** をクリックします。 **[ログファイルのプロパティ]** ダイアログボックスが表示されます。
4. **[ログファイルのプロパティ]** の **[設定]** タブで、 **[次の情報をログ]** に記録する で、アカウンティングの目標を達成するために十分な情報を記録するように選択していることを確認します。 たとえば、ログでセッションの関連付けを完了する必要がある場合は、すべてのチェックボックスをオンにします。
5. ログファイルが何らかの理由でいっぱいになった場合や使用できない場合に、NPS でアクセス要求メッセージの処理を停止する場合は、[ログ**記録の失敗] アクション**で、[**ログ記録が失敗した場合、接続要求を破棄**する] を選択します。 ログが失敗した場合に NPS が接続要求の処理を続行する場合は、このチェックボックスをオンにしないでください。
6. **[ログファイルのプロパティ]** ダイアログボックスで、 **[ログファイル]** タブをクリックします。
7. **[ログファイル]** タブの **[ディレクトリ]** に、NPS ログファイルを格納する場所を入力します。 既定の場所は systemroot\System32\LogFiles フォルダーです。<br>**ログファイルディレクトリ**に完全なパスステートメントを指定しなかった場合は、既定のパスが使用されます。 たとえば、**ログファイルディレクトリ**に「 **npslogfile** 」と入力すると、ファイルは%systemroot%\System32\NPSLogFile. にあります。
8. **[形式]** で **[DTS 準拠]** をクリックします。 必要に応じて、代わりに従来のファイル形式 ( **ODBC \(従来の\)** や**IAS \(レガシ\)** など) を選択することもできます。<br>**ODBC**および**IAS**のレガシファイルの種類には、NPS が SQL Server データベースに送信する情報のサブセットが含まれています。 **DTS 準拠**ファイルの種類の xml 形式は、NPS が SQL Server データベースにデータをインポートするために使用する xml 形式と同じです。 このため、 **DTS 準拠**ファイル形式を使用すると、NPS の標準 SQL Server データベースにデータをより効率的かつ完全に転送できます。
9. [**新しいログファイルを作成**する] で、指定した間隔で新しいログファイルを開始するように NPS を構成するには、使用する間隔をクリックします。
    - トランザクション量とログ記録の量が多い場合は、 **[毎日]** をクリックします。
    - トランザクション量とログアクティビティが少ない場合は、 **[毎週]** または **[毎月]** をクリックします。
    - すべてのトランザクションを1つのログファイルに格納するには、[**ファイルサイズを無制限**にする] をクリックし\)\(します。
    - 各ログファイルのサイズを制限するには、 **[ログファイルがこのサイズに達したとき]** をクリックし、ファイルサイズを入力します。これにより、新しいログが作成されます。 既定のサイズは 10 mb です。
10. ハードディスクの容量が不足している場合に、NPS で古いログファイルを削除して新しいログファイル用のディスク領域を作成するには、[**ディスクがいっぱいになったときに古いログファイルを削除**する] が選択されていることを確認します。 ただし、このオプションは使用できません。ただし、 **[新しいログファイルを作成する]** の値が **[ファイルサイズの制限なし]** に \(ない場合は\)。 また、最も古いログファイルが現在のログファイルである場合は削除されません。

## <a name="configure-nps-sql-server-logging"></a>NPS SQL Server ログを構成する

次の手順を使用すると、Microsoft SQL Server を実行しているローカルまたはリモートのデータベースに RADIUS アカウンティングデータを記録できます。

>[!NOTE]
>NPS では、アカウンティングデータを、NPS で指定した SQL Server データベースの**report_event**ストアドプロシージャに送信する XML ドキュメントとして書式設定します。 SQL Server のログ記録を正常に機能させるには、NPS から XML ドキュメントを受信して解析できる**report_event**という名前のストアドプロシージャを SQL Server データベースに用意する必要があります。

この手順を実行するには、Domain Admins のメンバーシップ、またはそれと同等のメンバーシップが最低限必要です。

### <a name="to-configure-sql-server-logging-in-nps"></a>NPS で SQL Server ログを構成するには

1. NPS コンソールまたは NPS Microsoft 管理コンソール (MMC) スナップインを開きます。
2. コンソールツリーで、 **[アカウンティング]** をクリックします。
3. 詳細ウィンドウの SQL Server の **[ログプロパティ]** で、 **[SQL Server ログプロパティの変更]** をクリックします。 **[SQL Server ログのプロパティ]** ダイアログボックスが表示されます。
4. [**次の情報をログに記録**する] で、ログに記録する情報を選択します。 
    - すべてのアカウンティング要求をログに記録するには、 **[アカウンティング要求]** をクリックします。
    - 認証要求をログに記録するには、 **[認証要求]** をクリックします。
    - 定期的なアカウンティングの状態をログに記録するには、 **[定期的なアカウンティングの状態]** をクリックします。
    - 中間アカウンティング要求などの定期的な状態をログに記録するには、 **[定期的な状態]** をクリックします。
5. NPS を実行するサーバーと SQL Server の間に許可される同時セッションの数を構成するには、 **[同時セッションの最大数]** に数値を入力します。
6. SQL Server データソースを構成するには、 **[SQL Server のログ記録]** で **[構成]** をクリックします。 **[データリンクプロパティ]** ダイアログボックスが表示されます。 **[接続]** タブで、次のように指定します。 
    - データベースが格納されているサーバーの名前を指定するには、 **[サーバー名の選択または入力**] で名前を入力または選択します。
    - サーバーへのログオンに使用する認証方法を指定するには、[ **WINDOWS NT 統合セキュリティを使用**する] をクリックします。 または、 **[特定のユーザー名とパスワードを使用]** する をクリックし、 **[ユーザー名]** と **[パスワード]** に資格情報を入力します。
    - 空白のパスワードを許可するには、 **[空のパスワード]** をクリックします。
    - パスワードを保存するには、[**パスワードの保存を許可**する] をクリックします。
    - SQL Server を実行しているコンピューター上の接続先のデータベースを指定するには、[**サーバー上のデータベースを選択**する] をクリックし、一覧からデータベース名を選択します。
7. NPS と SQL Server の間の接続をテストするには、 **[接続テスト]** をクリックします。 **[OK]** をクリックして、**データリンクのプロパティ**を閉じます。
8. SQL Server のログ記録が失敗した場合に NPS でテキストファイルのログ記録を続行する場合は、[**エラーのログ**記録] アクションで [**フェールオーバーのテキストファイルのログ記録を有効に**する] を選択します。 
9. ログファイルが何らかの理由でいっぱいになった場合や使用できない場合に、NPS でアクセス要求メッセージの処理を停止する場合は、[ログ**記録の失敗] アクション**で、[**ログ記録が失敗した場合、接続要求を破棄**する] を選択します。 ログが失敗した場合に NPS が接続要求の処理を続行する場合は、このチェックボックスをオンにしないでください。

## <a name="ping-user-name"></a>Ping ユーザー名

一部の RADIUS プロキシサーバーとネットワークアクセスサーバーは、認証要求およびアカウンティング要求 (ping 要求と呼ばれます) を定期的に送信し、NPS がネットワーク上に存在することを確認します。 これらの ping 要求には、架空のユーザー名が含まれます。 NPS がこれらの要求を処理すると、イベントログとアカウンティングログにアクセス拒否レコードが格納され、有効なレコードを追跡することが難しくなります。

**Ping ユーザー名**のレジストリエントリを構成すると、NPS は、レジストリエントリの値を、他のサーバーからの ping 要求のユーザー名の値と照合します。 **Ping ユーザー名**レジストリエントリは、RADIUS プロキシサーバーおよびネットワークアクセスサーバーによって送信された架空のユーザー名 (または、架空のユーザー名と一致する変数を持つユーザー名パターン) を指定します。 NPS が**ping のユーザー名**レジストリエントリの値に一致する ping 要求を受信すると、nps は要求を処理せずに認証要求を拒否します。 NPS は、架空のユーザー名に関連するトランザクションをログファイルに記録しないため、イベントログの解釈が容易になります。

既定では **、ユーザー名の Ping**はインストールされません。 レジストリに**ping ユーザー名**を追加する必要があります。 レジストリエディターを使用して、レジストリにエントリを追加できます。

>[!CAUTION]
>レジストリを正しく編集しないと、システムが正常に動作しなくなる場合があります。 レジストリを変更する前に、コンピューター上の重要なデータのバックアップを作成する必要があります。

### <a name="to-add-ping-user-name-to-the-registry"></a>Ping ユーザー名をレジストリに追加するには

Ping ユーザー名は、ローカルの Administrators グループのメンバーが文字列値として次のレジストリキーに追加できます。

`HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services\IAS\Parameters`

- **名前**: `ping user-name`
- **種類**: `REG_SZ`
- **データ**:*ユーザー名*

>[!TIP]
>複数のユーザー名を**ping ユーザー名**の値として指定するには、ワイルドカード文字を含む DNS 名などの名前のパターンを**データ**に入力します。
