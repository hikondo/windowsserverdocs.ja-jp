---
title: ネットワーク アダプターのパフォーマンスを調整する
description: このトピックは、Windows Server 2016 のネットワークサブシステムのパフォーマンスチューニングガイドに含まれています。
ms.prod: windows-server
ms.technology: networking
ms.topic: article
ms.assetid: 0b9b0f80-415c-4f5e-8377-c09b51d9c5dd
manager: brianlic
ms.author: pashort
author: shortpatti
ms.openlocfilehash: e9c0ba73a1df874edc63001812d059a9e70f187f
ms.sourcegitcommit: 6aff3d88ff22ea141a6ea6572a5ad8dd6321f199
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 09/27/2019
ms.locfileid: "71405524"
---
# <a name="performance-tuning-network-adapters"></a>ネットワーク アダプターのパフォーマンスを調整する

>適用対象:Windows Server (半期チャネル)、Windows Server 2016

このトピックを使用して、Windows Server 2016 を実行しているコンピューターにインストールされているネットワークアダプターのパフォーマンスチューニングを行うことができます。

ネットワーク アダプターの正しい調整設定は、次の変動要素に応じて決まります。

- ネットワーク アダプターとその機能セット  

- サーバーが実行するワークロードの種類  

- サーバーのハードウェアとソフトウェアのリソース  

- サーバーのパフォーマンス目標  

ネットワーク アダプターに調整オプションがある場合、ネットワークのスループットとリソースの使用状況を最適化して、前述のパラメーターに基づいて最適なスループットを達成できます。  

以下のセクションでは、パフォーマンス チューニング オプションの一部について説明します。  

##  <a name="bkmk_offload"></a>オフロード機能の有効化

ネットワーク アダプターのオフロード機能の調整には、一般的にメリットがあります。 ただし、場合によっては、ネットワーク アダプターの処理能力が足りず、高いスループットでオフロード機能を処理できないことがあります。

>[!IMPORTANT]
>オフロード機能の**IPsec タスクオフ**ロードまたは**TCP chimney オフロード**を使用しないでください。 これらのテクノロジは Windows Server 2016 で非推奨とされており、サーバーとネットワークのパフォーマンスに悪影響を及ぼす可能性があります。 さらに、これらのテクノロジはマイクロソフトによって今後サポートされない可能性があります。

たとえば、セグメンテーション オフロードを有効にすると、ハードウェアのリソースが制限されているため、一部のネットワーク アダプターでは最大の持続的スループットが下がることがあります。 ただし、スループットの低下が制限と考えられない場合は、このような種類のネットワーク アダプターでも、オフロード機能を有効にすることをお勧めします。

>[!NOTE]
> 一部のネットワーク アダプターでは、送信パスと受信パスについて個別にオフロード機能を有効にする必要があります。

##  <a name="bkmk_rss_web"></a>Web サーバーの Receive Side Scaling (RSS) を有効にする

サーバーの論理プロセッサよりもネットワーク アダプター数が少ない場合、RSS で Web のスケーラビリティとパフォーマンスを改善できます。 すべての Web トラフィックが RSS 対応ネットワーク アダプターを経由する場合、異なる接続から送信された Web 要求を複数の CPU で同時に処理することができます。

Rss およびハイパーテキスト転送プロトコル\(HTTP\)のロジックによって負荷分散が発生していることが原因で、rss 対応ではないネットワークアダプターがを持つサーバーで web トラフィックを受け入れると、パフォーマンスが著しく低下する可能性があることに注意する必要があります。その他の RSS 対応ネットワークアダプター。 このような場合、RSS 対応ネットワーク アダプターを使用するか、ネットワーク アダプターのプロパティの **[詳細プロパティ]** タブで RSS を無効にすることをお勧めします。ネットワーク アダプターが RSS 対応かどうかを判断するには、ネットワーク アダプターのプロパティの **[詳細プロパティ]** タブの RSS 情報を確認します。

### <a name="rss-profiles-and-rss-queues"></a>RSS プロファイルと RSS キュー

既定の RSS 定義済みプロファイルは NUMA 静的で、以前のバージョンのオペレーティングシステムの既定の動作を変更します。 RSS プロファイルを初めて使用する場合は、使用できるプロファイルを確認すると、いつそれが役に立つか、また実際のネットワーク環境とハードウェアに適用する方法について理解できます。

たとえば、タスク マネージャーを開き、サーバーの論理プロセッサを確認し、受信トラフィックの使用率が低いと考えられる場合、RSS のキュー数を既定の 2 から、お使いのネットワーク アダプターでサポートされている最大値まで増やしてみることができます。 ネットワーク アダプターによっては、ドライバーの一部として RSS キュー数を変更するオプションがあります。

##  <a name="bkmk_resources"></a>ネットワークアダプターのリソースを増やす

受信バッファーや送信バッファーなど、リソースの手動構成が可能なネットワーク アダプターの場合、割り当てリソースを増やすことをお勧めします。 

ネットワーク アダプターによっては、受信バッファーを低く設定して、ホストから割り当てられるメモリを節約している場合があります。 値を低くすると、パケットが損失し、パフォーマンスが低下します。 そのため、受信量が多いシナリオの場合、受信バッファー値を最大値まで増やすことをお勧めします。

>[!NOTE]
>ネットワーク アダプターに手動リソース構成機能がない場合、リソースが動的に構成されるか、リソースが変更できない固定値に設定されています。

### <a name="enabling-interrupt-moderation"></a>割り込み節度を有効にする

一部のネットワーク アダプターには、割り込み節度を制御するために、複数の割り込み節度レベル、バッファー結合パラメーター (場合によっては送信バッファーと受信バッファーで別に設定)、またはその両方の機能があります。

CPU にバインドされたワークロードについて割り込み節度を考慮し、ホストの CPU の節約量と待機時間と、割り込みの増加と短い待機時間のためにホストの CPU の節約量が増えることとのトレードオフを考慮することをお勧めします。 ネットワーク アダプターが割り込み節度を実行せず、バッファーの結合機能がある場合、結合されるバッファー数を増やすことで、1 回の送信または受信あたりのバッファーが増え、パフォーマンスを改善することができます。

##  <a name="bkmk_low"></a>低待機時間パケット処理のパフォーマンスチューニング

多くのネットワーク アダプターには、オペレーティング システムが原因の待機時間を最適化するオプションがあります。 待機時間は、ネットワーク ドライバーが着信パケットを処理してから、ネットワーク ドライバーがパケットを返送するまでの経過時間です。 通常、この時間はマイクロ秒単位で測定されます。 比較のために、長距離でのパケット転送の伝送時間は通常、ミリ\(秒\)単位で測定されます。 この調整によって、パケットの送信にかかる時間は短縮されません。

次に、精度がマイクロ秒のネットワークのパフォーマンス チューニングをいくつか提案します。

- コンピューターの BIOS を、C 状態を無効にして **High Performance (高パフォーマンス)** に設定します。 この設定はシステムと BIOS によって変わる点に注意してください。一部のシステムは、オペレーティング システムが電源管理を制御している場合に、パフォーマンスが高くなります。 電源管理設定の確認と調整は、**設定**から行うことも、 **powercfg**コマンドを使用して行うこともできます。 詳細については、「 [Powercfg のコマンドラインオプション](https://technet.microsoft.com/library/cc748940.aspx)」を参照してください。

- オペレーティング システムの電源管理プロファイルを **高パフォーマンス** システムに設定します。 システムの BIOS で、オペレーティング システムの電源管理の制御が無効にされている場合、この設定は正しく機能しません。

- UDP チェックサム、TCP チェックサム、Send Large Offload (LSO) など、静的オフロードを有効にします。

- 大量のマルチキャストの受信など、トラフィックがマルチストリームされる場合、RSS を有効にします。

-   待機時間をできるだけ短くする必要があるネットワーク カード ドライバーの場合、**Interrupt Moderation (割り込み節度)** を無効にします。 ただし、無効にした場合は CPU 時間が増える可能性があります。これはトレードオフの問題になります。

- パケットを処理するプログラム (ユーザー スレッド) に使用されているコアと CPU キャッシュを共有しているコア プロセッサで、ネットワーク アダプターの割り込みと DPC を処理します。 CPU アフィニティの調整を使用してプロセスを特定の論理プロセッサに誘導し、RSS の構成と組み合わせて、この処理を実行することができます。 割り込み、DPC、ユーザー モード スレッドに同じコアを使用すると、コアの使用に関する ISR、DPC、およびスレッドが競合することで負荷が増えるため、パフォーマンスが低下します。

##  <a name="bkmk_smi"></a>システム管理の割り込み

多くのハードウェアシステムは、さまざま\(な\)メンテナンス機能に対して、システム管理の SMI を使用し\(ます\) 。これには、エラー修正コード ECC メモリエラーの報告、レガシ USB 互換性、ファンなどが含まれます。制御、および BIOS で制御される電源管理。 

SMI は、システムで最も優先度が高い割り込みであり、CPU は管理モードに切り替わります。この処理はその他すべてのアクティビティよりも先に実行され、通常は BIOS に含まれる割り込みサービス ルーチンを実行します。

残念ながら、SMI によって、待機時間は 100 マイクロ秒以上急上昇する可能性があります。 

待機時間を最小限にする必要がある場合は、SMI を可能な限り低く抑えることができる BIOS バージョンをハードウェア プロバイダーに問い合わせることをお勧めします。 多くの場合、このような BIOS は、"低待機時間 BIOS" や "SMI フリー BIOS" と呼ばれます。 場合によっては、SMI アクティビティが重要な機能 (冷却ファンなど) の制御に使用されているため、ハードウェア プラットフォームで SMI アクティビティを排除できない可能性があります。

>[!NOTE]
>論理プロセッサが特殊なメンテナンス モードで実行されており、オペレーティング システムが割り込みできないために、オペレーティング システムで SMI を制御できない場合があります。

##  <a name="bkmk_tcp"></a>TCP のパフォーマンスチューニング

 次の項目を使用して、TCP のパフォーマンスを調整することができます。

###  <a name="bkmk_tcp_params"></a>TCP 受信ウィンドウ自動チューニング

Windows Server 2008 より前では、ネットワークスタックは固定サイズの受信側ウィンドウ (65535 バイト) を使用しています。これにより、接続の総スループットが制限されていました。 TCP スタックの最も大きな変更点の 1 つは、TCP の受信ウィンドウの自動調整です。 

固定サイズの TCP 受信ウィンドウを使用する場合、1つの接続の合計スループットを計算するには、次のようにします。

**達成可能スループットの合計 (バイト単位) = TCP 受信\*ウィンドウサイズ (バイト単位) (1/接続の待機時間 (秒))**

たとえば、50% の待機時間\(がある接続では、達成可能なスループットの合計は 51 Mbps のみで、大規模な企業ネットワークインフラストラクチャ\)では妥当な価値があります。 

ただし、自動調整を使用すると、受信側ウィンドウが調整可能になり、送信側の要求に応じて増加する可能性があります。 接続は、1 Gbps 接続の完全な回線速度を実現することができます。 従来は TCP 接続の達成可能な合計スループットによって制限されていたネットワーク使用状況のシナリオで、ネットワークを完全に使用できるようになります。

#### <a name="deprecated-tcp-parameters"></a>非推奨の TCP パラメーター

Windows Server 2003 の次のレジストリ設定はサポートされなくなり、以降のバージョンでは無視されます。

これらの設定はすべて、次のレジストリの場所にありました。

    ```  
    HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services\Tcpip\Parameters  
    ```  

- TcpWindowSize

- NumTcbTablePartitions  

- MaxHashTableSize  



###  <a name="bkmk_wfp"></a>Windows フィルタリングプラットフォーム

Windows Vista および Windows Server 2008 で導入された Windows Filtering Platform (WFP) は、Microsoft 以外の独立系ソフトウェアベンダー (Isv) に Api を提供して、パケット処理フィルターを作成します。 たとえば、ファイアウォールとウイルス対策ソフトウェアが含まれています。

>[!NOTE]
>正しく記述されていない WFP フィルターを使用すると、サーバーのネットワークパフォーマンスが大幅に低下する可能性があります。 詳細については、Windows デベロッパーセンターの「[パケット処理ドライバーとアプリを WFP に移植する](https://msdn.microsoft.com/windows/hardware/gg463267.aspx)」を参照してください。


このガイドのすべてのトピックへのリンクについては、「[ネットワークサブシステムのパフォーマンスチューニング](net-sub-performance-top.md)」を参照してください。
