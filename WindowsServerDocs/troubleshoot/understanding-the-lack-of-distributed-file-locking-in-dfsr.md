---
title: DFSR での分散ファイル ロック (の欠如) について理解する
description: この記事では、Windows 内に複数ホストの分散ファイルロックメカニズムがないこと、特に、DFSR によってレプリケートされたフォルダー内に存在することについて説明します。
ms.date: 06/10/2020
author: Deland-Han
ms.author: delhan
ms.openlocfilehash: 4c04ed0f97f3f6192817121bc1bd67ea8fc73fdd
ms.sourcegitcommit: dfa48f77b751dbc34409aced628eb2f17c912f08
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/07/2020
ms.locfileid: "87965859"
---
# <a name="understanding-the-lack-of-distributed-file-locking-in-dfsr"></a>DFSR での分散ファイル ロック (の欠如) について理解する

この記事では、Windows 内に複数ホストの分散ファイルロックメカニズムがないこと、特に、DFSR によってレプリケートされたフォルダー内に存在することについて説明します。

## <a name="some-background"></a>背景

  - 分散ファイルロック–これは、複数のコンピューター上にファイルの複数のコピーを保持し、1つのファイルを書き込み用に開いたときに、他のすべてのコピーがロックされるという概念を意味します。 これにより、複数のユーザーが同時に複数のサーバーでファイルを変更できなくなります。
  - 分散ファイルシステムレプリケーション– [DFSR](/previous-versions/windows/desktop/dfsr/distributed-file-system-replication--dfsr-)は、マルチマスターの状態ベースの設計で動作します。 状態ベースのレプリケーションでは、マルチマスターシステム内の各サーバーは、ログファイルを交換せずに、受信時にレプリカに更新を適用します (代わりに、バージョンベクターを使用して最新の情報を保持します)。 初期同期後に、どのサーバーにも任意の権限があることがないため、さまざまなネットワークトポロジにおいて可用性が高く、非常に柔軟になります。
  - サーバーメッセージブロック- [SMB](/openspecs/windows_protocols/ms-smb/f210069c-7086-4dc2-885e-861d837df688)は、ネットワーク経由でファイルにアクセスするために Windows で使用される一般的なプロトコルです。 簡単に言うと、これは、リモートファイルシステムがローカルファイルシステムとして表示されるようにリダイレクターを利用するクライアントサーバープロトコルです。 これは Windows に固有のものではなく、よく知られています。マイクロソフト以外の一般的な例として、Linux、Mac、およびその他のオペレーティングシステムを SMB クライアント/サーバーとして機能させ、Windows ネットワークに参加させることができます。


レプリケートされたデータ環境で DFSR と SMB が有効になっている場所を明確に輪郭することが重要です。 SMB では、ユーザーはファイルにアクセスでき、DFSR は認識されません。 同様に、DFSR (RPC プロトコルを使用) では、サーバー間でファイルの同期が維持され、SMB は認識されません。 この投稿と[便宜的ロック](/windows/win32/fileio/opportunistic-locks)で定義されている分散ロックを混同しないでください。

では、次のようにします。この例では、そのようにします。

ユーザーは複数のサーバー上のデータを変更できるため、各 Windows サーバーはそれ自体のファイルロックのみを認識します。また、DFSR は、[他のサーバー上のロックについては何も](/previous-versions/windows/it-pro/windows-server-2003/cc773238(v=ws.10))認識*し*ないため、ユーザーが互いの変更を上書きできるようになります。 DFSR は "最後のライター優先" の競合アルゴリズムを使用するので、だれかが紛失し、最後に保存するユーザーが変更を保持する必要があります。 失われたファイルのコピーは、 *conflictanddeleted および preexisting*フォルダーに保存されます。

これは、信じられない人よりも*あまり一般的で*はありません。 通常、実際の共有ファイルはローカル環境で変更されます。ブランチオフィスまたはブースの同じ行にあります。 これらは通常、同じチームのユーザーによって作業されるので、ユーザーは通常、データを変更する仕事仲間を認識します。 これらは通常同じサイトにあるため、共有ドキュメントで作業しているすべてのユーザーが同じサーバーを使用することになります。 この状況は Windows SMB によって処理されます。 ユーザーがファイルを変更するためにロックしていて、同僚が編集を試みると、もう一方のユーザーには次のようなエラーが表示されます。

![使用中のファイル](./media/understanding-the-lack-of-distributed-file-locking-in-dfsr/1.jpg)

また、Word 2007 のように、ファイルを開いているアプリケーションが本当に巧妙なものであれば、次のようなことが考えられます。

![使用中のファイル](./media/understanding-the-lack-of-distributed-file-locking-in-dfsr/2.jpg)

DFSR は、ロックされたファイルのメカニズムを備えていますが、サーバー自体のコンテキスト内でのみ使用できます。 DFSR は、ローカルコピーに排他ロックがある場合に、ファイルをレプリケートしません。 ただし、別のサーバー上のユーザーがファイルを変更するのを防ぐことはできません。

トピックに戻ると、地理的に変更されている共有データの問題は存在しますが、一部の人にとって*は*非常に gnarly です。 場合によっては、DFSR によってこのロックが処理されず、マジック杖を使用してすべてを取得する必要があります。 これは、マルチマスターレプリケーションシステムを解決するための興味深く難しいシナリオです。 確認してみましょう。

## <a name="third-party-solutions"></a>サードパーティのソリューション

この問題については、次の1つまたは複数の方法を使用して実行されるベンダーソリューションがあり \* ます。

  - ブローカーメカニズムの使用

> 中央の "traffic cop" を使用すると、1つのサーバーが他のすべてのサーバーと、ユーザーによってロックされているファイルを認識できます。 また、これは、分散ロックシステムの単一障害点になることもあります。

![トポロジ](./media/understanding-the-lack-of-distributed-file-locking-in-dfsr/3.png)

  - 完全にルーティングされたネットワークの要件

> 中央ブローカーは、ファイルレプリケーションに参加しているすべてのサーバーと通信できる必要があるため、複雑なネットワークトポロジを処理する機能を排除します。 通常、リングトポロジおよびマルチハブとスポークのトポロジは使用できません。 完全にルーティングされていないネットワークでは、一部のサーバーが相互に直接通信できないか、または別のサーバーと通信できるパートナーだけが通信できる可能性があります。 これは、複数のマスター環境では問題ありませんが、ブローカメカニズムでは問題ありません。

![トポロジ](./media/understanding-the-lack-of-distributed-file-locking-in-dfsr/4.png)

  - サーバーのペアに限定されます。

> 一部のソリューションでは、分散ロックメカニズムを簡略化するためにトポロジをサーバーのペアに限定しています。 大規模な環境の場合、これは実現できない可能性があります。

  - クライアントとサーバーでエージェントを使用する
  - マルチマスターレプリケーションを使用しない
  - MS クラスタリングを使用しない
  - 専門のアプライアンスを活用する


***\*** 通常 \! は、これらのメソッドの1つ以上を実装しないソリューションを使用しているため、死亡脅威を投稿しないようにしてください。\!*

## <a name="deeper-thoughts"></a>より深い考え

この問題についてさらに検討すると、いくつかの基本的な問題がクリーンアップを開始します。 たとえば、4つのサイトのユーザーがデータを変更できる4台のサーバーがあり、そのうちの1つへの WAN 接続がオフラインになっている場合は、どうすればよいでしょうか。 ユーザーは引き続き個々のサーバーにアクセスできますが、許可する必要がありますか。 競合が生じないように変更する必要はありませんが、確実に作業を継続し、会社の資金を確保することをお勧めします。 その時点で変更をブロックした場合、実際に競合が発生していなくても、ユーザーは動作できません。\! ファイルが使用されていることを他のサーバーに知らせる方法はありません。1マス目に戻ります。

![トポロジ](./media/understanding-the-lack-of-distributed-file-locking-in-dfsr/5.png)

その後、SMB 自体と、レポートロックのエラー処理があります。 大量のアプリケーションを中断し、クライアントが新しい拡張エラーメッセージを理解していないため、SMB がどのように共有違反を報告するかを実際に変更することはできません。 Word 2007 のようなアプリケーションでは、ファイルをロックしているユーザーを特定するのは trickery ではありませんが、アプリケーションの大部分は、ファイルが使用されているユーザー (または SMB が存在するかどうか) を認識していません。 そうですね)。 このため、"このファイルは使用中です" というメッセージが表示された場合、特に問題になることはありません。ヘルプデスクに連絡してください。 ヘルプデスクは、どのユーザーがファイルにアクセスしているかを確認するために、すべてのファイルサーバーにアクセスできますか。 面倒.

高可用性を実現するためにマルチマスターが必要であるため、broker システムの方が好ましいとは言えません。すべてのサーバーで、完全にルーティングされていないネットワーク経由でも通信できるようにする必要がある場合があります。 これには、非常に複雑な同期手法が必要です。 これにより、ネットワークのオーバーヘッドが増加しますが (多くの場合はそうではありませんが)、ユーザーが作業をしていないことを確認するために高速である必要があります。ファイルレプリケーション自体を outrun する必要があります。実際には、レプリケーションを何らかの方法で結び付ける必要がある場合があります。 また、サーバーのクラッシュではなく、ネットワークに関連するサーバーの停止についても考慮する必要があります。

![トポロジ](./media/understanding-the-lack-of-distributed-file-locking-in-dfsr/6.png)

次に、ロックを理解しやすくするために、このシナリオの特別なクライアントソフトウェアに戻り、ユーザーに有用な情報を提供することができます (例、"外出中に、ファイルのロックのトポロジが壊れており、管理者が修正されるまでこのファイルを開けません。" など)。 これは、Windows で実行されている何百万ものアプリケーションで適切に動作するようにすることは、明らかに興味深いものです。 サポートされていない、またはソフトウェアを入手できない OS がたくさんあります。 Windows 2000 はメインストリームサポートされておらず、XP が間もなくリリースされます。 Linux および Mac クライアントは、重要であると感じられるまでこのソフトウェアを持っていません。そのため、お客様は、ベンダーがそれに似たものになるようにする必要があります。

## <a name="more-inforamtion"></a>その他の information

DFSR でこの状況を制御する最も簡単な方法は、DFS 名前空間を使用して、一貫性のある名前空間でユーザーを予測可能な場所に導くことです。 DFSN サイトトポロジとサーバーリンクを正しく構成することで、すべてのユーザーに同じローカルサーバーを共有させることができます。また、"メイン" サーバーがダウンしている場合にのみ、リモートコンピューターへのアクセスを許可します。 ほとんどの環境では、これは非常にうまく機能します。 DFSR の代わりに、SharePoint はチェックアウト/チェックインシステムのためのオプションです。 BranchCache (Windows Server 2008 R2 および Windows 7) は、ブランチシナリオでのファイルの読み取りを容易にするように設計されているため、選択肢として適していますが、その場合は、[ここ](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/jj127252(v=ws.11))で詳しく説明されているように、権限のあるデータは1つのサーバーでのみ有効です。 ここでも、これらのベンダーにはソリューションがあります。

