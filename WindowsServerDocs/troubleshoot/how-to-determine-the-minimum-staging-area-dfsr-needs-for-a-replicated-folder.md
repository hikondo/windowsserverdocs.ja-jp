---
title: DFSR で複製フォルダーに必要な最小ステージング領域を確認する方法
description: この記事は、DFSR が正常に機能するために必要な最小ステージング領域を計算する方法に関するクイックリファレンスガイドです。
ms.date: 06/10/2020
author: Deland-Han
ms.author: delhan
ms.openlocfilehash: 581b485f219e960ecd467baa1f7dff7742c3acf8
ms.sourcegitcommit: dfa48f77b751dbc34409aced628eb2f17c912f08
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/07/2020
ms.locfileid: "87965789"
---
# <a name="how-to-determine-the-minimum-staging-area-dfsr-needs-for-a-replicated-folder"></a>DFSR で複製フォルダーに必要な最小ステージング領域を確認する方法

この記事は、DFSR が正常に機能するために必要な最小ステージング領域を計算する方法に関するクイックリファレンスガイドです。 これらより低い値を指定すると、レプリケーションが遅くなったり、完全に停止したりする可能性があります。

これらは*最小*のものであることに注意してください。 ステージング領域のサイズを考慮する場合、ステージング領域のサイズが大きいほど、レプリケートフォルダーのサイズが大きくなります。 適切なサイズのステージング領域を作成することが重要な理由の詳細については、この記事の最後にある「ステージング領域に問題があるかどうかを判断する方法」および「ブログ投稿」を参照してください。

> [!Note]
> また、ステージングのサイズを計算するための修正プログラムも用意されています。 [DFS レプリケーション (DFSR) 管理インターフェイスの更新プログラムが利用可能です](https://support.microsoft.com/kb/2607047)

## <a name="rules-of-thumb"></a>Thumb の規則

**Windows Server 2003 R2** –ステージング領域のクォータは、レプリケートフォルダー内の最大9個のファイルと同じサイズである必要があります

**Windows Server 2008 および 2008 R2** –ステージング領域のクォータは、レプリケートフォルダー内の最大サイズの32のファイルと同じサイズである必要があります。

初期レプリケーションでは、毎日のレプリケーションよりもステージング領域がはるかに多く使用されます。 ドライブの空き領域がある場合は、初期レプリケーション時のステージング領域を最小値より高く設定することを強くお勧めします。

## <a name="where-do-i-get-powershell"></a>PowerShell はどこで入手できますか?

PowerShell は、Windows 2008 以降に含まれています。 PowerShell は、Windows Server 2003 にインストールする必要があります。 PowerShell for Windows 2003 は[こちら](https://support.microsoft.com/kb/968930)からダウンロードできます。

## <a name="how-do-you-find-these-x-largest-files"></a>これらのサイズの大きいファイルを検索するにはどうすればよいですか。

PowerShell スクリプトを使用して、32または9の最大のファイルを検索し、それらのファイルの追加先となるギガバイト数を確認します (PowerShell コマンドの Pyle が追加されました)。 ここでは、3つの PowerShell スクリプトを紹介します。 それぞれが独自のものです。ただし、数値3が最も役に立ちます。

1. 次のコマンドを実行します。
   ```Powershell
   Get-ChildItem c:\\temp -recurse | Sort-Object length -descending | select-object -first 32 | ft name,length -wrap –auto
   ```

   このコマンドは、ファイル名とファイルサイズ (バイト単位) を返します。 レプリケートフォルダーの中で最も大きい32ファイルを知りたい場合に便利です。そのため、所有者を "訪問" できます。

2. 次のコマンドを実行します。
   ```Poswershell
   Get-ChildItem c:\\temp -recurse | Sort-Object length -descending | select-object -first 32 | measure-object -property length –sum
   ```
   このコマンドは、ファイル名を一覧表示せずに、フォルダー内の最大32のファイルの合計バイト数を返します。

3. 次のコマンドを実行します。
   ```Poswershell
   $big32 = Get-ChildItem c:\\temp -recurse | Sort-Object length -descending | select-object -first 32 | measure-object -property length –sum

   $big32.sum /1gb
   ```
   このコマンドは、フォルダー内の最大で32のファイルの合計バイト数を取得し、計算を実行してバイトをギガバイトに変換します。 このコマンドは2行に分かれています。 これらの両方を PowerShell コマンドシェルに一度に貼り付けるか、もう一度実行して戻すことができます。

## <a name="manual-walkthrough"></a>手動によるチュートリアル

プロセスをデモンストレーションして、私たちが何をしているのかを理解しやすくするために、各部分を手動でステップ実行します。

コマンド1を実行すると、次の出力のような結果が返されます。 この例では、簡潔にするために16個のファイルのみを使用します。 Windows 2008 以降のオペレーティングシステムには常に32を、Windows 2003 R2 には9を使用する

### <a name="example-data-returned-by-powershell"></a>PowerShell によって返されるデータの例

<table>
<tbody>
<tr class="odd">
<td>名前</td>
<td>長さ</td>
</tr>
<tr class="even">
<td><strong>File5.zip</strong></td>
<td>10286089216</td>
</tr>
<tr class="odd">
<td><strong>archive.zip</strong></td>
<td>6029853696</td>
</tr>
<tr class="even">
<td><strong>BACKUP.zip</strong></td>
<td>5751522304</td>
</tr>
<tr class="odd">
<td> <strong>file9.zip</strong></td>
<td>5472683008</td>
</tr>
<tr class="even">
<td><strong>MENTOS.zip</strong></td>
<td>5241586688</td>
</tr>
<tr class="odd">
<td><strong>File7.zip</strong></td>
<td>4321264640</td>
</tr>
<tr class="even">
<td><strong>file2.zip</strong></td>
<td>4176765952</td>
</tr>
<tr class="odd">
<td><strong>frd2.zip</strong></td>
<td>4176765952</td>
</tr>
<tr class="even">
<td><strong>BACKUP.zip</strong></td>
<td>4078994432</td>
</tr>
<tr class="odd">
<td><strong>File44.zip</strong></td>
<td>4058424320</td>
</tr>
<tr class="even">
<td><strong>file11.zip</strong></td>
<td>3858056192</td>
</tr>
<tr class="odd">
<td><strong>Backup2.zip</strong></td>
<td>3815138304</td>
</tr>
<tr class="even">
<td><strong>BACKUP3.zip</strong></td>
<td>3815138304</td>
</tr>
<tr class="odd">
<td><strong>Current.zip</strong></td>
<td>3576931328</td>
</tr>
<tr class="even">
<td><strong>Backup8.zip</strong></td>
<td>3307488256</td>
</tr>
<tr class="odd">
<td><strong>File999.zip</strong></td>
<td>3274982400</td>
</tr>
</tbody>
</table>

### <a name="how-to-use-this-data-to-determine-the-minimum-staging-area-size"></a>このデータを使用してステージング領域の最小サイズを決定する方法:

  - 名前 = ファイルの名前。
  - 長さ = バイト
  - 1 Gb = 1073741824 バイト

まず、合計バイト数を合計する必要があります。 次に、合計を1073741824で割ります。 Excel または選択したスプレッドシートを使用して、数値演算を行うことをお勧めします。

### <a name="example"></a>例

上記の例では、合計バイト数 = 75241684992。 必要なステージング領域の最小クォータを取得するには、75241684992を1073741824で割る必要があります。

> 75241684992/1073741824 = 70.07 GB

このデータに基づいて、最も近い整数に切り上げた場合、ステージング領域を 71 GB に設定します。

### <a name="real-world-scenario"></a>実際のシナリオ:

手動によるチュートリアルは興味深いものですが、自分で計算を行うのに時間をかけるのが最善の方法ではありません。 プロセスを自動化するには、上記の例のコマンド3を使用します。 結果は次のようになります。

> [![絵](https://msdnshared.blob.core.windows.net/media/TNBlogsFS/prod.evol.blogs.technet.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/00/58/02/metablogapi/8204.image_thumb_02CB3914.png "image")](https://msdnshared.blob.core.windows.net/media/TNBlogsFS/prod.evol.blogs.technet.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/00/58/02/metablogapi/0876.image_03A39EFE.png)

この例のコマンド3を使用して、最も近い整数に丸めるのではなく、6 GB のステージング領域のクォータが必要であることを確認できます \\ 。

## <a name="do-i-need-to-reboot-or-restart-the-service-for-the-changes-to-be-picked-up"></a>変更を取得するには、サービスを再起動または再起動する必要がありますか。

ステージング領域のクォータを変更しても、サービスの再起動または再起動は必要ありません。 変更を適用するには、AD レプリケーションと DFSR の AD ポーリングサイクルを待機する必要があります。

## <a name="how-to-determine-if-you-have-a-staging-area-problem"></a>ステージング領域に問題があるかどうかを判断する方法

ステージング領域の問題を検出するには、DFSR サーバーの特定のイベント Id を監視します。 イベントの一覧は、4202、4204、4206、4208、および4212です。 これらのイベントのテキストを次に示します。 4202と4204、およびその他のイベントを区別することが重要です。 通常の動作状態では、大量の4202および4204イベントをログに記録することができます。 4202と4204のイベントは、パルスに似ているものと考えてください。4206、4208、4212は仕立ての問題に似ています。 以下では、4202イベントと4204イベントを解釈する方法について説明します。

### <a name="staging-area-events"></a>ステージング領域イベント

> イベント ID: **4202**重要度:**警告**
>
> DFS レプリケーションサービスにより、ローカルパス (パス) でレプリケートフォルダーに使用されているステージング領域が高基準を超えていることが検出されました。 サービスは、最も古いステージングファイルを削除しようとします。 パフォーマンスが影響を受ける可能性があります。
>
> イベント ID: **4204**重要度:**情報**
>
> DFS レプリケーションサービスにより、ローカルパス (パス) でレプリケートフォルダーの古いステージングファイルが正常に削除されました。 ステージング領域が高基準値を下回っています。
>
> イベント ID: **4206**重要度:**警告**
>
> DFS レプリケーションサービスは、ローカルパス (パス) でレプリケートフォルダーの古いステージングファイルをクリーンアップできませんでした。 サービスがいくつかの大きなファイルをレプリケートできず、レプリケートフォルダーが同期されない可能性があります。サービスは、(x) 分以内にステージング領域のクリーンアップを自動的に再試行します。 ロックが解除されているステージングファイルが検出されると、サービスはクリーンアップを開始することがあります。
>
> イベント ID: **4208**重要度:**警告**
>
> DFS レプリケーションサービスにより、ステージング領域の使用量が、ローカルパス (パス) のレプリケートフォルダーのステージングクォータを超えていることが検出されました。 このオブジェクトは、レプリケート フォルダーをホストしているボリュームを監視し、レプリケート フォルダーをホストするボリューム構成に競合が検出された場合に、警告アラートを作成します。
>
> イベント ID: **4212**重要度:**エラー**
>
> ステージングパスが無効であるかアクセスできないため、DFS レプリケーションサービスはローカルパス (パス) でレプリケートフォルダーをレプリケートできませんでした。

## <a name="what-is-the-difference-between-4202-and-4208"></a>4202と4208の違いは何ですか?

イベント4202と4208には同様のテキストが含まれています。つまり、DFSR はステージング領域の使用率が高基準値を超えていることが検出されました。 違いは、ステージング領域のクリーンアップが実行され、ステージングのクォータが超過した後に4208が記録されることです。 4202は通常の予想されるイベントであり、4208は異常であり、介入が必要です。

## <a name="how-many-4202-4204-events-are-too-many"></a>4202、4204イベントの数が多すぎますか?

この質問に対する回答は1つではありません。 4206、4208、または4212イベントは、常に不適切であり、アクションが必要であることを示すため、通常の動作状態では4202イベントと4204イベントが発生します。 4202および4204イベントの多くが問題を示して*いる可能性があり*ます。 また、以下の点を考慮してください。

1.  レプリケートフォルダー (RF) ログ4202は、初期レプリケーションを実行していますか。 その場合、ログ4202と4204のイベントは正常に発生します。 できるだけ多くのステージング領域を提供することで、初期レプリケーション中にできるだけ少ない数でこれらをダウン状態に保つことができます。
2.  4202イベントの合計数を確認するだけでは十分ではありません。 RF ごとにログ記録された数を把握しておく必要があります。 1つの RF に対して 20 4202 イベントをログに記録する場合は、24時間の上限になります。 ただし、レプリケートフォルダーが20個あり、フォルダーごとに1つのイベントがある場合は、問題ありません。
3.  いくつかのデータを調べて、傾向を設定する必要があります。

通常、通常の動作状態では、1日あたり 1 4202 件以下のイベントをレプリケートしないことをお客様に許可します。 "Normal" は、初期レプリケーションが行われていないことを意味します。 これは、次のような理由に基づいています。

1.  ステージング領域のクリーンアップに要した時間は、ファイルをレプリケートしない時間です。 ステージング領域がクリアされている間、レプリケーションが一時停止します。
2.  DFSR とファイル間 RDC を使用する場合や、同じファイルを他のメンバーにレプリケートする場合は、DFSR が完全なステージング領域を利用できます。
3.  ログに記録する4202および4204イベントの数が多いほど、DFSR がステージング領域をクリーンアップできないか、ステージング領域からファイルを途中で削除する必要があるという状況が発生します。
4.  4206、4208、および4212のイベントは、私の経験では、常に前と後に多数の4202イベントと4204イベントが続きます。

1日あたり1つの RF に対して 1 4202 イベントのみを許可することは控えめなことですが、ステージング領域の問題が発生する可能性を大幅に低減し、ファイルをレプリケートする目的で DFSR サーバーのリソースを活用してください。


