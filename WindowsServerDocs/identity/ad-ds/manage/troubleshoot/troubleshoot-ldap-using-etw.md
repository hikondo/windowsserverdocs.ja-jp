---
title: ETW を使用した LDAP 接続のトラブルシューティング
description: ETW をオンにして、AD DS ドメインコントローラー間の LDAP 接続をトレースする方法
author: Teresa-Motiv
manager: dcscontentpm
ms.prod: windows-server-dev
ms.technology: active-directory-lightweight-directory-services
audience: Admin
ms.author: v-tea
ms.topic: article
ms.date: 11/22/2019
ms.openlocfilehash: f7b7df714dbd02b15555fa20c70c1e995e121a48
ms.sourcegitcommit: b00d7c8968c4adc8f699dbee694afe6ed36bc9de
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 04/08/2020
ms.locfileid: "80822935"
---
# <a name="using-etw-to-troubleshoot-ldap-connections"></a>ETW を使用した LDAP 接続のトラブルシューティング

[Windows イベントトレーシング (ETW)](https://docs.microsoft.com/windows/win32/etw/event-tracing-portal)は、Active Directory Domain Services (AD DS) のための重要なトラブルシューティングツールにすることができます。 ETW を使用して、Windows クライアントと LDAP サーバー (AD DS ドメインコントローラーを含む) との間の[ldap](https://docs.microsoft.com/previous-versions/windows/desktop/ldap/lightweight-directory-access-protocol-ldap-api)(ライトウェイトディレクトリアクセスプロトコル) 通信をトレースできます。

## <a name="how-to-turn-on-etw-and-start-a-trace"></a>ETW をオンにしてトレースを開始する方法

**ETW をオンにするには**

1. レジストリエディターを開き、次のレジストリサブキーを作成します。

   **HKEY\_ローカル\_マシン\\System\\CurrentControlSet\\Services\\ldap\\Tracing\\* ProcessName***

   このサブキーでは、 *ProcessName*は、トレースするプロセスの完全な名前 (たとえば、"svchost.exe") を示します。

1. (**省略可能**)このサブキーの下に、 **PID**という名前の新しいエントリを作成します。 このエントリを使用するには、プロセス ID を DWORD 値として割り当てます。  

   プロセス ID を指定した場合、ETW は、このプロセス ID を持つアプリケーションのインスタンスのみをトレースします。

**トレースセッションを開始するには**

- コマンドプロンプトウィンドウを開き、次のコマンドを実行します。

   ```cmd
   tracelog.exe -start <SessionName> -guid \#099614a5-5dd7-4788-8bc9-e29f43db28fc -f <FileName> -flag <TraceFlags>
   ```

   このコマンドのプレースホルダーは、次の値を表します。

  - \<*のセッション >* は、トレースセッションのラベル付けに使用される任意の識別子です。  
  > [!NOTE]  
  > このセッション名は、後でトレースセッションを停止するときに参照する必要があります。
  - \<*FileName*> イベントが書き込まれるログファイルを指定します。
  - \<*traceflags*> は、[トレースフラグテーブル](#values-for-trace-flags)に記載されている1つ以上の値である必要があります。

## <a name="how-to-end-a-tracing-session-and-turn-off-event-tracing"></a>トレースセッションを終了し、イベントのトレースをオフにする方法

**トレースを停止するには**

- コマンド プロンプトで次のコマンドを実行します。

   ```cmd
   tracelog.exe -stop <SessionName>
   ```

   このコマンドでは、\<の*セッション*名 > は、 **tracelog .exe-start**コマンドで使用した名前と同じです。

**ETW を無効にするには**

- レジストリエディターで、 **HKEY\_LOCAL\_MACHINE\\System\\CurrentControlSet\\Services\\ldap\\Tracing\\* ProcessName*** サブキーを削除します。

## <a name="values-for-trace-flags"></a>トレースフラグの値

フラグを使用するには、 **traceflags .exe-start**コマンドの引数で、<*traceflags*> プレースホルダーのフラグ値を置き換えます。

> [!NOTE]  
> 適切なフラグ値の合計を使用して、複数のフラグを指定できます。 たとえば、 **debug\_SEARCH** (0x00000001) と**debug\_CACHE** (0x00000010) フラグを指定する場合、適切な \<*traceflags*> 値は**0x00000011**になります。

|フラグ名 |フラグ値 |フラグの説明 |
| --- | --- | --- |
|**DEBUG_SEARCH** |0x00000001 |検索要求と、それらの要求に渡されるパラメーターをログに記録します。 応答はここには記録されません。 検索要求だけがログに記録されます。 (検索要求に対する応答をログに記録するには、 **DEBUG_SPEWSEARCH**を使用します。) |
|**DEBUG_WRITE** |0x00000002 |書き込み要求と、それらの要求に渡されるパラメーターをログに記録します。 書き込み要求には、追加、削除、変更、および拡張操作が含まれます。 |
|**DEBUG_REFCNT** |0x00000004 |接続と要求の参照カウントデータと操作をログに記録します。 |
|**DEBUG_HEAP** |0x00000008 |すべてのメモリ割り当てとメモリ解放をログに記録します。 |
|**DEBUG_CACHE** |0x00000010 |キャッシュの利用状況をログに記録します。 このアクティビティには、追加、削除、ヒット、ミスなどが含まれます。 |
|**DEBUG_SSL** |0x00000020 |SSL 情報とエラーをログに記録します。 |
|**DEBUG_SPEWSEARCH** |0x00000040 |検索要求に対するすべてのサーバー応答をログに記録します。 これらの応答には、要求された属性、および受信したすべてのデータが含まれます。 |
|**DEBUG_SERVERDOWN** |0x00000080 |サーバーダウンと接続エラーをログに記録します。 |
|**DEBUG_CONNECT** |0x00000100 |接続の確立に関連するデータをログに記録します。<br />**DEBUG_CONNECTION**を使用して、接続に関連する他のデータをログに記録します。 |
|**DEBUG_RECONNECT** |0x00000200 |自動再接続アクティビティをログに記録します。 このアクティビティには、再接続の試行、エラー、関連するエラーが含まれます。 |
|**DEBUG_RECEIVEDATA** |0x00000400 |サーバーからのメッセージの受信に関連するアクティビティをログに記録します。 このアクティビティには、"サーバーからの応答を待機しています"、サーバーから受信した応答などのイベントが含まれます。 |
|**DEBUG_BYTES_SENT** |0x00000800 |LDAP クライアントによってサーバーに送信されたすべてのデータをログに記録します。 この関数は基本的にパケットログ記録ですが、常に暗号化されていないデータをログに記録します。 (パケットが SSL 経由で送信される場合、この関数は暗号化されていないパケットをログに記録します)。このログ記録は詳細にすることができます。 このフラグは、単独で使用するか、 **DEBUG_BYTES_RECEIVED**と組み合わせて使用することをお勧めします。 |
|**DEBUG_EOM** |0x00001000 |メッセージリストの末尾への到達に関連するイベントをログに記録します。 これらのイベントには、"メッセージ一覧がクリアされました" などの情報が含まれます。 |
|**DEBUG_BER** |0x00002000 |基本エンコード規則 (BER) に関連する操作とエラーをログに記録します。 これらの操作とエラーには、エンコードの問題、バッファーサイズの問題などがあります。 |
|**DEBUG_OUTMEMORY** |0x00004000 |メモリの割り当てに失敗したことをログに記録します。 また、は、必要なメモリの計算に失敗した場合にもログに記録します (たとえば、必要なバッファーサイズを計算するときにオーバーフローが発生した場合など)。 |
|**DEBUG_CONTROLS** |0x00008000 |コントロールに関連するデータをログに記録します。 このデータには、挿入されるコントロール、コントロールに影響する問題、接続に必要なコントロールなどが含まれます。 |
|**DEBUG_BYTES_RECEIVED** |0x00010000 |LDAP クライアントによって受信されたすべてのデータをログに記録します。 この動作は基本的にパケットログ記録ですが、常に暗号化されていないデータをログに記録します。 (パケットが SSL 経由で送信される場合、このオプションを指定すると、暗号化されていないパケットがログに記録されます)。この種類のログ記録は詳細にすることができます。 このフラグは、単独で使用するか、 **DEBUG_BYTES_SENT**と組み合わせて使用することをお勧めします。 |
|**DEBUG_CLDAP** |0x00020000 |UDP およびコネクションレス LDAP に固有のイベントをログに記録します。 |
|**DEBUG_FILTER** |0x00040000 |検索フィルターを構築するときに発生するイベントとエラーをログに記録します。<br/>**メモ**このオプションは、フィルターの構築中にのみクライアントイベントをログに記録します。 フィルターに関するサーバーからの応答はログに記録されません。 |
|**DEBUG_BIND** |0x00080000 |ログにイベントとエラーをバインドします。 このデータには、ネゴシエーション情報、バインドの成功、バインドの失敗などが含まれます。 |
|**DEBUG_NETWORK_ERRORS** |0x00100000 |一般的なネットワークエラーをログに記録します。 このデータには、送信および受信エラーが含まれます。<br/>**メモ**接続が失われた場合、またはサーバーに到達できない場合は、 **DEBUG_SERVERDOWN**が優先タグになります。 |
|**DEBUG_VERBOSE** |0x00200000 |一般的なメッセージをログに記録します。 このオプションは、大量の出力を生成する傾向があるすべてのメッセージに対して使用します。 たとえば、"メッセージの終わりに達しました"、"サーバーはまだ応答していません" などのメッセージがログに記録されます。 このオプションは、汎用メッセージにも役立ちます。 |
|**DEBUG_PARSE** |0x00400000 |一般的なメッセージイベントとエラーに加え、パケット解析およびエンコードイベントとエラーをログに記録します。 |
|**DEBUG_REFERRALS** |0x00800000 |参照と追跡参照に関するデータをログに記録します。 |
|**DEBUG_REQUEST** |0x01000000 |要求の追跡をログに記録します。 |
|**DEBUG_CONNECTION** |0x02000000 |一般的な接続データとエラーをログに記録します。 |
|**DEBUG_INIT_TERM** |0x04000000 |モジュールの初期化とクリーンアップ (DLL Main など) をログに記録します。 |
|**DEBUG_API_ERRORS** |0x08000000 |API の不適切な使用のログ記録をサポートします。 たとえば、同じ接続でバインド操作が2回呼び出された場合、このオプションはデータをログに記録します。 |
|**DEBUG_ERRORS** |0x10000000 |一般的なエラーをログに記録します。 これらのエラーのほとんどは、モジュール初期化エラー、SSL エラー、オーバーフローまたはアンダーフローエラーとして分類できます。 |
|**DEBUG_PERFORMANCE** |0x20000000 |LDAP 要求に対するサーバー応答を受信した後の、プロセスグローバル LDAP アクティビティ統計に関するデータをログに記録します。 |

## <a name="example"></a>例

ユーザーアカウントのパスワードを設定するアプリケーションを例に考えてみましょう。 たとえば、printbrm.exe が予期しないエラーを生成したとします。 ETW を使用してこの問題を診断するには、次の手順を実行します。

1. レジストリエディターで、次のレジストリエントリを作成します。

   **HKEY\_ローカル\_マシン\\System\\CurrentControlSet\\Services\\ldap\\Tracing\\**

1. トレースセッションを開始するには、コマンドプロンプトウィンドウを開き、次のコマンドを実行します。

   ```cmd
   tracelog.exe -start ldaptrace -guid \#099614a5-5dd7-4788-8bc9-e29f43db28fc -f .\ldap.etl -flag 0x80000
   ```

   このコマンドが開始された後、**デバッグ\_バインド**により、ETW がトレースメッセージをに書き込むようにします。\\します。

1. Printbrm.exe を起動し、予期しないエラーを再現します。

1. トレースセッションを停止するには、コマンドプロンプトで次のコマンドを実行します。

   ```cmd
    tracelog.exe -stop ldaptrace
   ```

1. 他のユーザーがアプリケーションをトレースできないようにするには、 **HKEY\_LOCAL\_MACHINE**\\**System**\\**CurrentControlSet**\\**Services**\\**ldap**\\**tracing**\\**のレジストリエントリ**を削除します。

1. トレースログの情報を確認するには、コマンドプロンプトで次のコマンドを実行します。

   ```cmd
    tracerpt.exe .\ldap.etl -o -report
    ```

   > [!NOTE]  
   > このコマンドでは、 **tracerpt**は[トレースコンシューマー](https://go.microsoft.com/fwlink/p/?linkid=83876)ツールです。
