---
ms.assetid: 68db7f26-d6e3-4e67-859b-80f352e6ab6a
title: AD FS 構成データベースの役割
author: billmath
ms.author: billmath
manager: femila
ms.date: 05/31/2017
ms.topic: article
ms.prod: windows-server
ms.technology: identity-adfs
ms.openlocfilehash: 05acf7b07a07c07a8c2253a48a8a5557b1c636d3
ms.sourcegitcommit: d5e27c1f2f168a71ae272bebf8f50e1b3ccbcca3
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 07/23/2020
ms.locfileid: "86966624"
---
# <a name="the-role-of-the-ad-fs-configuration-database"></a>AD FS 構成データベースの役割
AD FS 構成データベースには、Active Directory フェデレーションサービス (AD FS) AD FS の1つのインスタンスを表すすべての構成データ \( \) \( (フェデレーションサービス) が格納され \) ます。 AD FS 構成データベースで定義される一連のパラメーターは、フェデレーション サービスがパートナー、証明書、属性ストア、要求、およびこれらの関連エンティティに関するさまざまなデータを識別する際に必要となります。 この構成データは、 &reg; \( \) windows Server &reg; 2008、windows server 2008 R2、および windows server 2012 に含まれる Microsoft SQL Server データベースまたは windows Internal database WID 機能のいずれかに格納でき &reg; ます。  
  
> [!NOTE]  
> AD FS 構成データベースの内容全体は、WID のインスタンスまたは SQL Server データベースのインスタンスのいずれかに保存できますが、これらの両方に保存することはできません。 つまり、AD FS 構成データベースの同じインスタンスで、WID を使用するフェデレーション サーバーと SQL Server データベースを使用するフェデレーション サーバーを同時に使用することはできません。  
  
このトピックの以下の情報に加えて、「[AD FS 展開トポロジに関する考慮事項](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/gg982489(v=ws.11))」を参照すると、AD FS 構成データベースの保存に WID または SQL Server を選択した場合のそれぞれの利点と欠点を理解できます。  
  
WID リレーショナル データ ストアを使用し、管理ユーザー インターフェイスを持たない \(UI\)します。 代わりに、管理者は、AD FS 管理スナップイン \- 、Fsconfig.exe、または Windows PowerShell コマンドレットを使用して、AD FS 構成データベースの内容を変更でき &trade; ます。  
  
## <a name="using-wid-to-store-the-ad-fs-configuration-database"></a>WID を使用して AD FS 構成データベースを保存する  
いずれかを使用して、ストアとして WID を使用して AD FS 構成データベースを作成すると、Fsconfig.exe コマンド\-ライン ツールまたは AD FS フェデレーション サーバー構成ウィザード。 これらのツールを使用する場合、フェデレーション サーバー トポロジを作成するために次のいずれかのオプションを選択できます。 これらのオプションでは、AD FS 構成データベースの保存に WID を使用します。  
  
-   作成、スタンド\-だけでフェデレーション サーバー  
  
-   フェデレーション サーバー ファーム内に最初のフェデレーション サーバーを作成する  
  
-   フェデレーション サーバー ファームにフェデレーション サーバーを追加する  
  
スタンドを選択した場合\-AD FS 構成データベースの単一のインスタンスを格納するだけでオプション、WID を使用します。 このインスタンスを複数のフェデレーション サーバーで共有することはできません。 これはテスト ラボ環境向けのオプションです。 スタンドアロンの詳細については\-単独で、フェデレーション サーバーのオプションまたはいずれかを設定する方法を参照してください。 [WID を使用してフェデレーション サーバーをスタンドアロン](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/gg982486(v=ws.11)) または [スタンドアロン フェデレーション サーバーを作成](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/ee913579(v=ws.11))します。  
  
フェデレーション サーバー ファームに最初のフェデレーション サーバーを作成するオプションを選択した場合、後からファームに別のフェデレーション サーバーを追加できるように、WID でスケーラビリティが構成されます。 WID ファームの展開に関する詳細とセットアップ方法については、「[WID を使用したフェデレーション サーバー ファーム](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/gg982492(v=ws.11))」または「[フェデレーション サーバー ファームに最初のフェデレーション サーバーを作成する](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/dd807070(v=ws.11))」を参照してください。  
  
フェデレーション サーバーを追加するオプションを選択した場合、指定した間隔で構成データベースの変更点が新しいフェデレーション サーバーにレプリケートされるように WID が構成されます。 WID ファームへのフェデレーション サーバーの追加に関する詳細については、「[WID を使用するフェデレーション サーバー ファーム](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/gg982492(v=ws.11))」または「[フェデレーション サーバー ファームにフェデレーション サーバーを追加する](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/ee913575(v=ws.11))」を参照してください。  
  
> [!NOTE]  
> WID を使用するフェデレーション サーバー ファームを展開するときに AD FS の一部の機能は利用できません。 サーバー ファームを構成する際にすべての機能セットにアクセスできるようにするには、WID の代わりに Microsoft SQL Server を使用して AD FS 構成データベースを保存することを検討してください。 詳細については、「[AD FS 展開トポロジに関する考慮事項](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/gg982489(v=ws.11))」を参照してください。  
  
### <a name="how-a-wid-federation-server-farm-works"></a>WID フェデレーション サーバー ファームの動作  
このセクションでは、WID フェデレーション サーバー ファームのプライマリおよびセカンダリ フェデレーション サーバー間でデータがレプリケートされる仕組みを理解する上で重要な概念を説明します。 .  
  
#### <a name="primary-federation-server"></a>プライマリ フェデレーション サーバー  
プライマリフェデレーションサーバーは、Windows Server 2008、Windows Server 2008 R2、または Windows Server 2012 を実行しているコンピューターで、 &reg; AD FS フェデレーションサーバー構成ウィザードを使用してフェデレーションサーバーの役割で構成され、AD FS 構成データベースの読み取り/書き込みコピーを持つコンピューターです。 AD FS フェデレーション サーバー構成ウィザードを使用して、新しいフェデレーション サービスを作成し、そのコンピューターに、ファーム内の最初のフェデレーション サーバーを作成するオプションを選択すると、プライマリ フェデレーション サーバーは常に作成されます。 このファーム内の他のすべてのフェデレーション サーバー (セカンダリ フェデレーション サーバーと呼ばれます) は、プライマリ フェデレーション サーバーに対して行われた変更を、ローカルに保存されている AD FS 構成データベースのコピーに同期させる必要があります。  
  
#### <a name="secondary-federation-servers"></a>セカンダリ フェデレーション サーバー  
セカンダリ フェデレーション サーバー、プライマリ フェデレーション サーバーから AD FS 構成データベースのコピーを保存するが、これらのコピーは読み取り\-のみです。 セカンダリ フェデレーション サーバーは、ファーム内のプライマリ フェデレーション サーバーに接続し、一定間隔でサーバーをポーリングしてデータが変更されたかどうかをチェックすることにより、プライマリとデータを同期します。 セカンダリ フェデレーション サーバーの存在を読み込むには、機能している間、プライマリ フェデレーション サーバーにフォールト トレランスを提供する\-ネットワーク環境のさまざまなサイトで行われるアクセス要求を分散します。  
  
> [!NOTE]  
> プライマリ フェデレーション サーバーがクラッシュしてオフラインになった場合でも、すべてのセカンダリ フェデレーション サーバーは通常どおり要求を処理し続けます。 ただし、プライマリ フェデレーション サーバーがオンライン状態に戻るまで、フェデレーション サービスに新たに変更を加えることはできません。 Windows PowerShell を使用して、セカンダリ フェデレーション サーバーをプライマリ フェデレーション サーバーとして指定することもできます。 詳細については、次を参照してください。、 [Windows PowerShell による AD FS の管理](https://go.microsoft.com/fwlink/?LinkID=179634)します。  
  
#### <a name="how-the-adfs-configuration-database-is-synchronized"></a>AD FS 構成データベースの同期方法  
により、AD FS 構成データベースが果たす重要な役割、入手可能には、ネットワーク内のすべてのフェデレーション サーバーでフォールト トレランスと負荷を行います\-要求を処理するときに、分散機能 \(とネットワーク負荷\-バランサーが使用される\)します。 ただし、セカンダリ フェデレーション サーバーがこれらの機能を提供するためには、プライマリ フェデレーション サーバーに保存されている AD FS 構成データベースと同期している必要があります。  
  
ファームにフェデレーション サーバーを追加する場合、セカンダリ フェデレーション サーバーになる新しいコンピューターは、プライマリ フェデレーション サーバーに接続して AD FS 構成データベースのコピーをレプリケートします。 これ以降、新しいフェデレーション サーバーは、次の図に示すように定期的にプライマリ フェデレーション サーバーから更新を取得し続けます。  
  
![AD FS の役割](media/adfs2_WID.png)  
  
各セカンダリ フェデレーション サーバーは、変更を確認するために 5 分おきにプライマリ フェデレーション サーバーをポーリングします。 この既定値 5 を調整する\-値を分単位または強制的に即時同期はいつでも Windows PowerShell コマンドレットを使用しています。 これを行う方法の詳細については、次を参照してください。 [Windows PowerShell による AD FS の管理](https://go.microsoft.com/fwlink/?LinkID=179634)します。  
  
WID の同期プロセスでは、中程度の変更をより効率的に転送できるように増分転送もサポートされています。 増分転送プロセスでは、必要なネットワーク トラフィックを大幅に削減でき、転送が完了するまでの時間を大幅に短縮できます。  
  
> [!NOTE]  
> AD FS 構成データベースの WID から SQL Server のインスタンスへの移行がサポートされています。 これを行う方法の詳細については、次を参照してください。 [AD FS: AD FS 構成データベースを SQL Server に移行](https://go.microsoft.com/fwlink/?LinkId=192232) 、TechNet Wiki サイトにします。  
  
## <a name="using-sql-server-to-store-the-ad-fs-configuration-database"></a>SQL Server を使用して AD FS 構成データベースを保存する  
Fsconfig.exe コマンドを使用して、ストアとして 1 つの SQL Server データベース インスタンスを使用して AD FS 構成データベースを作成する\-ライン ツールです。 SQL Server データベースを AD FS 構成データベースとして使用すると、WID を使用する場合に比べて次のような利点があります。  
  
-   管理者は SQL Server の高可用性機能を活用できます  
  
-   高トラフィック時のパフォーマンスがさらに向上します  
  
-   次に示す saml アーティファクト解決と SAML/WS \- フェデレーショントークンリプレイ検出の機能サポートを提供 \( \) します。  
  
次の図に示すように、すべてのフェデレーションサーバーが同じクラスター化された SQL Server インスタンスを使用している AD FS 構成データベースに対して同じように読み取りおよび書き込みを行うことができるため、"プライマリフェデレーションサーバー" という用語は、AD FS 構成データベースが SQL database インスタンスに格納されている場合には適用されません。  
  
![AD FS の役割](media/adfs2_SQL.png)  
  
SQL Server を使用して、AD FS にできるは、受信クライアント要求をサービスに高可用性サーバー クラスターとして連携して動作するのに 2 つ以上のサーバーを構成します。 高可用性を提供するスケール\-アウト アーキテクチャの他のサーバーを追加することによってサーバー容量を増やすことができます。 単一障害点は自動的なクラスター フェールオーバーによって軽減されます。  
  
ネットワーク負荷を使用して高可用性を実現できます\-SQL クラスタ リング テクノロジを提供する分散とフェールオーバーのサービスです。 高可用性のために SQL Server を構成する方法の詳細については、「[高可用性ソリューションの概要](https://go.microsoft.com/fwlink/?LinkId=179853)」を参照してください。  
  
### <a name="saml-artifact-resolution"></a>SAML アーティファクト解決  
Security Assertion Markup Language \(SAML\) アーティファクト解決は、要求プロバイダーから直接、証明書利用者がトークンを取得する方法について説明する SAML 2.0 プロトコルの一部に基づいたエンドポイントです。 解決プロセスの最初の段階では、ブラウザー クライアントがリソース フェデレーション サーバーに接続してアーティファクトを提供します。 第 2 段階では、リソース フェデレーション サーバーが、アカウント パートナー組織でホストされている SAML アーティファクト エンドポイント URL にアーティファクトを送信して、アーティファクト メッセージを解決します。 最終段階では、アカウント フェデレーション サーバーがブラウザー クライアントの代わりにトークンをフェデレーション サーバーに発行します。  
  
> [!NOTE]  
> アカウントパートナー組織の管理者は、Windows ルート証明書プログラムのメンバーのルート証明書にチェーンされている SSL 証明書を、 \( <ComputerName> \\ \\ \\ \\ ファーム内のすべてのアカウントフェデレーションサーバー上の [IIS サイトの既定の web サイト adfs ls] のフェデレーションパッシブ Web サイトに割り当てまたはバインドする必要が \) あります。 これは、リソース フェデレーション サーバーで SSL 証明書を [ローカル コンピューター] の [信頼されたユーザー] 証明書ストアに手動で追加する必要が生じたり、組織で公開されているアーティファクトを解決できなくなったりすることを避けるために重要です。  
  
### <a name="samlws---federation-token-replay-detection"></a>SAML/WS-FEDERATION トークンリプレイ検出  
*トークン リプレイ*という用語は、アカウント パートナー組織内のブラウザー クライアントが、リソース フェデレーション サーバーで認証するために、アカウント フェデレーション サーバーから受け取った同じトークンの送信を何度も試行する動作を指します。この動作は、ユーザーが認証ページを再送信する目的でブラウザーの **[戻る]** ボタンをクリックしたときに発生します。  
  
AD FS の*トークン リプレイ検出*という機能を使用すると、同じトークンを使用する複数のトークン要求を検出して破棄することができます。 トークン リプレイ検出が、両方の WS で認証要求の整合性を保護するこの機能を有効にすると、\-フェデレーション パッシブ プロファイルと同じトークンが複数回使用されることを確認することによって、SAML WebSSO プロファイル。 キオスクを使用する場合など、セキュリティが非常に重要な懸念事項になる状況では、この機能を有効にする必要があります。  
  
キオスクの場合、ユーザーがすべての Web サイトからログオフした後で、悪意のあるユーザーがブラウザーの履歴を使用して前のユーザーが読み込んだフェデレーション認証ページを再送信しようとすることが考えられます。トークン リプレイ検出機能は、アカウント パートナー組織で正常に完了した認証に関する追加情報を保存することで、後続のトークンのリプレイを検出して複数回の認証試行が成功しないようにして、この問題を軽減します。  
  
