---
ms.assetid: 68db7f26-d6e3-4e67-859b-80f352e6ab6a
title: ADFS 構成データベースの役割
description: ''
author: billmath
ms.author: billmath
manager: femila
ms.date: 05/31/2017
ms.topic: article
ms.prod: windows-server
ms.technology: identity-adfs
ms.openlocfilehash: 22047a93ab67d3f21b3e2318fcce497feab8f996
ms.sourcegitcommit: 6aff3d88ff22ea141a6ea6572a5ad8dd6321f199
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 09/27/2019
ms.locfileid: "71385583"
---
# <a name="the-role-of-the-ad-fs-configuration-database"></a>ADFS 構成データベースの役割
AD FS の構成データベースには、Active Directory フェデレーションサービス (AD FS) AD FS \(の1つのインスタンスを表すすべての構成データ (\) \(フェデレーションサービス\)が格納されます。 AD FS 構成データベースで定義される一連のパラメーターは、フェデレーション サービスがパートナー、証明書、属性ストア、要求、およびこれらの関連エンティティに関するさまざまなデータを識別する際に必要となります。 この構成データは、Microsoft SQL Server®データベース、または Windows Server®2008、Windows Server 2008 R2、および Windows Server®2012に含まれる windows Internal Database \(WID\) 機能のいずれかに格納できます。  
  
> [!NOTE]  
> AD FS 構成データベースの内容全体は、WID のインスタンスまたは SQL Server データベースのインスタンスのいずれかに保存できますが、これらの両方に保存することはできません。 つまり、AD FS 構成データベースの同じインスタンスで、WID を使用するフェデレーション サーバーと SQL Server データベースを使用するフェデレーション サーバーを同時に使用することはできません。  
  
このトピックの以下の情報に加えて、「[AD FS 展開トポロジに関する考慮事項](https://technet.microsoft.com/library/gg982489.aspx)」を参照すると、AD FS 構成データベースの保存に WID または SQL Server を選択した場合のそれぞれの利点と欠点を理解できます。  
  
WID リレーショナル データ ストアを使用し、管理ユーザー インターフェイスを持たない \(UI\)します。 代わりに、管理者は、の AD FS 管理スナップ\-イン、Fsconfig .exe、または Windows PowerShell™コマンドレットを使用して、AD FS 構成データベースの内容を変更できます。  
  
## <a name="using-wid-to-store-the-ad-fs-configuration-database"></a>WID を使用して AD FS 構成データベースを保存する  
Fsconfig コマンド\-ラインツールまたは AD FS フェデレーションサーバー構成ウィザードを使用して、WID をストアとして使用して AD FS 構成データベースを作成できます。 これらのツールを使用する場合、フェデレーション サーバー トポロジを作成するために次のいずれかのオプションを選択できます。 これらのオプションでは、AD FS 構成データベースの保存に WID を使用します。  
  
-   作成、スタンド\-だけでフェデレーション サーバー  
  
-   フェデレーション サーバー ファーム内に最初のフェデレーション サーバーを作成する  
  
-   フェデレーション サーバー ファームにフェデレーション サーバーを追加する  
  
[スタンド\-アロン] オプションを選択した場合、WID を使用して AD FS 構成データベースの1つのインスタンスが格納されます。 このインスタンスを複数のフェデレーション サーバーで共有することはできません。 これはテスト ラボ環境向けのオプションです。 スタンドアロンの詳細については\-単独で、フェデレーション サーバーのオプションまたはいずれかを設定する方法を参照してください。 [WID を使用してフェデレーション サーバーをスタンドアロン](https://technet.microsoft.com/library/gg982486.aspx) または [スタンドアロン フェデレーション サーバーを作成](https://technet.microsoft.com/library/ee913579.aspx)します。  
  
フェデレーション サーバー ファームに最初のフェデレーション サーバーを作成するオプションを選択した場合、後からファームに別のフェデレーション サーバーを追加できるように、WID でスケーラビリティが構成されます。 WID ファームの展開に関する詳細とセットアップ方法については、「[WID を使用したフェデレーション サーバー ファーム](https://technet.microsoft.com/library/gg982492.aspx)」または「[フェデレーション サーバー ファームに最初のフェデレーション サーバーを作成する](https://technet.microsoft.com/library/dd807070.aspx)」を参照してください。  
  
フェデレーション サーバーを追加するオプションを選択した場合、指定した間隔で構成データベースの変更点が新しいフェデレーション サーバーにレプリケートされるように WID が構成されます。 WID ファームにフェデレーション サーバーを追加する方法の詳細については、次を参照してください。 [WID フェデレーション サーバー ファームを使用して](https://technet.microsoft.com/library/gg982492.aspx) または [をフェデレーション サーバー ファームにフェデレーション サーバーを追加](https://technet.microsoft.com/library/ee913575.aspx)します。  
  
> [!NOTE]  
> WID を使用するフェデレーション サーバー ファームを展開するときに AD FS の一部の機能は利用できません。 サーバー ファームを構成する際にすべての機能セットにアクセスできるようにするには、WID の代わりに Microsoft SQL Server を使用して AD FS 構成データベースを保存することを検討してください。 詳細については、次を参照してください。 [AD FS 展開トポロジに関する考慮事項](https://technet.microsoft.com/library/gg982489(v=ws.11).aspx)します。  
  
### <a name="how-a-wid-federation-server-farm-works"></a>WID フェデレーション サーバー ファームの動作  
このセクションでは、WID フェデレーション サーバー ファームのプライマリおよびセカンダリ フェデレーション サーバー間でデータがレプリケートされる仕組みを理解する上で重要な概念を説明します。 .  
  
#### <a name="primary-federation-server"></a>プライマリ フェデレーション サーバー  
プライマリフェデレーションサーバーは、Windows Server 2008、Windows Server 2008 R2、または Windows Server®2012を実行するコンピューターで、AD FS フェデレーションサーバー構成ウィザードを使用してフェデレーションサーバーの役割で構成されており、AD FS 構成データベースの読み取り/書き込みコピーが含まれています。 AD FS フェデレーション サーバー構成ウィザードを使用して、新しいフェデレーション サービスを作成し、そのコンピューターに、ファーム内の最初のフェデレーション サーバーを作成するオプションを選択すると、プライマリ フェデレーション サーバーは常に作成されます。 このファーム内の他のすべてのフェデレーション サーバー (セカンダリ フェデレーション サーバーと呼ばれます) は、プライマリ フェデレーション サーバーに対して行われた変更を、ローカルに保存されている AD FS 構成データベースのコピーに同期させる必要があります。  
  
#### <a name="secondary-federation-servers"></a>セカンダリ フェデレーション サーバー  
セカンダリフェデレーションサーバーは、プライマリフェデレーションサーバーからの AD FS 構成データベースのコピーを格納しますが、これらのコピーは読み取り\-のみです。 セカンダリ フェデレーション サーバーは、ファーム内のプライマリ フェデレーション サーバーに接続し、一定間隔でサーバーをポーリングしてデータが変更されたかどうかをチェックすることにより、プライマリとデータを同期します。 セカンダリ フェデレーション サーバーの存在を読み込むには、機能している間、プライマリ フェデレーション サーバーにフォールト トレランスを提供する\-ネットワーク環境のさまざまなサイトで行われるアクセス要求を分散します。  
  
> [!NOTE]  
> プライマリ フェデレーション サーバーがクラッシュしてオフラインになった場合でも、すべてのセカンダリ フェデレーション サーバーは通常どおり要求を処理し続けます。 ただし、プライマリ フェデレーション サーバーがオンライン状態に戻るまで、フェデレーション サービスに新たに変更を加えることはできません。 Windows PowerShell を使用して、セカンダリ フェデレーション サーバーをプライマリ フェデレーション サーバーとして指定することもできます。 詳細については、「 [Windows PowerShell を使用した AD FS 管理](https://go.microsoft.com/fwlink/?LinkID=179634)」を参照してください。  
  
#### <a name="how-the-adfs-configuration-database-is-synchronized"></a>AD FS 構成データベースの同期方法  
AD FS 構成データベースは、重要な役割を果たすため、ネットワーク上のすべてのフェデレーションサーバーで使用できるようになります。これにより、ネットワーク負荷\-バランサーが\)使用されている場合に \(要求を処理するときに、フォールトトレランスと負荷\-分散機能が提供されます。 ただし、セカンダリ フェデレーション サーバーがこれらの機能を提供するためには、プライマリ フェデレーション サーバーに保存されている AD FS 構成データベースと同期している必要があります。  
  
ファームにフェデレーション サーバーを追加する場合、セカンダリ フェデレーション サーバーになる新しいコンピューターは、プライマリ フェデレーション サーバーに接続して AD FS 構成データベースのコピーをレプリケートします。 これ以降、新しいフェデレーション サーバーは、次の図に示すように定期的にプライマリ フェデレーション サーバーから更新を取得し続けます。  
  
![AD FS の役割](media/adfs2_WID.png)  
  
各セカンダリ フェデレーション サーバーは、変更を確認するために 5 分おきにプライマリ フェデレーション サーバーをポーリングします。 Windows PowerShell コマンドレットを使用すると、この既定の5つの\-分の値を調整したり、常に即時同期を強制的に実行したりすることができます。 これを行う方法の詳細については、次を参照してください。 [Windows PowerShell による AD FS の管理](https://go.microsoft.com/fwlink/?LinkID=179634)します。  
  
WID の同期プロセスでは、中程度の変更をより効率的に転送できるように増分転送もサポートされています。 増分転送プロセスでは、必要なネットワーク トラフィックを大幅に削減でき、転送が完了するまでの時間を大幅に短縮できます。  
  
> [!NOTE]  
> AD FS 構成データベースの WID から SQL Server のインスタンスへの移行がサポートされています。 これを行う方法の詳細については、次を参照してください。 [AD FS: AD FS 構成データベースを SQL Server に移行](https://go.microsoft.com/fwlink/?LinkId=192232) 、TechNet Wiki サイトにします。  
  
## <a name="using-sql-server-to-store-the-ad-fs-configuration-database"></a>SQL Server を使用して AD FS 構成データベースを保存する  
Fsconfig .exe コマンド\-line tool を使用して、ストアとして1つの SQL Server データベースインスタンスを使用して、AD FS 構成データベースを作成できます。 SQL Server データベースを AD FS 構成データベースとして使用すると、WID を使用する場合に比べて次のような利点があります。  
  
-   管理者は SQL Server の高可用性機能を活用できます  
  
-   高トラフィック時のパフォーマンスがさらに向上します  
  
-   SAML アーティファクト解決と SAML/WS\-フェデレーショントークンリプレイ検出 \(の機能をサポートしています。これについては、以下の\)を参照してください。  
  
“プライマリ フェデレーション サーバー” という用語は、AD FS 構成データベースが SQL Server データベースのインスタンスに保存される場合は適用されません。次の図に示すように、すべてのフェデレーション サーバーは、クラスター化された同じ SQL Server インスタンスを使用する AD FS 構成データベースを均等に読み書きできるためです。  
  
![AD FS の役割](media/adfs2_SQL.png)  
  
SQL Server を使用すると、複数のサーバーをサーバークラスターとして連携するように構成し、AD FS が受信クライアント要求を処理できるように高可用性を確保することができます。 高可用性を提供するスケール\-アウト アーキテクチャの他のサーバーを追加することによってサーバー容量を増やすことができます。 単一障害点は自動的なクラスター フェールオーバーによって軽減されます。  
  
ネットワーク負荷を使用して高可用性を実現できます\-SQL クラスタ リング テクノロジを提供する分散とフェールオーバーのサービスです。 高可用性のために SQL Server を構成する方法の詳細については、「[高可用性ソリューションの概要](https://go.microsoft.com/fwlink/?LinkId=179853)」を参照してください。  
  
### <a name="saml-artifact-resolution"></a>SAML アーティファクト解決  
Security Assertion Markup Language \(SAML\) アーティファクト解決は、要求プロバイダーから直接、証明書利用者がトークンを取得する方法について説明する SAML 2.0 プロトコルの一部に基づいたエンドポイントです。 解決プロセスの最初の段階では、ブラウザー クライアントがリソース フェデレーション サーバーに接続してアーティファクトを提供します。 第 2 段階では、リソース フェデレーション サーバーが、アカウント パートナー組織でホストされている SAML アーティファクト エンドポイント URL にアーティファクトを送信して、アーティファクト メッセージを解決します。 最終段階では、アカウント フェデレーション サーバーがブラウザー クライアントの代わりにトークンをフェデレーション サーバーに発行します。  
  
> [!NOTE]  
> アカウントパートナー組織の管理者である場合は、Windows ルート証明書プログラムのメンバーのルート証明書にチェーンされている SSL 証明書を、IIS \(<ComputerName>\\\\サイトのフェデレーションパッシブ Web サイト、およびファーム内のすべてのアカウントフェデレーションサーバー上の既定の Web サイト\\adfs\\ls\) に割り当てまたはバインドする必要があります。 これは、リソース フェデレーション サーバーで SSL 証明書を [ローカル コンピューター] の [信頼されたユーザー] 証明書ストアに手動で追加する必要が生じたり、組織で公開されているアーティファクトを解決できなくなったりすることを避けるために重要です。  
  
### <a name="samlws---federation-token-replay-detection"></a>SAML/WS-FEDERATION トークンリプレイ検出  
用語 *トークン リプレイ* 、アカウント パートナー組織内のブラウザー クライアントがリソース フェデレーション サーバーを認証に複数回、アカウント フェデレーション サーバーから受け取った同じトークンを送信しよう動作を指します。  この動作は、ユーザーがブラウザーの **[戻る]** ボタンをクリックして認証ページを再送信したときに発生します。  
  
AD FS の*トークン リプレイ検出*という機能を使用すると、同じトークンを使用する複数のトークン要求を検出して破棄することができます。 トークン リプレイ検出が、両方の WS で認証要求の整合性を保護するこの機能を有効にすると、\-フェデレーション パッシブ プロファイルと同じトークンが複数回使用されることを確認することによって、SAML WebSSO プロファイル。 キオスクを使用する場合など、セキュリティが非常に重要な懸念事項になる状況では、この機能を有効にする必要があります。  
  
キオスクの場合、ユーザーがすべての Web サイトからログオフした後で、悪意のあるユーザーがブラウザーの履歴を使用して前のユーザーが読み込んだフェデレーション認証ページを再送信しようとすることが考えられます。 この機能は、アカウントパートナー組織によって行われた認証の成功に関する追加情報を格納することで、この問題を軽減します。これにより、トークンの後続のリプレイを検出し、複数の認証試行が成功しないようにすることができます。  
  

