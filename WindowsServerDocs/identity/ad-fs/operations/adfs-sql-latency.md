---
title: AD FS による SQL の微調整と待機時間に関する問題の解決
description: このドキュメントでは、AD FS を使用して SQL を微調整する方法について説明します。
author: billmath
ms.author: billmath
manager: daveba
ms.date: 06/20/2019
ms.topic: article
ms.openlocfilehash: 254ba73063a1be49e7833a5e2f022bdf1f6a0101
ms.sourcegitcommit: dfa48f77b751dbc34409aced628eb2f17c912f08
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/07/2020
ms.locfileid: "87966849"
---
# <a name="fine-tuning-sql-and-addressing-latency-issues-with-ad-fs"></a>AD FS による SQL の微調整と待機時間に関する問題の解決
[AD FS 2016](https://support.microsoft.com/help/4503294/windows-10-update-kb4503294)の更新では、データベース間の待機時間を削減するために、次の機能強化が導入されました。 AD FS 2019 の今後の更新プログラムには、これらの機能強化が含まれています。

## <a name="in-memory-cache-update-in-background-thread"></a>バックグラウンドスレッドでのメモリ内キャッシュ更新
以前の alwayson 可用性 (AoA) の展開では、マスターノードが別のデータセンターに配置される可能性があるため、"読み取り" 操作の待機時間は存在していました。 2つの異なるデータセンター間の呼び出しの結果、待機時間が発生しました。

AD FS する最新の更新プログラムでは、待機時間の短縮は、AD FS 構成キャッシュを更新するためのバックグラウンドスレッドの追加と、更新間隔を設定するための設定の対象となります。 データベースキャッシュの更新がバックグラウンドスレッドに移動されるため、要求スレッドでデータベース参照に費やした時間が大幅に短縮されます。

`backgroundCacheRefreshEnabled`が true に設定されている場合、AD FS によってバックグラウンドスレッドでキャッシュの更新を実行できるようになります。 キャッシュからデータをフェッチする頻度は、を設定することによって、時刻の値にカスタマイズでき `cacheRefreshIntervalSecs` ます。 が true に設定されている場合、既定値は300秒に設定され `backgroundCacheRefreshEnabled` ます。 値の設定期間が経過すると、AD FS によってキャッシュの更新が開始され、更新の進行中は、古いキャッシュデータが引き続き使用されます。

AD FS がアプリケーションの要求を受信すると、AD FS は SQL からアプリケーションを取得し、キャッシュに追加します。 値で `cacheRefreshIntervalSecs` は、キャッシュ内のアプリケーションがバックグラウンドスレッドを使用して更新されます。 キャッシュ内にエントリが存在する間は、バックグラウンド更新の進行中に、受信要求でキャッシュが使用されます。 5 * のエントリにアクセスしない場合 `cacheRefreshIntervalSecs` は、キャッシュから削除されます。 構成可能な値に達すると、キャッシュから最も古いエントリを削除することもでき `maxRelyingPartyEntries` ます。

>[!NOTE]
> `cacheRefreshIntervalSecs`データベースで変更が発生したことを示す通知を ADFS が SQL から受信した場合、キャッシュのデータは値の外部で更新されます。 この通知により、キャッシュの更新がトリガーされます。

### <a name="recommendations-for-setting-the-cache-refresh"></a>キャッシュ更新の設定に関する推奨事項
キャッシュ更新の既定値は**5 分**です。 SQL の変更が発生した場合にキャッシュデータが更新されるため、AD FS によって不要なデータ更新を減らすには、 **1 時間**に設定することをお勧めします。

AD FS によって SQL の変更のコールバックが登録され、変更時に ADFS は通知を受け取ります。 この方法を使用すると、ADFS は、SQL からの新しい変更を発生するとすぐに受け取ります。

ネットワークでエラーが発生し、SQL 通知が AD FS ない場合、AD FS はキャッシュ更新の値で指定された間隔で更新されます。 AD FS と SQL の間で接続の問題が疑われる場合は、キャッシュ更新の値を1時間未満に設定することをお勧めします。

### <a name="configuration-instructions"></a>構成の手順
構成ファイルでは、複数のキャッシュエントリがサポートされています。 次の一覧は、組織のニーズに基づいて構成できます。

次の例では、バックグラウンドキャッシュ更新を有効にし、キャッシュ更新間隔を1800秒 (30 分) に設定します。 これは、各 ADFS ノードで実行する必要があり、その後、ADFS サービスを再起動する必要があります。 変更は、他のノードには影響しません。また、すべてのノードに変更を加える前に、最初のノードをテストします。

  1. AD FS 構成ファイルに移動し、セクション "Microsoft. サービス" の下に、次のエントリを追加します。 

  - `backgroundCacheRefreshEnabled`-バックグラウンドキャッシュ機能が有効かどうかを指定します。 "true/false" の値。
  - `cacheRefreshIntervalSecs`-ADFS がキャッシュを更新する秒単位の値。 SQL に変更があった場合、AD FS によってキャッシュが更新されます。 AD FS は SQL 通知を受け取り、キャッシュを更新します。

 >[!NOTE]
 > 構成ファイル内のすべてのエントリで大文字と小文字が区別されます。
 &lt;cache cacheRefreshIntervalSecs = "1800" backgroundCacheRefreshEnabled = "true"/&gt;

サポートされている追加の構成可能な値:

   - **maxRelyingPartyEntries** -AD FS がメモリに保持する証明書利用者エントリの最大数。 この値は、oAuth アプリケーションアクセス許可キャッシュでも使用されます。 RPs よりも多くのアプリケーションアクセス許可があり、すべてがメモリに格納される場合、この値はアプリケーションのアクセス許可の数である必要があります。 既定値は 1000 です。
   - **Maxidentity providerentries** -これは、AD FS がメモリに保持する要求プロバイダーエントリの最大数です。 既定値は 200 です。
   - **Maxcliententries** -これは、AD FS がメモリに保持する OAuth クライアントエントリの最大数です。 既定値は 500 です。
   - **Maxclaimdescriptor エントリ**-AD FS は、メモリ内に保持される要求記述子エントリの最大数を指定します。 既定値は 500 です。
   - **Maxnullentries** -これはネガティブキャッシュとして使用されます。 AD FS がデータベース内でエントリを検索し、見つからない場合、AD FS はネガティブキャッシュに追加されます。 これは、そのキャッシュの最大サイズです。 オブジェクトの種類ごとにネガティブキャッシュがあり、すべてのオブジェクトに対する単一のキャッシュではありません。 既定値は50、0000です。

## <a name="multiple-artifact-db-support-across-datacenters"></a>複数のデータセンターにまたがる複数のアーティファクトデータベースのサポート
複数のデータセンターの以前の構成では、AD FS が1つのアーティファクトデータベースのみをサポートしているため、取得呼び出し中にセンターデータセンターの待機時間が発生します。

データセンター間の待機時間を削減するために、AD FS 管理者は複数のアーティファクト DB インスタンスをデプロイし、AD FS ノードの構成ファイルを変更して別のアーティファクト DB インスタンスを指すようにすることができます。 構成ファイルにアーティファクトデータベース接続文字列を指定して、ノードごとのアーティファクト DB を許可できます。 接続文字列が構成ファイル内に存在しない場合は、構成データベースに存在するアーティファクトデータベースを使用するために、ノードが前の設計に戻されます。
ハイブリッド環境は、この構成でもサポートされます。

### <a name="requirements"></a>要件:
複数のアーティファクトデータベースのサポートを設定する前に、すべてのノードで更新を実行し、マルチノードの呼び出しがこの機能を使用して行われるため、バイナリを更新します。
  1. アーティファクトデータベースを作成する配置スクリプトを生成する: 複数のアーティファクト DB インスタンスをデプロイするには、管理者がアーティファクトデータベース用の SQL 配置スクリプトを生成する必要があります。 この更新の一環として、既存の `Export-AdfsDeploymentSQLScript` コマンドレットが更新され、必要に応じて、SQL 配置スクリプトを生成する AD FS データベースを指定するパラメーターを使用できるようになりました。

 たとえば、成果物データベースのみの配置スクリプトを生成するには、パラメーターを指定 `-DatabaseType` し、値 "アーティファクト" を渡します。 省略可能なパラメーターでは、 `-DatabaseType` AD FS データベースの種類を指定します。 All (既定)、アーティファクト、または構成を設定できます。 パラメーターを `-DatabaseType` 指定しない場合、スクリプトはアーティファクトと構成スクリプトの両方を構成します。

   ```PowerShell
   PS C:\> Export-AdfsDeploymentSQLScript -DestinationFolder <script folder where scripts will be created> -ServiceAccountName <domain\serviceaccount> -DatabaseType "Artifact"
   ```
生成されたスクリプトは、SQL マシンで実行して、必要なデータベースを作成し、それらのデータベースに対する SQL SA アクセス許可を AD FS サービスアカウントに付与する必要があります。

 2. 配置スクリプトを使用してアーティファクト DB を作成します。 新しく生成された CreateDB スクリプトと SetPermissions スクリプトを SQL server マシンにコピーして実行し、ローカルアーティファクト DB を作成します。

 3. 構成ファイルを変更して、アーティファクトデータベース接続を追加します。
 AD FS ノードの構成ファイルに移動し、セクション "Microsoft. サービス" の下で、新しく構成された ArtifactDB にエントリポイントを追加します。

 >[!NOTE]
 > artifactStore と connectionString では、大文字と小文字が区別されます。 これらが正しく構成されていることを確認します。
 &lt;artifactStore connectionString = "Data Source = .\SQLInstance; Integrated Security = True; Initial Catalog = AdfsArtifactStore"/&gt;
>
>Sql 接続に一致するデータソースの値を使用します。



 4. 変更を有効にするには、AD FS サービスを再起動してください。

 >[!NOTE]
 > SQL レプリケーションを使用したり、アーティファクトデータベース間の同期を使用したりすることはお勧めしません。 データセンターごとに1つのアーティファクトデータベースを設定することをお勧めします。

### <a name="cross-datacenter-failover-and-database-recovery"></a>データセンター間のフェールオーバーとデータベース復旧
フェールオーバーアーティファクトデータベースは、マスターアーティファクトデータベースと同じデータセンターに作成することをお勧めします。 フェールオーバーが発生した場合、待機時間が増加することはありません。 データセンター間のフェールオーバーアーティファクトデータベースは推奨されません。 ここでは、複数のアーティファクトデータベースで OAuth、SAML、ESL、およびトークンリプレイ検出関数を呼び出す方法について詳しく説明します。
 - **OAuth と SAML**

   OAuth および SAML アーティファクト要求の場合、ノードは、構成ファイル内に存在するアーティファクトデータベースにアーティファクトを作成します。 構成ファイルにアーティファクトデータベース接続が含まれていない場合は、共通のアーティファクト DB が使用されます。 アーティファクトをフェッチする次の要求が別のノードに移動すると、他のノードは rest API を1番目のノードに作成し、アーティファクトデータベースからアーティファクトをフェッチします。 これは、さまざまなノードが異なる成果物データベースを持つ可能性があり、ノードがそれを認識していない場合に必要です。 1番目のノードがダウンした場合、アーティファクトの解決は失敗します。 この設計により、異なるデータセンターにアーティファクトデータベースをレプリケートする必要はありません。 データセンター全体がダウンしている場合は、アイテムを作成したノードもダウンしている可能性があります。つまり、アーティファクトを解決できなくなります。

 - **エクストラネットのロックアウト**

    構成ファイルで参照されるアーティファクトデータベースは、エクストラネットのロックアウトデータに使用されます。 ただし、ESL 機能の場合、AD FS は、アーティファクトデータベースのデータを書き込むマスターを選択します。 すべてのノードは、各ユーザーに関する最新情報を取得して設定するために、マスターノードへの REST API 呼び出しを行います。 複数のアーティファクトデータベースが使用されている場合は、管理者が各アーティファクトデータベースまたはデータセンターのマスターノードを選択する必要があります。

    1つのノードを ESL マスターとして選択するには、ADFS ノードの構成ファイルに移動し、セクション "Microsoft. サービス" に次の項目を追加します。      

    マスターの次のエントリを追加します。 3つのキーはすべて大文字小文字が区別されることに注意してください。

    &lt;useractivityfarmrole masterFQDN = [選択されたプライマリの FQDN] isMaster = "true"/&gt;

    他のノードでは、次のエントリを追加します。

   &lt;useractivityfarmrole masterFQDN = [選択されたプライマリの FQDN] isMaster = "false"/&gt;

    >[!NOTE]
    >複数のアーティファクトデータベースでデータが同期されないため、ESL 値はアーティファクトデータベース間で同期されません。
    ユーザーは、要求に対して別のデータセンターに到達する可能性があります。したがって、アーティファクト Db の数に依存するように、ExtranetLockoutThreshold を作成することができます。

  - **トークンリプレイ検出**

    トークンリプレイ検出データは、常に中央の成果物データベースから呼び出されます。 AD FS は、要求プロバイダー信頼からトークンを保存し、同じトークンを再生できないようにします。 攻撃者が同じトークンを再生しようとすると、AD FS は、トークンがアーティファクトデータベースに存在するかどうかを確認します。 トークンが存在する場合、要求は拒否されます。 中央の成果物データベースはセキュリティのために使用されます。アーティファクト DB データはレプリケートされないため、攻撃者は要求を別のデータセンターに送信して、トークンを再生できます。 このシナリオでは、中央の成果物データベースのみが使用されるため、ArtifactDB の追加の読み取り専用コピーを作成しても、データセンター間の待機時間を回避することはできません。


