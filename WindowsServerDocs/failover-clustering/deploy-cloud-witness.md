---
ms.assetid: 0cd1ac70-532c-416d-9de6-6f920a300a45
title: フェールオーバークラスターのクラウド監視をデプロイする
ms.prod: windows-server
manager: lizross
ms.author: jgerend
ms.technology: storage-failover-clustering
ms.topic: article
author: JasonGerend
ms.date: 01/18/2019
description: クラウド内の Windows Server フェールオーバークラスターのミラーリング監視サーバーをホストするために Microsoft Azure を使用する方法 (クラウド監視を展開する方法)
ms.openlocfilehash: 0b4ba643dca81d2d19b94b1d27485149f938e1c4
ms.sourcegitcommit: b00d7c8968c4adc8f699dbee694afe6ed36bc9de
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 04/08/2020
ms.locfileid: "80827915"
---
# <a name="deploy-a-cloud-witness-for-a-failover-cluster"></a>フェールオーバー クラスターのクラウド監視を展開する

> 適用対象: Windows Server 2019、Windows Server 2016

クラウド監視は、クラスタークォーラムに投票を提供するために Microsoft Azure を使用するフェールオーバークラスタークォーラム監視の一種です。 このトピックでは、クラウド監視機能の概要、サポートされるシナリオ、およびフェールオーバークラスターのクラウド監視を構成する手順について説明します。

## <a name="cloud-witness-overview"></a><a name="CloudWitnessOverview"></a>クラウド監視の概要

図1は、Windows Server 2016 を使用したマルチサイトの拡張フェールオーバークラスタークォーラム構成を示しています。 この例の構成 (図 1) では、2つのノード (サイトと呼ばれます) が2つのデータセンターにあります。 クラスターが2つ以上のデータセンターにまたがる可能性があることに注意してください。 また、各データセンターには2つ以上のノードを含めることができます。 このセットアップでの一般的なクラスタークォーラム構成 (自動フェールオーバー SLA) は、各ノードに投票を提供します。 いずれかのデータセンターで停電が発生した場合でも、クラスターを実行し続けることができるように、クォーラム監視に1つの追加の投票が与えられます。 数値演算は単純であり、投票の合計は5件です。クラスターで実行を維持するには、3票が必要です。  

![2つの他のサイトの2つのノードを持つ3つ目の独立したサイトでのファイル共有監視](media/Deploy-a-Cloud-Witness-for-a-Failover-Cluster/CloudWitness_1.png "ファイル共有監視")  
**図 1: ファイル共有監視をクォーラム監視として使用する**  

1つのデータセンターで停電が発生した場合、他のデータセンターのクラスターと同等の機会を提供して実行を維持するには、2つのデータセンター以外の場所でクォーラム監視をホストすることをお勧めします。 通常、これは、クォーラム監視 (ファイル共有監視) として使用されるファイル共有をバッキングするファイルサーバーをホストするために、3つ目の個別のデータセンター (サイト) が必要であることを意味します。  

ほとんどの組織には、ファイル共有監視をバッキングするファイルサーバーをホストする3つ目の独立したデータセンターがありません。 つまり、組織は主にファイルサーバーを2つのデータセンターの1つでホストします。これは拡張機能によって、データセンターがプライマリデータセンターになります。 プライマリデータセンターで停電が発生した場合、クラスターはダウンします。これは、他のデータセンターでは、必要な3票のうち、クォーラムの過半数を下回る2票しかないためです。 ファイルサーバーをホストするために3つ目の独立したデータセンターを使用しているお客様にとっては、ファイル共有監視をバックアップする高可用性ファイルサーバーを維持するためのオーバーヘッドになります。 ゲスト OS で実行されているファイル共有監視用のファイルサーバーを持つパブリッククラウド内の仮想マシンをホストすることは、セットアップ & メンテナンスの両方において非常に大きなオーバーヘッドになります。  

クラウド監視は、アービトレーションポイントとして Microsoft Azure を活用する新しい種類のフェールオーバークラスタークォーラム監視です (図 2)。 この例では、Azure Blob Storage を使用して Blob ファイルの読み取り/書き込みを行います。これは、スプリットブレイン解像度の場合には、判別ポイントとして使用されます。  

このアプローチには大きな利点があります。
1. Microsoft Azure を活用します (3 番目の個別のデータセンターは不要です)。  
2. 標準の使用可能な Azure Blob Storage を使用します (パブリッククラウドでホストされている仮想マシンの追加のメンテナンスオーバーヘッドはありません)。  
3. 複数のクラスターに同じ Azure Storage アカウントを使用できます (クラスターごとに1つの blob ファイル、blob ファイル名として使用されるクラスターの一意の id)。  
4. ストレージアカウントへの $cost が非常に低い (blob ファイルごとに書き込まれたデータが非常に少ない場合、blob ファイルはクラスターノードの状態が変化したときに1回だけ更新されます)。  
5. 組み込みのクラウド監視リソースの種類。  

クォーラム監視としてクラウド監視を使用するマルチサイトのストレッチされるクラスターを示す ![図](media/Deploy-a-Cloud-Witness-for-a-Failover-Cluster/CloudWitness_2.png)  
**図 2: クォーラム監視としてクラウド監視を使用する複数サイトの拡張されるクラスター**  

図2に示すように、3つの独立したサイトは必要ありません。 他のクォーラム監視と同様に、クラウド監視は投票を取得し、クォーラム計算に参加できます。  

## <a name="cloud-witness-supported-scenarios-for-single-witness-type"></a><a name="CloudWitnessSupportedScenarios"></a>クラウド監視: 単一の監視の種類でサポートされるシナリオ
フェールオーバークラスターデプロイで、すべてのノードが (Azure の拡張によって) インターネットに接続できる場合は、クラウド監視をクォーラム監視リソースとして構成することをお勧めします。  

次のように、クラウド監視をクォーラム監視として使用するシナリオがサポートされています。  
- ディザスターリカバリーの拡張マルチサイトクラスター (図2を参照)。  
- 共有ストレージのないフェールオーバークラスター (SQL Always On など)。  
- Microsoft Azure 仮想マシンロール (またはその他のパブリッククラウド) でホストされているゲスト OS 内部で実行されているフェールオーバークラスター。  
- プライベートクラウドでホストされている Virtual Machines のゲスト OS 内部で実行されているフェールオーバークラスター。
- スケールアウトファイルサーバークラスターなどの共有記憶域のある、または使用されていない記憶域クラスター。  
- 小規模なブランチオフィスクラスター (2 ノードクラスターも含む)  

Windows Server 2012 R2 以降では、クラスターが監視の投票を自動的に管理し、ノードが動的クォーラムに投票するため、常にミラーリング監視サーバーを構成することをお勧めします。  

## <a name="set-up-a-cloud-witness-for-a-cluster"></a><a name="CloudWitnessSetUp"></a>クラスターのクラウド監視を設定する
クラスターのクォーラム監視としてクラウド監視を設定するには、次の手順を実行します。
1. クラウド監視として使用する Azure Storage アカウントを作成する
2. クラスターのクォーラム監視としてクラウド監視を構成します。

## <a name="create-an-azure-storage-account-to-use-as-a-cloud-witness"></a>クラウド監視として使用する Azure Storage アカウントを作成する

このセクションでは、ストレージアカウントを作成し、そのアカウントのエンドポイント Url とアクセスキーを表示およびコピーする方法について説明します。

クラウド監視を構成するには、有効な Azure Storage アカウントが必要です。このアカウントを使用して、(判別に使用される) blob ファイルを格納できます。 クラウド監視は、Microsoft ストレージアカウントの下に既知のコンテナー **(msft)** を作成します。 クラウド監視は、対応するクラスターの一意の ID を持つ1つの blob ファイルを、この**msft-クラウド監視**コンテナーの下の blob ファイルのファイル名として書き込みます。 これは、同じ Microsoft Azure Storage アカウントを使用して、複数の異なるクラスターに対してクラウド監視を構成できることを意味します。

同じ Azure Storage アカウントを使用して、複数の異なるクラスターに対してクラウド監視を構成すると、単一の**msft-クラウド監視**コンテナーが自動的に作成されます。 このコンテナーには、クラスターごとに1つの blob ファイルが含まれます。

### <a name="to-create-an-azure-storage-account"></a>Azure ストレージアカウントを作成するには

1. [Azure portal](https://portal.azure.com) にサインインします。
2. [ハブ] メニューで、[新規]、[データ + ストレージ]、[ストレージ アカウント] の順に選択します。
3. [ストレージアカウントの作成] ページで、次の操作を行います。
    1. ストレージアカウントの名前を入力します。
    <br>ストレージアカウント名の長さは 3 ~ 24 文字にする必要があり、数字と小文字のみを含めることができます。 ストレージアカウント名は、Azure 内で一意である必要もあります。
        
    2. **[アカウントの種類]** で **、[汎用] を選択し**ます。
    <br>クラウドミラーリング監視サーバーには、Blob ストレージアカウントを使用できません。
    3. **[パフォーマンス]** で **[標準]** を選択します。
    <br>クラウド監視に Azure Premium Storage を使用することはできません。
    2. **レプリケーション**の場合は、 **[ローカル冗長ストレージ (LRS)]** を選択します。
    <br>フェールオーバークラスタリングでは、データの読み取り時に一定の整合性を保証する必要がある、アービトレーションポイントとして blob ファイルを使用します。 そのため、**レプリケーション**の種類には **、ローカル冗長ストレージ**を選択する必要があります。

### <a name="view-and-copy-storage-access-keys-for-your-azure-storage-account"></a>Azure Storage アカウントのストレージアクセスキーを表示およびコピーする

Microsoft Azure Storage アカウントを作成すると、自動的に生成されたプライマリアクセスキーとセカンダリアクセスキーの2つのアクセスキーに関連付けられます。 クラウド監視を初めて作成する場合は、**プライマリアクセスキー**を使用します。 クラウド監視に使用するキーに関する制限はありません。  

#### <a name="to-view-and-copy-storage-access-keys"></a>ストレージアクセスキーを表示およびコピーするには

Azure Portal でストレージアカウントに移動し、すべての **[設定]** 、 **[アクセスキー]** の順にクリックして、アカウントアクセスキーを表示、コピー、再生成します。 [アクセスキー] ブレードには、プライマリキーとセカンダリキーを使用して事前に構成された接続文字列も含まれており、アプリケーションで使用するためにコピーできます (図4参照)。

Microsoft Azure](media/Deploy-a-Cloud-Witness-for-a-Failover-Cluster/CloudWitness_4.png) の [アクセスキーの管理] ダイアログのスナップショットの ![  
**図 4: ストレージアクセスキー**

### <a name="view-and-copy-endpoint-url-links"></a>エンドポイント URL リンクの表示とコピー  
ストレージアカウントを作成すると、次の Url がという形式で生成されます。 `https://<Storage Account Name>.<Storage Type>.<Endpoint>`  

クラウド監視では、常にストレージの種類として**Blob**が使用されます。 Azure では、エンドポイントとして **. core.windows.net**を使用します。 クラウド監視を構成する場合は、シナリオに従って別のエンドポイントで構成することもできます (たとえば、中国の Microsoft Azure データセンターには異なるエンドポイントがあります)。  

> [!NOTE]  
> エンドポイント URL は、クラウド監視リソースによって自動的に生成されます。 URL に必要な追加の構成手順はありません。  

#### <a name="to-view-and-copy-endpoint-url-links"></a>エンドポイント URL リンクを表示およびコピーするには
Azure Portal でストレージアカウントに移動し、すべての **[設定]** をクリックし、 **[プロパティ]** をクリックしてエンドポイント url を表示し、コピーします (図5を参照)。  

クラウド監視エンドポイントリンクの ![スナップショット](media/Deploy-a-Cloud-Witness-for-a-Failover-Cluster/CloudWitness_5.png)  
**図 5: クラウド監視エンドポイントの URL リンク**

Azure Storage アカウントの作成と管理の詳細については、「 [Azure Storage アカウントについ](https://azure.microsoft.com/documentation/articles/storage-create-storage-account/)て」を参照してください。

## <a name="configure-cloud-witness-as-a-quorum-witness-for-your-cluster"></a>クラスターのクォーラム監視としてクラウド監視を構成する
クラウド監視の構成は、フェールオーバークラスターマネージャーに組み込まれている既存のクォーラム構成ウィザード内で適切に統合されます。  

### <a name="to-configure-cloud-witness-as-a-quorum-witness"></a>クラウド監視をクォーラム監視として構成するには
1. フェールオーバークラスターマネージャーを起動します。
2. クラスターを右クリックし、 **[その他のアクション]**  -> **クラスタークォーラム設定**> を構成します (図6を参照)。 クラスタークォーラム構成ウィザードが起動します。  
    フェールオーバークラスターマネージャー UI](media/Deploy-a-Cloud-Witness-for-a-Failover-Cluster/CloudWitness_7.png) 図6の [構成] クラスタークォーラム設定へのメニューパスのスナップショットを ![し**ます。クラスタークォーラム設定**

3. **[クォーラム構成の選択]** ページで、 **[クォーラム監視の選択]** を選択します (図7を参照)。  

    クラスタークォーラムウィザードの [quotrum 監視を選択してください] オプションボタンのスナップショットを ![](media/Deploy-a-Cloud-Witness-for-a-Failover-Cluster/CloudWitness_8.png)  
    **図 7.クォーラム構成の選択**

4. **[クォーラム監視の選択]** ページで、 **[クラウド監視の構成]** を選択します (図8を参照)。  

    適切なラジオボタンのスナップショットを ![して、クラウド監視を選択](media/Deploy-a-Cloud-Witness-for-a-Failover-Cluster/CloudWitness_9.png)  
    **図 8.クォーラム監視を選択する**  

5. **[クラウド監視の構成]** ページで、次の情報を入力します。  
   1. (必須パラメーター)Azure Storage アカウント名。  
   2. (必須パラメーター)ストレージアカウントに対応するアクセスキー。  
       1. 初めて作成する場合は、プライマリアクセスキーを使用します (図5を参照)。  
       2. プライマリアクセスキーをローテーションする場合は、セカンダリアクセスキーを使用します (図5を参照)。  
   3. (省略可能なパラメーター)別の Azure サービスエンドポイント (中国の Microsoft Azure サービスなど) を使用する場合は、エンドポイントサーバー名を更新します。  

      クラスタークォーラムウィザードの [クラウド監視の構成] ウィンドウの ![スナップショット](media/Deploy-a-Cloud-Witness-for-a-Failover-Cluster/CloudWitness_10.png)  
      **図 9: クラウド監視を構成する**

6. クラウド監視が正常に構成されたら、フェールオーバークラスターマネージャースナップインに新しく作成した監視リソースを表示できます (図10を参照)。

    クラウド監視を正常に構成 ![](media/Deploy-a-Cloud-Witness-for-a-Failover-Cluster/CloudWitness_11.png)  
    **図 10: クラウド監視を正常に構成する**

### <a name="configuring-cloud-witness-using-powershell"></a>PowerShell を使用したクラウド監視の構成  
既存の Set ClusterQuorum PowerShell コマンドには、クラウド監視に対応する新しいパラメーターが追加されています。  

クラウド監視を構成するには[`Set-ClusterQuorum`](https://technet.microsoft.com/library/ee461013.aspx)次の PowerShell コマンドを使用します。  

```PowerShell
Set-ClusterQuorum -CloudWitness -AccountName <StorageAccountName> -AccessKey <StorageAccountAccessKey>
```

別のエンドポイント (まれ) を使用する必要がある場合は、次のようにします。  

```PowerShell
Set-ClusterQuorum -CloudWitness -AccountName <StorageAccountName> -AccessKey <StorageAccountAccessKey> -Endpoint <servername>  
```

### <a name="azure-storage-account-considerations-with-cloud-witness"></a>クラウド監視での Azure Storage アカウントに関する考慮事項  
フェールオーバークラスターのクォーラム監視としてクラウド監視を構成する場合は、次の点を考慮してください。
* アクセスキーを格納する代わりに、フェールオーバークラスターによって、Shared Access Security (SAS) トークンが生成され、安全に格納されます。  
* 生成された SAS トークンは、アクセスキーが有効なままである限り有効です。 プライマリアクセスキーをローテーションする場合は、プライマリアクセスキーを再生成する前に、まず、そのストレージアカウントを使用しているすべてのクラスターで、セカンダリアクセスキーを使用してクラウド監視を更新することが重要です。  
* クラウド監視では、Azure Storage アカウントサービスの HTTPS REST インターフェイスが使用されます。 これは、すべてのクラスターノードで HTTPS ポートを開く必要があることを意味します。

### <a name="proxy-considerations-with-cloud-witness"></a>クラウド監視でのプロキシに関する考慮事項  
クラウド監視では、HTTPS (既定のポート 443) を使用して Azure blob service との通信を確立します。 ネットワークプロキシ経由で HTTPS ポートにアクセスできることを確認します。

## <a name="see-also"></a>参照
- [Windows Server でのフェールオーバークラスタリングの新機能](whats-new-in-failover-clustering.md)
