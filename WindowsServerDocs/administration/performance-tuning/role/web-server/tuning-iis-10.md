---
title: IIS 10.0 のチューニング
description: Windows Server 16 の IIS 10.0 web サーバーのパフォーマンスチューニング recommmendations
ms.prod: windows-server
ms.technology: performance-tuning-guide
ms.topic: landing-page
ms.author: davso; ericam; yashi
author: phstee
ms.date: 10/16/2017
ms.openlocfilehash: 8617c285ae55521e4e301b5c6b74f389df6b32d2
ms.sourcegitcommit: 145cf75f89f4e7460e737861b7407b5cee7c6645
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 07/29/2020
ms.locfileid: "87409452"
---
# <a name="tuning-iis-100"></a>IIS 10.0 のチューニング

Windows Server 2016 にはインターネットインフォメーションサービス (IIS) 10.0 が含まれています。 IIS 8.5 および IIS 7.0 と同様のプロセスモデルを使用します。 カーネルモードの web ドライバー (http.sys) は、HTTP 要求を受信してルーティングし、応答キャッシュからの要求を満たします。 ワーカープロセスによって URL サブ空間が登録され、http.sys によって適切なプロセス (またはアプリケーションプールのプロセスセット) に要求がルーティングされます。

HTTP.sys は、接続管理と要求の処理を担当します。 要求は、HTTP.sys キャッシュから提供することも、ワーカープロセスに渡して処理することもできます。 複数のワーカープロセスを構成できます。これにより、コストを削減しながら分離することができます。 要求処理のしくみの詳細については、次の図を参照してください。

![iis 10.0 での要求処理](../../media/perftune-guide-iis-request-handling.png)

HTTP.sys には、応答キャッシュが含まれます。 要求が応答キャッシュのエントリと一致すると、HTTP.sys は、カーネルモードから直接キャッシュ応答を送信します。 ASP.NET などの一部の web アプリケーションプラットフォームは、任意の動的コンテンツをカーネルモードキャッシュにキャッシュできるようにするメカニズムを提供します。 IIS 10.0 の静的ファイルハンドラーは、頻繁に要求されるファイルを http.sys に自動的にキャッシュします。

Web サーバーにはカーネルモードとユーザーモードのコンポーネントがあるため、パフォーマンスを最適化するために両方のコンポーネントをチューニングする必要があります。 そのため、特定のワークロードに対して IIS 10.0 を調整するには、次の構成が含まれます。

-   HTTP.sys と関連するカーネルモードキャッシュ

-   ワーカープロセスとユーザーモード IIS (アプリケーションプールの構成を含む)

-   パフォーマンスに影響を与える特定のチューニングパラメーター

以下のセクションでは、IIS 10.0 のカーネルモードとユーザーモードの側面を構成する方法について説明します。

## <a name="kernel-mode-settings"></a>カーネルモード設定

パフォーマンス関連の HTTP.sys 設定は、キャッシュ管理と接続と要求の管理という2つの広範なカテゴリに分類されます。 すべてのレジストリ設定は、次のレジストリエントリの下に格納されます。

``` syntax
HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services\Http\Parameters
```

**メモ**  HTTP サービスが既に実行されている場合は、変更を有効にするために再起動する必要があります。

## <a name="cache-management-settings"></a>キャッシュ管理の設定

HTTP.sys が提供する利点の1つは、カーネルモードのキャッシュです。 応答がカーネルモードのキャッシュ内にある場合は、カーネルモードからの HTTP 要求を完全に満たすことができます。これにより、要求の処理にかかる CPU コストが大幅に削減されます。 ただし、IIS 10.0 のカーネルモードキャッシュは物理メモリに基づいており、エントリのコストは占有されているメモリです。

キャッシュ内のエントリは、使用されている場合にのみ役立ちます。 ただし、エントリが使用されているかどうかにかかわらず、エントリは常に物理メモリを消費します。 キャッシュ内の項目の有用性 (キャッシュからサービスを提供することによる節約額) と、使用可能なリソース (CPU と物理メモリ)、およびワークロードの要件を考慮して、エントリの有効期間におけるそのコスト (使用される物理メモリ) を評価する必要があります。 HTTP.sys は、キャッシュ内のアクティブにアクセスされた便利な項目のみを保持しようとしますが、特定のワークロードの HTTP.sys キャッシュを調整することで、web サーバーのパフォーマンスを向上させることができます。

次に、HTTP.sys カーネルモードキャッシュの便利な設定をいくつか示します。

-   **UriEnableCache**既定値: 1

    0以外の値を指定すると、カーネルモードの応答とフラグメントのキャッシュが有効になります。 ほとんどのワークロードでは、キャッシュは有効なままにしておく必要があります。 応答が非常に少なく、フラグメントがキャッシュされることが予想される場合は、キャッシュを無効にすることを検討してください。

-   **UriMaxCacheMegabyteCount**既定値: 0

    カーネルモードのキャッシュで使用可能な最大メモリを指定する0以外の値。 既定値の0では、システムがキャッシュに使用できるメモリの量を自動的に調整できます。

    **メモ**サイズを指定した場合、最大値のみが設定され、システムではキャッシュが最大サイズに拡張されない可能性があります。

    Â 

-   **Urimaxuribytes**既定値: 262144 バイト (256 KB)

    カーネルモードキャッシュ内のエントリの最大サイズ。 この値より大きい応答またはフラグメントはキャッシュされません。 十分なメモリがある場合は、制限を増やすことを検討してください。 メモリが制限されていて、大きなエントリの crowding が小さい場合は、制限を低くすると役立つことがあります。

-   **UriScavengerPeriod**既定値: 120 秒

    HTTP.sys キャッシュは、スカベンジャーによって定期的にスキャンされ、スカベンジャースキャン間でアクセスされないエントリは削除されます。 スカベンジャー period を high 値に設定すると、スカベンジャースキャンの回数を減らすことができます。 ただし、アクセス頻度の低い古いエントリがキャッシュに残っている可能性があるため、キャッシュメモリの使用量が増加する可能性があります。 期間を低く設定すると、より頻繁にスカベンジャースキャンが実行され、フラッシュとキャッシュチャーンが過剰になる可能性があります。

## <a name="request-and-connection-management-settings"></a>要求と接続の管理の設定

Windows Server 2016 では、HTTP.sys は自動的に接続を管理します。 次のレジストリ設定は使用されなくなりました。

-   **MaxConnections**

    ``` syntax
    HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services\Http\Parameters\MaxConnections
    ```

-   **IdleConnectionsHighMark**

    ``` syntax
    HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services\Http\Parameters\IdleConnectionsHighMark
    ```

-   **IdleConnectionsLowMark**

    ``` syntax
    HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services\Http\Parameters\IdleConnectionsLowMark
    ```

-   **IdleListTrimmerPeriod**

    ``` syntax
    HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services\Http\Parameters\IdleListTrimmerPeriod
    ```

-   **Requestbufferlook の深さ**

    ``` syntax
    HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services\Http\Parameters\RequestBufferLookasideDepth
    ```

-   **Internalrequestlook Aside の深さ**

    ``` syntax
    HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services\Http\Parameters\InternalRequestLookasideDepth
    ```


## <a name="user-mode-settings"></a>ユーザーモードの設定

このセクションの設定は、IISÂワーカープロセスの動作に影響します。 これらの設定のほとんどは、次の XML 構成ファイルにあります。

% SystemRoot% \\ system32 \\ inetsrv config administration.config \\ config \\applicationHost.config

これらを変更するには、Appcmd.exe、IIS 10.0 管理コンソール、WebAdministration または IISAdministration PowerShell コマンドレットを使用します。 ほとんどの設定は自動的に検出され、IIS 10.0 ワーカープロセスまたは web アプリケーションサーバーを再起動する必要はありません。 applicationHost.config ファイルの詳細については、「 [ApplicationHost.configの概要](https://www.iis.net/learn/get-started/planning-your-iis-architecture/introduction-to-applicationhostconfig)」を参照してください。


## <a name="ideal-cpu-setting-for-numa-hardware"></a>NUMA ハードウェアの理想的な CPU 設定

Windows 2016 以降では、IIS 10.0 は、NUMA ハードウェアのパフォーマンスとスケーラビリティを向上させるために、スレッドプールスレッドに対して自動的に最適な CPU 割り当てをサポートしています。 この機能は既定で有効になっており、次のレジストリキーを使用して構成できます。

``` syntax
HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services\InetInfo\Parameters\ThreadPoolUseIdealCpu
```

この機能を有効にすると、IIS スレッドマネージャーは、現在の負荷に基づいて、すべての NUMA ノード内のすべての Cpu に IIS スレッドプールのスレッドを均等に分散させることができるようになります。 一般に、NUMA ハードウェアでは、この既定の設定をそのままにしておくことをお勧めします。

**メモ**  理想的な CPU 設定は、[アプリケーションプールの Cpu 設定](https://www.iis.net/configreference/system.applicationhost/applicationpools/add/cpu)で導入されたワーカープロセス NUMA ノードの割り当て設定 (num、Num/deassignment と Num* Deaffinitymode) とは異なります。 最適な CPU 設定は、IIS がスレッドプールのスレッドを配布する方法に影響します。ワーカープロセスの NUMA ノード割り当ての設定によって、ワーカープロセスが開始される NUMA ノードが決まります。

## <a name="user-mode-cache-behavior-settings"></a>ユーザーモードのキャッシュ動作の設定

ここでは、IISÂでのキャッシュの動作に影響する設定について説明します。 ユーザーモードのキャッシュは、統合されたパイプラインによって発生するグローバルキャッシュイベントをリッスンするモジュールとして実装されます。 ユーザーモードのキャッシュを完全に無効にするには、applicationHost.config の System.webserver/globalModules 構成セクションにあるインストールされているモジュールの一覧から FileCacheModule (cachfile.dll) モジュールを削除します。

**System.webserver/キャッシュ**

| 属性 | 説明 | Default |
|--|--|--|
| Enabled | **False**に設定されている場合、ユーザーモードの IIS キャッシュを無効にします。 キャッシュヒット率が非常に小さい場合は、キャッシュコードパスに関連付けられているオーバーヘッドを回避するために、キャッシュを完全に無効にすることができます。 ユーザーモードのキャッシュを無効にしても、カーネルモードのキャッシュは無効になりません。 | True |
| Enableカーネルキャッシュ | **False**に設定されている場合、カーネルモードのキャッシュを無効にします。 | True |
| maxCacheSize | IIS ユーザーモードのキャッシュサイズを指定したサイズ (メガバイト単位) に制限します。 IIS では、使用可能なメモリに応じて既定値が調整されます。 頻繁にアクセスするファイルのセットのサイズと RAM の容量または IIS プロセスのアドレス空間に基づいて、値を慎重に選択します。 | 0 |
| maxResponseSize | 指定されたサイズまでファイルをキャッシュします。 実際の値は、データセット内の最大ファイルの数とサイズ、および使用可能な RAM によって異なります。 頻繁に要求される大規模なファイルをキャッシュすることで、CPU の使用率、ディスクアクセス、および関連する待機時間を減らすことができます。 | 262144 |

## <a name="compression-behavior-settings"></a>圧縮動作の設定

既定では、7.0 から始まる IIS は静的なコンテンツを圧縮します。 また、DynamicCompressionModule をインストールすると、動的コンテンツの圧縮が既定で有効になります。 圧縮によって帯域幅の使用が削減されますが、CPU 使用率が増加します 可能であれば、圧縮されたコンテンツはカーネルモードのキャッシュにキャッシュされます。 8.5 以降では、静的コンテンツと動的コンテンツに対して、IIS によって圧縮が個別に制御できるようになります。 静的コンテンツは、通常、GIF や HTM ファイルなど、変更されないコンテンツを指します。 動的コンテンツは、通常、サーバー上のスクリプトまたはコード (つまり、ASP.NET ページ) によって生成されます。 特定の拡張機能の分類は、静的または動的としてカスタマイズできます。

圧縮を完全に無効にするには、applicationHost.config の System.webserver/globalModules セクションにあるモジュールの一覧から StaticCompressionModule と DynamicCompressionModule を削除します。

**System.webserver/httpCompression**

| 属性 | 説明 | Default |
|--|--|--|
| staticCompression-EnableCpuUsage<br><br>staticCompression-DisableCpuUsage<br><br>dynamicCompression-EnableCpuUsage<br><br>dynamicCompression-DisableCpuUsage | 現在の CPU 使用率が、指定された制限を超えた場合、または下回った場合に、圧縮を有効または無効にします。<br><br>IIS 7.0 以降では、安定状態の CPU が無効しきい値を超えた場合、圧縮は自動的に無効になります。 CPU が有効しきい値を下回ると、圧縮が有効になります。 | 50、100、50、および90 |
| directory | 圧縮されたバージョンの静的ファイルが一時的に格納およびキャッシュされるディレクトリを指定します。 頻繁にアクセスされる場合は、このディレクトリをシステムドライブから移動することを検討してください。 | %SystemDrive%\inetpub\temp\IIS Temporary Compressed Files |
| Dodiskspace の制限 | 圧縮されたすべてのファイルが占有できるディスク領域の制限が存在するかどうかを指定します。 圧縮されたファイルは、 **directory**属性によって指定された圧縮ディレクトリに格納されます。 | True |
| Maxdiskspace Usage | 圧縮ファイルが圧縮ディレクトリに格納できるディスク領域のバイト数を指定します。<br><br>圧縮されたすべてのコンテンツの合計サイズが大きすぎる場合は、この設定を増やす必要があります。 | 100 MB |

**System.webserver/urlCompression**

| 属性 | 説明 | Default |
|--|--|--|
| doStaticCompression | 静的コンテンツを圧縮するかどうかを指定します。 | True |
| doDynamicCompression | 動的コンテンツを圧縮するかどうかを指定します。 | True |

> [!NOTE]
> 平均 CPU 使用率が低い IIS 10.0 を実行しているサーバーの場合、特に応答が大きい場合は、動的コンテンツの圧縮を有効にすることを検討してください。 これは、ベースラインからの CPU 使用率の影響を評価するために、まずテスト環境で実行する必要があります。

### <a name="tuning-the-default-document-list"></a>既定のドキュメントリストのチューニング

既定のドキュメントモジュールは、ディレクトリのルートに対する HTTP 要求を処理し、Default.htm や Index.htm など、特定のファイルに対する要求に変換します。 平均して、インターネット上のすべての要求の aroundÂ25% が、既定のドキュメントパスを経由します。 これは、サイトごとに大きく異なります。 HTTP 要求でファイル名が指定されていない場合、既定のドキュメントモジュールは、ファイルシステム内の各名前に対して許可されている既定のドキュメントの一覧を検索します。 この場合、特にコンテンツに到達するには、ネットワークラウンドトリップを作成するか、ディスクにタッチする必要があります。

既定のドキュメントを選択的に無効にしたり、ドキュメントの一覧を減らしたり順序付けたりすることによって、オーバーヘッドを回避できます。 既定のドキュメントを使用する web サイトの場合は、使用されている既定のドキュメントの種類のみを一覧に表示する必要があります。 また、最も頻繁にアクセスされる既定のドキュメントファイル名で始まるようにリストを並べ替えます。

特定の Url に対して既定のドキュメント動作を設定するには、applicationHost.config の location タグ内で構成をカスタマイズするか、web.config ファイルをコンテンツディレクトリに直接挿入します。 これにより、ハイブリッドアプローチが可能になります。これにより、既定のドキュメントのみが必要な場所で使用できるようになり、各 URL の正しいファイル名にリストが設定されます。

既定のドキュメントを完全に無効にするには、applicationHost.config の System.webserver/globalModules セクションにあるモジュールの一覧から DefaultDocumentModule を削除します。

**System.webserver/defaultDocument**

| 属性 | 説明 | Default |
|--|--|--|
| enabled | 既定のドキュメントを有効にすることを指定します。 | True |
| `<files>` 要素 | 既定のドキュメントとして構成されているファイル名を指定します。 | 既定の一覧は Default.htm、default.asp、Index.htm、Index.html、Iisstart.htm、および default.aspx です。 |

## <a name="central-binary-logging"></a>中央バイナリログ

サーバーセッションに多数の URL グループが含まれている場合、個々の URL グループに対して数百の形式のログファイルを作成し、ログデータをディスクに書き込むプロセスによって、貴重な CPU リソースとメモリリソースを迅速に使用できるため、パフォーマンスとスケーラビリティの問題が発生する可能性があります。 バイナリログの一元化により、ログ記録に使用されるシステムリソースの量が最小限に抑えられ、同時に、それを必要とする組織のための詳細なログデータを提供します。 バイナリ形式のログを解析するには、処理後のツールが必要です。

CentralLogFileMode 属性を CentralBinary に設定し、 **enabled**属性を**True**に設定することによって、中央のバイナリログ記録を有効にすることができます。 システムアクティビティとログアクティビティの競合を避けるために、中央のログファイルの場所をシステムパーティションから専用のログ記録ドライブに移動することを検討してください。

**Applicationhost.config/log**

| 属性 | 説明 | Default |
|--|--|--|
| centralLogFileMode | サーバーのログモードを指定します。 中央バイナリログを有効にするには、この値を CentralBinary に変更します。 | サイト |

**Applicationhost.config/log/centralBinaryLogFile**

| 属性 | 説明 | Default |
|--|--|--|
| enabled | 中央バイナリログを有効にするかどうかを指定します。 | False |
| directory | ログエントリが書き込まれるディレクトリを指定します。 | %SystemDrive%\inetpub\logs\LogFiles |

## <a name="application-and-site-tunings"></a>アプリケーションとサイトチューニング

次の設定は、アプリケーションプールとサイトチューニングに関連しています。

**Applicationhost.config/applicationPools/applicationPoolDefaults**

| 属性 | 説明 | Default |
|--|--|--|
| queueLength | 今後の要求が拒否されるまでに、アプリケーションプールのキューに登録されている要求の数を HTTP.sys することを示します。 このプロパティの値を超えた場合、IIS は503エラーが発生した後続の要求を拒否します。<br><br>503エラーが検出された場合に、待機時間の長いバックエンドデータストアと通信するアプリケーションでは、これを増やすことを検討してください。 | 1000 |
| enable32BitAppOnWin64 | True の場合、64ビットプロセッサを搭載したコンピューターで32ビットアプリケーションを実行できます。<br><br>メモリ使用量が問題になる場合は、32ビットモードを有効にすることを検討してください。 ポインターのサイズと命令のサイズが小さいため、32ビットアプリケーションでは、64ビットアプリケーションよりもメモリ使用量が少なくなります。 64ビットコンピューターで32ビットアプリケーションを実行する場合の欠点は、ユーザーモードのアドレス空間が 4 GB に制限されていることです。 | False |

**Applicationhost.config/sites/VirtualDirectoryDefault**

| 属性 | 説明 | Default |
|--|--|--|
| で allowsubdirconfig | IIS が現在のレベルより低いコンテンツディレクトリ内の web.config ファイルを検索するか (True)、現在のレベルより低いコンテンツディレクトリ内の web.config ファイルを検索するか (False) を指定します。 単純な制限を適用することで、仮想ディレクトリでのみ構成できるようになるため、iisâでは、ファイル** / &lt; 名 &gt; .htm**が仮想ディレクトリでない限り、構成ファイルを検索しないことがわかります。 追加のファイル操作を省略すると、ランダムにアクセスされる静的コンテンツが非常に多い web サイトのパフォーマンスを大幅に向上させることができます。 | True |

## <a name="managing-iis-100-modules"></a>IIS 10.0 モジュールの管理

IIS 10.0 は、モジュール構造をサポートするために、複数のユーザー拡張モジュールに分割されています。 このような場合のコストはわずかです。 各モジュールについて、統合パイプラインはモジュールに関連するすべてのイベントに対してモジュールを呼び出す必要があります。 これは、モジュールが何らかの処理を実行する必要があるかどうかに関係なく発生します。 特定の web サイトに関連しないすべてのモジュールを削除することで、CPU サイクルとメモリを節約できます。

単純な静的ファイル用にチューニングされた web サーバーには、UriCacheModule、HttpCacheModule、StaticFileModule、AnonymousAuthenticationModule、HttpLoggingModule という5つのモジュールのみを含めることができます。

applicationHost.config からモジュールを削除するには、system.webserver/globalModules のモジュール宣言を削除するだけでなく、system.webserver/ハンドラおよび system.webserver/modules セクションからモジュールへのすべての参照を削除します。

## <a name="classic-asp-settings"></a>Classic ASP の設定

従来の ASP 要求の処理にかかる大きなコストには、スクリプトエンジンの初期化、要求された ASP スクリプトの ASP テンプレートへのコンパイル、スクリプトエンジンでのテンプレートの実行などがあります。 テンプレートの実行コストは要求された ASP スクリプトの複雑さに依存しますが、IIS classic ASP モジュールはメモリとディスクの両方にスクリプトエンジンをキャッシュできます (メモリ内のテンプレートキャッシュオーバーフローの場合のみ)。これにより、CPU バインドのシナリオでのパフォーマンスが向上します。

次の設定は、従来の ASP テンプレートキャッシュとスクリプトエンジンのキャッシュを構成するために使用され、ASP.NET の設定には影響しません。

**System.webserver/asp/cache**

| 属性 | 説明 | Default |
|--|--|--|
| diskTemplateCacheDirectory | メモリ内キャッシュがオーバーフローした場合に ASP がコンパイル済みテンプレートを格納するために使用するディレクトリの名前。<br><br>推奨: オペレーティングシステム、IIS ログ、またはその他の頻繁にアクセスされるコンテンツと共有されていないドライブなど、あまり使用されていないディレクトリに設定します。 | %SystemDrive%\inetpub\temp\ASP Compiled Templates |
| maxDiskTemplateCacheFiles | ディスクにキャッシュできるコンパイル済み ASP テンプレートの最大数を指定します。<br><br>推奨: 0x7FFFFFFF の最大値に設定します。 | 2000 |
| scriptFileCacheSize | この属性は、メモリにキャッシュできるコンパイル済み ASP テンプレートの最大数を指定します。<br><br>推奨事項: アプリケーションプールによって提供される、頻繁に要求される ASP スクリプトの数以上に設定します。 可能であれば、メモリ制限で許可されている数の ASP テンプレートに設定します。 | 500 |
| scriptEngineCacheMax | メモリ内にキャッシュされるスクリプトエンジンの最大数を指定します。<br><br>推奨事項: アプリケーションプールによって提供される、頻繁に要求される ASP スクリプトの数以上に設定します。 可能であれば、メモリ制限で許可されている数のスクリプトエンジンをに設定します。 | 250 |

**System.webserver/asp/limits**

| 属性 | 説明 | Default |
|--|--|--|
| processorThreadMax | ASP が作成できる、プロセッサごとのワーカースレッドの最大数を指定します。 現在の設定が負荷を処理するのに十分ではない場合には増加します。これにより、要求の処理中、または CPU リソースの使用率が原因でエラーが発生する可能性があります。 | 25 |

**System.webserver/asp/comPlus**

| 属性 | 説明 | Default |
|--|--|--|
| executeInMta | IIS が ASP コンテンツを提供している間にエラーまたはエラーが検出された場合は、 **True**に設定します。 これは、たとえば、各サイトが独自のワーカープロセスで実行される複数の分離されたサイトをホストする場合に発生することがあります。 エラーは通常、イベントビューアーの COM + から報告されます。 この設定により、ASP でマルチスレッドアパートメントモデルが有効になります。 | False |

## <a name="aspnet-concurrency-setting"></a>ASP.NET concurrency の設定

### <a name="aspnet-35"></a>ASP.NET 3.5
既定では、ASP.NET は要求の同時実行を制限して、サーバー上の安定したメモリ使用量を削減します。 高い同時実行アプリケーションでは、全体的なパフォーマンスを向上させるために一部の設定を調整する必要がある場合があります。 この設定は aspnet.config ファイルで変更できます。

``` syntax
<system.web>
  <applicationPool maxConcurrentRequestsPerCPU="5000"/>
</system.web>
```

システム上のリソースを完全に使用するには、次の設定が役立ちます。

-   **maxConcurrentRequestPerCpu**既定値: 5000

    この設定は、システムで同時に実行される ASP.NET 要求の最大数を制限します。 既定値は控えめで、ASP.NET アプリケーションのメモリ使用量を削減します。 同期 i/o 操作が長時間実行されるアプリケーションを実行するシステムでは、この制限を引き上げることを検討してください。 そうしないと、既定の設定が使用されていると、キューの制限が高負荷の場合に発生するため、キューまたは要求の失敗が原因で、待機時間が長くなる可能性があります。

### <a name="aspnet-46"></a>ASP.NET 4.6
MaxConcurrentRequestPerCpu の設定に加えて、ASP.NET 4.7 には、非同期操作に頻繁に依存するアプリケーションのパフォーマンスを向上させるための設定も用意されています。 この設定は aspnet.config ファイルで変更できます。

``` syntax
<system.web>
  <applicationPool percentCpuLimit="90" percentCpuLimitMinActiveRequestPerCpu="100"/>
</system.web>
```

-   **percentCpuLimit**既定値:90 非同期要求には、(ハードウェア機能を超えた) 大きな負荷が発生した場合に、スケーラビリティの問題がいくつかあります。 この問題は、非同期シナリオでの割り当ての性質に起因します。 このような状況では、非同期操作の開始時に割り当てが行われ、完了時に割り当てられます。 その時点で、itâs は、オブジェクトが GC によってジェネレーション1または2に移動された可能性があります。 この場合、負荷を上げると、1秒あたりの要求数 (rps) が増加します。 このポイントに到達すると、GC で費やされた時間が問題になり、rps は dip を開始し、負のスケーリング効果が適用されます。 この問題を解決するには、cpu 使用率が percentCpuLimit の設定を超えると、要求が ASP.NET ネイティブキューに送信されます。
-   **percentCpuLimitMinActiveRequestPerCpu**既定値: 100 CPU 調整 (percentCpuLimit 設定) は、要求の数に基づいていませんが、コストが高くなります。 その結果、大量の CPU を集中的に使用する要求が発生し、ネイティブキューでバックアップが実行され、受信要求とは別に空にすることができなくなる可能性があります。 この problme を解決するために、percentCpuLimitMinActiveRequestPerCpu を使用して、調整が開始される前に最小数の要求が提供されるようにすることができます。

## <a name="worker-process-and-recycling-options"></a>ワーカープロセスとリサイクルのオプション

IIS ワーカープロセスをリサイクルするためのオプションを構成し、サービスやコンピューターの介入やリセットを行わずに、特別な解決策やイベントに実用的なソリューションを提供できます。 このような状況やイベントには、メモリリーク、メモリ負荷の増加、または応答していないワーカープロセスやアイドル状態のワーカープロセスなどがあります。 通常の状況下では、リサイクルオプションは不要であり、リサイクルはオフにすることができます。また、システムのリサイクルを非常に頻繁に構成することもできます。

**リサイクル/周期再開**要素に属性を追加することで、特定のアプリケーションのプロセスリサイクルを有効にすることができます。 リサイクルイベントは、メモリ使用量、一定の数の要求、固定された期間など、いくつかのイベントによってトリガーできます。 ワーカープロセスがリサイクルされると、キューに入っている要求と実行中の要求がドレインされ、新しいプロセスが同時に開始され、新しい要求を処理します。 **リサイクル/周期再開**要素はアプリケーションごとに使用されます。つまり、次の表の各属性は、アプリケーションごとにパーティション分割されます。

**Applicationhost.config/applicationPools/ApplicationPoolDefaults/リサイクル/周期再開**

| 属性 | 説明 | Default |
|--|--|--|
| メモリ | 仮想メモリの使用量が指定された制限 (kb 単位) を超える場合は、プロセスのリサイクルを有効にします。 これは、32ビットのコンピューターで、2 GB のアドレス空間が小さい場合に便利な設定です。 これは、メモリ不足エラーが原因で失敗した要求を回避するのに役立ちます。 | 0 |
| privateMemory | プライベートメモリの割り当てが指定された制限 (kb 単位) を超えた場合に、プロセスのリサイクルを有効にします。 | 0 |
| requests | 特定の数の要求の後にプロセスのリサイクルを有効にします。 | 0 |
| time | 指定された期間後のプロセスのリサイクルを有効にします。 | 29:00:00 |

## <a name="dynamic-worker-process-page-out-tuning"></a>動的なワーカープロセスのページアウトチューニング

Windows Server 2012 R2 以降、IIS では、しばらくの間アイドル状態になった後に、ワーカープロセスを中断するように構成するオプションが用意されています (IIS 7 以降に存在していた terminate オプションに加えて)。

アイドル状態のワーカープロセスのページアウトとアイドル状態のワーカープロセスの終了機能の主な目的は、サーバーのメモリ使用量を節約することです。これは、サイトが座っている間でも大量のメモリを消費する可能性があるためです。 サイトで使用されているテクノロジ (静的なコンテンツと、他のフレームワーク) によっては、使用されるメモリが約 10 MB から数百 mb になることがあります。これは、サーバーが多数のサイトで構成されている場合、サイトに対して最も効果的な設定を行うことで、アクティブサイトと中断サイトの両方の

詳細に進む前に、メモリの制約がない場合は、単に一時停止または終了しないようにサイトを設定することをお勧めします。 結局のところ、ワーカープロセスがコンピューター上に1つしかない場合は、thereâs の値を小さくします。

> [!NOTE]
> メモリリークが発生しているコードや不安定なコードなど、サイトで不安定なコードが実行されている場合、アイドル時に終了するようにサイトを設定すると、コードのバグを修正するための代替手段になります。 これは推奨される方法ではありませんが、高速処理では、この機能をクリーンアップメカニズムとして使用する方が適切な場合があります。\]

考慮すべきもう1つの要因は、サイトで大量のメモリを使用している場合、コンピューターがワーカープロセスによって使用されるデータをディスクに書き込む必要があるため、中断プロセス自体は有料になります。 ワーカープロセスが大量のメモリを使用している場合、バックアップを開始するまで待機する必要があるコストよりも時間がかかることがあります。

ワーカープロセスの中断機能を最大限に活用するには、各アプリケーションプール内のサイトを確認し、中断する必要があるものを決定して、中断する必要があることと、無期限にアクティブにする必要があるかどうかを決定する必要があります。 各アクションと各サイトについて、最適なタイムアウト期間を把握する必要があります。

中断または終了のために構成するサイトは、毎日訪問者を持つサイトであることが理想ですが、常にアクティブな状態を維持するためには十分ではありません。 これらは通常、1日以内に20人の一意の訪問者がいるサイトです。 サイトのログファイルを使用してトラフィックパターンを分析し、平均日次トラフィックを計算することができます。

特定のユーザーがサイトに接続すると、通常は少なくともしばらくの間はそのまま維持され、追加の要求が行われるため、1日あたりの要求数を数えるだけで実際のトラフィックパターンが正確に反映されないことに注意してください。 より正確な情報を取得するために、Microsoft Excel などのツールを使用して、要求間の平均時間を計算することもできます。 次に例を示します。

| Number | 要求 URL | 要求時間 | 差分 |
|--|--|--|--|
| 1 | /Sourcesilver電球/grosource.html | 10:01 |  |
| 2 | /Sourcesilverload/dns/sliverlight.js | 10:10 | 0:09 |
| 3 | /SourceSilverLight/Geosource.web/clientbin/geo/1.aspx | 10:11 | 0:01 |
| 4 | /lClientAccessPolicy.xml | 10:12 | 0:01 |
| 5 | /SourceSilverLight/GeosourcewebService/Service .asmx | 10:23 | 0:11 |
| 6 | /SourceSilverLight/Geosource. web/GeoSearchServer... ヲ。 | 11:50 | 1:27 |
| 7 | /rest/Services/CachedServices/Silverlight_load_la...? | 12:50 | 1:00 |
| 8 | /rest/Services/CachedServices/Silverlight_basemap...? | 12:51 | 0:01 |
| 9 | /rest/Services/DynamicService/Silverlight_basemap...? | 12:59 | 0:08 |
| 10 | /rest/Services/CachedServices/Ortho_2004_cache... | 13:40 | 0:41 |
| 11 | /rest/Services/CachedServices/Ortho_2005_cache.js | 13:40 | 0:00 |
| 12 | /rest/Services/CachedServices/OrthoBaseEngine.aspx | 13:41 | 0:01 |

しかし、難しいのは、どのような設定を適用するかを理解することです。 この場合、サイトはユーザーから多数の要求を取得し、上の表は4時間の間に合計4つの一意のセッションが発生したことを示しています。 アプリケーションプールのワーカープロセスの中断に関する既定の設定では、サイトは既定のタイムアウトである20分の後に終了します。これは、これらの各ユーザーがサイトのスピンアップサイクルを経験することを意味します。 このため、ワーカープロセスの中断に最適な候補となります。ほとんどの場合、サイトはアイドル状態であるため、中断するとリソースが節約され、ユーザーはほぼ瞬時にサイトに接続できるようになります。

この機能については、最終的に重要な注意事項として、ディスクのパフォーマンスが非常に重要になります。 中断およびウェイクアッププロセスでは、大量のデータをハードドライブに書き込んで読み取る必要があるため、このためには高速ディスクを使用することを強くお勧めします。 このためには、ソリッドステートドライブ (Ssd) が最適で、強く推奨されます。また、Windows ページファイルがその上に格納されていることを確認する必要があります (オペレーティングシステム自体が SSD にインストールされていない場合は、ページファイルを移動するようにオペレーティングシステムを構成します)。

SSD を使用するかどうかにかかわらず、ファイルサイズ変更なしでページアウトデータの書き込みに対応するために、ページファイルのサイズを修正することもお勧めします。 ページファイルのサイズ変更は、オペレーティングシステムがページファイルにデータを格納する必要がある場合に発生する可能性があります。既定では、Windows は必要に応じて自動的にサイズを調整するように構成されているためです。 サイズを固定された値に設定すると、サイズ変更やパフォーマンスの向上を防ぐことができます。

事前に固定されたページファイルサイズを構成するには、中断するサイトの数と使用するメモリの量に応じて、理想的なサイズを計算する必要があります。 アクティブなワーカープロセスの平均が 200 MB で、中断するサーバーに500サイトがある場合は、ページファイル \* の基本サイズ (この例では base + 100 GB) に対して、ページファイルが (200 500) MB 以上である必要があります。

> [!NOTE]
> サイトが中断されると、それぞれ約 6 MB が消費されます。この場合、すべてのサイトが中断された場合のメモリ使用量は約 3 GB になります。 しかし、実際には、youâre がすべて同時に中断されることはありません。

## <a name="transport-layer-security-tuning-parameters"></a>トランスポート層のセキュリティチューニングパラメーター

TLS (Transport Layer Security) を使用すると、追加の CPU コストがかかります。 TLS の最も負荷の高いコンポーネントは、完全なハンドシェイクを伴うため、セッションの確立を確立するコストです。 再接続、暗号化、および暗号化解除もコストに追加されます。 TLS のパフォーマンスを向上させるには、次の手順を実行します。

-   TLS セッションの HTTP キープアライブを有効にします。 これにより、セッションの確立コストが削減されます。

-   特にキープアライブ以外のトラフィックについては、必要に応じてセッションを再利用します。

-   サイト全体ではなく、必要なページまたはサイトの一部にのみ暗号化を選択的に適用します。

> [!NOTE]
> - キーを大きくするとセキュリティが強化されますが、CPU 時間も長くなります。
> - すべてのコンポーネントを暗号化する必要はありません。 ただし、plain HTTP と HTTPS を混在させると、ページ上のすべてのコンテンツがセキュリティで保護されているわけではないという警告が表示されることがあります。

## <a name="internet-server-application-programming-interface-isapi"></a>インターネットサーバーアプリケーションプログラミングインターフェイス (ISAPI)

ISAPI アプリケーションでは、特別なチューニングパラメーターは必要ありません。 プライベート ISAPI 拡張機能を作成する場合は、パフォーマンスとリソースの使用のために作成されていることを確認してください。

## <a name="managed-code-tuning-guidelines"></a>マネージコードのチューニングガイドライン

IIS 10.0 の統合パイプラインモデルを使用すると、柔軟性と拡張性を高めることができます。 ネイティブコードまたはマネージコードで実装されたカスタムモジュールは、パイプラインに挿入することも、既存のモジュールを置き換えることもできます。 この拡張モデルでは利便性と簡潔さが提供されていますが、グローバルイベントにフックする新しいマネージモジュールを挿入する前に注意する必要があります。 グローバルマネージモジュールを追加することは、静的ファイル要求を含むすべての要求がマネージコードに触れる必要があることを意味します。 カスタムモジュールは、ガベージコレクションなどのイベントの影響を受けやすくなります。 また、ネイティブコードとマネージコードの間でデータをマーシャリングするため、カスタムモジュールによって CPU コストが大幅に削減されます。 可能な場合は、前提条件をマネージモジュールの managedHandler に設定する必要があります。

コールド起動のパフォーマンスを向上させるには、ASP.NET web サイトをプリコンパイルするか、IIS アプリケーション初期化機能を活用してアプリケーションをウォームアップします。

セッション状態が不要な場合は、ページごとにオフにしてください。

多数の i/o バインド操作がある場合は、より優れたスケーラビリティを提供する、関連する Api の非同期バージョンを使用するようにしてください。

また、出力キャッシュを適切に使用すると、web サイトのパフォーマンスも向上します。

分離モード (サイトごとに1つのアプリケーションプール) に ASP.NET スクリプトを含む複数のホストを実行する場合は、メモリ使用量を監視します。 サーバーに、予想される数のアプリケーションプールを同時に実行するのに十分な RAM があることを確認します。 複数の分離されたプロセスではなく、複数のアプリケーションドメインを使用することを検討してください。

## <a name="other-issues-that-affect-iis-performance"></a>IIS のパフォーマンスに影響するその他の問題

IIS のパフォーマンスに影響する可能性がある問題を次に示します。

-   キャッシュ対応ではないフィルターのインストール

    HTTP キャッシュ対応ではないフィルターをインストールすると、IIS はキャッシュを完全に無効にするため、パフォーマンスが低下します。 IISÂより前に記述された ISAPI フィルターでは、この動作が発生する可能性があります。

-   Common Gateway Interface (CGI) 要求

    パフォーマンス上の理由から、IIS では CGI アプリケーションを使用して要求を処理することはお勧めできません。 多くの場合、CGI プロセスの作成と削除には大きなオーバーヘッドが伴います。 代替手段として、FastCGI、ISAPI アプリケーションスクリプト、ASP スクリプト、ASP.NET スクリプトを使用する方法があります。 これらの各オプションで分離を使用できます。

## <a name="additional-references"></a>その他のリファレンス

- [Web サーバーのパフォーマンスチューニング](index.md)
- [HTTP 1.1/2 のチューニング](http-performance.md)
