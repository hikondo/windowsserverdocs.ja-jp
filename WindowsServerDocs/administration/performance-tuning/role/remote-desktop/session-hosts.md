---
title: リモートデスクトップセッションホストのパフォーマンスチューニング
description: リモートデスクトップセッションホストのパフォーマンスチューニングガイドライン
ms.topic: article
ms.author: hammadbu
author: phstee
ms.date: 10/22/2019
ms.openlocfilehash: 82a89454cfab7cda9de4375c843cde81af5b0544
ms.sourcegitcommit: 7cacfc38982c6006bee4eb756bcda353c4d3dd75
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 09/14/2020
ms.locfileid: "90078179"
---
# <a name="performance-tuning-remote-desktop-session-hosts"></a>リモートデスクトップセッションホストのパフォーマンスチューニング


このトピックでは、リモートデスクトップセッションホスト (RD セッションホスト) ハードウェアを選択する方法、ホストを調整する方法、およびアプリケーションを調整する方法について説明します。

**このトピックの内容:**

-   [パフォーマンスのための適切なハードウェアの選択](#selecting-the-proper-hardware-for-performance)

-   [リモートデスクトップセッションホスト用のアプリケーションのチューニング](#tuning-applications-for-remote-desktop-session-host)

-   [チューニングパラメーターのリモートデスクトップセッションホスト](#remote-desktop-session-host-tuning-parameters)

## <a name="selecting-the-proper-hardware-for-performance"></a>パフォーマンスのための適切なハードウェアの選択


RD セッションホストサーバーの展開では、ハードウェアの選択はアプリケーションセットと、ユーザーがどのように使用するかによって決まります。 ユーザーの数とそのエクスペリエンスに影響を与える主な要因は、CPU、メモリ、ディスク、およびグラフィックスです。 このセクションには、RD セッションホストサーバーに固有の追加のガイドラインが含まれており、主に RD セッションホストサーバーのマルチユーザー環境に関連しています。

### <a name="cpu-configuration"></a>CPU 構成

CPU 構成は、一時的なスパイクを処理するためのバッファーゾーンを維持したまま、必要な CPU とシステムがサポートしているセッションの数でセッションをサポートするために必要な CPU を乗算することによって、概念的に決定されます。 複数の論理プロセッサを使用すると、異常な CPU 輻輳状態を減らすことができます。通常、これは、類似した数の論理プロセッサに含まれるオーバーアクティブなスレッド数が少ない場合に発生します。

したがって、システム上の論理プロセッサが多くなるほど、CPU 使用率の推定に組み込む必要があるクッションの余白が低くなり、CPU あたりのアクティブな負荷の割合が大きくなります。 覚えておく必要がある1つの重要な要素は、cpu の数が2倍になっていないということです。

### <a name="memory-configuration"></a>メモリ構成

メモリの構成は、ユーザーが使用するアプリケーションに依存します。ただし、次の式を使用して、必要なメモリ量を推定することができます。 TotalMem = OSMem + SessionMem \* NS

OSMem は、オペレーティングシステムの実行に必要なメモリの量 (システムバイナリイメージ、データ構造など)、1つのセッションで実行されているメモリプロセスの量を要求します。また、NS は、アクティブなセッションの目標数です。 セッションに必要なメモリの量は、ほとんどの場合、セッション内で実行されているアプリケーションとシステムプロセスのプライベートメモリ参照セットによって決まります。 システム上に1つのコピーしか存在しないため、共有コードまたはデータページの効果はほとんどありません。

1つの注目すべき監視 (ページファイルをバックアップしているディスクシステムが変更されないことを前提としています) は、システムがサポートする同時アクティブセッションの数が多いということです。つまり、セッションごとのメモリ割り当てが大きくなります。 セッションごとに割り当てられたメモリの量が増加していない場合、アクティブなセッションによって生成されるページフォールトの数は、セッションの数によって増加します。 これらの障害によって、最終的に i/o サブシステムが過負荷になります。 セッションごとに割り当てられるメモリの量を増やすことで、ページフォールトが発生する確率が低下します。これにより、ページフォールトの全体的な速度が低下します。

### <a name="disk-configuration"></a>ディスク構成

記憶域は、RD セッションホストサーバーを構成するときに見落とされる最も見過ごされた側面の1つであり、フィールドに展開されるシステムで最も一般的な制限となります。

一般的な RD セッションホストサーバーで生成されるディスクアクティビティは、次の領域に影響します。

-   システムファイルとアプリケーションバイナリ

-   ページファイル

-   ユーザープロファイルとユーザーデータ

これらの領域は、個別の記憶装置によってバックアップされるのが理想的です。 ストライピング RAID 構成またはその他の種類の高パフォーマンスストレージを使用すると、パフォーマンスがさらに向上します。 バッテリを使用した書き込みキャッシュでは、ストレージアダプターを使用することを強くお勧めします。 ディスク書き込みキャッシュを使用するコントローラーでは、同期書き込み操作のサポートが強化されています。 すべてのユーザーには個別の hive があるため、同期書き込み操作は RD セッションホストサーバーでは非常に一般的です。 レジストリハイブは、同期書き込み操作を使用して定期的にディスクに保存されます。 これらの最適化を有効にするには、ディスク管理コンソールで、目的のディスクの [ **プロパティ** ] ダイアログボックスを開き、[ **ポリシー** ] タブで、[ **ディスクの書き込みキャッシュを有効に** する] チェックボックスをオンにして、[デバイスの書き込みキャッシュを有効にする] チェックボックスを **オフ** にします。

### <a name="network-configuration"></a>ネットワーク構成

RD セッションホストサーバーのネットワーク使用率には、次の2つの主なカテゴリがあります。

-   RD セッションホスト接続トラフィックの使用量は、セッション内で実行されているアプリケーションとリダイレクトされたデバイスの i/o トラフィックによって発生する描画パターンによって、ほぼ排他的に決定されます。

    たとえば、テキスト処理とデータ入力を処理するアプリケーションでは、約 10 ~ 100 kbps の帯域幅が使用されます。一方、豊富なグラフィックスやビデオの再生では、帯域幅の使用量が大幅に増加します。

-   ローミングプロファイル、アプリケーションアクセス、ファイル共有、データベースサーバー、電子メールサーバー、HTTP サーバーなどのバックエンド接続。

    ネットワークトラフィックのボリュームとプロファイルは、各展開に固有です。

## <a name="tuning-applications-for-remote-desktop-session-host"></a>リモートデスクトップセッションホスト用のアプリケーションのチューニング


RD セッションホストサーバーの CPU 使用率の大部分は、アプリによって駆動されます。 通常、デスクトップアプリは、アプリケーションがユーザーの要求に応答するまでにかかる時間を最小限に抑えることを目的として、応答性に合わせて最適化されています。 ただし、サーバー環境では、他のセッションに悪影響を及ぼさないように、操作を完了するために必要な CPU 使用率の合計を最小限に抑えることが、同様に重要です。

RD セッションホストサーバーで使用するアプリを構成するときは、次の推奨事項を考慮してください。

-   バックグラウンドアイドルループ処理の最小化

    一般的な例として、バックグラウンドの文法とスペルチェック、検索のためのデータインデックス作成、およびバックグラウンド保存が無効になっています。

-   アプリが状態の確認または更新を実行する頻度を最小限に抑えます。

    このような動作を無効にしたり、ポーリングの反復とタイマーの起動の間隔を長くしたりすると、多くのアクティブなセッションでこのようなアクティビティの効果が急速に増幅されるので、CPU 使用率が大幅に向上します。 一般的な例としては、接続状態アイコンやステータスバー情報の更新などがあります。

-   同期の頻度を減らすことで、アプリ間のリソースの競合を最小限に抑えます。

    このようなリソースの例としては、レジストリキーや構成ファイルなどがあります。 アプリケーションのコンポーネントと機能の例としては、状態インジケーター (シェル通知など)、バックグラウンドのインデックス作成または変更の監視、オフライン同期などがあります。

-   ユーザーのサインインまたはセッションの開始から開始するように登録されている不要なプロセスを無効にします。

    これらのプロセスは、新しいユーザーセッションを作成するときに CPU 使用率のコストに大幅に寄与する可能性があります。通常は CPU を集中的に使用するプロセスであり、朝のシナリオでは非常にコストがかかる可能性があります。 MsConfig.exe または MsInfo32.exe を使用して、ユーザーのサインインで開始されたプロセスの一覧を取得します。 詳細については、「 [autoruns.exe For Windows](/sysinternals/downloads/autoruns)」を参照してください。

メモリ使用量については、次の点を考慮する必要があります。

-   アプリによって読み込まれた Dll が再配置されていないことを確認します。

    -   再配置された Dll を確認するには、プロセス [エクスプローラー](/sysinternals/downloads/process-explorer)を使用して、次の図に示すように、[Dll の処理] ビューを選択します。

    -   ここでは、x.dll 既定のベースアドレスが既に使用されていて、ASLR が有効になっていなかったため y.dll が再配置されたことがわかります。

        ![再配置 (dll を)](../../media/perftune-guide-relocated-dlls.png)

        Dll を再配置すると、セッション間でコードを共有することができなくなるため、セッションのフットプリントが大幅に増加します。 これは、RD セッションホストサーバー上のメモリ関連の最も一般的なパフォーマンスの問題の1つです。

-   共通言語ランタイム (CLR) アプリケーションの場合は、ネイティブイメージジェネレーター (Ngen.exe) を使用して、ページの共有を増やし、CPU のオーバーヘッドを削減します。

    可能であれば、同様の手法を他の同様の実行エンジンに適用します。

## <a name="remote-desktop-session-host-tuning-parameters"></a>チューニングパラメーターのリモートデスクトップセッションホスト


### <a name="page-file"></a>ページファイル

ページファイルのサイズが不十分な場合、アプリまたはシステムコンポーネントでメモリ割り当てエラーが発生する可能性があります。 メモリからコミットされたバイト数パフォーマンスカウンターを使用して、システム上にあるコミット済みの仮想メモリの量を監視できます。

### <a name="antivirus"></a>ウイルス対策

RD セッションホストサーバーにウイルス対策ソフトウェアをインストールすると、システム全体のパフォーマンス、特に CPU 使用率に大きく影響します。 特にサービスやその他のシステムコンポーネントによって生成される一時ファイルを保持するすべてのフォルダーを、アクティブな監視一覧から除外することを強くお勧めします。

### <a name="task-scheduler"></a>タスク スケジューラ

タスクスケジューラでは、さまざまなイベントに対してスケジュールされたタスクの一覧を確認できます。 RD セッションホストサーバーでは、アイドル状態で実行するように構成されているタスク、ユーザーのサインイン時、セッションの接続と切断時に実行するように構成されているタスクに特に重点を置いておくと便利です。 展開の詳細により、これらのタスクの多くは不要な場合があります。

### <a name="desktop-notification-icons"></a>デスクトップ通知アイコン

デスクトップ上の通知アイコンは、かなり高価な更新メカニズムを備えています。 通知は、スタートアップリストから登録するコンポーネントを削除するか、アプリとシステムコンポーネントの構成を変更して無効にすることによって無効にする必要があります。 [通知の **カスタマイズ] アイコン** を使用して、サーバーで使用可能な通知の一覧を確認できます。

### <a name="remote-desktop-protocol-data-compression"></a>データ圧縮のリモートデスクトッププロトコル

リモートデスクトッププロトコル圧縮を構成するには、[**コンピューターの構成**] の下にあるグループポリシーを使用し &gt; **Administrative Templates** &gt; ます。 [ **Windows コンポーネント** &gt; **リモートデスクトップサービス** &gt; **リモートデスクトップセッションホスト** &gt; **リモートセッション環境**管理用テンプレート &gt; **RemoteFX データの圧縮を構成**します。 次の3つの値が考えられます。

-   **使用量が少ないメモリに最適化** は、セッションごとに最小限のメモリを消費しますが、圧縮率が最も低く、帯域幅の消費量が最も高くなります。

-   **メモリとネットワーク帯域幅のバランスを** 取るメモリ消費量の増加に伴う帯域幅の消費の削減 (セッションあたり約 200 KB)。

-   **使用するネットワーク帯域幅が少なくなるように最適化** セッションあたり約 2 MB のコストで、ネットワーク帯域幅の使用量をさらに削減します。 この設定を使用する場合は、サーバーを運用環境に配置する前に、セッションの最大数を評価し、この設定でそのレベルまでテストする必要があります。

また、リモートデスクトッププロトコル圧縮アルゴリズムを使用しないように選択することもできます。そのため、ネットワークトラフィックを最適化するように設計されたハードウェアデバイスでのみ使用することをお勧めします。 圧縮アルゴリズムを使用しない場合でも、一部のグラフィックスデータは圧縮されます。

### <a name="device-redirection"></a>デバイス リダイレクト

デバイスリダイレクトを構成するには、[ **コンピューターの構成** &gt; **管理用テンプレート** &gt; **Windows コンポーネント** &gt; **リモートデスクトップサービス** &gt; **リモートデスクトップセッションホスト** &gt; **デバイスとリソースのリダイレクト** ] の下にあるグループポリシーを使用するか、サーバーマネージャーの [ **セッションコレクション** のプロパティ] ボックスを使用します。

一般に、デバイスのリダイレクトでは、クライアントコンピューター上のデバイスとサーバーセッションで実行されているプロセスとの間でデータが交換されるため、サーバー接続で使用されるネットワーク帯域幅 RD セッションホストの量が増加します。 増加の程度は、リダイレクトされたデバイスに対してサーバーで実行されているアプリケーションによって実行される操作の頻度です。

また、プリンターのリダイレクトとプラグアンドプレイデバイスのリダイレクトにより、サインイン時の CPU 使用率も増加します。 プリンターをリダイレクトするには、次の2つの方法があります。

-   プリンタのドライバをサーバーにインストールする必要がある場合に、プリンタドライバベースのリダイレクトを照合します。 以前のリリースの Windows Server では、このメソッドが使用されていました。

-   Windows Server 2008 で導入された Easy Print プリンタードライバーのリダイレクトでは、すべてのプリンターに共通のプリンタードライバーが使用されます。

印刷方法をお勧めします。これは、接続時にプリンターをインストールする際の CPU 使用率が低くなるためです。 ドライバーの一致方法を使用すると、スプーラサービスがさまざまなドライバーを読み込む必要があるため、CPU 使用率が増加します。 帯域幅の使用量については、簡単に印刷すると、ネットワーク帯域幅の使用量がわずかに増加しますが、他のパフォーマンス、管理容易性、信頼性の利点を相殺するのに十分ではありません。

オーディオのリダイレクトにより、ネットワークトラフィックが安定したストリームになります。 また、オーディオリダイレクトを使用すると、CPU 消費量が多いマルチメディアアプリをユーザーが実行できます。

### <a name="client-experience-settings"></a>クライアントエクスペリエンスの設定

既定では、リモートデスクトップ接続 (RDC) は、サーバーとクライアントコンピューター間のネットワーク接続の適合性に基づいて、適切なエクスペリエンス設定を自動的に選択します。 RDC の構成は、 **接続の品質を自動的に検出**することをお勧めします。

高度なユーザーの場合、RDC を使用すると、リモートデスクトップサービス接続のネットワーク帯域幅のパフォーマンスに影響するさまざまな設定を制御できます。 リモートデスクトップ接続の [ **エクスペリエンス** ] タブを使用するか、RDP ファイルの設定として、次の設定にアクセスできます。

任意のコンピューターに接続するときに、次の設定が適用されます。

-   **壁紙を無効** にする (壁紙を無効にする: i: 0) リダイレクトされた接続でデスクトップの壁紙を表示しません。 デスクトップの壁紙が画像などのコンテンツで構成されており、描画にかなりのコストがかかる場合、この設定によって帯域幅の使用量を大幅に削減できます。

-   **ビットマップキャッシュ** (bitmapcachepersistenable: i: 1) この設定を有効にすると、セッションでレンダリングされるビットマップのクライアント側キャッシュが作成されます。 帯域幅の使用が大幅に改善され、セキュリティ上の考慮事項が他にない限り、常に有効にする必要があります。

-   **ドラッグ中にウィンドウの内容を表示** する (完全なウィンドウのドラッグを無効にする: i: 1) この設定を無効にすると、ウィンドウをドラッグしたときにすべてのコンテンツではなく、ウィンドウフレームだけを表示することで帯域幅が削減されます。

-   **メニューとウィンドウのアニメーション** (メニュー anims: i: 1 を無効にし、カーソル設定を無効にする: i: 1): これらの設定を無効にすると、メニュー (フェードなど) のアニメーションとカーソルを無効にすることで帯域幅が削減されます。

-   **フォントスムージング** (フォントスムージングの許可: i: 0) は、ClearType フォントレンダリングのサポートを制御します。 Windows 8 または Windows Server 2012 以降を実行しているコンピューターに接続する場合、この設定を有効または無効にしても、帯域幅の使用に大きな影響はありません。 ただし、Windows 7 と Windows 2008 R2 よりも前のバージョンを実行しているコンピューターでは、この設定を有効にすると、ネットワーク帯域幅の使用量が大幅に増加します。

次の設定は、Windows 7 以前のバージョンのオペレーティングシステムを実行しているコンピューターに接続する場合にのみ適用されます。

-   **デスクトップコンポジション** この設定は、Windows 7 または Windows Server 2008 R2 を実行しているコンピューターへのリモートセッションでのみサポートされます。

-   **視覚スタイル** (テーマを無効にする: i: 1) この設定を無効にすると、従来のテーマを使用するテーマの描画を簡略化することで帯域幅が削減されます。

リモートデスクトップ接続内の [ **エクスペリエンス** ] タブを使用すると、接続速度を選択してネットワーク帯域幅のパフォーマンスに影響を与えることができます。 接続速度の構成に使用できるオプションを次に示します。

-   **接続品質を自動的に検出** する (接続の種類: i: 7) この設定を有効にすると、リモートデスクトップ接続によって自動的に設定が選択され、接続の品質に基づいて最適なユーザーエクスペリエンスが得られます。 (この構成は、Windows 8 または Windows Server 2012 以降を実行しているコンピューターに接続する場合に推奨されます)。

-   **モデム (56 Kbps)** (接続の種類: i: 1) この設定では、ビットマップの永続キャッシュが有効になります。

-   **低速度ブロードバンド (256 Kbps-2 Mbps)** (接続の種類: i: 2) この設定では、ビットマップの永続キャッシュと視覚スタイルが有効になります。

-   **携帯電話/サテライト (高待機時間の 2mbps-16 mbps)** (接続の種類: i: 3) この設定では、デスクトップコンポジション、永続ビットマップキャッシュ、視覚スタイル、およびデスクトップの背景が有効になります。

-   **高速ブロードバンド (2 mbps – 10 mbps)** (接続の種類: i: 4) この設定では、デスクトップコンポジション、ドラッグ中のウィンドウの内容の表示、メニューとウィンドウのアニメーション、永続ビットマップキャッシュ、視覚スタイル、およびデスクトップの背景が有効になります。

-   **WAN (待機時間が長い 10 Mbps 以上)** (接続の種類: i: 5) この設定では、デスクトップコンポジション、ドラッグ中のウィンドウの内容の表示、メニューとウィンドウのアニメーション、永続ビットマップキャッシュ、視覚スタイル、およびデスクトップの背景が有効になります。

-   **LAN (10 Mbps 以上)** (接続の種類: i: 6) この設定では、デスクトップコンポジション、ドラッグ中のウィンドウの内容の表示、メニューとウィンドウのアニメーション、ビットマップの永続的なキャッシュ、テーマ、およびデスクトップの背景が有効になります。

### <a name="desktop-size"></a>デスクトップのサイズ

リモートセッションのデスクトップサイズを制御するには、リモートデスクトップ接続の [表示] タブを使用するか、RDP 構成ファイル (desktopwidth: i: 1152 と desktopwidth: i: 864) を使用します。 デスクトップのサイズが大きいほど、そのセッションに関連付けられているメモリと帯域幅の消費量が大きくなります。 現在のデスクトップの最大サイズは 4096 x 2048 です。