---
title: リモートデスクトップ仮想化ホストのパフォーマンスチューニング
description: リモートデスクトップ仮想化ホストのパフォーマンスチューニング
ms.topic: article
ms.author: hammadbu; vladmis; denisgun
author: phstee
ms.date: 10/22/2019
ms.openlocfilehash: 235dd0209030854f1fc883f52ab41550ab693dc5
ms.sourcegitcommit: 68444968565667f86ee0586ed4c43da4ab24aaed
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/07/2020
ms.locfileid: "87992082"
---
# <a name="performance-tuning-remote-desktop-virtualization-hosts"></a>リモートデスクトップ仮想化ホストのパフォーマンスチューニング

リモートデスクトップ仮想化ホスト (RD 仮想化ホスト) は、仮想デスクトップインフラストラクチャ (VDI) シナリオをサポートする役割サービスであり、複数のユーザーが windows Server と Hyper-v を実行するサーバーでホストされている仮想マシンで Windows ベースのアプリケーションを実行できます。

Windows Server では、個人用仮想デスクトップとプールされた仮想デスクトップという2種類の仮想デスクトップがサポートされています。

## <a name="general-considerations"></a>一般的な考慮事項

### <a name="storage"></a>記憶域

ストレージは、パフォーマンスのボトルネックとなる可能性が高いので、仮想マシンの状態の変更によって生成される i/o 負荷を適切に処理するために、記憶域のサイズを変更することが重要です。 パイロットまたはシミュレーションが不可能な場合は、4つのアクティブな仮想マシン用に1つのディスクスピンドルをプロビジョニングすることをお勧めします。 書き込みパフォーマンスが良好なディスク構成 (RAID 1 + 0 など) を使用します。

必要に応じて、ディスクの重複除去とキャッシュを使用してディスクの読み取り負荷を軽減し、記憶域ソリューションを有効にして、イメージの重要な部分をキャッシュすることでパフォーマンスを向上させます。

### <a name="data-deduplication-and-vdi"></a>データ重複除去と VDI

Windows Server 2012 R2 で導入されたデータ重複除去では、開いているファイルの最適化をサポートしています。 重複除去ボリュームで実行されている仮想マシンを使用するには、仮想マシンファイルを Hyper-v ホストとは別のホストに格納する必要があります。 Hyper-v と重複除去が同じコンピューター上で実行されている場合、2つの機能はシステムリソースに対して競合し、全体のパフォーマンスに悪影響を与えます。

また、"仮想デスクトップインフラストラクチャ (VDI)" 重複除去の最適化の種類を使用するようにボリュームを構成する必要があります。 これを構成するには、サーバーマネージャー (**ファイルサービスおよび記憶域サービス**  - &gt; **ボリューム**の  - &gt; **重複除去設定**) を使用するか、次の Windows PowerShell コマンドを使用します。

``` syntax
Enable-DedupVolume <volume> -UsageType HyperV
```

> [!NOTE]
> 開いているファイルのデータ重複除去の最適化は、SMB 3.0 経由のリモート記憶域を使用する Hyper-v の VDI シナリオでのみサポートされます。

### <a name="memory"></a>メモリ

サーバーのメモリ使用量は、主に次の3つの要因によって決まります。

- オペレーティングシステムのオーバーヘッド

- 仮想マシンごとの hyper-v サービスのオーバーヘッド

- 各仮想マシンに割り当てられたメモリ

一般的なナレッジワーカーワークロードの場合は、x86 ウィンドウ8または Windows 8.1 を実行しているゲスト仮想マシンに、ベースラインとして ~ 512 MB のメモリが割り当てられている必要があります。 ただし、ワークロードによっては、動的メモリによってゲスト仮想マシンのメモリが約 800 MB に増加する可能性があります。 X64 では、約 800 MB が開始され、1024 MB に増加しています。

そのため、予想されるゲスト仮想マシンの数に必要なメモリを満たすために十分なサーバーメモリを確保し、そのサーバーに十分な量のメモリを確保することが重要です。

### <a name="cpu"></a>CPU

RD 仮想化ホストサーバーのサーバー容量を計画する場合、物理コアあたりの仮想マシンの数は、ワークロードの性質によって異なります。 出発点として、物理コアあたり12台の仮想マシンを計画してから、適切なシナリオを実行してパフォーマンスと密度を検証することが妥当です。 ワークロードの詳細によっては、密度が高くなる可能性があります。

ハイパースレッディングを有効にすることをお勧めしますが、論理プロセッサの数ではなく、物理コアの数に基づいてオーバーサブスクリプションの比率を計算することをお勧めします。 これにより、CPU ごとに予想されるパフォーマンスレベルが保証されます。

## <a name="performance-optimizations"></a>パフォーマンスの最適化

### <a name="dynamic-memory"></a>Dynamic Memory

動的メモリを使用すると、実行中の仮想マシン間でメモリを分散する方法を分散することにより、Hyper-v を実行しているサーバーのメモリリソースをより効率的に使用できます。 変化するワークロードに応じて、仮想マシン間でメモリを動的に再割り当てできます。

動的メモリを使用すると、パフォーマンスやスケーラビリティを犠牲にすることなく、既存のリソースで仮想マシンの密度を高めることができます。 その結果、コストのかかるサーバーハードウェアリソースがより効率的に使用されます。これにより、管理が容易になり、コストを削減できます。

複数の論理プロセッサにまたがる仮想プロセッサを使用して Windows 8 以降を実行しているゲストオペレーティングシステムでは、メモリ使用量を最小限に抑え、動的メモリを無効にして、コンピュータートポロジに対応しているアプリケーションのパフォーマンスを向上させるために、動的メモリとの間のトレードオフを考慮してください。 このようなアプリケーションでは、トポロジ情報を活用して、スケジュール設定とメモリ割り当てに関する決定を行うことができます。

### <a name="tiered-storage"></a>階層型記憶域

RD 仮想化ホストは、仮想デスクトッププール用の階層型記憶域をサポートします。 コレクション内のすべてのプールされた仮想デスクトップで共有される物理コンピューターでは、ミラー化されたソリッドステートドライブ (SSD) などの、サイズの小さい高パフォーマンスの記憶域ソリューションを使用できます。 プールされた仮想デスクトップは、RAID 1 + 0 などの低コストの従来の記憶域に配置できます。

物理コンピューターは、プールされた仮想デスクトップからの読み取り i/o のほとんどが管理オペレーティングシステムに移動するため、SSD に配置する必要があります。 そのため、物理コンピューターによって使用される記憶域は、1秒あたりの読み取り i/o の量を大幅に増やす必要があります。

この展開構成では、パフォーマンスが必要な場合に、コスト効果の高いパフォーマンスを保証します。 SSD は、構成に応じて、より小さいサイズのディスク (コレクションあたり最大 20 GB) のパフォーマンスを向上させることができます。 プールされた仮想デスクトップの従来の記憶域 (RAID 1 + 0) では、仮想マシンあたり約 3 GB が使用されます。

### <a name="csv-cache"></a>CSV キャッシュ

Windows Server 2012 以降のフェールオーバークラスタリングでは、クラスター共有ボリューム (CSV) でのキャッシュが提供されます。 これは、読み取り i/o の大部分が管理オペレーティングシステムから取得されるプールされた仮想デスクトップコレクションに対して非常に有益です。 CSV キャッシュを使用すると、2回以上読み取られるブロックがキャッシュされ、システムメモリから配信されるため、i/o を減らすことができるため、パフォーマンスが向上します。 CSV キャッシュの詳細については、「 [Csv キャッシュを有効にする方法](https://blogs.msdn.com/b/clustering/archive/2012/03/22/10286676.aspx)」を参照してください。

### <a name="pooled-virtual-desktops"></a>プールされた仮想デスクトップ

既定では、プールされた仮想デスクトップは、ユーザーがサインアウトした後に不自然状態にロールバックされるため、最後のユーザーのサインイン以降に Windows オペレーティングシステムに加えられた変更は破棄されます。

ロールバックを無効にすることはできますが、仮想デスクトップテンプレートのさまざまな更新によってプールされた仮想デスクトップコレクションが再作成されるので、一時的な状態になります。

永続的な状態に依存する Windows の機能とサービスを無効にすることは理にかなっています。 また、主に非エンタープライズシナリオ用のサービスを無効にすることも意味があります。

各サービスは、広範なデプロイの前に適切に評価される必要があります。 次に、最初に考慮すべき点をいくつか示します。

| サービス                                      | なぜですか?                                                                                                                                                                                                      |
|----------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 自動更新                                  | プールされた仮想デスクトップは、仮想デスクトップテンプレートを再作成することによって更新されます。                                                                                                                          |
| オフライン ファイル                                | 仮想デスクトップは常にオンラインであり、ネットワーク上の観点から接続されています。                                                                                                                         |
| バックグラウンドデフラグ                            | ファイルシステムの変更は、ユーザーがサインオフした後に破棄されます (不自然状態へのロールバック、または仮想デスクトップテンプレートの再作成により、プールされたすべての仮想デスクトップが再作成されます)。 |
| 休止状態またはスリープ状態                           | このような VDI の概念はありません                                                                                                                                                                                   |
| バグチェックメモリダンプ                        | プールされた仮想デスクトップにはこのような概念はありません。 バグチェックのプールされた仮想デスクトップは、不自然状態から開始します。                                                                                       |
| WLAN 自動 autoconfig                              | VDI 用の WiFi デバイスインターフェイスはありません                                                                                                                                                                 |
| Windows Media Player ネットワーク共有サービス | コンシューマー中心のサービス                                                                                                                                                                                  |
| ホームグループプロバイダー                          | コンシューマー中心のサービス                                                                                                                                                                                  |
| インターネット接続の共有                  | コンシューマー中心のサービス                                                                                                                                                                                  |
| Media Center 拡張サービス               | コンシューマー中心のサービス                                                                                                                                                                                  |
> [!NOTE]
> この一覧は、意図された目的とシナリオに影響する変更があるため、完全な一覧ではありません。 詳細については、「ホットオフ」、「今すぐ入手」、「 [Windows 8 VDI の最適化スクリプト」、「PFE!](/archive/blogs/jeff_stokes/hot-off-the-presses-get-it-now-the-windows-8-vdi-optimization-script-courtesy-of-pfe)」を参照してください。


> [!NOTE]
> 既定では、Windows 8 の SuperFetch が有効になっています。 VDI 対応であり、無効にしないでください。 SuperFetch を使用すると、VDI の利点を活用して、メモリページ共有によってメモリ消費をさらに減らすことができます。 Windows 7 を実行するプールされた仮想デスクトップ、SuperFetch は無効にする必要がありますが、Windows 7 を実行している個人用仮想デスクトップの場合は、そのままにしておく必要があります。