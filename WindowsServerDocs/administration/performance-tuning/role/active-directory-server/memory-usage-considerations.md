---
title: AD DS のパフォーマンス チューニングのメモリ使用率に関する考慮事項
description: Windows Server 2012 R2、2016 および 2019 を実行しているドメイン コント ローラーで Lsass.exe プロセスによるメモリ使用量。
ms.prod: windows-server-threshold
ms.technology: performance-tuning-guide
ms.topic: article
ms.author: v-tea; lindakup
author: Teresa-Motiv
ms.date: 7/3/2019
ms.openlocfilehash: dd33124d7d480f3670fa2781f567eaaa28abbce6
ms.sourcegitcommit: be243a92f09048ca80f85d71555ea6ee3751d712
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 07/11/2019
ms.locfileid: "67799784"
---
# <a name="memory-usage-considerations-for-ad-ds-performance-tuning"></a>AD DS のパフォーマンス チューニングのメモリ使用率に関する考慮事項

この記事では、LSASS の構成のベスト プラクティスとメモリ使用量の予測のローカル セキュリティ機関サブシステム サービス (LSASS、Lsass.exe のプロセスとも呼ばれます) の基本について説明します。 この記事では、LSASS のパフォーマンスとメモリの使用の分析でドメイン コント ローラー (Dc) のガイドとして使用する必要があります。 この記事の情報を調整して、サーバー、およびこのエンジンを最適化するために Dc を構成する方法について質問がある場合に便利ですがあります。  

LSASS は、ローカル セキュリティ機関 (LSA) のドメイン認証の管理と Active Directory の管理を担当します。 LSASS は、クライアントとサーバーの両方の認証を処理し、Active Directory エンジンによっても決まります。 LSASS は、次のコンポーネントを担います。  

- ローカル セキュリティ機関
- NetLogon サービス
- セキュリティ アカウント マネージャー (SAM) サービス
- LSA サーバー サービス
- SSL (Secure Sockets Layer)
- Kerberos v5 認証プロトコル
- NTLM 認証プロトコル
- LSA に読み込まれるその他の認証パッケージ

Active Directory データベース サービス (NTDSAI.dll) Extensible Storage Engine (ESE、ESENT.dll) を使用します。

LSASS DC 上のメモリ使用量のビジュアル ダイアグラムを次に示します。

![LSASS のメモリを使用するコンポーネントの図](media/domain-controller-lsass-memory-usage.png)  

Active Directory の使用状況に従って LSASS は、DC 上で使用されるメモリの量が増加します。 データが照会されたときに、メモリにキャッシュされます。 その結果、通常の Active Directory データベース ファイル (NTDS.dit) のサイズより大きいメモリ容量を使用して LSASS、されます。

図のように、LSASS のメモリ使用量は ESE データベースのバッファー キャッシュ、ESE バージョン ストア、およびその他のユーザーを含む、いくつかの部分に分割できます。 この記事の残りの部分では、これらの各パーツに関する洞察を提供します。

## <a name="ese-database-buffer-cache"></a>ESE データベース バッファー キャッシュ  
LSASS 内の最大の変数のメモリ使用率は、ESE データベースのバッファー キャッシュです。 キャッシュのサイズの範囲は 1 MB 未満のデータベース全体のサイズです。 キャッシュ サイズには、パフォーマンスが向上しますが、ため、データベース エンジンの Active Directory (ESENT) は、可能なキャッシュを保持しようとします。 キャッシュのサイズは、コンピューターでのメモリ不足によって異なります、ESE データベースのバッファー キャッシュの最大サイズは*のみ*コンピューターにインストールされている物理メモリによって制限されます。 その他のメモリ不足がない限り、キャッシュは、Active Directory の NTDS.dit データベース ファイルのサイズまで拡張できます。 キャッシュ可能なデータベースのほど、DC のパフォーマンスになります。  
  
> [!NOTE]
> データベースのサイズは、使用可能な ram の容量よりも小さい 64 ビット システムで、アルゴリズムのキャッシュ、データベースの動作方法により、データベースのキャッシュできますよりも大きく、データベースのサイズを 30 ~ 40%。

## <a name="ese-version-store"></a>ESE バージョン ストア

ESE バージョン ストア (上記の図で赤色の部分) で変数のメモリ使用量があります。 使用されるメモリ量は、Windows Server 2019 または Windows の以前のバージョンがあるかどうかによって異なります。

- Windows Server のバージョンが Windows Server 2019 される前では、既定では、ESE バージョンの 64 ビット コンピューター上の (Cpu の数) に応じてメモリの約 400 MB まで LSASS が使用を格納します。 バージョン ストアの使用方法の詳細については、ASKDS ブログ Ryan Ries で投稿を参照してください。[バージョン ストアと呼ばれる、すべてのバケット帯になると](https://techcommunity.microsoft.com/t5/Ask-the-Directory-Services-Team/The-Version-Store-Called-and-They-8217-re-All-Out-of-Buckets/ba-p/400415)します。

- Windows Server の 2019 では、これが簡略化し、ESE バージョン ストアのサイズが 400 MB の最小値、最大 4 GB の RAM、10% として計算されるよう NTDS サービスの最初の開始、ときにします。 すばらしい詳細については、これとバージョン ストアのトラブルシューティング、Ryan Ries から別の優れたブログを参照してください。「[Deep Dive:Active Directory ESE バージョン ストアの変更がサーバー 2019年](https://techcommunity.microsoft.com/t5/Ask-the-Directory-Services-Team/Deep-Dive-Active-Directory-ESE-Version-Store-Changes-in-Server/ba-p/400510)します。

## <a name="other-memory-use"></a>その他のメモリの使用

最後に、あるコード、スタック、ヒープ、および固定サイズのさまざまなデータ構造 (スキーマ キャッシュなど)。 LSASS で使用されるメモリの量は、コンピューター上の負荷に応じて異なる場合があります。 実行中のスレッド数が多いほどもメモリのスタックの数。 平均すると、LSASS は、これらの固定のコンポーネントを 100 MB を 300 MB のメモリを使用します。 多くの RAM がインストールされている場合、LSASS は、以上の RAM と仮想メモリが少ないに使用できます。

**制限またはドメイン コント ローラー上のプログラムの数を最小限に抑えるか、適切な場所に追加の RAM を追加**

最適なパフォーマンス、LSASS は、特定の DC で実現できますとして多くの RAM を受け取ります。 LSASS は、他のプロセスを要求するように、その RAM を解放します。 考え方は、コンピューターで実行される他のプロセスでも、LSASS のパフォーマンスを最適化します。 注意すべきプログラムの一覧には、監視エージェントが含まれています。 一部のお客様には、大量の RAM リソースで利用できるさまざまなサーバー関数の別のエージェントがあります。 多くの WMI クエリでは、以下のいくつかの詳細があるいくつか発行可能性があります。

このため、パフォーマンスを向上させるは、DC 上のプログラムの数を最小限に抑えるを制限したりすることをお勧めです。 メモリ要求がない場合、LSASS は、Active Directory データベースをキャッシュし、そのための最適なパフォーマンスを実現するこのメモリを使用します。

DC は、パフォーマンスの問題であることを確認するときに、大量のメモリ使用率のプロセスもご覧ください。 これらには、トラブルシューティングが必要な問題があります。 Microsoft コンポーネントが含まれる場合します。 最新のサービス更新プログラムを使用維持するかどうかを確認してください&mdash;Microsoft にはソリューションには、DC のパフォーマンスにも役立つ品質更新プログラムの一部として過剰なメモリの使用率が含まれています。

これには、使用状況のプロファイルによって重要な RAM が利用できる組み込みの OS 機能があります。

- **ファイル サーバー**します。 Dc もグループ ポリシーおよびポリシーとスタートアップまたはログオン スクリプトのスクリプトをサービス、SYSVOL と Netlogon 共有のファイル サーバーです。
  ただし、Dc を使用して、その他のファイルの内容をサービスする顧客を表示します。 SMB ファイル サーバーはアクティブのクライアントを追跡するために RAM を消費するが何よりもまず、ファイルの内容は、OS ファイル キャッシュが拡大し、RAM、ESE データベースのキャッシュの競合が発生します。  

- **WMI クエリ**します。 監視ソリューションは、多くの場合、多くの WMI クエリをください。 個々 のクエリは、実行コストが低い可能性があります。 多くの場合、特に監視ソリューションでは、Windows を管理するさまざまなイベント ログから新しいイベントを抽出、いくつかのオーバーヘッドが発生する呼び出しの量になります。  

  ほとんどのボリュームを生成するイベント ログは、セキュリティ イベント ログでは通常です。 セキュリティ管理者は、特にドメイン コント ローラーから、収集するイベント ログにもなります。  

  WMI サービスは、クエリを最適化する動的メモリの割り当て方法を使用します。 そのため、WMI サービスには、大量のメモリ、もう一度、ESE データベースのキャッシュとの競合を割り当てることがあります。  
