---
title: 電源とパフォーマンスのチューニング
description: Windows Server のバランスの取れた電源プランのプロセッサ電源管理 (PPM) のチューニング
ms.prod: windows-server
ms.technology: performance-tuning-guide
ms.topic: article
ms.author: Qizha;TristanB
author: phstee
ms.date: 10/16/2017
ms.openlocfilehash: 1fcb1601169fa8f8b45a8a89b6495179092a0adc
ms.sourcegitcommit: 6aff3d88ff22ea141a6ea6572a5ad8dd6321f199
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 09/27/2019
ms.locfileid: "71370539"
---
# <a name="power-and-performance-tuning"></a>電源とパフォーマンスのチューニング

企業およびデータセンター環境でエネルギー効率がますます重要になっており、構成オプションの組み合わせに別のトレードオフセットが追加されています。

Windows Server 2016 は、幅広い顧客のワークロードにおけるパフォーマンスへの影響を最小限に抑えながら、優れたエネルギー効率を実現するために最適化されています。 [Windows server のバランスの取れた電源プランのプロセッサ電源管理 (PPM) チューニング](processor-power-management-tuning.md)windows server 2016 で既定のパラメーターをチューニングするために使用するワークロードについて説明し、カスタマイズされたチューニングの提案を提供します。

このセクションでは、電力効率のトレードオフについて説明します。これは、サーバーの既定の電源設定を調整する必要がある場合に、情報に基づく決定を行うのに役立ちます。 ただし、サーバーのハードウェアとワークロードの大部分では、Windows Server 2016 を実行しているときに管理者による電源調整は必要ありません。

## <a name="calculating-server-energy-efficiency"></a>サーバーのエネルギー効率の計算

電力を節約するためにサーバーを調整する場合は、パフォーマンスも考慮する必要があります。 チューニングはパフォーマンスと能力に影響し、場合によっては、過剰な量になることがあります。 考えられる調整ごとに、電力の割り当てとパフォーマンスの目標を考慮して、トレードオフが許容されるかどうかを判断します。

電力とパフォーマンスの情報を組み込んだ便利なメトリックについて、サーバーのエネルギー効率比率を計算することができます。 エネルギー効率とは、指定された時間内に必要な平均電力に対して行われる作業の比率です。

![エネルギー効率の式](../../media/perftune-guide-power-formula.png)

このメトリックを使用して、電力とパフォーマンスのトレードオフを考慮する現実的な目標を設定できます。 これに対して、データセンター全体での 10% のエネルギー節約の目標は、パフォーマンスへの対応する効果の取得に失敗し、その逆も同様です。

同様に、サーバーをチューニングしてパフォーマンスを 5% 向上させ、エネルギー消費が 10% 向上した場合は、ビジネス目標に対して結果全体の結果が許容されない場合があります。 エネルギー効率メトリックを使用すると、電力またはパフォーマンスメトリックだけでなく、より詳細な情報を得ることができます。

## <a name="measuring-system-energy-consumption"></a>システムエネルギー消費量の測定

電力効率を高めるためにサーバーを調整する前に、ベースラインの電力測定を確立する必要があります。

サーバーに必要なサポートがある場合は、Windows Server 2016 の電力測定と予算作成機能を使用して、パフォーマンスモニターを使用してシステムレベルのエネルギー消費量を確認できます。

サーバーで測定と予算作成がサポートされているかどうかを確認する方法の1つは、 [Windows Server カタログ](http://www.windowsservercatalog.com)の確認です。 サーバーモデルが Windows ハードウェア認定プログラムの新しい強化された電源管理の認定を受ける場合は、使用状況測定および予算作成の機能がサポートされていることが保証されます。

使用状況測定のサポートを確認するもう1つの方法は、パフォーマンスモニターでカウンターを手動で検索することです。 パフォーマンスモニターを開き、 **[カウンターの追加]** を選択し、 **[電源メーター]** カウンター グループを探します。

**[選択したオブジェクトのインスタンス]** というラベルの付いたボックスに電源メーターの名前付きインスタンスが表示されている場合、プラットフォームは測定をサポートします。 選択したカウンターグループに電力を表示する**電源**カウンターが表示されます。 電力データ値の正確な派生が指定されていません。 たとえば、瞬間的な電源描画や、一定期間の平均電力描画などです。

サーバープラットフォームで測定がサポートされていない場合は、電源入力に接続されている物理測定デバイスを使用して、システムの電力描画またはエネルギー消費を測定できます。

ベースラインを確立するには、さまざまなシステムロードポイントで必要とされる平均電力を、アイドルから 100% (最大スループット) に測定して、読み込み線を生成する必要があります。 次の図は、3つのサンプル構成の読み込み線を示しています。

![読み込み行のサンプル](../../media/perftune-guide-sample-loadlines.png)

読み込みラインを使用して、すべての負荷ポイントでの構成のパフォーマンスとエネルギー消費量を評価し、比較することができます。 この例では、最適な構成を簡単に確認できます。 ただし、1つの構成が負荷の高いワークロードに最適であり、1つは負荷の軽いワークロードに最適なシナリオです。

最適な構成を選択するには、ワークロードの要件を十分に理解している必要があります。 適切な構成が見つかったとしても、常に最適な状態に保たれるとは限りません。 システム使用率とエネルギー消費量は、定期的に測定し、ワークロード、ワークロードレベル、またはサーバーハードウェアの変更後に測定する必要があります。

## <a name="diagnosing-energy-efficiency-issues"></a>エネルギー効率に関する問題の診断

**PowerCfg**は、サーバーのアイドルエネルギー効率を分析するために使用できるコマンドラインオプションをサポートしています。 **/エネルギー**オプションを使用して PowerCfg を実行すると、60秒のテストが実行され、エネルギー効率に関する潜在的な問題が検出されます。 ツールは、現在のディレクトリに単純な HTML レポートを生成します。

> [!Important]
> 正確な分析を行うには、 **PowerCfg**を実行する前にすべてのローカルアプリが閉じられていることを確認します。 

タイマー刻みの短縮率、電源管理がサポートされていないドライバー、および過剰な CPU 使用率は、 **powercfg/エネルギー**コマンドによって検出される動作の問題の一部です。 このツールを使用すると、電源管理の問題を簡単に識別して修正することができます。これにより、大規模なデータセンターでコストを大幅に節約できる可能性があります。

PowerCfg の詳細については、「 [powercfg を使用したシステムエネルギー効率の評価](https://msdn.microsoft.com/windows/hardware/gg463250.aspx)」を参照してください。

## <a name="using-power-plans-in-windows-server"></a>Windows Server での電源プランの使用

Windows Server 2016 には、さまざまなビジネスニーズに対応するように設計された3つの組み込みの電源プランがあります。 これらのプランでは、電力またはパフォーマンスの目標を満たすようにサーバーをカスタマイズする簡単な方法が提供されます。 次の表では、各プランを使用する一般的なシナリオの一覧を示し、各プランの実装の詳細を示します。

| **計画** | **[説明]** | **一般的な該当するシナリオ** | **実装のハイライト** |
|------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------|
| 均衡 (推奨) | 既定の設定。 パフォーマンスへの影響を最小限に抑えて、優れたエネルギー効率をターゲットにします。 | 一般的なコンピューティング | 容量を要求に一致させる。 エネルギー節約機能は、電力とパフォーマンスのバランスを取ることができます。 |
| 高パフォーマンス | 高電力消費のコストでパフォーマンスが向上します。 電源と温度の制限、運用経費、および信頼性に関する考慮事項が適用されます。 | 低待機時間アプリと、プロセッサパフォーマンスの変化に影響するアプリコード | プロセッサは常に最高のパフォーマンス状態 ("ターボ" 周波数を含む) でロックされます。 すべてのコアは保留されていません。 熱の出力は重要な場合があります。 |
| 省電力 | エネルギーを節約し、運用コストを削減するために、パフォーマンスを制限します。 パフォーマンスが十分であることを確認するために、十分なテストを行わないでください。 | 電力の予算と温度の制限が限定されたデプロイ | プロセッサの頻度を最大値 (サポートされている場合) で上限とし、その他のエネルギー節約機能を有効にします。 |


これらの電源プランは、現在 (AC) およびダイレクト電流 (DC) を搭載したシステムに対応していますが、サーバーは常に AC 電源を使用していることを前提としています。

電源プランと電源ポリシーの構成の詳細については、「 [Windows での電源ポリシーの構成と展開](https://msdn.microsoft.com/windows/hardware/gg463243.aspx)」を参照してください。

> [!Note]
> 一部のサーバー製造元には、BIOS 設定を通じて使用できる独自の電源管理オプションが用意されています。 オペレーティングシステムが電源管理を制御できない場合、Windows の電源プランを変更しても、システムの電源とパフォーマンスには影響しません。

## <a name="tuning-processor-power-management-parameters"></a>プロセッサの電源管理パラメーターのチューニング

各電源プランは、多くの基本的な電源管理パラメーターの組み合わせを表します。 組み込みのプランは、さまざまなワークロードとシナリオに対応する3つの推奨設定のコレクションです。 ただし、これらのプランは顧客のニーズを満たしていないことを認識しています。

以下のセクションでは、いくつかの特定のプロセッサ電源管理パラメーターを調整して、3つの組み込みプランでは対応できない目標を達成する方法について説明します。 より広範な電源パラメーターを理解する必要がある場合は、「 [Windows での電源ポリシーの構成と展開](https://msdn.microsoft.com/windows/hardware/gg463243.aspx)」を参照してください。

## <a name="processor-performance-boost-mode"></a>プロセッサパフォーマンスブーストモード

Intel Turbo ブーストおよび AMD ターボコアテクノロジは、プロセッサが最も役に立つ場合 (つまり、システムの負荷が高い場合) にパフォーマンスを向上させる機能です。 ただし、この機能により CPU コアエネルギー消費量が増加するため、Windows Server 2016 では、使用中の電源ポリシーと特定のプロセッサ実装に基づいて、ターボテクノロジが構成されます。

Turbo は、すべての Intel および AMD プロセッサの高パフォーマンス電源プランで有効になっており、省電力電源プランでは無効になっています。 従来の P 状態ベースの周波数管理に依存するシステムのバランスの取れた電源プランの場合、ターボは、プラットフォームが EPB 登録をサポートしている場合に限り、既定で有効になります。

> [!Note]
> EPB レジスタは、Intel Westmere 以降のプロセッサでのみサポートされています。

Intel Nehalem および AMD プロセッサの場合、P 状態ベースのプラットフォームでは、ターボが既定で無効になっています。 ただし、システムでコラボレーションプロセッサパフォーマンス制御 (CPPC) がサポートされている場合は、オペレーティングシステムとハードウェア (ACPI 5.0 で定義されています) の間のパフォーマンス通信の新しい代替モードであるため、Windows オペレーティングシステムがシステムは、可能な限り高いパフォーマンスレベルを提供するようにハードウェアを動的に要求します。

ターボブースト機能を有効または無効にするには、管理者または選択した電源プランの既定のパラメーター設定で、プロセッサパフォーマンスブーストモードパラメーターを構成する必要があります。 表5に示すように、プロセッサパフォーマンスブーストモードには5つの値が許可されます。

P 状態ベースの制御では、選択が無効になり、有効になっています (公称パフォーマンスが要求されるたびに、ハードウェアで Turbo が使用可能)。また、効率的 (Turbo は EPB レジスタが実装されている場合にのみ使用可能) です。

CPPC ベースの制御では、選択が無効になり、効率的に有効になり (Windows が提供する正確な量を指定します)、アグレッシブ (Windows が "最大のパフォーマンス" を要求して、ターボを有効にするよう求められます)。

Windows Server 2016 では、ブーストモードの既定値は3です。

| **Name** | **P-状態に基づく動作** | **CPPC の動作** |
|--------------------------|------------------------|-------------------|
| 0 (無効) | Disabled | Disabled |
| 1 (有効) | 有効 | 効率的な有効化 |
| 2 (アグレッシブ) | 有効 | アグレッシブな |
| 3 (効率的に有効化) | 効率的 | 効率的な有効化 |
| 4 (効率的な積極的) | 効率的 | アグレッシブな |

 
次のコマンドは、現在の電源プランでプロセッサパフォーマンスブーストモードを有効にします (GUID エイリアスを使用してポリシーを指定します)。

``` syntax
Powercfg -setacvalueindex scheme_current sub_processor PERFBOOSTMODE 1
Powercfg -setactive scheme_current
```

> [!Important]
> 新しい設定を有効にするには、 **powercfg-setactive**コマンドを実行する必要があります。 サーバーを再起動する必要はありません。

現在選択されているプラン以外の電源プランにこの値を設定するには、scheme\_MAX (省電力)、スキーム\_の最小値 (高\_パフォーマンス)、scheme (均衡) などのエイリアスをスキーム\_の代わりに使用します。現在の。 以前に表示されていた powercfg-setactive コマンドの "scheme current" を目的のエイリアスに置き換えて、その電源プランを有効にします。

たとえば、省電力プランのブーストモードを調整し、その省電力を現在のプランに設定するには、次のコマンドを実行します。

``` syntax
Powercfg -setacvalueindex scheme_max sub_processor PERFBOOSTMODE 1
Powercfg -setactive scheme_max
```

## <a name="minimum-and-maximum-processor-performance-state"></a>プロセッサパフォーマンスの最小値と最大状態

プロセッサは、需要に合わせてパフォーマンスの状態 (P 状態) が非常に速く変化し、必要に応じてパフォーマンスが向上し、可能な場合は電力を節約します。 サーバーに特定の高パフォーマンスまたは最小電力消費の要件がある場合は、**最小プロセッサパフォーマンス状態**パラメーターまたは**最大プロセッサパフォーマンス状態**パラメーターを構成することを検討してください。

**[最小プロセッサパフォーマンス]** および **[最大プロセッサパフォーマンス]** の各パラメーターの値は、プロセッサの最大周波数に対する比率として表され、0 ~ 100 の範囲の値が使用されます。

サーバーで、非常に短い待機時間、不変の CPU 頻度 (反復可能なテストの場合など)、または最高のパフォーマンスレベルが必要な場合は、プロセッサを低パフォーマンスの状態に切り替える必要はありません。 このようなサーバーでは、次のコマンドを使用して、最低プロセッサパフォーマンス状態を 100% に上限できます。

``` syntax
Powercfg -setacvalueindex scheme_current sub_processor PROCTHROTTLEMIN 100
Powercfg -setactive scheme_current
```

サーバーのエネルギー消費量を削減する必要がある場合は、プロセッサのパフォーマンス状態を最大値で上限にすることをお勧めします。 たとえば、次のコマンドを使用して、プロセッサを最大周波数の 75% に制限することができます。

``` syntax
Powercfg -setacvalueindex scheme_current sub_processor PROCTHROTTLEMAX 75
Powercfg -setactive scheme_current
```

> [!Note]
> プロセッサパフォーマンスの上限に対する上限でプロセッサのサポートが必要です。 プロセッサのドキュメントを確認して、そのようなサポートが存在するかどうかを判断するか、**プロセッサ**グループの**最大周波数の**パフォーマンスモニターカウンター% を表示して、frequency が適用されているかどうかを確認します。

## <a name="processor-performance-increase-and-decrease-of-thresholds-and-policies"></a>プロセッサのパフォーマンスが向上し、しきい値とポリシーが低下する

プロセッサのパフォーマンス状態が増加または減少する速度は、複数のパラメーターによって制御されます。 次の4つのパラメーターは、最もわかりやすくなっています。

-   **プロセッサのパフォーマンスの増加しきい**値は、プロセッサのパフォーマンス状態が増加する前の使用率の値を定義します。 値が大きいほど、アクティビティの増加に応じてパフォーマンスの状態が増加する速度が低下します。

-   **プロセッサパフォーマンスの低下しきい**値は、プロセッサのパフォーマンス状態が低下する使用率の値を定義します。 値を大きくすると、アイドル期間中にパフォーマンス状態が低下する速度が上がります。

-   **プロセッサのパフォーマンスの向上ポリシーとプロセッサのパフォーマンスの低下**ポリシーは、変更が発生したときに設定するパフォーマンス状態を決定します。 "Single" ポリシーは、次の状態を選択することを意味します。 "ロケット" は、最大または最小の電力パフォーマンス状態を意味します。 "理想的" は、電力とパフォーマンスのバランスを見つけることを試みます。

たとえば、サーバーで非常に短い待機時間を必要としていても、アイドル期間中に低電力を利用する場合は、負荷が増加したときにパフォーマンスの状態が増加し、負荷が減少したときにパフォーマンスが低下することを速度ことがあります。 次のコマンドでは、より高速な状態増加を実現するためにポリシーの引き上げを "ロケット" に設定し、ポリシーの低下を "Single" に設定しています。 しきい値の増減は、それぞれ10と8に設定されています。

``` syntax
Powercfg.exe -setacvalueindex scheme_current sub_processor PERFINCPOL 2
Powercfg.exe -setacvalueindex scheme_current sub_processor PERFDECPOL 1
Powercfg.exe -setacvalueindex scheme_current sub_processor PERFINCTHRESHOLD 10
Powercfg.exe -setacvalueindex scheme_current sub_processor PERFDECTHRESHOLD 8
Powercfg.exe /setactive scheme_current
```

## <a name="processor-performance-core-parking-maximum-and-minimum-cores"></a>プロセッサパフォーマンスコアパーキング最大と最小コア数

コアパーキングは、Windows Server 2008 R2 で導入された機能です。 プロセッサ電源管理 (PPM) エンジンとスケジューラは連携して動作し、スレッドを実行するために使用できるコアの数を動的に調整します。 PPM エンジンによって、スケジュールされるスレッドのコアの最小数が選択されます。

一般に、保留中のコアには、スケジュールされたスレッドはありません。割り込み、Dpc、またはその他の厳密に関連付けられた作業を処理していない場合は、非常に低い電力状態になります。 残りのコアは、ワークロードの残りの部分を担います。 コアパーキングは、使用率が低いときにエネルギー効率を向上する可能性があります。

ほとんどのサーバーでは、既定のコアパーキング動作によって、スループットとエネルギー効率の妥当なバランスが実現されます。 コアパーキングが汎用ワークロードに対してあまり利点を示していないプロセッサでは、既定で無効にすることができます。

サーバーに特定のコア駐車要件がある場合は、**プロセッサパフォーマンスコアパーキング最大コア**パラメーターまたは**プロセッサパフォーマンスコアパーキング最小コアを使用して、パークに使用できるコアの数を制御できます。** Windows Server 2016 のパラメーター。

コアパーキングが常に最適ではないシナリオの1つは、NUMA ノード内の Cpu の重要でないサブセット (つまり、ノードの cpu セット全体よりも少ない CPU) に関連付けられているアクティブなスレッドが1つ以上ある場合です。 コア駐車アルゴリズムがコアを非駐車するように選択している場合 (ワークロードの輝度が増加した場合)、アクティブな関連付けられたサブセット (またはサブセット) 内のコアが常に選択されていない可能性があります。したがって、実際には、非駐車コアが最終的に過大.

これらのパラメーターの値は、0 ~ 100 の範囲のパーセンテージです。 **プロセッサパフォーマンスコアパーキング最大コア**数のパラメーターでは、**プロセッサパフォーマンスコアパーキング最小コア**のパラメーターで、いつでも保留を解除できる (実行スレッドで使用可能な) コアの最大割合を制御します。保留解除できるコアの最小割合を制御します。 コアパーキングをオフにするには、次のコマンドを使用して、**プロセッサパフォーマンスコアパーキングの最小コア**数を 100% に設定します。

``` syntax
Powercfg -setacvalueindex scheme_current sub_processor CPMINCORES 100
Powercfg -setactive scheme_current
```

スケジュール可能なコアの数を最大数の 50% に減らすには、次のように**プロセッサパフォーマンスコアパーキング最大コア**数を50に設定します。

``` syntax
Powercfg -setacvalueindex scheme_current sub_processor CPMAXCORES 50
Powercfg -setactive scheme_current
```

## <a name="processor-performance-core-parking-utility-distribution"></a>プロセッサパフォーマンスコアパーキングユーティリティの配布

ユーティリティの配布は、一部のワークロードの電力効率を向上させるように設計された Windows Server 2016 のアルゴリズムの最適化です。 移動可能な CPU アクティビティ (Dpc、割り込み、または厳密に関連付けられたスレッド) を追跡し、すべての保留されていないすべてのコアに均等に移動可能な作業を均等に分散できるという前提に基づいて、各プロセッサの将来の作業を予測します。

一部のプロセッサの分散電源プランでは、ユーティリティの配布が既定で有効になっています。 適度に安定した状態にあるワークロードの要求された CPU 頻度を下げることで、プロセッサの電力消費を減らすことができます。 ただし、ユーティリティの配布は、アクティビティのバーストが多いワークロードや、ワークロードがプロセッサ間をすばやくランダムに移動するプログラムに対しては、必ずしも適切なアルゴリズムを選択するとは限りません。

このようなワークロードでは、次のコマンドを使用してユーティリティの配布を無効にすることをお勧めします。

``` syntax
Powercfg -setacvalueindex scheme_current sub_processor DISTRIBUTEUTIL 0
Powercfg -setactive scheme_current
```

## <a name="see-also"></a>関連項目
- [サーバーハードウェアのパフォーマンスに関する考慮事項](../index.md)
- [サーバー ハードウェアの電源に関する考慮事項](../power.md)
- [プロセッサの電源管理チューニング](processor-power-management-tuning.md)
- [推奨されるバランスのプラン パラメーター](recommended-balanced-plan-parameters.md)
