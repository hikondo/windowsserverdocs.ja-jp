---
title: サーバーに NPS サーバーをインストールして構成する
description: NPS サーバーは、VPN サーバーによって送信される接続要求を処理することで、ユーザーが接続を許可しているかどうか、ユーザーの id を確認し、NPS で RADIUS アカウンティングを構成したときに選択した接続要求の側面をログに記録します。
ms.prod: windows-server
ms.technology: networking-ras
ms.topic: article
ms.assetid: ''
ms.localizationpriority: medium
ms.author: pashort
author: shortpatti
ms.date: 08/30/2018
ms.openlocfilehash: 5cb0d342afec9c28259efb7a2e15666358f3cb5b
ms.sourcegitcommit: 6aff3d88ff22ea141a6ea6572a5ad8dd6321f199
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 09/27/2019
ms.locfileid: "71404261"
---
# <a name="step-4-install-and-configure-the-network-policy-server-nps"></a>手順 4. ネットワークポリシーサーバー (NPS) をインストールして構成する

> 適用対象:Windows Server 2019、Windows Server (半期チャネル)、Windows Server 2016、Windows Server 2012 R2、Windows 10

- [**次に：** 手順 3.Always On VPN 用にリモート アクセス サーバーを構成する](vpn-deploy-ras.md)
- [**次に：** 手順 5.DNS とファイアウォールの設定を構成する](vpn-deploy-dns-firewall.md)

この手順では、VPN サーバーによって送信された接続要求を処理するために、ネットワークポリシーサーバー (NPS) をインストールします。

- 認証を実行して、ユーザーが接続のアクセス許可を持っていることを確認します。
- 認証を実行してユーザーの id を検証しています。
- NPS で RADIUS アカウンティングを構成したときに選択した接続要求の側面をログに記録するためのアカウンティングの実行。

このセクションの手順を実行すると、次の項目を完了できます。

1. NPS サーバー用に計画し、組織または企業ネットワークにインストールされているコンピューターまたは VM で、NPS をインストールすることができます。

   >[!TIP]
   >ネットワーク上に1つまたは複数の NPS サーバーが既にある場合は、NPS サーバーのインストールを実行する必要はありません。このトピックを使用して、既存の NPS サーバーの構成を更新できます。

> [!NOTE]
> Windows Server Core にネットワークポリシーサーバーサービスをインストールすることはできません。

2. 組織または企業の NPS サーバーで、VPN サーバーから受信した接続要求を処理する RADIUS サーバーとして実行するように NPS を構成できます。

## <a name="install-network-policy-server"></a>ネットワーク ポリシー サーバーをインストールする

この手順では、Windows PowerShell またはサーバーマネージャーの役割と機能の追加ウィザードを使用して、NPS をインストールします。 NPS とは、サーバーの役割である "ネットワーク ポリシーとアクセス サービス" の役割サービスの 1 つです。

>[!TIP]
>既定では、NPS は、インストールされているすべてのネットワーク アダプターの RADIUS トラフィックをポート 1812、1813、1645、および 1646 でリッスンします。 NPS をインストールするときに、セキュリティが強化された Windows ファイアウォールを有効にすると、これらのポートに対するファイアウォールの例外が IPv4 と IPv6 の両方のトラフィックに対して自動的に作成されます。 ネットワークアクセスサーバーが、これらの既定以外のポートを使用して RADIUS トラフィックを送信するように構成されている場合は、「セキュリティが強化された Windows ファイアウォール」で作成した例外を NPS のインストール時に削除し、に使用するポートに対して例外を作成します。RADIUS トラフィック。

**Windows PowerShell の手順:**

Windows PowerShell を使用してこの手順を実行するには、Windows PowerShell を管理者として実行し、次のコマンドレットを入力します。

```powershell
Install-WindowsFeature NPAS -IncludeManagementTools
```

**サーバーマネージャーの手順:**

1.  サーバーマネージャーで、 **[管理]** を選択し、 **[役割と機能の追加]** を選択します。
        役割と機能の追加ウィザードが起動されます。

2.  開始する前に で **次へ** を選択します。

    >[!NOTE] 
    >役割と機能の追加ウィザードの **[開始する前に]** ページは、役割と機能の追加ウィザードの実行時に **[既定でこのページをスキップ]** する を選択している場合は、表示されません。

3.  インストールの種類の選択 で、**役割ベースまたは機能ベースのインストール** が選択されていることを確認し、**次へ** を選択します。

4.  [対象サーバーの選択] で、 **[サーバープールからサーバーを選択**する] が選択されていることを確認します。

5.  サーバープール で、ローカルコンピューター が選択されていることを確認し、**次へ** を選択します。

6.  サーバーの役割の選択 の **役割** で、**ネットワークポリシーとアクセスサービス** を選択します。 ネットワークポリシーとアクセスサービスに必要な機能を追加するかどうかを確認するダイアログボックスが表示されます。

7.  **[機能の追加]** を選択し、 **[次へ]** を選択します。

8.  機能の選択 で **次へ** を選択し、ネットワークポリシーとアクセスサービス で提供されている情報を確認してから、**次へ** を選択します。

9.  役割サービスの選択 で、**ネットワークポリシーサーバー** を選択します。

10. ネットワークポリシーサーバーに必要な機能については、 **[機能の追加]** を選択し、 **[次へ]** を選択します。

11. インストールオプションの確認 で、**必要に応じて、移行先サーバーを自動的に再起動する** を選択します。

12. **[はい]** を選択して選択したを確認し、 **[インストール]** を選択します。
    
    [インストールの進行状況] ページに、インストール処理中の状態が表示されます。 プロセスが完了すると、" *computername*でのインストールが成功しました" というメッセージが表示されます。ここで、 *Computername*は、ネットワークポリシーサーバーをインストールしたコンピューターの名前です。

13. **[閉じる]** を選びます。

## <a name="configure-nps"></a>NPS の構成

NPS をインストールした後、VPN サーバーから受信する接続要求に対して、認証、承認、およびアカウンティングのすべての操作を処理するように NPS を構成します。

### <a name="register-the-nps-server-in-active-directory"></a>Active Directory に NPS サーバーを登録する

この手順では、接続要求の処理中にユーザーアカウント情報にアクセスする権限があるように、Active Directory にサーバーを登録します。

**作業**

1.  サーバーマネージャーで、 **[ツール]** を選択し、 **[ネットワークポリシーサーバー]** を選択します。 NPS コンソールが開きます。

2.  NPS コンソールで、 **[nps (ローカル)]** を右クリックし、 **[Active Directory でサーバーを登録]** する を選択します。
   
     [ネットワークポリシーサーバー] ダイアログボックスが表示されます。

3.  ネットワークポリシーサーバー ダイアログボックスで、 **OK** を2回選択します。

NPS を登録する別の方法については、「 [Active Directory ドメインに Nps サーバーを登録](../../../../../networking/technologies/nps/nps-manage-register.md)する」を参照してください。

### <a name="configure-network-policy-server-accounting"></a>ネットワーク ポリシー サーバー アカウンティングを構成する

この手順では、次のいずれかのログの種類を使用してネットワークポリシーサーバーアカウンティングを構成します。

- **イベントログ**。 主に、接続試行の監査とトラブルシューティングに使用されます。 Nps のイベントログを構成するには、nps コンソールで nps サーバーのプロパティを取得します。

- **ユーザー認証およびアカウンティング要求をローカルファイルに記録**します。 主に、接続分析と課金のために使用されます。 また、セキュリティ調査ツールとしても使用されます。これは、攻撃後に悪意のあるユーザーのアクティビティを追跡する方法を提供するためです。 ローカルファイルのログ記録は、アカウンティング構成ウィザードを使用して構成できます。

- **MICROSOFT SQL SERVER XML 準拠のデータベースに対するユーザー認証およびアカウンティング要求をログに記録**します。 NPS を実行する複数のサーバーが1つのデータソースを持つことができるようにするために使用します。 には、リレーショナルデータベースを使用する利点もあります。 SQL Server のログ記録は、アカウンティング構成ウィザードを使用して構成できます。

ネットワークポリシーサーバーアカウンティングを構成するには、「[ネットワークポリシーサーバーアカウンティングを構成](../../../../../networking/technologies/nps/nps-accounting-configure.md)する」を参照してください。

### <a name="add-the-vpn-server-as-a-radius-client"></a>VPN サーバーを RADIUS クライアントとして追加する

[ [ALWAYS ON vpn 用のリモートアクセスサーバーの構成](vpn-deploy-ras.md)] セクションで、vpn サーバーをインストールして構成しました。 VPN サーバーの構成中に、VPN サーバーに RADIUS 共有シークレットを追加しました。

この手順では、同じ共有シークレットテキスト文字列を使用して、NPS で VPN サーバーを RADIUS クライアントとして構成します。 VPN サーバーで使用したのと同じテキスト文字列を使用するか、NPS サーバーと VPN サーバーの間の通信が失敗します。

>[!IMPORTANT] 
>新しいネットワークアクセスサーバー (VPN サーバー、ワイヤレスアクセスポイント、認証スイッチ、またはダイヤルアップサーバー) をネットワークに追加する場合、nps がネットワークアクセスサーバーと通信できるように、NPS で RADIUS クライアントとしてサーバーを追加する必要があります。

**作業**

1. Nps サーバーの NPS コンソールで、 **[RADIUS クライアントとサーバー]** をダブルクリックします。

2. **[RADIUS クライアント]** を右クリックし、 **[新規]** をクリックします。 [新しい RADIUS クライアント] ダイアログボックスが開きます。

3. [**この RADIUS クライアントを有効に**する] チェックボックスがオンになっていることを確認します。

4. **[フレンドリ名]** に、VPN サーバーの表示名を入力します。

5. **[アドレス (ip または DNS)]** に、NAS IP アドレスまたは FQDN を入力します。
     
     FQDN を入力する場合は、名前が正しいことを確認し、有効な IP アドレスにマップする場合は、 **[確認]** を選択します。

6. **[共有シークレット]** で、次の操作を行います。

    1. **手動**が選択されていることを確認します。

    2. VPN サーバーにも入力した厳密なテキスト文字列を入力します。

    3. 共有シークレットの確認入力に共有シークレットを再入力します。

7. **[OK]** を選択します。 NPS サーバーに構成されている RADIUS クライアントの一覧に、VPN サーバーが表示されます。

## <a name="configure-nps-as-a-radius-for-vpn-connections"></a>VPN 接続の RADIUS として NPS を構成する

この手順では、組織のネットワーク上で NPS を RADIUS サーバーとして構成します。 NPS では、特定のグループのユーザーだけが VPN サーバー経由で組織または企業ネットワークにアクセスすることを許可するポリシーを定義する必要があります。その後、PEAP 認証要求で有効なユーザー証明書を使用する場合に限ります。

**作業**

1. NPS コンソールの 標準構成 で、**ダイヤルアップ接続または VPN 接続用の RADIUS サーバー** が選択されていることを確認します。

2. **[VPN またはダイヤルアップを構成する]** を選択します。
        
    VPN またはダイヤルアップの構成ウィザードが開きます。

3. **[仮想プライベートネットワーク (VPN) 接続]** を選択し、 **[次へ]** を選択します。

4. [RADIUS クライアント] で、[ダイヤルアップまたは VPN サーバーの指定] で、前の手順で追加した VPN サーバーの名前を選択します。 たとえば、VPN サーバーの NetBIOS 名が RAS1 の場合は、 **[RAS1]** を選択します。

5. **[次へ]** を選択します。

6. [認証方法の構成] で、次の手順を実行します。

    1. **[Microsoft 暗号化認証バージョン 2 (MS-CHAPv2)]** チェックボックスをオフにします。

    2. **[拡張認証プロトコル]** チェックボックスをオンにして選択します。

    3. (アクセス方法とネットワーク構成に基づく) [種類] で、[ **Microsoft] を選択します。保護された EAP**(PEAP)、 **[構成]** の順に選択します。
      
        [保護された EAP のプロパティの編集] ダイアログボックスが開きます。

    4. **[削除]** を選択して、セキュリティで保護されたパスワード (eap MSCHAP v2) の eap の種類を削除します。

    5. **[追加]** をクリックします。 [EAP の追加] ダイアログボックスが表示されます。

    6. **[スマートカードまたはその他の証明書]** を選択し、[ **OK]** を選択します。

    7. **[OK]** を選択して、[保護された EAP プロパティの編集] を閉じます。

7. **[次へ]** を選択します。

8. [ユーザーグループの指定] で、次の手順を実行します。

    1. **[追加]** をクリックします。 [ユーザー、コンピューター、サービスアカウントまたはグループの選択] ダイアログボックスが表示されます。

    2. 「 **VPN Users**」と入力し、[ **OK]** を選択します。

    3. **[次へ]** を選択します。

9. IP フィルターの指定 で、**次へ** を選択します。

10. 暗号化設定の指定 で、**次へ** を選択します。 変更しないでください。

    これらの設定は、このシナリオでサポートされていない Microsoft Point-to-point Encryption (MPPE) 接続にのみ適用されます。

11. 領域名の指定 で、**次へ** を選択します。

12. **[完了]** を選択してウィザードを終了します。

## <a name="autoenroll-the-nps-server-certificate"></a>NPS サーバー証明書を自動登録する

この手順では、ローカルの NPS サーバーでグループポリシーを手動で更新します。 証明書の自動登録が構成され、正常に機能している場合、グループポリシー更新すると、ローカルコンピューターは証明機関 (CA) によって証明書を自動登録します。

>[!NOTE]  
>ドメインメンバーコンピューターを再起動したとき、またはユーザーがドメインメンバーコンピューターにログオンしたときに、グループポリシー自動的に更新されます。 また、グループポリシー定期的に更新します。 既定では、この定期的な更新は、最大30分のランダム化されたオフセットで90分ごとに実行されます。

メンバーシップ **管理者**, 、または同等の権限は、この手順を実行するために必要な最小値。

**作業**

1. NPS で、Windows PowerShell を開きます。

2. Windows PowerShell プロンプトで「 **gpupdate**, 、ENTER キーを押します。

## <a name="next-steps"></a>次の手順

[手順 5.Always On VPN](vpn-deploy-dns-firewall.md)の DNS とファイアウォールの設定を構成します。この手順では、Windows PowerShell またはサーバーマネージャーの役割と機能の追加ウィザードを使用して、ネットワークポリシーサーバー (NPS) をインストールします。 また、NPS が VPN サーバーから受信する接続要求のすべての認証、承認、およびアカウンティングの各作業を処理するように構成します。