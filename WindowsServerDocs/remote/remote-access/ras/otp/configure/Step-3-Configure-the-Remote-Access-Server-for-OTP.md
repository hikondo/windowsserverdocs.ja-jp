---
title: 手順 3 OTP 用にリモートアクセスサーバーを構成する
description: このトピックは、「Windows Server 2016 で OTP 認証を使用してリモートアクセスを展開する」の一部です。
manager: brianlic
ms.topic: article
ms.assetid: df1e87f2-6a0f-433b-8e42-816ae75395f9
ms.author: lizross
author: eross-msft
ms.openlocfilehash: e0b03bfd06c693674e10e9eb9fba0a0dfd30b167
ms.sourcegitcommit: dfa48f77b751dbc34409aced628eb2f17c912f08
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/07/2020
ms.locfileid: "87969079"
---
# <a name="step-3-configure-the-remote-access-server-for-otp"></a>手順 3 OTP 用にリモートアクセスサーバーを構成する

>適用先:Windows Server (半期チャネル)、Windows Server 2016

RADIUS サーバーにソフトウェア配布トークンが構成されている場合、通信ポートが開いていて、共有シークレットが作成されていること、Active Directory に対応するユーザーアカウントが RADIUS サーバー上に作成されていること、およびリモートアクセスサーバーが RADIUS 認証エージェントとして構成されている場合は、OTP をサポートするようにリモートアクセスサーバーを構成

|タスク|説明|
|----|--------|
|[3.1 OTP 認証からの除外ユーザー (オプション)](#BKMK_Exempt)|特定のユーザーが OTP 認証を使用して DirectAccess から除外される場合は、次の準備手順に従います。|
|[3.2 OTP をサポートするようにリモートアクセスサーバーを構成する](#BKMK_Config)|リモートアクセスサーバーで、OTP 2 要素認証をサポートするようにリモートアクセス構成を更新します。|
|[3.3 スマートカードによる追加の承認](#BKMK_Smartcard)|スマートカードの使用に関する追加情報。|

> [!NOTE]
> このトピックでは、説明した手順の一部を自動化するのに使用できる Windows PowerShell コマンドレットのサンプルを示します。 詳細については、「[コマンドレットの使用](https://go.microsoft.com/fwlink/p/?linkid=230693)」を参照してください。

## <a name="31-exempt-users-from-otp-authentication-optional"></a><a name="BKMK_Exempt"></a>3.1 OTP 認証からの除外ユーザー (オプション)
特定のユーザーを OTP 認証から除外する場合は、リモートアクセスを構成する前に、次の手順を実行する必要があります。

> [!NOTE]
> OTP 除外グループを構成するときに、ドメイン間のレプリケーションが完了するまで待機する必要があります。

#### <a name="create-user-exemption-security-group"></a>ユーザーの除外セキュリティグループを作成する

1.  目的の OTP 除外のために Active Directory でセキュリティグループを作成します。

2.  OTP 認証から除外するすべてのユーザーをセキュリティグループに追加します。

    > [!NOTE]
    > OTP 除外セキュリティグループには、コンピューターアカウントではなく、ユーザーアカウントのみを含めるようにしてください。

## <a name="32-configure-the-remote-access-server-to-support-otp"></a><a name="BKMK_Config"></a>3.2 OTP をサポートするようにリモートアクセスサーバーを構成する
2要素認証と OTP を使用するようにリモートアクセスを構成するには、前のセクションの RADIUS サーバーと証明書の展開で、次の手順を実行します。

#### <a name="configure-remote-access-for-otp"></a>OTP のリモートアクセスの構成

1.  **リモートアクセス管理**を開き、[**構成**] をクリックします。

2.  [ **DirectAccess セットアップ**] ウィンドウの [**手順 2-リモートアクセスサーバー**] で、[**編集**] をクリックします。

3.  [**次へ**] を3回クリックし、[**認証**] セクションで [ **2 要素認証**と**OTP の使用**] を選択し、[**コンピューター証明書を使用**する] がオンになっていることを確認します。

    > [!NOTE]
    > リモートアクセスサーバーで OTP を有効にした後、[ **otp を使用**する] をオフにして otp を無効にすると、サーバーで ISAPI および CGI 拡張機能がアンインストールされます。

4.  Windows 7 のサポートが必要な場合は、[ **windows 7 クライアントコンピューターが DirectAccess 経由で接続できるように**する] チェックボックスをオンにします。 注: 計画セクションで説明したように、OTP を使用した DirectAccess をサポートするには、Windows 7 クライアントに DCA 2.0 がインストールされている必要があります。

5.  **[次へ]** をクリックします。

6.  [ **OTP RADIUS サーバー** ] セクションで、[空の**サーバー名**] フィールドをダブルクリックします。

7.  [ **Radius サーバーの追加**] ダイアログで、[**サーバー名**] フィールドに radius サーバーの名前を入力します。 [**共有シークレット**] フィールドの横にある [**変更**] をクリックし、[**新しいシークレット**] に RADIUS サーバーを構成するときに使用したものと同じパスワードを入力し、[**新しいシークレットを確認**してください] フィールドを入力します。 [ **OK]** を2回クリックし、[**次へ**] をクリックします。

    > [!NOTE]
    > RADIUS サーバーがリモートアクセスサーバーとは異なるドメインにある場合、[**サーバー名**] フィールドに radius サーバーの FQDN を指定する必要があります。

8.  [ **OTP Ca サーバー** ] セクションで、otp クライアント認証証明書の登録に使用する CA サーバーを選択し、[**追加**] をクリックします。 **[次へ]** をクリックします。

9. [ **Otp 証明書テンプレート**] セクションで、[**参照**] をクリックして、otp 認証用に発行された証明書の登録に使用する証明書テンプレートを選択します。

    > [!NOTE]
    > 企業 CA によって発行された OTP 証明書の証明書テンプレートは、[発行された証明書に失効情報を含めない] オプションを使用せずに構成する必要があります。 証明書テンプレートの作成中にこのオプションを選択した場合、OTP クライアントコンピューターは正しくログオンできません。

    [**参照**] をクリックして、OTP 証明書の登録要求に署名するためにリモートアクセスサーバーによって使用される証明書を登録するために使用される証明書テンプレートを選択します。 **[OK]** をクリックします。 **[次へ]** をクリックします。

10. OTP を使用して特定のユーザーを DirectAccess から除外する必要がある場合は、[ **otp の除外**] セクションで、[ **2 要素認証を使用して認証するために指定されたセキュリティグループのユーザーを必要としない**] を選択します。 [**セキュリティグループ**] をクリックし、OTP の除外対象として作成されたセキュリティグループを選択します。

11. [**リモートアクセスサーバーのセットアップ**] ページで、[**完了**] をクリックします。

12. [ **DirectAccess セットアップ**] ウィンドウの [**手順 3-インフラストラクチャサーバー**] で、[**編集**] をクリックします。

13. [**次へ**] を2回クリックし、[**管理**] セクションで [**管理サーバー** ] フィールドをダブルクリックします。

14. OTP 証明書を発行するように構成されている CA サーバーの**コンピューター名**または**アドレス**を入力し、[ **OK]** をクリックします。

15. **リモートアクセスのセットアップ**ウィンドウで、[**完了**] をクリックします。

16. **DirectAccess エキスパートウィザード**で、[**完了**] をクリックします。

17. [**リモートアクセスの確認**] ダイアログボックスで [**適用**] をクリックし、DirectAccess ポリシーが更新されるまで待ち、[**閉じる**] をクリックします。

18. [**スタート**] 画面で、** 「powershell.exe**」と入力し、[ **powershell**] を右クリックして [**詳細設定**] をクリックし、[**管理者として実行**] をクリックします。 [**ユーザー アカウント制御**] ダイアログ ボックスが表示されたら、表示された操作が正しいことを確認し、[**はい**] をクリックします。

19. Windows PowerShell ウィンドウで、「 **gpupdate/force** 」と入力し、enter キーを押します。

PowerShell コマンドを使用して OTP のリモートアクセスを構成するには

![Windows PowerShell](../../../../media/Step-3-Configure-the-Remote-Access-Server-for-OTP/PowerShellLogoSmall.gif)**Windows powershell の同等のコマンド**

次の Windows PowerShell コマンドレットは、前の手順と同じ機能を実行します。 各コマンドレットを単一行に入力します。ただし、ここでは、書式上の制約があるために、複数行に改行されて表示される場合があります。

現在、コンピューター証明書認証を使用している展開で2要素認証を使用するようにリモートアクセスを構成するには、次のようにします。

```
Set-DAServer -UserAuthentication TwoFactor
```

OTP 認証を使用するようにリモートアクセスを構成するには、次の設定を使用します。

-   OTP.corp.contoso.com という名前の OTP サーバー。

-   Com\corp-APP1-CA1. という名前の CA サーバー

-   OTP 認証用に発行された証明書の登録に使用される DAOTPLogon という名前の証明書テンプレート。

-   OTP 証明書の登録要求に署名するためにリモートアクセスサーバーによって使用される登録機関の証明書を登録するために使用される、DAOTPRA という名前の証明書テンプレート。

```
Enable-DAOtpAuthentication -CertificateTemplateName 'DAOTPLogon' -SigningCertificateTemplateName 'DAOTPRA' -CAServer @('APP1.corp.contoso.com\corp-APP1-CA1') -RadiusServer OTP.corp.contoso.com -SharedSecret Abcd123$
```

PowerShell コマンドを実行した後、前の手順の手順12-19 を実行して、OTP をサポートするようにリモートアクセスサーバーを構成します。

> [!NOTE]
> エントリポイントを追加する前に、リモートアクセスサーバーで OTP 設定が適用されていることを確認してください。

## <a name="33-smart-cards-for-additional-authorization"></a><a name="BKMK_Smartcard"></a>3.3 スマートカードによる追加の承認
リモートアクセスのセットアップウィザードの手順2の [認証] ページで、内部ネットワークへのアクセスにスマートカードを使用するように要求できます。 このオプションを選択すると、リモートアクセスのセットアップウィザードによって、DirectAccess サーバーのイントラネットトンネルの IPsec 接続セキュリティ規則が構成され、スマートカードによるトンネルモード認証が必要になります。 トンネルモード承認を使用すると、承認されたコンピューターまたはユーザーのみが受信トンネルを確立できるように指定できます。

イントラネットトンネルに対して IPsec トンネルモード認証でスマートカードを使用するには、スマートカードインフラストラクチャを備えた公開キー基盤 (PKI) を展開する必要があります。

DirectAccess クライアントは、イントラネットへのアクセスにスマートカードを使用しているため、ユーザーがスマートカードベースの証明書を使用してログオンしたかどうかに基づいて、ファイル、フォルダー、プリンターなどのリソースへのアクセスを制御するために、Windows Server 2008 R2 の機能である認証メカニズムアシュアランスを使用することもできます。 認証メカニズムアシュアランスには、Windows Server 2008 R2 のドメイン機能レベルが必要です。

### <a name="allowing-access-for-users-with-unusable-smart-cards"></a>使用できないスマートカードを使用しているユーザーにアクセスを許可する
スマートカードを使用できないユーザーが一時的にアクセスできるようにするには、次の手順を実行します。

1.  スマートカードを一時的に使用できないユーザーのユーザーアカウントを格納する Active Directory セキュリティグループを作成します。

2.  DirectAccess サーバーグループポリシーオブジェクトの場合は、IPsec トンネル認証のグローバル IPsec 設定を構成し、承認されたユーザーの一覧に Active Directory セキュリティグループを追加します。

スマートカードを使用できないユーザーにアクセスを許可するには、そのユーザーアカウントを一時的に Active Directory セキュリティグループに追加します。 スマートカードが使用可能な場合は、グループからユーザーアカウントを削除します。

### <a name="under-the-covers-smart-card-authorization"></a>内部: スマートカードの承認
スマートカード認証は、特定の Kerberos ベースのセキュリティ識別子 (SID) に対して、DirectAccess サーバーのイントラネットトンネル接続セキュリティ規則でトンネルモード承認を有効にすることによって機能します。 スマートカード認証の場合、これは既知の SID (S-1-5-65-1) です。これは、スマートカードベースのログオンにマップされます。 この SID は、DirectAccess クライアントの Kerberos トークンに存在し、グローバル IPsec トンネルモードの承認設定で構成されている場合、"この組織証明書" と呼ばれます。

DirectAccess セットアップウィザードの手順2でスマートカードの承認を有効にすると、directaccess セットアップウィザードによって、DirectAccess サーバーグループポリシーオブジェクトのこの SID を使用してグローバル IPsec トンネルモードの承認設定が構成されます。 DirectAccess サーバーグループポリシーオブジェクトの [セキュリティが強化された Windows ファイアウォール] スナップインでこの構成を表示するには、次の操作を行います。

1.  [セキュリティが強化された Windows ファイアウォール] を右クリックし、[プロパティ] をクリックします。

2.  [IPsec の設定] タブの [IPsec トンネル認証] で、[カスタマイズ] をクリックします。

3.  [ユーザー] タブをクリックします。"NT AUTHORITY\This Organization Certificate" が承認されたユーザーとして表示されます。



