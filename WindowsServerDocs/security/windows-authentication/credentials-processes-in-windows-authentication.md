---
title: Windows 認証での資格情報の処理
description: Windows Server のセキュリティ
ms.topic: article
ms.assetid: 48c60816-fb8b-447c-9c8e-800c2e05b14f
ms.author: lizross
author: eross-msft
manager: mtillman
ms.date: 10/12/2016
ms.openlocfilehash: 3d2948c632697e6278b716784f68c7a0085eab07
ms.sourcegitcommit: db2d46842c68813d043738d6523f13d8454fc972
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 09/10/2020
ms.locfileid: "89640083"
---
# <a name="credentials-processes-in-windows-authentication"></a>Windows 認証での資格情報の処理

>適用先:Windows Server (半期チャネル)、Windows Server 2016

IT プロフェッショナル向けのこのリファレンストピックでは、Windows 認証が資格情報を処理する方法について説明します。

Windows 資格情報の管理とは、オペレーティングシステムがサービスまたはユーザーから資格情報を受信し、将来のプレゼンテーションのためにその情報を認証対象にセキュリティで保護するプロセスです。 ドメインに参加しているコンピューターの場合、認証対象はドメインコントローラーです。 認証で使用される資格情報は、証明書、パスワード、PIN など、ユーザーの id をなんらかの信頼性証明に関連付けるデジタルドキュメントです。

既定では、Windows 資格情報は、ローカルコンピューターのセキュリティアカウントマネージャー (SAM) データベース、またはドメインに参加しているコンピューターの Active Directory に対して、Winlogon サービスを介して検証されます。 資格情報は、ログオンユーザーインターフェイスのユーザー入力を通じて収集されるか、またはアプリケーションプログラミングインターフェイス (API) を使用してプログラムによって認証対象に提示されます。

ローカルセキュリティ情報は **HKEY_LOCAL_MACHINE \security**の下のレジストリに格納されます。 格納される情報には、ポリシー設定、既定のセキュリティ値、アカウント情報 (キャッシュされたログオン資格情報など) が含まれます。 SAM データベースのコピーもここに格納されますが、書き込み禁止になっています。

次の図は、必要なコンポーネントと、ログオンに成功した場合にユーザーまたはプロセスを認証するために資格情報がシステムを通過するパスを示しています。

![必要なコンポーネントと資格情報がシステムを通過して、ログオンに成功したユーザーまたはプロセスを認証するためのパスを示す図。](../media/credentials-processes-in-windows-authentication/AuthN_LSA_Architecture_Client.gif)

次の表では、ログオン時に認証プロセスで資格情報を管理する各コンポーネントについて説明します。

**すべてのシステムの認証コンポーネント**

|コンポーネント|説明|
|-------|--------|
|ユーザー ログオン|Winlogon.exe は、セキュリティで保護されたユーザー操作の管理を担当する実行可能ファイルです。 Winlogon サービスは、ユーザー操作によって収集された資格情報をセキュリティで保護されたデスクトップ (ログオン UI) に Secur32.dll 経由でローカルセキュリティ機関 (LSA) に渡すことによって、Windows オペレーティングシステムのログオンプロセスを開始します。|
|アプリケーションのログオン|対話型ログオンを必要としないアプリケーションまたはサービスのログオン。 ユーザーによって開始されるほとんどのプロセスは、Secur32.dll を使用してユーザーモードで実行します。一方、サービスなどの起動時に開始されるプロセスは、Ksecdd.sys を使用してカーネルモードで実行します。<p>ユーザーモードとカーネルモードの詳細については、このトピックの「アプリケーションとユーザーモード」または「サービスとカーネルモード」を参照してください。|
|Secur32.dll|認証プロセスの基礎を形成する複数の認証プロバイダー。|
|Lsasrv.dll|LSA サーバーサービス。これにより、セキュリティポリシーが適用され、LSA のセキュリティパッケージマネージャーとして機能します。 LSA には Negotiate 関数が含まれています。この関数は、成功するプロトコルを決定した後、NTLM または Kerberos プロトコルのいずれかを選択します。|
|セキュリティサポートプロバイダ|1つ以上の認証プロトコルを個別に呼び出すことができるプロバイダーのセット。 既定のプロバイダーのセットは、Windows オペレーティングシステムの各バージョンで変更できます。また、カスタムプロバイダーを作成することもできます。|
|Netlogon.dll|Net Logon サービスによって実行されるサービスは、次のとおりです。<p>-コンピューターのセキュリティで保護されたチャネル (Schannel と混同しない) をドメインコントローラーに保持します。<br />-セキュリティで保護されたチャネルを介してドメインコントローラーにユーザーの資格情報を渡し、ユーザーのドメインセキュリティ識別子 (Sid) とユーザー権利を返します。<br />-ドメインネームシステム (DNS) 内のサービスリソースレコードを発行し、DNS を使用してドメインコントローラーのインターネットプロトコル (IP) アドレスに名前を解決します。<br />-プライマリドメインコントローラー (Pdc) とバックアップドメインコントローラー (Bdc) を同期するためのリモートプロシージャコール (RPC) に基づいて、レプリケーションプロトコルを実装します。|
|Samsrv.dll|ローカルセキュリティアカウントを格納し、ローカルに格納されているポリシーを適用し、Api をサポートするセキュリティアカウントマネージャー (SAM)。|
|レジストリ|レジストリには、SAM データベースのコピー、ローカルセキュリティポリシーの設定、既定のセキュリティ値、システムからのみアクセスできるアカウント情報が含まれています。|

このトピックには、次のセクションが含まれます。

-   [ユーザーログオンの資格情報の入力](#BKMK_CrentialInputForUserLogon)

-   [アプリケーションとサービスログオンの資格情報の入力](#BKMK_CredentialInputForApplicationAndServiceLogon)

-   [ローカル セキュリティ機関](#BKMK_LSA)

-   [キャッシュされた資格情報と検証](#BKMK_CachedCredentialsAndValidation)

-   [資格情報の保存と検証](#BKMK_CredentialStorageAndValidation)

-   [セキュリティ アカウント マネージャー データベース](#BKMK_SAM)

-   [ローカルドメインと信頼されたドメイン](#BKMK_LocalDomainsAndTrustedDomains)

-   [Windows 認証の証明書](#BKMK_CertificatesInWindowsAuthentication)

## <a name="credential-input-for-user-logon"></a><a name="BKMK_CrentialInputForUserLogon"></a>ユーザーログオンの資格情報の入力
Windows Server 2008 および Windows Vista では、グラフィカルな識別と認証 (GINA) アーキテクチャが資格情報プロバイダーモデルに置き換えられました。これにより、ログオンタイルを使用してさまざまなログオンの種類を列挙できます。 次に、両方のモデルについて説明します。

**グラフィカルな識別と認証のアーキテクチャ**

GINA (グラフィカルな識別と認証) アーキテクチャは、Windows Server 2003、Microsoft Windows 2000 Server、Windows XP、および Windows 2000 Professional の各オペレーティングシステムに適用されます。 これらのシステムでは、すべての対話型ログオンセッションで、Winlogon サービスの個別のインスタンスが作成されます。 GINA アーキテクチャは、Winlogon によって使用されるプロセス領域に読み込まれ、資格情報を受信して処理し、LSALogonUser を介して認証インターフェイスを呼び出します。

セッション0で対話型ログオンを実行する場合の Winlogon のインスタンス。 セッション0は、システムサービスおよびその他の重要なプロセスをホストします。これには、ローカルセキュリティ機関 (LSA) プロセスが含まれます。

次の図は、Windows Server 2003、Microsoft Windows 2000 Server、Windows XP、および Microsoft Windows 2000 Professional の資格情報プロセスを示しています。

![Windows Server 2003、Microsoft Windows 2000 Server、Windows XP、および Microsoft Windows 2000 Professional の資格情報プロセスを示す図](../media/credentials-processes-in-windows-authentication/AuthN_GINA_Architecture.gif)

**資格情報プロバイダーのアーキテクチャ**

資格情報プロバイダーのアーキテクチャは、このトピックの冒頭にある「 **適用対象** 」の一覧に示されているバージョンに適用されます。 これらのシステムでは、資格情報の入力アーキテクチャは、資格情報プロバイダーを使用して拡張可能な設計に変更されています。 これらのプロバイダーは、セキュリティで保護されたデスクトップ上のさまざまなログオンタイルによって表されます。これにより、同じユーザーおよび異なる認証方法 (パスワード、スマートカード、生体認証など) に対して、任意の数のログオンシナリオを使用できます。

資格情報プロバイダーのアーキテクチャでは、Winlogon は、セキュリティで保護されたアテンションシーケンスイベントを受信した後、常にログオン UI を開始します。 ログオン UI では、プロバイダーが列挙するように構成されているさまざまな種類の資格情報について、各資格情報プロバイダーに対してクエリを行います。 資格情報プロバイダーには、これらのタイルのいずれかを既定値として指定するオプションがあります。 すべてのプロバイダーがタイルを列挙した後、ログオン UI でユーザーに表示されます。 ユーザーは、タイルと対話して資格情報を提供します。 ログオン UI は、これらの資格情報を認証用に送信します。

資格情報プロバイダーは、強制メカニズムではありません。 これらは、資格情報を収集してシリアル化するために使用されます。 ローカルセキュリティ機関と認証パッケージは、セキュリティを適用します。

資格情報プロバイダーはコンピューターに登録され、次のことを担当します。

-   認証に必要な資格情報を記述します。

-   外部認証機関を使用した通信とロジックの処理。

-   対話型およびネットワークログオン用の資格情報をパッケージ化します。

対話型およびネットワークログオン用の資格情報のパッケージ化には、シリアル化のプロセスが含まれます。 資格情報をシリアル化することで、ログオン UI に複数のログオンタイルを表示できます。 そのため、組織では、ユーザー、ログオンの対象システム、ネットワークへのログオン前のアクセス、およびワークステーションのロック/ロック解除など、カスタマイズされた資格情報プロバイダーを使用して、ログオンの表示を制御できます。 複数の資格情報プロバイダーを同じコンピューターに共存させることができます。

シングルサインオン (SSO) プロバイダーは、標準の資格情報プロバイダーとして、またはログオン前アクセスプロバイダーとして開発できます。

Windows の各バージョンには、既定の資格情報プロバイダーと1つの既定のログオン前アクセスプロバイダー (PLAP) が含まれています。これは SSO プロバイダーとも呼ばれます。 SSO プロバイダーは、ローカルコンピューターにログオンする前に、ユーザーがネットワークに接続することを許可します。 このプロバイダーが実装されている場合、プロバイダーはログオン UI のタイルを列挙しません。

SSO プロバイダーは、次のシナリオで使用することを目的としています。

-   **ネットワーク認証とコンピューターログオンは、さまざまな資格情報プロバイダーによって処理されます。** このシナリオのバリエーションは次のとおりです。

    -   ユーザーは、コンピューターにログオンする前に、仮想プライベートネットワーク (VPN) に接続するなど、ネットワークに接続することができますが、この接続を行う必要はありません。

    -   ローカルコンピューターで対話型認証を行うときに使用される情報を取得するには、ネットワーク認証が必要です。

    -   複数のネットワーク認証の後に、その他のシナリオの1つが続きます。 たとえば、ユーザーがインターネットサービスプロバイダー (ISP) に対して認証を行い、VPN に対して認証を行い、ユーザーアカウントの資格情報を使用してローカルにログオンしたとします。

    -   キャッシュされた資格情報は無効になり、ユーザーを認証するには、ローカルログオンの前に VPN 経由のリモートアクセスサービス接続が必要になります。

    -   ドメインユーザーは、ドメインに参加しているコンピューターにローカルアカウントを設定しておらず、対話型ログオンを完了する前に VPN 接続を介してリモートアクセスサービス接続を確立する必要があります。

-   **ネットワーク認証とコンピューターログオンは、同じ資格情報プロバイダーによって処理されます。** このシナリオでは、ユーザーは、コンピューターにログオンする前に、ネットワークに接続する必要があります。

**ログオンタイル列挙型**

資格情報プロバイダーは、次のインスタンスのログオンタイルを列挙します。

-   このトピックの冒頭にある「 **適用対象** 」の一覧に指定されているオペレーティングシステムの場合。

-   資格情報プロバイダーは、ワークステーションログオンのタイルを列挙します。 通常、資格情報プロバイダーは、認証のための資格情報をローカルセキュリティ機関にシリアル化します。 このプロセスでは、各ユーザーに固有のタイルと、各ユーザーの対象システムに固有のタイルが表示されます。

-   ログオンと認証のアーキテクチャにより、ユーザーは資格情報プロバイダーによって列挙されたタイルを使用して、ワークステーションのロックを解除できます。 通常、現在ログオンしているユーザーは既定のタイルですが、複数のユーザーがログオンしている場合は、多数のタイルが表示されます。

-   資格情報プロバイダーは、ユーザーからのパスワードまたはその他の個人情報 (PIN など) を変更する要求に応じてタイルを列挙します。 通常、現在ログオンしているユーザーは既定のタイルです。ただし、複数のユーザーがログオンしている場合は、さまざまなタイルが表示されます。

-   資格情報プロバイダーは、リモートコンピューターでの認証に使用される、シリアル化された資格情報に基づいてタイルを列挙します。 資格情報 UI では、ログオン UI としてプロバイダーの同じインスタンスを使用したり、ワークステーションのロックを解除したり、パスワードを変更したりすることはできません。 そのため、資格情報 UI のインスタンス間で、状態情報をプロバイダーで保持することはできません。 この構造では、資格情報が正しくシリアル化されていることを前提として、リモートコンピューターログオンごとに1つのタイルが生成されます。 このシナリオは、ユーザーアカウント制御 (UAC) でも使用されます。これは、コンピューターの操作に影響を与える可能性のある操作や、コンピューターの他のユーザーに影響を与える設定の変更を許可する前に、ユーザーに対してアクセス許可または管理者パスワードの入力を求めることによって、コンピューターに対する承認されていない

次の図は、このトピックの冒頭にある「 **適用対象** 」の一覧に指定されているオペレーティングシステムの資格情報プロセスを示しています。

![このトピックの冒頭に記載されている * * に適用されるオペレーティングシステムの資格情報プロセスを示す図](../media/credentials-processes-in-windows-authentication/AuthN_CredMan_CredProv.gif)

## <a name="credential-input-for-application-and-service-logon"></a><a name="BKMK_CredentialInputForApplicationAndServiceLogon"></a>アプリケーションとサービスログオンの資格情報の入力
Windows 認証は、ユーザーの操作を必要としないアプリケーションまたはサービスの資格情報を管理するように設計されています。 ユーザーモードのアプリケーションは、アクセスできるシステムリソースの観点からは限られていますが、サービスはシステムメモリと外部デバイスに無制限にアクセスできます。

システムサービスとトランスポートレベルのアプリケーションは、Windows のセキュリティサポートプロバイダーインターフェイス (SSPI) を介してセキュリティサポートプロバイダー (SSP) にアクセスします。これには、システムで使用可能なセキュリティパッケージを列挙し、パッケージを選択し、そのパッケージを使用して認証された接続を取得するための機能が用意されています。

クライアント/サーバー接続が認証された場合:

-   接続のクライアント側のアプリケーションは、SSPI 関数を使用してサーバーに資格情報を送信し `InitializeSecurityContext (General)` ます。

-   接続のサーバー側のアプリケーションが SSPI 関数で応答し `AcceptSecurityContext (General)` ます。

-   SSPI 関数 `InitializeSecurityContext (General)` と `AcceptSecurityContext (General)` は、必要なすべての認証メッセージが交換され、認証が成功するか失敗するまで繰り返されます。

-   接続が認証されると、サーバー上の LSA はクライアントからの情報を使用して、アクセストークンを含むセキュリティコンテキストを構築します。

-   サーバーは SSPI 関数を呼び出して、 `ImpersonateSecurityContext` アクセストークンをサービスの偽装スレッドにアタッチできます。

**アプリケーションとユーザーモード**

Windows のユーザーモードは、適切なカーネルモードドライバーに i/o 要求を渡すことができる2つのシステムで構成されています。これは、さまざまな種類のオペレーティングシステム用に記述されたアプリケーションを実行する環境システムと、環境システムに代わってシステム固有の機能を運用する不可欠なシステムです。

このようなシステムは、オペレーティングシステムの特定の機能を環境システムに代わって管理し、セキュリティシステムプロセス (LSA)、ワークステーションサービス、およびサーバーサービスで構成されています。 セキュリティシステムプロセスは、セキュリティトークンを処理し、リソースのアクセス許可に基づいてユーザーアカウントにアクセスするためのアクセス許可を付与または拒否し、ログオン要求を処理してログオン認証を開始し、オペレーティングシステムが監査する必要のあるシステムリソースを決定します。

アプリケーションはユーザーモードで実行できます。アプリケーションは、ローカルシステム (SYSTEM) のセキュリティコンテキストなど、任意のプリンシパルとして実行できます。 また、アプリケーションはカーネルモードで実行することもできます。このモードでは、アプリケーションをローカルシステム (SYSTEM) のセキュリティコンテキストで実行できます。

SSPI は Secur32.dll モジュールを通じて利用できます。これは、認証、メッセージの整合性、およびメッセージのプライバシーを確保するために統合セキュリティサービスを取得するために使用される API です。 アプリケーションレベルのプロトコルとセキュリティプロトコルの間に抽象レイヤーを提供します。 アプリケーションによっては、ユーザーの識別や認証を行うためのさまざまな方法が必要になるため、ネットワーク経由で転送されるデータを暗号化するためのさまざまな方法があります。 SSPI を使用すると、さまざまな認証および暗号化機能を含むダイナミックリンクライブラリ (Dll) にアクセスすることができます。 これらの Dll は、セキュリティサポートプロバイダー (Ssp) と呼ばれます。

管理されたサービスアカウントと仮想アカウントは、Windows Server 2008 R2 と Windows 7 で導入され、独自のドメインアカウントを分離することによって Microsoft SQL Server やインターネットインフォメーションサービス (IIS) などの重要なアプリケーションを提供し、管理者がこれらのアカウントのサービスプリンシパル名 (SPN) と資格情報を手動で管理する必要がなくなりました。 これらの機能と認証の役割の詳細については、「 [windows 7 および Windows Server 2008 R2 の管理されたサービスアカウントに関するドキュメント](/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/ff641731(v=ws.10)) 」および「グループの管理された [サービスアカウントの概要](../group-managed-service-accounts/group-managed-service-accounts-overview.md)」を参照してください。

**サービスとカーネルモード**

ほとんどの Windows アプリケーションは、起動するユーザーのセキュリティコンテキストで実行されますが、これはサービスには当てはまりません。 ネットワークや印刷サービスなどの多くの Windows サービスは、ユーザーがコンピューターを起動したときにサービスコントローラーによって開始されます。 これらのサービスは、ローカルサービスまたはローカルシステムとして実行され、最後のユーザーがログオフした後も引き続き実行される可能性があります。

> [!NOTE]
> 通常、サービスは、ローカルシステム (SYSTEM)、ネットワークサービス、またはローカルサービスと呼ばれるセキュリティコンテキストで実行されます。  Windows Server 2008 R2 では、管理されたサービスアカウント (ドメインプリンシパル) で実行されるサービスが導入されました。

サービスを開始する前に、サービスコントローラーはサービス用に指定されたアカウントを使用してログオンし、LSA による認証のためにサービスの資格情報を提示します。 Windows サービスは、サービスコントローラーマネージャーがサービスを制御するために使用できるプログラムインターフェイスを実装しています。 Windows サービスは、システムが起動したとき、またはサービスコントロールプログラムを使用して手動で起動したときに、自動的に開始できます。 たとえば、Windows クライアントコンピューターがドメインに参加している場合、コンピューター上の messenger サービスはドメインコントローラーに接続し、セキュリティで保護されたチャネルを開きます。 認証された接続を取得するには、サービスに、リモートコンピューターのローカルセキュリティ機関 (LSA) が信頼する資格情報が必要です。 ネットワーク内の他のコンピューターと通信する場合、LSA はローカルシステムおよびネットワークサービスのセキュリティコンテキストで実行されている他のすべてのサービスと同様に、ローカルコンピューターのドメインアカウントの資格情報を使用します。 ローカルコンピューター上のサービスはシステムとして実行されるため、資格情報を LSA に提示する必要はありません。

ファイル Ksecdd.sys は、これらの資格情報を管理および暗号化し、ローカルプロシージャコールを LSA に使用します。 ファイルの種類は DRV (driver) で、カーネルモードセキュリティサポートプロバイダー (SSP) と呼ばれます。このトピックの冒頭にある「 **適用対象** 」の一覧で指定されているバージョンでは、FIPS 140-2 Level 1 に準拠しています。

カーネルモードには、コンピューターのハードウェアおよびシステムリソースへのフルアクセスがあります。 カーネルモードは、ユーザーモードのサービスとアプリケーションが、アクセスできないオペレーティングシステムの重要な領域にアクセスするのを停止します。

## <a name="local-security-authority"></a><a name="BKMK_LSA"></a>ローカル セキュリティ機関
ローカルセキュリティ機関 (LSA) は、ユーザーを認証し、ローカルコンピューターにログオンする、保護されたシステムプロセスです。 さらに、LSA はコンピューター上のローカルセキュリティのあらゆる側面に関する情報を保持します (これらの側面を総称してローカルセキュリティポリシーと呼びます)。また、名前とセキュリティ識別子 (Sid) を変換するためのさまざまなサービスを提供します。 セキュリティシステムプロセスである Local Security Authority Server Service (LSASS) は、セキュリティポリシーと、コンピューターシステムで有効になっているアカウントを追跡します。

LSA は、次の2つのエンティティのどちらがユーザーのアカウントを発行したかに基づいて、ユーザーの id を検証します。

-   **ローカルセキュリティ機関。** LSA は、同じコンピューター上にあるセキュリティアカウントマネージャー (SAM) データベースを確認することによって、ユーザー情報を検証できます。 ワークステーションまたはメンバーサーバーには、ローカルユーザーアカウントとローカルグループに関する情報を格納できます。 ただし、これらのアカウントは、そのワークステーションまたはコンピューターのみにアクセスするために使用できます。

-   **ローカルドメインまたは信頼されたドメインのセキュリティ機関。** LSA は、アカウントを発行したエンティティにアクセスし、アカウントが有効であることと、要求がアカウント所有者から送信されたことを確認することを要求します。

ローカル セキュリティ機関サブシステム サービス (LSASS) は、Windows セッションがアクティブなユーザーの代わりに資格情報をメモリに保存します。 保存された資格情報を使用すると、ユーザーは、各リモートサービスの資格情報を再入力することなく、ファイル共有、Exchange Server メールボックス、SharePoint サイトなどのネットワークリソースにシームレスにアクセスできます。

LSASS は、以下を含む複数の形式の資格情報を保存できます。

-   可逆的に暗号化されたプレーンテキスト

-   Kerberos チケット (チケット保証チケット (Tgt)、サービスチケット)

-   NT ハッシュ

-   LAN Manager (LM) ハッシュ

ユーザーがスマートカードを使用して Windows にログオンした場合、LSASS はプレーンテキストのパスワードを保存しませんが、アカウントの対応する NT ハッシュ値とスマートカードのプレーンテキストの PIN を格納します。 対話型ログオンに必要なスマート カードに対してアカウント属性が有効な場合は、元のパスワード ハッシュではなく、ランダム NT ハッシュ値がアカウントのために自動的に生成されます。 属性の設定時に自動的に生成されたパスワード ハッシュは変更されません。

ユーザーが LAN Manager (LM) ハッシュと互換性のあるパスワードを使用して Windows ベースのコンピューターにログオンすると、この認証子はメモリに存在します。

プレーンテキストの資格情報を必要とする資格情報プロバイダーが無効な場合でも、プレーンテキストの資格情報をメモリに保存することは無効にできません。

保存された資格情報は、最後の再起動後に開始され、閉じられていないローカルセキュリティ機関サブシステムサービス (LSASS) ログオンセッションに直接関連付けられます。 たとえば、ユーザーが以下のいずれかを実行すると、保存された LSA 資格情報を使用した LSA セッションが作成されます。

-   コンピューター上のローカルセッションまたはリモートデスクトッププロトコル (RDP) セッションにログオンします。

-   **RunAs** オプションを使用してタスクを実行する

-   コンピューターでアクティブ Windows サービスを実行する

-   スケジュールされたタスクまたはバッチ ジョブを実行する

-   リモート管理ツールを使用してローカル コンピューターでタスクを実行する

場合によっては、LSA シークレットは、システムアカウントプロセスのみがアクセスできる秘密のデータであり、ハードディスクドライブに格納されます。 これらのシークレットの一部は、再起動後も保持される必要がある資格情報で、ハード ディスク ドライブに暗号化された形式で保存されます。 LSA シークレットとして保存される資格情報には以下が含まれます。

-   コンピューターの Active Directory Domain Services (AD DS) アカウントのアカウントパスワード

-   コンピューターで構成されている Windows サービスのアカウント パスワード

-   構成済みのスケジュールされたタスクのアカウント パスワード

-   IIS アプリケーション プールと Web サイトのアカウント パスワード

-   Microsoft アカウントのパスワード

Windows 8.1 で導入されたクライアントオペレーティングシステムは、保護されていないプロセスによるメモリやコードインジェクションの読み取りを防ぐために、LSA の追加の保護を提供します。 この保護により、LSA によって格納および管理される資格情報のセキュリティが強化されます。

これらの追加の保護の詳細については、「 [追加の LSA 保護の構成](../credentials-protection-and-management/configuring-additional-lsa-protection.md)」を参照してください。

## <a name="cached-credentials-and-validation"></a><a name="BKMK_CachedCredentialsAndValidation"></a>キャッシュされた資格情報と検証
検証メカニズムは、ログオン時に資格情報の表示に依存します。 ただし、コンピューターがドメインコントローラーから切断され、ユーザーがドメインの資格情報を提示している場合、Windows は検証メカニズムでキャッシュされた資格情報の処理を使用します。

ユーザーがドメインにログオンするたびに、指定された資格情報が Windows によってキャッシュされ、オペレーティングシステムのレジストリのセキュリティハイブに格納されます。

キャッシュされた資格情報を使用すると、ユーザーは、そのドメイン内のドメインコントローラーに接続しなくても、ドメインメンバーにログオンできます。


## <a name="credential-storage-and-validation"></a><a name="BKMK_CredentialStorageAndValidation"></a>資格情報の保存と検証
異なるリソースにアクセスするために1セットの資格情報を使用することは必ずしも望ましいとは限りません。 たとえば、リモートサーバーにアクセスするときに、管理者がユーザーの資格情報ではなく管理を使用する場合があります。 同様に、ユーザーが外部リソース (銀行口座など) にアクセスする場合は、ドメイン資格情報とは異なる資格情報のみを使用できます。 以下のセクションでは、現在のバージョンの Windows オペレーティングシステムと windows Vista および Windows XP オペレーティングシステムの間での資格情報管理の違いについて説明します。

### <a name="remote-logon-credential-processes"></a>リモートログオンの資格情報プロセス
リモートデスクトッププロトコル (RDP) は、Windows 8 で導入されたリモートデスクトップクライアントを使用してリモートコンピューターに接続するユーザーの資格情報を管理します。 プレーンテキスト形式の資格情報は、ホストが認証プロセスを実行しようとするターゲットホストに送信されます。成功した場合は、ユーザーを許可されたリソースに接続します。 RDP では、クライアントに資格情報は保存されませんが、ユーザーのドメイン資格情報は LSASS に格納されます。

Windows Server 2012 R2 および Windows 8.1 で導入された制限付き管理モードでは、リモートログオンのシナリオに対してセキュリティが強化されます。 このモードのリモートデスクトップを使用すると、クライアントアプリケーションは NT の一方向機能 (NTOWF) を使用してネットワークログオンチャレンジ応答を実行するか、リモートホストに対して認証するときに Kerberos サービスチケットを使用します。 管理者が認証されると、管理者は、リモートホストに渡されなかったため、LSASS にそれぞれのアカウント資格情報がありません。 代わりに、管理者はセッションのコンピューターアカウント資格情報を持っています。 リモートホストに管理者の資格情報が指定されていないため、アクションはコンピューターアカウントとして実行されます。 リソースもコンピューターアカウントに限定され、管理者は自分のアカウントでリソースにアクセスすることはできません。

### <a name="automatic-restart-sign-on-credential-process"></a>自動再起動サインオンの資格情報プロセス
ユーザーが Windows 8.1 デバイスにサインインすると、LSA は LSASS.exe だけがアクセスできる暗号化されたメモリにユーザー資格情報を保存します。 Windows Update ユーザーが存在せずに自動再起動を開始すると、これらの資格情報を使用してユーザーの自動ログオンが構成されます。

再起動時に、ユーザーは自動ログオンメカニズムを使用して自動的にサインインされ、さらにコンピューターがロックされ、ユーザーのセッションが保護されます。 ロックは Winlogon によって開始されますが、資格情報の管理は LSA によって行われます。 コンソールでユーザーのセッションに自動的にサインインしてロックすることで、ユーザーのロック画面アプリケーションが再起動され、使用できるようになります。

ARSO の詳細については、「 [Winlogon 自動再起動サインオン &#40;arso&#41;](winlogon-automatic-restart-sign-on-arso.md)」を参照してください。

### <a name="stored-user-names-and-passwords-in-windows-vista-and-windows-xp"></a>Windows Vista および Windows XP での保存されたユーザー名とパスワード
Windows Server 2008、Windows Server 2003、Windows Vista、および Windows XP では、コントロールパネルに **格納されているユーザー名とパスワード** を使用すると、スマートカードや Windows Live 資格情報で使用される x.509 証明書 (Microsoft アカウントと呼ばれる) を含む、複数のログオン資格情報セットの管理と使用が簡単になります。 ユーザーのプロファイルの一部である資格情報は、必要になるまで格納されます。 この操作により、1つのパスワードが侵害された場合にセキュリティが侵害されないようにすることで、リソースごとにセキュリティを強化することができます。

ユーザーがログオンし、サーバー上の共有などの追加のパスワードで保護されたリソースにアクセスしようとした後、ユーザーの既定のログオン資格情報がアクセスできない場合は、 **保存されたユーザー名とパスワード** が照会されます。 正しいログオン情報を持つ代替資格情報が保存されている **ユーザー名とパスワード**に保存されている場合は、これらの資格情報を使用してアクセスできます。 それ以外の場合、ユーザーは新しい資格情報を入力するように求められます。この資格情報は、後でログオンセッションで、または以降のセッションで再利用するために保存できます。

次の制限事項が適用されます。

-   **保存されたユーザー名とパスワード**に特定のリソースの無効または正しくない資格情報が含まれている場合は、リソースへのアクセスが拒否され、[**保存されたユーザー名とパスワード**] ダイアログボックスは表示されません。

-   **保存されたユーザー名とパスワード** には、NTLM、Kerberos プロトコル、Microsoft アカウント (以前の WINDOWS Live ID)、および SECURE SOCKETS LAYER (SSL) 認証の資格情報のみが保存されます。 Internet Explorer の一部のバージョンでは、基本認証用に独自のキャッシュを保持しています。

これらの資格情報は、\Documents および Settings\Username\Application Data\Microsoft\Credentials ディレクトリのユーザーのローカルプロファイルの暗号化された部分になります。 このため、ユーザーのネットワークポリシーで移動ユーザープロファイルがサポートされている場合、これらの資格情報をユーザーとローミングできます。 ただし、ユーザーが保存された **ユーザー名とパスワード** のコピーを2台の異なるコンピューターに持っていて、これらのコンピューターのいずれかのリソースに関連付けられている資格情報を変更した場合、変更は、2台目のコンピューターの **保存されたユーザー名とパスワード** には反映されません。

### <a name="windows-vault-and-credential-manager"></a>Windows コンテナーと資格情報マネージャー
資格情報マネージャーは、ユーザー名とパスワードを格納および管理するためのコントロールパネル機能として、Windows Server 2008 R2 と Windows 7 で導入されました。 資格情報マネージャーを使用すると、他のシステムや web サイトに関連する資格情報をセキュリティで保護された Windows コンテナーに格納できます。 Internet Explorer の一部のバージョンでは、web サイトへの認証にこの機能を使用します。

資格情報マネージャーを使用した資格情報管理は、ローカル コンピューター上でユーザーが制御します。 ユーザーは、サポートされるブラウザーや Windows アプリケーションにサインインする必要があるときに便利なように、それらのリソースに資格情報を保存および格納することができます。 資格情報は、ユーザーのプロファイルの下にあるコンピューター上の特殊な暗号化されたフォルダーに保存されます。 Web ブラウザーやアプリなど、この機能をサポートするアプリケーションは、資格情報マネージャー Api を使用して、ログオンプロセス中に他のコンピューターや web サイトに正しい資格情報を提示することができます。

Web サイト、アプリケーション、または別のコンピューターが NTLM または Kerberos プロトコルを使用して認証を要求すると、ダイアログボックスが表示され、[ **既定の資格情報を更新** する] または [ **パスワードを保存** する] チェックボックスをオンにします。 ユーザーが資格情報をローカルに保存できるようにするこのダイアログボックスは、資格情報マネージャー Api をサポートするアプリケーションによって生成されます。 ユーザーが [パスワードを **保存** する] チェックボックスをオンにした場合、資格情報マネージャーは、使用されている認証サービスのユーザーのユーザー名、パスワード、および関連する情報を記録します。

次回サービスを使用すると、資格情報マネージャーによって Windows 資格情報が自動的に提供されます。 それが受け付けられない場合は、ユーザーは正しいアクセス情報の入力を要求されます。 新しい資格情報を使用してアクセス権が付与されると、資格情報マネージャーは、以前の資格情報を新しい資格情報で上書きし、新しい資格情報を Windows コンテナーに格納します。

## <a name="security-accounts-manager-database"></a><a name="BKMK_SAM"></a>セキュリティ アカウント マネージャー データベース
セキュリティアカウントマネージャー (SAM) は、ローカルユーザーアカウントとグループを格納するデータベースです。 これは、すべての Windows オペレーティングシステムに存在します。ただし、コンピューターがドメインに参加している場合、Active Directory は Active Directory ドメインのドメインアカウントを管理します。

たとえば、Windows オペレーティングシステムを実行しているクライアントコンピューターは、ユーザーがログオンしていない場合でも、ドメインコントローラーと通信することによって、ネットワークドメインに参加します。 通信を開始するには、コンピューターがドメイン内にアクティブなアカウントを持っている必要があります。 コンピューターからの通信を受け入れる前に、ドメインコントローラー上の LSA はコンピューターの id を認証し、ユーザーのセキュリティプリンシパルの場合と同様にコンピューターのセキュリティコンテキストを構築します。 このセキュリティコンテキストでは、特定のコンピューター上のユーザーまたはサービス、またはネットワーク上のユーザー、サービス、またはコンピューターの id と機能を定義します。 たとえば、セキュリティコンテキストに含まれるアクセストークンは、アクセス可能なリソース (ファイル共有やプリンターなど) と、そのプリンシパルによって実行可能なアクション (読み取り、書き込み、変更など) を定義します。このリソースは、そのリソースのユーザー、コンピューター、またはサービスによって実行されます。

ユーザーまたはコンピューターのセキュリティコンテキストは、1台のコンピューターによって異なる場合があります。たとえば、ユーザーがサーバーにログオンしたときや、ユーザー自身のプライマリワークステーション以外のワークステーションにログオンした場合などです。 また、管理者がユーザーの権利とアクセス許可を変更する場合など、セッションごとに異なる場合があります。 さらに、ユーザーまたはコンピューターがスタンドアロンで、ネットワーク内、または Active Directory ドメインの一部として動作している場合、セキュリティコンテキストは通常異なります。

## <a name="local-domains-and-trusted-domains"></a><a name="BKMK_LocalDomainsAndTrustedDomains"></a>ローカルドメインと信頼されたドメイン
2つのドメイン間に信頼関係が存在する場合、各ドメインの認証メカニズムは、もう一方のドメインからの認証の有効性に依存します。 信頼は、信頼された機関 (信頼される側のドメイン) からの受信認証要求であることを確認することによって、リソースドメイン (信頼する側のドメイン) の共有リソースへのアクセスを制御するのに役立ちます。 このようにして、信頼は、ドメイン間での認証要求の検証のみを行うブリッジとして機能します。

特定の信頼が認証要求に渡す方法は、どのように構成されているかによって異なります。 信頼される側のドメインから信頼する側のドメインのリソースにアクセスできるようにすることで、信頼関係のあるドメインから他のドメインのリソースへのアクセスを提供することで、信頼関係を一方向にすることができます。 信頼も非推移的です。この場合、2つの信頼関係パートナードメイン間にのみ信頼が存在するか、推移的に信頼関係が、パートナーのいずれかが信頼している他のすべてのドメインに自動的に拡張されます。

認証に関するドメインおよびフォレストの信頼関係の詳細については、「委任された [認証と信頼関係](/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/dn169022(v=ws.10))」を参照してください。

## <a name="certificates-in-windows-authentication"></a><a name="BKMK_CertificatesInWindowsAuthentication"></a>Windows 認証の証明書
公開キー基盤 (PKI) とは、組織が通信とビジネストランザクションをセキュリティで保護できるようにする、ソフトウェア、暗号化テクノロジ、プロセス、およびサービスを組み合わせたものです。 通信とビジネストランザクションをセキュリティで保護するための PKI の機能は、認証されたユーザーと信頼されたリソースの間のデジタル証明書の交換に基づいています。

デジタル証明書は、そのエンティティが属するエンティティ、その発行元のエンティティ、一意のシリアル番号またはその他の一意の識別、発行と有効期限、およびデジタル指紋に関する情報が含まれている電子ドキュメントです。

認証は、リモートホストを信頼できるかどうかを判断するプロセスです。 信頼を確立するには、リモートホストが受け入れ可能な認証証明書を提供する必要があります。

リモートホストは、証明機関 (CA) から証明書を取得することによって信頼性を確立します。 さらに、CA は、より高い権限を持つ証明書を持つことができます。これにより、信頼チェーンが作成されます。 証明書が信頼できるかどうかを判断するには、アプリケーションがルート CA の id を特定し、信頼できるかどうかを判断する必要があります。

同様に、リモートホストまたはローカルコンピューターは、ユーザーまたはアプリケーションによって提示された証明書が本物であるかどうかを判断する必要があります。 LSA と SSPI を通じてユーザーが提示した証明書は、ローカルコンピューターでのローカルログオン、ネットワーク上、または Active Directory の証明書ストアを介したドメインでの信頼性のために評価されます。

証明書を生成するために、認証データは、セキュアハッシュアルゴリズム 1 (SHA1) などのハッシュアルゴリズムを通じて、メッセージダイジェストを生成するために渡されます。 メッセージダイジェストは、送信者の秘密キーを使用してデジタル署名され、送信者によってメッセージダイジェストが生成されたことを証明します。

> [!NOTE]
> Windows 7 と Windows Vista では SHA1 が既定ですが、Windows 8 では SHA2 に変更されました。

**スマート カード認証**

スマートカードテクノロジは、証明書ベースの認証の一例です。 スマートカードを使用してネットワークにログオンすると、ドメインに対してユーザーを認証するときに暗号化ベースの識別と所有の証明が使用されるため、強力な認証形式が提供されます。 Active Directory 証明書サービス (AD CS) は、各スマートカードのログオン証明書を発行することによって、暗号化ベースの id を提供します。

スマートカード認証の詳細については、「 [Windows スマートカードのテクニカルリファレンス](/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/ff404297(v=ws.10))」を参照してください。

仮想スマートカードテクノロジは Windows 8 で導入されました。 スマートカードの証明書を PC に保存し、デバイスの改ざん防止トラステッドプラットフォームモジュール (TPM) セキュリティチップを使用して保護します。 このようにして、PC は実際にはスマートカードになります。これは、認証するためにユーザーの PIN を受け取る必要があります。

**リモート認証とワイヤレス認証**

リモートとワイヤレスのネットワーク認証は、認証に証明書を使用する別のテクノロジです。 インターネット認証サービス (IAS) と仮想プライベートネットワークサーバーは、拡張認証プロトコル-トランスポートレベルセキュリティ (EAP-TLS)、保護された拡張認証プロトコル (PEAP)、またはインターネットプロトコルセキュリティ (IPsec) を使用して、仮想プライベートネットワーク (VPN) やワイヤレス接続など、さまざまな種類のネットワークアクセスに対して証明書ベースの認証を実行します。

ネットワークでの証明書ベースの認証の詳細については、「 [ネットワークアクセスの認証と証明書](/previous-versions/windows/it-pro/windows-server-2003/cc759575(v=ws.10))」を参照してください。

## <a name="see-also"></a><a name="BKMK_SeeAlso"></a>関連項目
[Windows 認証の概念](./windows-authentication-concepts.md)