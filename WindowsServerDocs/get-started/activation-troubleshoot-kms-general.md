---
title: KMS のトラブルシューティングに関するガイドライン
description: KMS サービスに関する情報を提供し、ライセンス認証の問題をトラブルシューティングするためのツールと方法を提案します
ms.topic: troubleshooting
ms.date: 9/24/2019
ms.technology: server-general
author: Teresa-Motiv
ms.author: v-tea
manager: dcscontentpm
ms.localizationpriority: medium
ms.openlocfilehash: dc84edaebda64d3ae359e17b683411ac479c9397
ms.sourcegitcommit: 771db070a3a924c8265944e21bf9bd85350dd93c
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 06/27/2020
ms.locfileid: "85473219"
---
# <a name="guidelines-for-troubleshooting-the-key-management-service-kms"></a>キー管理サービス (KMS) のトラブルシューティングに関するガイドライン

多くの企業のお客様は、展開プロセスの一環として、キー管理サービス (KMS) を設定し、環境内での Windows のライセンス認証を有効にすることができます。 KMS ホストの設定プロセスは簡単であり、それが済むと、KMS クライアントによってホストが検出され、自動的にライセンス認証が試みられるようになります。 しかし、そのプロセスが機能しない場合はどうなるでしょうか。 次に何をすればよいのでしょうか。 この記事では、問題のトラブルシューティングに必要なリソースについて説明します。 イベント ログのエントリと Slmgr.vbs スクリプトの詳細については、「[ボリューム ライセンス認証テクニカル リファレンス](https://docs.microsoft.com/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/dn502529(v=ws.11))」を参照してください。

## <a name="kms-overview"></a>KMS の概要

最初に、KMS のライセンス認証について簡単にまとめておきます。 KMS は、クライアント/サーバー モデルです。 概念的には、DHCP に似ています。 KMS では、要求に応じてクライアントに IP アドレスが渡されるのではなく、製品のライセンス認証が有効にされます。 また、KMS は更新モデルであり、クライアントでは定期的にライセンスの再認証が試みられます。 "*KMS ホスト*" と "*KMS クライアント*" の 2 つの役割があります。

- **KMS ホスト**では、アクティブ化サービスが実行され、環境でのライセンス認証が有効にされます。 KMS ホストを構成するには、ボリューム ライセンス サービス センター (VLSC) から KMS キーをインストールした後、サービスをライセンス認証する必要があります。
- **KMS クライアント**は、環境に展開され、ライセンス認証する必要がある Windows オペレーティング システムです。 KMS クライアントでは、ボリューム ライセンス認証を使用する Windows の任意のエディションを実行できます。 KMS クライアントには、汎用ボリューム ライセンス キー (GVLK) または KMS クライアント セットアップ キーと呼ばれるキーがプレインストールされています。 GVLK が存在するシステムは KMS クライアントになります。 KMS クライアントでは、DNS SRV レコード (_vlmcs._tcp) を使用して KMS ホストが識別されます。 その後、クライアントでは自動的に、このサービスの検出とそれを使用したライセンス認証が試みられます。 既定では 30 日間の猶予期間中は、2 時間ごとにライセンス認証が試行されます。 ライセンス認証が済むと、KMS クライアントでは 7 日ごとにライセンス認証の更新が試みられます。

トラブルシューティングでは、両方の側 (ホストとクライアント) を調べて、何が起こっているかを確認することが必要になる場合があります。

## <a name="kms-host"></a>KMS ホスト

KMS ホストでは、2 つの点を調べる必要があります。 最初に、ホスト ソフトウェア ライセンス サービスの状態を確認します。 次に、イベント ビューアーで、ライセンス付与またはライセンス認証に関連するイベントを確認します。

### <a name="slmgrvbs-and-the-software-licensing-service"></a>Slmgr.vbs とソフトウェア ライセンス サービス

ソフトウェア ライセンス サービスからの詳細な出力を表示するには、管理者特権でのコマンド プロンプト ウィンドウを開き、コマンド プロンプトで「**slmgr.vbs /dlv**」と入力します。 次のスクリーンショットでは、Microsoft 内にある KMS ホストの 1 つでのこのコマンドの結果を示します。

![KMS ホストでの Slmgr の出力](./media/ee939272.kms_slmgr_output(en-us,technet.10).png)

トラブルシューティングのために最も重要なフィールドは次のとおりです。 何を探すかは、解決する問題によって異なる場合があります。

- **バージョン情報**。 **slmgr.vbs /dlv** の出力の先頭には、ソフトウェア ライセンス サービスのバージョンがあります。 これは、最新バージョンのサービスがインストールされているかどうかを判断するのに役立つ場合があります。 たとえば、Windows Server 2003 上の KMS サービスに対する更新プログラムでは、異なる KMS ホスト キーがサポートされています。 このデータを使用して、バージョンが最新かどうか、およびインストールしようとしている KMS ホスト キーがサポートされているかどうかを評価できます。 これらの更新プログラムの詳細については、「[Windows 7 および Windows Server 2008 R2 の KMS アクティベーション サポートを拡張するための Windows Vista および Windows Server 2008 用の更新プログラムについて](https://support.microsoft.com/help/968912/an-update-is-available-for-windows-vista-and-for-windows-server-2008-t)」を参照してください。
- **[名前]** 。 これは、KMS ホスト システムにインストールされている Windows のエディションを示します。 これは、KMS ホスト キーの追加または変更に関する問題が発生した場合のトラブルシューティングに重要な場合があります (その OS エディションでキーがサポートされているかどうかを確認する場合など)。
- **[説明]** 。 ここには、インストールされているキーが表示されます。 サービスのライセンス認証に使用されたキー、およびそれが展開した KMS クライアントに対して正しいものかどうかを確認するには、このフィールドを使用します。
- **License Status (ライセンスの状態)** 。 KMS ホスト システムの状態です。 値が **Licensed (ライセンス済み)** になっている必要があります。 それ以外の値は、何らかの問題が発生しており、ホストの再ライセンス認証が必要な場合があることを意味します。
- **Current Count (現在の数)** 。 表示されるカウントは、**0** から **50** の間です。 カウントは (オペレーティング システム間で) 累積され、30 日以内にライセンス認証が試みられた有効なシステムの数が示されます。

  カウントが **0** の場合は、サービスのライセンス認証が最近行われたこと、または有効なクライアントが KMS ホストに接続しなかったことを示します。

  環境内に存在する有効なシステムの数に関係なく、この数が **50** より大きくなることはありません。 これは、これらのカウントが、KMS クライアントによって返される最大ライセンス ポリシーの 2 倍だけをキャッシュするように設定されているためです。 現時点では、最大ポリシーは Windows クライアント OS によって設定され、それ自体のライセンス認証のために KMS ホストから **25** 以上のカウントが必要です。 そのため、KMS ホストでの最大数は、2 x 25 つまり 50 です。 Windows Server KMS クライアントのみが含まれている環境では、KMS ホストの最大数は **10** になることに注意してください。 これは、Windows Server のエディションのしきい値が **5** (2 x 5 つまり 10) であるためです。

  カウントに関してよくある問題は、環境にライセンス認証された KMS ホストと十分なクライアントがあるのに、カウントが 1 より大きくならない場合です。 主な問題は、展開されたクライアント イメージが正しく構成されておらず (**sysprep /generalize**)、システムに一意のクライアント コンピューター ID (CMID) がないことです。 詳細については、「[KMS クライアント](#kms-client)」と「[Windows Vista または Windows 7 ベースの新しいクライアント コンピューターをネットワークに追加しても、KMS の現在の数が増加しない](https://support.microsoft.com/help/929829/the-kms-current-count-does-not-increase-when-you-add-new-windows-vista)」を参照してください。 サポート エスカレーション エンジニアの 1 人によるこの問題についてのブログ投稿「[重複する CMID のために KMS ホスト クライアント数が増加しない](https://blogs.technet.microsoft.com/askcore/2009/10/16/kms-host-client-count-not-increasing-due-to-duplicate-cmids/)」も参照してください。

  カウントが増加しない可能性があるもう 1 つの理由は、環境内の KMS ホストの数が多すぎて、カウントがすべてのホストに分散されている場合です。
- **Listening on Port (リッスン先のポート)** 。 KMS との通信には匿名 RPC が使用されます。 既定では、クライアントによる KMS ホストへの接続には TCP ポート 1688 が使用されます。 KMS クライアントと KMS ホストの間で、このポートが開かれていることを確認します。 KMS ホストでポートを変更または構成することができます。 通信の間に、KMS ホストによって KMS クライアントにポートの指定が送信されます。 KMS クライアントでポートを変更すると、そのクライアントがホストに接続するときに、ポートの指定が上書きされます。

**slmgr.vbs /dlv** の出力の "cumulative requests" (累積要求数) セクションについて質問されることがよくあります。 一般に、このデータはトラブルシューティングには役に立ちません。 KMS ホストでは、ライセンス認証または再ライセンス認証を試みる各 KMS クライアントの状態の継続的な記録が保持されています。 失敗した要求は、KMS ホストでサポートされていない KMS クライアントを示します。 たとえば、Windows Vista の KMS キーを使用してライセンス認証された KMS ホストに対して、Windows 7 の KMS クライアントがライセンス認証を試みた場合、ライセンス認証は失敗します。 "Requests with License Status" (ライセンスの状態が ... の要求数) 行では、過去および現在のすべての可能なライセンスの状態が示されています。 トラブルシューティングの点からは、このデータは、カウントが想定どおりに増加していない場合にのみ関連します。 その場合は、失敗した要求の数が増えているはずです。 これは、KMS ホスト システムのライセンス認証に使用されたプロダクト キーを確認する必要があることを示しています。 また、累積要求の値は KMS ホスト システムを再インストールする場合にのみリセットされることに注意してください。

### <a name="useful-kms-host-events"></a>便利な KMS ホスト イベント

#### <a name="event-id-12290"></a>イベント ID 12290

KMS クライアントがライセンス認証のためにホストに接続すると、KMS ホストでイベント ID 12290 がログに記録されます。 イベント ID 12290 では、ホストに接続したクライアントの種類とエラーが発生した理由を明らかにするために使用できる大量の情報が提供されます。 イベント ID 12290 のエントリの次のセグメントは、KMS ホストのキー管理サービスのイベント ログから取得されます。

![KMS 12290 イベント](./media/ee939272.kms_12290_event(en-us,technet.10).png)

イベントの詳細には次の情報が含まれます。

- **ライセンス認証するために必要な最小カウント**。 KMS クライアントでは、ライセンス認証を行うには KMS ホストからのカウントが **5** でなければならないことが報告されています。 つまり、これは Windows Server OS ですが、特定のエディションは示されていません。 クライアントがライセンス認証されない場合は、カウントがホストにおいて十分であることを確認してください。
- **クライアント コンピューター ID (CMID)** 。 これは、システムごとに一意の値です。 この値が一意でない場合は、イメージがディストリビューションに対して正しく準備されていないことが原因です (**sysprep /generalize**)。 この問題は、KMS ホスト上では、環境内に十分な数のクライアントがあるにも関わらず、カウントが増加しないことで示されます。 詳細については、「[Windows Vista または Windows 7 ベースの新しいクライアント コンピューターをネットワークに追加しても、KMS の現在の数が増加しない](https://support.microsoft.com/help/929829/the-kms-current-count-does-not-increase-when-you-add-new-windows-vista)」を参照してください。
- **ライセンスの状態および状態の有効期限までの時間**。 これは、クライアントの現在のライセンスの状態です。 初めてライセンス認証を試みているクライアントと、再ライセンス認証を試みているクライアントを区別するのに役立ちます。 時刻のエントリは、何も変更されない場合に、クライアントがその状態にとどまる時間を示します。

クライアントのトラブルシューティングを行っていて、KMS ホストで対応するイベント ID 12290 が見つからない場合、そのクライアントは KMS ホストに接続していません。 イベント ID 12290 のエントリが存在しない理由としては、次のようなものがあります。

- ネットワークの停止が発生しました。
- DNS でホストが解決されていないか、登録されていません。
- ファイアウォールで TCP 1688 がブロックされています。
   KMS ホスト システム自体など、ポートは環境内のさまざまな場所でブロックされる可能性があります。 KMS ホストには既定で KMS に対するファイアウォールの例外がありますが、自動的に有効になることはありません。 例外を有効にする必要があります。
- イベント ログ ファイルがいっぱいです。

KMS クライアントでは、2 つの対応するイベント (イベント ID 12288 とイベント ID 12289) がログに記録されます。 これらのイベントの詳細については、「[KMS クライアント](#kms-client)」セクションを参照してください。

#### <a name="event-id-12293"></a>イベント ID 12293

KMS ホストで検索するもう 1 つの関連イベントは、イベント ID 12293 です。 このイベントは、ホストで DNS に必要なレコードが発行されなかったことを示します。 このような状況ではエラーが発生することがわかっており、ホストを設定した "*後*"、クライアントを展開する "*前*" に、確認する必要がある事柄です。 DNS の問題について詳しくは、[KMS と DNS の問題に関する一般的なトラブルシューティング手順](common-troubleshooting-procedures-kms-dns.md)に関する記事をご覧ください。

## <a name="kms-client"></a>KMS クライアント

クライアントでは、同じツール (Slmgr とイベント ビューアー) を使用して、ライセンス認証のトラブルシューティングを行います。

### <a name="slmgrvbs-and-the-software-licensing-service"></a>Slmgr.vbs とソフトウェア ライセンス サービス

ソフトウェア ライセンス サービスからの詳細な出力を表示するには、管理者特権でのコマンド プロンプト ウィンドウを開き、コマンド プロンプトで「**slmgr.vbs /dlv**」と入力します。 次のスクリーンショットでは、Microsoft 内にある KMS ホストの 1 つでのこのコマンドの結果を示します。

![KMS クライアントでの Slmgr の出力](./media/ee939272.kms_client_slmgr_output(en-us,technet.10).png)

次の一覧では、トラブルシューティングのために最も重要なフィールドを示します。 何を探すかは、解決する問題によって異なる場合があります。

- **[名前]** 。 この値は、KMS クライアント システムにインストールされている Windows のエディションです。 ライセンス認証しようとしている Windows のバージョンで KMS を使用できることを確認するには、これを使用します。 たとえば、Windows Vista Ultimate などのボリューム ライセンス認証が使用されない Windows のエディションで、ユーザーが KMS クライアント セットアップ キーをインストールしようとしたというインシデントが、弊社のヘルプ デスクで発生しています。
- **[説明]** 。 この値では、インストールされているキーが示されます。 VOLUME_KMSCLIENT は、KMS クライアント セットアップ キー (または GVLK) がインストールされていること (ボリューム ライセンス メディアでの既定の構成)、およびこのシステムで KMS ホストを使用したライセンス認証が自動的に試みられることを示します。 MAK などの別のものがここに表示される場合は、GVLK を再インストールし、このシステムを KMS クライアントとして構成する必要があります。 **slmgr.vbs /ipk &lt;*GVLK*&gt;** を使用して手動でキーをインストールするか (「[KMS クライアント セットアップ キー](kmsclientkeys.md)」を参照)、ボリューム ライセンス認証管理ツール (VAMT) を使用することができます。 VAMT の入手と使用については、「[ボリューム ライセンス認証管理ツール (VAMT) のテクニカル リファレンス](https://docs.microsoft.com/windows/deployment/volume-activation/volume-activation-management-tool)」を参照してください。
- **Partial Product Key (プロダクト キーの一部)** 。 **Name (名前)** フィールドと同じように、この情報を使用して、正しい KMS クライアント セットアップ キーがこのコンピューターにインストールされているかどうかを判断できます (つまり、キーは KMS クライアントにインストールされているオペレーティング システムと一致します)。 既定では、ボリューム ライセンス サービス センター (VLSC) ポータルのメディアを使用して構築されたシステムには、正しいキーが存在します。 場合によっては、KMS ライセンス認証をサポートするために十分なシステムが環境に存在するようになるまで、顧客が複数ライセンス認証キー (MAK) ライセンス認証を使用することがあります。 MAK から KMS に移行するには、KMS クライアント セットアップ キーをこれらのシステムにインストールする必要があります。 VAMT を使用してこのキーをインストールし、正しいキーが適用されていることを確認します。
- **License Status (ライセンスの状態)** 。 この値では、KMS クライアント システムの状態が示されます。 KMS を使用してライセンス認証されたシステムの場合、この値は **Licensed (ライセンス済み)** になっている必要があります。 それ以外の値は、問題があることを示している可能性があります。 たとえば、KMS ホストが正常に機能していて、KMS クライアントがライセンス認証されない場合 (たとえば、**Grace (猶予)** 状態のままになっている)、何らかの理由でクライアントがホスト システムに到達できない可能性があります (ファイアウォールの問題、ネットワークの停止など)。
- **Client Machine ID (CMID) (クライアント コンピューター ID (CMID))** 。 各 KMS クライアントには、一意の CMID が必要です。 「[KMS ホスト](#kms-host)」セクションで説明したように、カウントに関してよくある問題は、環境にライセンス認証された KMS ホストと十分なクライアントがあるのに、カウントが **1** より大きくならない場合です。 詳細については、「[Windows Vista または Windows 7 ベースの新しいクライアント コンピューターをネットワークに追加しても、KMS の現在の数が増加しない](https://support.microsoft.com/help/929829/the-kms-current-count-does-not-increase-when-you-add-new-windows-vista)」を参照してください。
- **KMS Machine Name from DNS (DNS の KMS コンピューター名)** 。 この値は、クライアントでライセンス認証に正常に使用された KMS ホストの FQDN と、通信に使用された TCP ポートを示します。
- **KMS Host Caching (KMS ホスト キャッシュ)** 。 最後の値では、キャッシュが有効になっているかどうかが示されます。 既定では有効になっています。 これは、KMS クライアントではライセンス認証に使用された KMS ホストの名前がキャッシュされており、再ライセンス認証のときは (DNS に照会するのではなく) このホストと直接通信することを意味します。 クライアントでキャッシュされた KMS ホストに接続できない場合は、DNS に照会して新しい KMS ホストを検出します。

### <a name="useful-kms-client-events"></a>便利な KMS クライアント イベント

#### <a name="event-id-12288-and-event-id-12289"></a>イベント ID 12288 とイベント ID 12289

KMS クライアントのライセンス認証または再ライセンス認証が正常に行われると、クライアントでは 2 つのイベント (イベント ID 12288 とイベント ID 12289) がログに記録されます。 イベント ID 12288 のエントリの次のセグメントは、KMS クライアントのキー管理サービスのイベント ログから取得されます。

![KMS クライアント イベント ID 12288](./media/ee939272.client_12288(en-us,technet.10).png)

イベント ID 12288 のみが表示される場合は (対応するイベント ID 12289 がない)、KMS クライアントが KMS ホストに接続できなかったこと、KMS ホストが応答しなかったこと、またはクライアントが応答を受信しなかったことを意味します。 この場合は、KMS ホストが検出可能で、KMS クライアントがそれにアクセスできることを確認します。

イベント ID 12288 で最も関連性の高い情報は、Info (情報) セクションのデータです。 たとえば、このセクションでは、クライアントの現在の状態に加えて、クライアントがライセンス認証を試みたときに使用した FQDN と TCP ポートが示されます。 FQDN を使用すると、KMS ホストでカウントが増えない場合のトラブルシューティングを行うことができます。 たとえば、クライアントが使用できる KMS ホストの数が多すぎる場合 (正当なシステムまたは偽のシステム)、カウントはそのすべてに分散される可能性があります。

ライセンス認証が失敗しても、必ずしもクライアントに 12288 が存在して 12289 が存在しないとは限りません。 ライセンス認証または再ライセンス認証が失敗した場合でも、両方のイベントが存在する可能性があります。 この場合は、2 番目のイベントを調べて、エラーの原因を確認する必要があります。

![KMS クライアント イベント ID 12289](./media/ee939272.client_12289(en-us,technet.10).png)

イベント ID 12289 の Info (情報) セクションでは、次の情報が提供されます。

- **ライセンス認証フラグ**。 この値は、ライセンス認証が成功したか (**1**)、失敗したか (**0**) を示します。
- **KMS ホストでの現在の数**。 この値には、クライアントがライセンス認証を試みたときの KMS ホストでのカウントの値が反映されます。 ライセンス認証が失敗した場合は、このクライアント OS に対してカウントが不十分であること、またはカウントを構築するのに十分な数のシステムが環境内にないことが原因である可能性があります。

## <a name="what-does-support-ask-for"></a>サポートから求められること

サポートに連絡してライセンス認証のトラブルシューティングを行う必要がある場合、通常、サポート エンジニアから次の情報を求められます。

- KMS ホスト システムおよび KMS クライアント システムからの **Slmgr.vbs /dlv** の出力。 wscript または cscript のどちらを使用してコマンドを実行するかどうかにかかわらず、Ctrl + C キーを使用して出力をコピーし、メモ帳に貼り付けて、サポートの連絡先に送信することができます。
- KMS ホスト (キー管理サービス ログ) と KMS クライアント システム (アプリケーション ログ) の両方からのイベント ログ

## <a name="additional-references"></a>その他の参照情報
- [コア チームにたずねる: #Activation](https://blogs.technet.microsoft.com/askcore/tag/Activation/)


