---
title: ADBA クライアントのトラブルシューティング
description: Windows ライセンス認証の問題のトラブルシューティング プロセスについて説明します
ms.topic: troubleshooting
ms.date: 09/24/2019
ms.technology: server-general
author: Teresa-Motiv
ms.author: v-tea
manager: dcscontentpm
ms.localizationpriority: medium
ms.openlocfilehash: d56b2d002b0403971dc50fab639f77bddf1f8809
ms.sourcegitcommit: d5e27c1f2f168a71ae272bebf8f50e1b3ccbcca3
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 07/23/2020
ms.locfileid: "86959884"
---
# <a name="example-troubleshooting-active-directory-based-activation-adba-clients-that-do-not-activate"></a>例:ライセンス認証が行われない Active Directory によるライセンス認証 (ADBA) クライアントのトラブルシューティング

> [!NOTE]
> この記事は、2018 年 3 月 26 日に TechNet ブログとして最初に公開されたのもです。

こんにちは。 私の名前は Mike Kammer です。2 年以上にわたって Microsoft のプラットフォーム PFE を担当しています。 最近、あるお客様の環境への Windows Server 2016 の展開を支援しました。 この機会に、ライセンス認証方法も KMS サーバーから [Active Directory によるライセンス認証](/previous-versions/windows/hh852637(v=win.10))へと移行することにしました。

すべての変更を行うための適切な手順として、移行をお客様のテスト環境で開始しました。 展開を開始するために、Charity Shelbourne 氏による、[Active Directory によるライセンス認証とキー管理サービスの比較](https://techcommunity.microsoft.com/t5/Core-Infrastructure-and-Security/Active-Directory-Based-Activation-vs-Key-Management-Services/ba-p/256016)に関するこの素晴らしいブログ記事に記載された手順を行いました。 テスト環境のドメイン コントローラーすべてで Windows Server 2012 R2 が実行されているので、フォレストを準備する必要はありませんでした。 Windows Server 2012 R2 ドメイン コントローラーにロールをインストールし、ボリューム ライセンス認証方法として Active Directory ベースのライセンス認証を選択しました。 KMS キーをインストールし、「KMS AD Activation (* * LAB)」という名前を付けました。 ブログ記事にある手順にほぼ従いました。

私たちは、4 台の仮想マシンと、2 つの Windows 2016 Standard および 2 つの Windows 2016 Datacenter を構築することから始めました。 この時点ではすべてが順調で、皆満足していました。 Windows 2016 Standard を実行している物理サーバーを構築し、マシンは正常にライセンス認証されました。 これで、私たちの話は終わりです。

というのは、 冗談です。 そのように簡単にはいきませんでした。 実際のところ、セットアップと構成は非常に簡単でした。その部分についてはシンプルで容易でした。 月曜日にオフィスに戻ったところ、前の週に構築した仮想マシンすべてが、ライセンス認証されていない状態でした。 どうしたことでしょう。 これは、よくありません。 物理マシンを調べましたが、問題はありませんでした。 何が起こったのかを話し合うため、お客様のところに行きました。 最初の質問はもちろん、「週末に変更されたところはありますか?」でした。 答えはいつものとおり、「何もないです。」でした。 今回は本当に何も変更されていないので、何が起こっているのかを把握する必要がありました。

問題のサーバーの 1 つでコマンド プロンプトを開き、**slmgr /ao-list** コマンドの出力を確認しました。 **/ao-list** スイッチを指定すると、Active Directory 内のすべてのライセンス認証オブジェクトが表示されます。

![slmgr コマンドを示す画像](./media/032618_1700_Troubleshoo1.png)

![slmgr コマンドの結果を示す画像](./media/032618_1700_Troubleshoo2.png)

結果は、2 つのライセンス認証オブジェクトがあることを示しています。1 つは Windows Server 2012 R2 用で、もう 1 つは Windows Server 2016 ライセンスである、新しく作成された KMS AD Activation (* * LAB) です。 これにより、Active Directory が Windows KMS クライアントをライセンス認証するように正しく構成されていることが確認できます。

ライセンス認証に関して **slmgr** コマンドを使用できることがわかっていたので、続いて別のオプションを使用することにしました。 **/dlv** スイッチを試してみました。これにより詳細なライセンス情報が表示されます。 Windows Server 2016 の Standard バージョンを実行しており、ライセンス認証 ID、インストール ID、検証 URL、そして部分プロダクト キーもあり、問題はないように見えました。

![slmgr /dlv の結果を示す画像](./media/ActivationTroubleshoot2b.jpg)

ここで私が何を見逃したか、おわかりになりますか? 他のトラブルシューティング手順を説明したあとにあらためてお話しますが、答えはこのスクリーンショットにある、ということをお伝えすれば十分でしょう。

この時点での私の考えは、何らかの理由でキーが壊れているということでした。そのため、 **/upk** スイッチを使用して、現在のキーをアンインストールしました。 これはキーの削除には有効ですが、一般的には最適な方法ではありません。 新しいキーを取得する前にサーバーが再起動した場合は、サーバーが適切ではない状態のままになる可能性があります。 **/ipk** スイッチを使用すれば (このトラブルシューティングの後半で行いました) 既存のキーが上書きされるため、こちらの方がより安全な方法です。 私の失敗を教訓としてください。

![slmgr /upk コマンドとその結果を示す画像](./media/032618_1700_Troubleshoo3.png)

詳細なライセンス情報を確認するため、 **/dlv** スイッチを再度実行しました。 残念なことに、役に立つ情報を得ることはできませんでした。プロダクト キーが見つからないというエラーが表示されただけです。 それはもちろん、私がキーをアンインストールしたばかりだからです。

![slmgr /dlv コマンドとその結果を示す画像](./media/032618_1700_Troubleshoo4.png)

大きな賭けだとわかってはいましたが、私は **/ato** スイッチを試してみました。これにより、既知の KMS サーバー (場合によっては Active Directory) に対して Windows のライセンス認証が行われるはずです。 やはり、製品が見つからないというエラーが表示されただけでした。

![slmgr /ato コマンドとその結果を示す画像](./media/032618_1700_Troubleshoo5.png)

次に、サービスの停止と開始を行えばうまくいくことがあると考え、次のことを試しました。 Microsoft ソフトウェア保護プラットフォーム サービス (SPPSvc サービス) を停止して開始します。 管理コマンド プロンプトから、信頼できる **net stop** および **net start** コマンドを使用しました。 最初は、サービスが実行されていないことを確認できたので、これで解決できると思いました。

![net stop および net start コマンドの結果を示す画像](./media/032618_1700_Troubleshoo6.png)

しかし、そうではありませんでした。 サービスを開始し、Windows のライセンス認証を再度試みたところ、製品が見つからないというエラーがまた表示されました。

次に、問題のサーバーのうち 1 台でアプリケーション イベント ログを調べました。 コード 0x8007007B の、ライセンス認証、イベント ID 8198 に関するエラーを見つけました。

![イベント ID 8198 の詳細を示す画像](./media/032618_1700_Troubleshoo7.png)

このコードについて調べたところ、このエラー コードはファイル名、ディレクトリ名、またはボリューム ラベルの構文が正しくないことを意味する、という記事を見つけました。 その記事で説明されている方法を読みましたが、どれも私の状況には合っていないように思われました。 **nslookup -type=all _vlmcs._tcp** コマンドを実行したところ、既存の KMS サーバー (この環境にはまだ多くの Windows 7 と Windows Server 2008 マシンが存在するため、それはそのままにしておく必要がありました) が見つかりましたが、5 つのドメイン コントローラーも同時に見つかりました。 これは、DNS の問題ではなく、問題が他の場所にあることを示すものです。

![nslookup コマンドの結果を示す画像](./media/032618_1700_Troubleshoo8.png)

これで、DNS に問題がないことがわかりました。 Active Directory は、KMS ライセンス認証ソースとして適切に構成されています。 物理サーバーは正常にライセンス認証されています。 これは VM だけの問題になるのでしょうか? ここで興味深いことに、お客様が私に、別の部門の誰かも 10 数台以上の仮想 Windows Server 2016 マシンを構築することにした、と話してくれました。 そのため私は、ライセンス認証されないサーバーが 10 数台増え、対処しなくてはならないだろうと思いました。 しかし、そうではありませんでした。 それらのサーバーは正常にライセンス認証されたのです。

ここで私はまた **slmgr** コマンドを実行して、問題のマシンをどうしたらライセンス認証できるか解明しようとしました。 今回は、 **/ipk** スイッチを使用します。これによりプロダクト キーをインストールできます。 [このサイト](/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/jj612867(v=ws.11))にアクセスして、Windows Server 2016 の Standard バージョンに適したキーを取得しました。 一部のサーバーは Datacenter ですが、最初にこれを修正する必要がありました。

![KMS クライアント セットアップ キーの一覧を示す画像](./media/032618_1700_Troubleshoo9.png)

**/ipk** スイッチを使用して、Windows Server 2016 Standard キーを選択してプロダクト キーをインストールしました。

![slmgr /ipk コマンドとその結果を示す画像](./media/032618_1700_Troubleshoo10.png)

ここからは、Datacenter で実行した結果だけをキャプチャしたのですが、同じものとなります。 **/ato** スイッチを使用して、ライセンス認証を強制的に実行しました。 製品が正常にライセンス認証されたという、素晴らしいメッセージが表示されました。

![slmgr /ato コマンドとその結果を示す画像](./media/032618_1700_Troubleshoo11.png)

**/dlv** スイッチを再度使用し、今回は Active Directory によりライセンス認証が行われたことがわかりました。

![slmgr /dlv コマンドとその結果を示す画像](./media/032618_1700_Troubleshoo12.png)

では、何が問題だったのでしょうか? 私はなぜ、これらのマシンが正しくライセンス認証されるように、インストールされたキーを削除してこれらの汎用キーを追加する必要があったのでしょうか? 他の 10 数台以上のマシンが問題なくライセンス認証されたのはなぜなのでしょうか? 前にお話ししたとおり、この問題を調べる最初の段階で、私は重要な何かを見逃していたのです。 私は完全に混乱していたため、最初のブログ記事の Charity 氏に助けを求めました。 彼女は問題をすぐに見てくれて、私が最初の段階で何を見逃したのかを教えてくれました。

私が最初に **/dlv** スイッチを実行したとき、説明に示されていたのはキーでした。 説明は、"Windows® Operating System, RETAIL Channel" となっていました。 私はこれを見て、RETAIL Channel は購入済みであることを示し、有効なキーであると考えました。

![チャネル情報が強調表示されている、slmgr /dlv の結果を示す画像](./media/032618_1700_Troubleshoo13.png)

正しくライセンス認証されたサーバーからの **/dlv** スイッチの結果を見ると、説明には "VOLUME_KMSCLIENT channel" と示されています。 これはボリューム ライセンスであるということが、これによってわかります。

![チャネル情報が強調表示されている、slmgr /dlv の結果を示す画像](./media/032618_1700_Troubleshoo14.png)

では、RETAIL channel とはどういう意味なのでしょうか? これは、オペレーティング システムのインストールに使用されたメディアが MSDN ISO である、ということを意味するのです。 私はお客様に、もしかしたら 2 つ目の Windows Server 2016 ISO がネットワークに存在するのでは、とたずねました。 答えはイエスでした。ネットワーク上に別の ISO があり、他の 10 数台のマシンの作成に使用されていたのです。 お客様は 2 つの ISO を比較し、仮想サーバーを構築するために私に割り当てられたのが、やはり MSDN ISO であったことがわかりました。 お客様のネットワークからこの MSDN ISO は削除されました。現在では既存のすべてのサーバーがライセンス認証され、今後の構築でライセンス認証に失敗する心配もありません。

この記事が皆さまのお役に立つことを願っております。

Mike
