---
title: ボリューム シャドウ コピー サービス
ms.date: 01/30/2019
ms.prod: windows-server
ms.technology: storage
author: JasonGerend
manager: elizapo
ms.author: jgerend
ms.openlocfilehash: 19e07504dad49c5e23cc49630015529e2a746aa7
ms.sourcegitcommit: 6aff3d88ff22ea141a6ea6572a5ad8dd6321f199
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 09/27/2019
ms.locfileid: "71394447"
---
# <a name="volume-shadow-copy-service"></a>ボリューム シャドウ コピー サービス

適用対象: Windows Server 2019、Windows Server 2016、Windows Server 2012 R2、windows server 2012、Windows Server 2008 R2、Windows Server 2008、Windows 10、Windows 8.1、Windows 8、Windows 7

重要なビジネスデータのバックアップと復元は、次のような問題が原因で非常に複雑になる可能性があります。

  - データを生成するアプリケーションがまだ実行されている間は、通常、データをバックアップする必要があります。 これは、一部のデータファイルが開いているか、一貫性のない状態になっている可能性があることを意味します。  
      
  - データセットが大きい場合、一度にすべてのデータセットをバックアップすることが困難になることがあります。  
      

バックアップと復元の操作を適切に実行するには、バックアップアプリケーション、バックアップする基幹業務アプリケーション、および記憶域管理のハードウェアとソフトウェアの間で、密接な連携が必要です。 Windows Server®2003で導入されたボリュームシャドウコピーサービス (VSS) を使用すると、これらのコンポーネント間のメッセージ交換を容易にすることができます。 すべてのコンポーネントで VSS がサポートされている場合は、アプリケーションをオフラインにしなくても、それらを使用してアプリケーションデータをバックアップできます。

VSS では、バックアップするデータの一貫したシャドウコピー (スナップショットまたは特定の時点のコピーとも呼ばれます) を作成するために必要なアクションを調整します。 シャドウコピーはそのように使用することも、次のようなシナリオで使用することもできます。

  - 別のハードディスクドライブ、テープ、またはその他のリムーバブルメディアにデータをアーカイブするなど、アプリケーションのデータとシステム状態の情報をバックアップする必要がある。  
      
  - データマイニングです。  
      
  - ディスクからディスクへのバックアップを実行しています。  
      
  - 元の LUN にデータを復元するか、障害が発生した元の LUN を置き換える完全に新しい LUN にデータを復元することにより、データ損失から迅速に回復する必要があります。  
      

VSS を使用する Windows の機能とアプリケーションには、次のものが含まれます。

  - [Windows Server バックアップ](http://go.microsoft.com/fwlink/?linkid=180891)(http://go.microsoft.com/fwlink/?LinkId=180891)  
      
  - [共有フォルダーのシャドウコピー](http://go.microsoft.com/fwlink/?linkid=142874) (http://go.microsoft.com/fwlink/?LinkId=142874)  
      
  - [System Center Data Protection Manager](http://go.microsoft.com/fwlink/?linkid=180892) (http://go.microsoft.com/fwlink/?LinkId=180892)  
      
  - [システムの復元](http://go.microsoft.com/fwlink/?linkid=180893)(http://go.microsoft.com/fwlink/?LinkId=180893)  
      

## <a name="how-volume-shadow-copy-service-works"></a>ボリュームシャドウコピーサービスのしくみ

完全な VSS ソリューションには、次の基本部分がすべて必要です。

**VSS サービス**は、他のコンポーネントが適切に通信し、連携できるように、Windows オペレーティングシステムの一部を   します。

**VSS リクエスター**は、実際にシャドウコピーの作成を要求するソフトウェア (または、インポートや削除などの高レベルの操作) を   します。 通常、これはバックアップアプリケーションです。 Windows Server バックアップユーティリティと System Center Data Protection Manager アプリケーションは、VSS の依頼者です。 Microsoft 以外の® VSS の依頼者には、Windows で実行されるほとんどすべてのバックアップソフトウェアが含まれています。

**VSS writer**は、バックアップするための一貫したデータセットがあることを保証するコンポーネント   します。 これは通常、SQL Server®や Exchange Server などの基幹業務アプリケーションの一部として提供されます。 Windows オペレーティングシステムには、レジストリなどのさまざまな Windows コンポーネントの VSS ライターが含まれています。 Microsoft 以外の VSS ライターは、バックアップ中のデータの整合性を保証する必要がある Windows 用の多くのアプリケーションに含まれています。

**VSS プロバイダー**は、シャドウコピーを作成して維持するコンポーネント   します。 これは、ソフトウェアまたはハードウェアで発生する可能性があります。 Windows オペレーティングシステムには、書き込み時コピーを使用する VSS プロバイダーが含まれています。 記憶域ネットワーク (SAN) を使用する場合は、SAN の VSS ハードウェアプロバイダーが提供されている場合は、それらをインストールすることが重要です。 ハードウェアプロバイダは、ホストオペレーティングシステムからシャドウコピーを作成して維持するタスクをオフロードします。

次の図は、VSS サービスが依頼者、ライター、およびプロバイダーと連携してボリュームのシャドウコピーを作成する方法を示しています。

![](media/volume-shadow-copy-service/Ee923636.94dfb91e-8fc9-47c6-abc6-b96077196741(WS.10).jpg)

**図 1**   ボリュームシャドウコピーサービスのアーキテクチャ図

### <a name="how-a-shadow-copy-is-created"></a>シャドウコピーの作成方法

このセクションでは、シャドウコピーの作成に必要な手順を一覧表示して、要求元、ライター、およびプロバイダーのさまざまなロールをコンテキストに含めます。 次の図は、ボリュームシャドウコピーサービスが要求元、ライター、およびプロバイダーの全体的な調整を制御する方法を示しています。

![](media/volume-shadow-copy-service/Ee923636.1c481a14-d6bc-4796-a3ff-8c6e2174749b(WS.10).jpg)

**図 2**シャドウコピーの作成プロセス

シャドウコピーを作成するために、リクエスター、ライター、およびプロバイダーは、次の操作を実行します。

1.  要求元は、ライターを列挙し、ライターメタデータを収集し、シャドウコピーの作成を準備するために、ボリュームシャドウコピーサービスに要求します。  
      
2.  各ライターは、バックアップする必要があるコンポーネントとデータストアの XML 記述を作成し、ボリュームシャドウコピーサービスに提供します。 また、ライターは、すべてのコンポーネントで使用される復元メソッドも定義します。 ボリュームシャドウコピーサービスは、ライターの説明を要求元に提供し、バックアップするコンポーネントを選択します。  
      
3.  ボリュームシャドウコピーサービスは、すべてのライターに対して、シャドウコピーを作成するためのデータを準備するように通知します。  
      
4.  各ライターは、すべての開いているトランザクションの完了、トランザクションログのローリング、キャッシュのフラッシュなど、必要に応じてデータを準備します。 データをシャドウコピーする準備ができたら、ライターはボリュームシャドウコピーサービスに通知します。  
      
5.  このボリュームシャドウコピーサービスは、ボリュームまたはボリュームのシャドウコピーの作成に必要な数秒間、アプリケーションの書き込み i/o 要求 (読み取り i/o 要求が可能) を一時的に固定するようライターに指示します。 アプリケーションのフリーズは、60秒より長くかかることはありません。 ボリュームシャドウコピーサービスは、ファイルシステムのバッファーをフラッシュし、ファイルシステムをフリーズします。これにより、ファイルシステムのメタデータが正しく記録され、シャドウコピーされるデータが一貫性のある順序で書き込まれます。  
      
6.  ボリュームシャドウコピーサービスは、シャドウコピーを作成するようにプロバイダーに指示します。 シャドウコピーの作成期間は10秒以内で、ファイルシステムへの書き込み i/o 要求はすべて固定されたままになります。  
      
7.  ボリュームシャドウコピーサービスは、ファイルシステムの書き込み i/o 要求を解放します。  
      
8.  VSS は、アプリケーション書き込み i/o 要求の解凍をライターに指示します。 この時点で、アプリケーションは、シャドウコピーされているディスクにデータの書き込みを再開することができます。  
      

> [!NOTE]
> ライターが60秒より長く凍結状態で保持されている場合、またはプロバイダーがシャドウコピーのコミットに10秒以上かかる場合は、シャドウコピーの作成を中止できます。 
<br>

9. 要求元は、プロセスを再試行 (手順1に戻る) するか、後で再試行するよう管理者に通知することができます。  
      
10. シャドウコピーが正常に作成された場合、ボリュームシャドウコピーサービスによって、要求元にシャドウコピーの場所情報が返されます。 場合によっては、シャドウコピーを読み取り/書き込みボリュームとして一時的に使用できるため、シャドウコピーが完了する前に VSS と1つ以上のアプリケーションでシャドウコピーの内容を変更できます。 VSS とアプリケーションが変更を行った後、シャドウコピーは読み取り専用になります。 このフェーズは自動回復と呼ばれ、シャドウコピーが作成される前に完了しなかったシャドウコピーボリューム上のファイルシステムまたはアプリケーショントランザクションを元に戻すために使用されます。  
      

### <a name="how-the-provider-creates-a-shadow-copy"></a>プロバイダーがシャドウコピーを作成する方法

ハードウェアまたはソフトウェアのシャドウコピープロバイダーは、次のいずれかの方法でシャドウコピーを作成します。

**完全**なコピー   このメソッドは、特定の時点で元のボリュームの完全なコピー ("完全コピー" または "複製" と呼ばれます) を作成します。 このコピーは読み取り専用です。

**書き込み時にコピー**する   このメソッドでは、元のボリュームはコピーされません。 代わりに、特定の時点以降にボリュームに対して行われたすべての変更 (書き込み i/o 要求の完了) をコピーして差分コピーを作成します。

**[書き込み時にリダイレクト**する]   この方法では、元のボリュームはコピーされません。特定の時点以降は元のボリュームに変更は加えられません。 代わりに、すべての変更を別のボリュームにリダイレクトすることで、差分コピーを作成します。

## <a name="complete-copy"></a>完全なコピー

完全なコピーは、通常、次のように "分割ミラー" を作成することによって作成されます。

1.  元のボリュームとシャドウコピーボリュームは、ミラー化されたボリュームセットです。  
      
2.  シャドウコピーボリュームは、元のボリュームから分離されます。 これにより、ミラー接続が切断されます。  
      

ミラー接続が切断された後、元のボリュームとシャドウコピーボリュームは独立しています。 元のボリュームでは、すべての変更 (書き込み i/o 要求) が引き続き受け入れられますが、シャドウコピーボリュームは、中断時に元のデータの読み取り専用の正確なコピーを保持します。

### <a name="copy-on-write-method"></a>書き込み時コピーメソッド

書き込み時コピー方法では、元のボリュームに対する変更が発生したとき (ただし、書き込み i/o 要求が完了する前) に、変更される各ブロックが読み取られ、ボリュームのシャドウコピー記憶域 ("差分領域" とも呼ばれます) に書き込まれます。 シャドウコピーの記憶域は、同じボリュームまたは別のボリュームに配置できます。 これにより、変更によって上書きされる前に、元のボリュームにデータブロックのコピーが保持されます。


<table>
<colgroup>
<col style="width: 33%" />
<col style="width: 33%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr class="header">
<th>時間</th>
<th>ソースデータ (状態とデータ)</th>
<th>シャドウコピー (状態とデータ)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p>T0</p></td>
<td><p>元のデータ: 1 2 3 4 5</p></td>
<td><p>コピーなし: —</p></td>
</tr>
<tr class="even">
<td><p>T1</p></td>
<td><p>キャッシュでデータが変更されました: 3 ~ 3</p></td>
<td><p>作成されたシャドウコピー (相違点のみ): 3</p></td>
</tr>
<tr class="odd">
<td><p>T2</p></td>
<td><p>元のデータが上書きされた場合: 1 2 3 ' 4 5</p></td>
<td><p>シャドウコピーに格納されている相違点とインデックス: 3</p></td>
</tr>
</tbody>
</table>

**表 1**   シャドウコピーを作成する書き込み時コピー方法

書き込み時コピー方法は、変更されたデータのみがコピーされるため、シャドウコピーを作成するための簡単な方法です。 差分領域内のコピーされたブロックは、元のボリューム上の変更されたデータと組み合わせて、変更が行われる前の状態にボリュームを復元することができます。 多くの変更が加えられた場合、書き込み時コピーの方法はコストが高くなる可能性があります。

### <a name="redirect-on-write-method"></a>リダイレクト/書き込みメソッド

書き込み時リダイレクト方式では、元のボリュームが変更 (書き込み i/o 要求) を受信するたびに、変更は元のボリュームに適用されません。 代わりに、変更は別のボリュームのシャドウコピー記憶域に書き込まれます。


<table>
<colgroup>
<col style="width: 33%" />
<col style="width: 33%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr class="header">
<th>時間</th>
<th>ソースデータ (状態とデータ)</th>
<th>シャドウコピー (状態とデータ)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p>T0</p></td>
<td><p>元のデータ: 1 2 3 4 5</p></td>
<td><p>コピーなし: —</p></td>
</tr>
<tr class="even">
<td><p>T1</p></td>
<td><p>キャッシュでデータが変更されました: 3 ~ 3</p></td>
<td><p>シャドウコピーの作成 (相違点のみ): 3 '</p></td>
</tr>
<tr class="odd">
<td><p>T2</p></td>
<td><p>元のデータは変更されません: 1 2 3 4 5</p></td>
<td><p>シャドウコピーに格納されている相違点とインデックス: 3 '</p></td>
</tr>
</tbody>
</table>

**表 2**   シャドウコピーを作成するためのリダイレクト/書き込み方法

書き込み時コピー方法と同様に、データへの変更のみがコピーされるため、シャドウコピーを作成するための簡単な方法として、書き込み時の転送方法があります。 差分領域内のコピーされたブロックは、元のボリューム上の変更されていないデータと組み合わせて、データの完全な最新コピーを作成できます。 読み取り i/o 要求が多数ある場合は、書き込み時の書き込み方法が高価になることがあります。

## <a name="shadow-copy-providers"></a>シャドウコピープロバイダー

シャドウコピープロバイダーには、ハードウェアベースのプロバイダーとソフトウェアベースのプロバイダーの2種類があります。 また、システムプロバイダーもあります。これは、Windows オペレーティングシステムに組み込まれているソフトウェアプロバイダーです。

### <a name="hardware-based-providers"></a>ハードウェアベースのプロバイダー

ハードウェアベースのシャドウコピープロバイダーは、ハードウェアストレージアダプターまたはコントローラーと連携して動作することによって、ボリュームシャドウコピーサービスとハードウェアレベルの間のインターフェイスとして機能します。 シャドウコピーの作成と保守の作業は、記憶域配列によって実行されます。

ハードウェアプロバイダーは常に LUN 全体のシャドウコピーを取得しますが、ボリュームシャドウコピーサービスは、要求されたボリュームのシャドウコピーのみを公開します。

ハードウェアベースのシャドウコピープロバイダーは、特定の時点を定義し、データの同期を可能にし、シャドウコピーを管理し、バックアップアプリケーションとの共通のインターフェイスを提供する、ボリュームシャドウコピーサービスの機能を利用します。 ただし、ボリュームシャドウコピーサービスでは、ハードウェアベースのプロバイダーによるシャドウコピーの生成と保持に使用する、基になるメカニズムが指定されていません。

### <a name="software-based-providers"></a>ソフトウェアベースのプロバイダー

通常、ソフトウェアベースのシャドウコピープロバイダーは、ファイルシステムとボリュームマネージャーソフトウェア間のソフトウェアレイヤーでの読み取りおよび書き込みの i/o 要求をインターセプトして処理します。

これらのプロバイダーは、ユーザーモードの DLL コンポーネントとして実装され、少なくとも1つのカーネルモードデバイスドライバー (通常はストレージフィルタードライバー) として実装されます。 ハードウェアベースのプロバイダーとは異なり、ソフトウェアベースのプロバイダーは、ハードウェアレベルではなく、ソフトウェアレベルでシャドウコピーを作成します。

ソフトウェアベースのシャドウコピープロバイダーは、シャドウコピーの作成時間の前にボリュームの状態を再作成するために使用できるデータセットにアクセスすることによって、ボリュームの "特定の時点" のビューを維持する必要があります。 例として、システムプロバイダーのコピー時書き込みの手法があります。 ただし、ボリュームシャドウコピーサービスでは、ソフトウェアベースのプロバイダーがシャドウコピーの作成と管理に使用する技法に制限はありません。

ソフトウェアプロバイダーは、ハードウェアベースのプロバイダーよりも広範なストレージプラットフォームに適用されます。また、ベーシックディスクや論理ボリュームと同様に機能します。 (論理ボリュームは、2つ以上のディスクの空き領域を組み合わせることによって作成されるボリュームです)。ハードウェアシャドウコピーとは対照的に、ソフトウェアプロバイダーは、オペレーティングシステムリソースを使用してシャドウコピーを保持します。

ベーシックディスクの詳細については、「[ベーシックディスクとボリュームとは何ですか?](http://go.microsoft.com/fwlink/?linkid=180894) 」を参照してください。 (TechNet の http://go.microsoft.com/fwlink/?LinkId=180894)。

### <a name="system-provider"></a>システムプロバイダー

Windows オペレーティングシステムでは、1つのシャドウコピープロバイダー (システムプロバイダー) が提供されています。 Windows では既定のプロバイダーが提供されていますが、他のベンダーは、ストレージハードウェアおよびソフトウェアアプリケーション用に最適化された実装を自由に提供できます。

シャドウコピーに含まれているボリュームの "特定の時点" のビューを維持するために、システムプロバイダーは書き込み時コピーの手法を使用します。 シャドウコピーの作成開始以降に変更されたボリューム上のブロックのコピーは、シャドウコピーの記憶域に格納されます。

システムプロバイダーは運用ボリュームを公開できます。このボリュームは、通常どおりに書き込みや読み取りができます。 シャドウコピーが必要な場合は、実稼働ボリューム上のデータに差分を論理的に適用して、完全なシャドウコピーを公開します。

システムプロバイダーの場合、シャドウコピーの記憶域は NTFS ボリューム上にある必要があります。 シャドウコピーするボリュームは、NTFS ボリュームである必要はありませんが、少なくとも1つのボリュームが NTFS ボリュームである必要があります。

システムプロバイダーを構成するコンポーネントファイルは、swprv と volsnap です。

### <a name="in-box-vss-writers"></a>インボックス VSS ライター

Windows オペレーティングシステムには、さまざまな Windows 機能で必要なデータを列挙する VSS ライターのセットが含まれています。

これらのライターの詳細については、次の Microsoft Web サイトを参照してください。

  - [インボックス VSS ライター](http://go.microsoft.com/fwlink/?linkid=180895) (http://go.microsoft.com/fwlink/?LinkId=180895)  
      
  - [Windows Server 2008 および Windows VISTA SP1 用の新しいインボックス VSS ライター](http://go.microsoft.com/fwlink/?linkid=180896) (http://go.microsoft.com/fwlink/?LinkId=180896)  
      
  - [Windows Server 2008 R2 および windows 7 用の新しいインボックス VSS ライター](http://go.microsoft.com/fwlink/?linkid=180897) (http://go.microsoft.com/fwlink/?LinkId=180897)  
      

## <a name="how-shadow-copies-are-used"></a>シャドウコピーの使用方法

シャドウコピーは、アプリケーションデータとシステム状態情報のバックアップに加えて、次のようなさまざまな目的で使用できます。

  - Lun の復元 (LUN の再同期と LUN スワップ)  
      
  - 個々のファイルの復元 (共有フォルダーのシャドウコピー)  
      
  - 転送可能シャドウコピーを使用したデータマイニング  
      

### <a name="restoring-luns-lun-resynchronization-and-lun-swapping"></a>Lun の復元 (LUN の再同期と LUN スワップ)

Windows Server 2008 R2 および Windows 7 では、VSS の依頼者は、LUN の再同期 (または "LUN の再同期") と呼ばれるハードウェアシャドウコピープロバイダーの機能を使用できます。 これは、アプリケーション管理者がシャドウコピーから元の LUN または新しい LUN にデータを復元できるようにする、高速復旧スキームです。

シャドウコピーは、完全な複製または差分シャドウコピーにすることができます。 どちらの場合も、再同期操作の終了時に、コピー先 LUN のコンテンツはシャドウコピー LUN と同じになります。 再同期操作中、配列はシャドウコピーからコピー先の LUN へのブロックレベルのコピーを実行します。


> [!NOTE]
> シャドウコピーは、転送可能なハードウェアシャドウコピーである必要があります。 
<br>


ほとんどの配列では、再同期操作の開始直後に実稼働 i/o 操作を再開できます。 再同期操作の実行中、読み取り要求はシャドウコピー LUN にリダイレクトされ、要求は宛先 LUN に書き込まれます。 これにより、アレイは非常に大きなデータセットを復旧し、数秒で通常の操作を再開できます。

Lun の再同期は、LUN スワップとは異なります。 LUN スワップは、Windows Server 2003 SP1 以降で VSS がサポートする高速復旧シナリオです。 LUN スワップでは、シャドウコピーがインポートされ、読み取り/書き込みボリュームに変換されます。 変換は元に戻すことができない操作であり、その後、ボリュームと基になる LUN を VSS Api で制御することはできません。 次の一覧では、LUN の再同期が LUN スワップと比較する方法について説明します。

  - LUN の再同期では、シャドウコピーは変更されないため、複数回使用できます。 LUN スワップでは、シャドウコピーを1回の回復でのみ使用できます。 安全性を意識する最も安全な管理者にとっては、これが重要です。 LUN の再同期を使用すると、最初に何らかの問題が発生した場合に、要求元が復元操作全体を再試行できます。  
      
  - LUN スワップの最後に、シャドウコピー LUN が運用 i/o 要求に使用されます。 このため、シャドウコピー LUN は、回復操作後にパフォーマンスが影響を受けないように、元の運用 LUN と同じ容量の記憶域を使用する必要があります。 代わりに LUN の再同期が使用されている場合、ハードウェアプロバイダーは、実稼働品質の記憶域よりも安価な記憶域にシャドウコピーを保持できます。  
      
  - 移行先 LUN が使用できず、再作成が必要な場合、LUN のスワップは、宛先 LUN を必要としないため、より経済的になる可能性があります。  
      


> [!WARNING]
> 一覧表示されているすべての操作は、LUN レベルの操作です。 LUN の再同期を使用して特定のボリュームを回復しようとすると、LUN を共有している他のすべてのボリュームが元に戻されます。 
<br>


### <a name="restoring-individual-files-shadow-copies-for-shared-folders"></a>個々のファイルの復元 (共有フォルダーのシャドウコピー)

共有フォルダーのシャドウコピーは、ボリュームシャドウコピーサービスを使用して、ファイルサーバーなどの共有ネットワークリソースに配置されているファイルの特定の時点のコピーを提供します。 共有フォルダーのシャドウコピーを使用すると、ネットワークに保存されている削除または変更されたファイルを迅速に回復できます。 管理者の支援なしで実行できるため、共有フォルダーのシャドウコピーによって生産性が向上し、管理コストが削減されます。

共有フォルダーのシャドウコピーの詳細については、TechNet[の「](http://go.microsoft.com/fwlink/?linkid=180898)共有フォルダーのシャドウコピー http://go.microsoft.com/fwlink/?LinkId=180898)」を参照してください。

### <a name="data-mining-by-using-transportable-shadow-copies"></a>転送可能シャドウコピーを使用したデータマイニング

ボリュームシャドウコピーサービスと共に使用するように設計されたハードウェアプロバイダーを使用すると、同じサブシステム (SAN など) 内のサーバーにインポートできる、転送可能なシャドウコピーを作成できます。 これらのシャドウコピーを使用すると、データマイニングの読み取り専用データを使用して、運用環境またはテスト環境のインストールをシードすることができます。

ボリュームシャドウコピーサービスと、ボリュームシャドウコピーサービスで使用するように設計されたハードウェアプロバイダーがあるストレージアレイでは、1台のサーバーにソースデータボリュームのシャドウコピーを作成してから、シャドウコピーを別のサーバーにインポートすることができます。 (または同じサーバーに戻します)。 データのサイズに関係なく、このプロセスは数分で完了します。 トランスポートプロセスは、転送可能なシャドウコピーをサポートするシャドウコピーリクエスター (記憶域管理アプリケーション) を使用する一連の手順によって実現されます。

## <a name="to-transport-a-shadow-copy"></a>シャドウコピーを転送するには

1.  サーバー上のソースデータの転送可能なシャドウコピーを作成します。

2.  SAN に接続されているサーバーにシャドウコピーをインポートします (別のサーバーまたは同じサーバーにインポートできます)。

3.  これで、データを使用する準備ができました。

![](media/volume-shadow-copy-service/Ee923636.633752e0-92f6-49a7-9348-f451b1dc0ed7(WS.10).jpg)

**図 3**   2 つのサーバー間でのシャドウコピーの作成と転送


> [!NOTE]
> Windows server 2003 に作成された転送可能なシャドウコピーは、Windows Server 2008 または Windows Server 2008 R2 を実行しているサーバーにインポートすることはできません。 Windows server 2008 または Windows Server 2008 R2 で作成された転送可能なシャドウコピーは、Windows Server 2003 を実行しているサーバーにインポートすることはできません。 ただし、windows server 2008 で作成されたシャドウコピーは、Windows Server 2008 R2 を実行しているサーバーにインポートできます。また、その逆の場合もあります。 
<br>


シャドウ コピーは読み取り専用です。 シャドウコピーを読み取り/書き込み LUN に変換する場合は、ボリュームシャドウコピーサービスに加えて、仮想ディスクサービスベースの記憶域管理アプリケーション (一部の依頼者も含む) を使用できます。 このアプリケーションを使用すると、ボリュームシャドウコピーサービス管理からシャドウコピーを削除して、読み取り/書き込み LUN に変換することができます。

ボリュームシャドウコピーサービストランスポートは、Windows Server 2003 Enterprise Edition、Windows Server 2003 Datacenter Edition、Windows Server 2008、または Windows Server 2008 R2 を実行しているコンピューターの高度なソリューションです。 記憶域配列にハードウェアプロバイダーがある場合にのみ機能します。 シャドウコピートランスポートは、テープバックアップ、データマイニング、テストなど、さまざまな目的で使用できます。

## <a name="frequently-asked-questions"></a>よく寄せられる質問

この FAQ は、システム管理者のボリュームシャドウコピーサービス (VSS) に関する質問に回答します。 VSS アプリケーションプログラミングインターフェイスの詳細については、[ Windows デベロッパーセンターのライブラリの「](http://go.microsoft.com/fwlink/?linkid=180899)ボリュームシャドウコピーサービス http://go.microsoft.com/fwlink/?LinkId=180899)」を参照してください。

### <a name="when-was-volume-shadow-copy-service-introduced-on-which-windows-operating-system-versions-is-it-available"></a>Was ボリュームシャドウコピーサービス導入された場合 使用可能な Windows オペレーティングシステムのバージョンを教えてください。

VSS は Windows XP で導入されました。 Windows XP、Windows Server 2003、Windows Vista®、Windows Server 2008、Windows 7、および Windows Server 2008 R2 で使用できます。

### <a name="what-is-the-difference-between-a-shadow-copy-and-a-backup"></a>シャドウコピーとバックアップの違いは何ですか。

ハードディスクドライブのバックアップの場合は、作成されたシャドウコピーがバックアップでもあります。 復元用にシャドウコピーからデータをコピーすることも、シャドウコピーを使用して高速回復のシナリオ (LUN の再同期や LUN スワップなど) を使用することもできます。

シャドウコピーからテープまたはその他のリムーバブルメディアにデータをコピーすると、メディアに格納されているコンテンツによってバックアップが構成されます。 シャドウコピー自体は、データがコピーされた後で削除できます。

### <a name="what-is-the-largest-size-volume-that-volume-shadow-copy-service-supports"></a>ボリュームシャドウコピーサービスがサポートしている最大サイズのボリュームは何ですか。

ボリュームシャドウコピーサービスは、最大 64 TB のボリュームサイズをサポートしています。

### <a name="i-made-a-backup-on-windows-server2008-can-i-restore-it-on-windows-server2008r2"></a>Windows Server 2008 でバックアップを作成しました。 Windows Server 2008 R2 で復元することはできますか。

これは、使用したバックアップソフトウェアによって異なります。 ほとんどのバックアッププログラムでは、システム状態のバックアップではなく、データのこのシナリオがサポートされます。

これらのいずれかのバージョンの Windows で作成されたシャドウコピーは、もう一方でも使用できます。

### <a name="i-made-a-backup-on-windows-server2003-can-i-restore-it-on-windows-server2008"></a>Windows Server 2003 でバックアップを作成しました。 Windows Server 2008 で復元することはできますか。

使用するバックアップソフトウェアによって異なります。 Windows Server 2003 でシャドウコピーを作成した場合、Windows Server 2008 で使用することはできません。 また、Windows Server 2008 でシャドウコピーを作成した場合は、Windows Server 2003 では復元できません。

### <a name="how-can-i-disable-vss"></a>VSS を無効にするにはどうすればよいですか。

Microsoft 管理コンソールを使用して、ボリュームシャドウコピーサービスを無効にすることができます。 ただし、この操作は行わないでください。 VSS を無効にすると、システムの復元や Windows Server バックアップなど、使用するソフトウェアに悪影響が及びます。

詳細については、次の Microsoft TechNet Web サイトを参照してください。

  - [システムの復元](http://go.microsoft.com/fwlink/?linkid=157113)(http://go.microsoft.com/fwlink/?LinkID=157113)  
      
  - [Windows Server バックアップ](http://go.microsoft.com/fwlink/?linkid=180891)(http://go.microsoft.com/fwlink/?LinkID=180891)  
      

### <a name="can-i-exclude-files-from-a-shadow-copy-to-save-space"></a>シャドウコピーからファイルを除外して領域を節約することはできますか。

VSS は、ボリューム全体のシャドウコピーを作成するように設計されています。 ページングファイルなどの一時ファイルは、領域を節約するために、シャドウコピーから自動的に除外されます。

シャドウコピーから特定のファイルを除外するには、次のレジストリキーを使用します。 **Filesnottosnapshot**。


> [!NOTE]
> <STRONG>Filesnottosnapshot</STRONG>レジストリキーは、アプリケーションによってのみ使用されることを目的としています。 これを使用しようとすると、次のような制限が発生します。
> <br>
> <UL>
> <LI>以前のバージョンの機能を使用して、Windows Server 上で作成されたシャドウコピーからファイルを削除することはできません。<BR><BR>
> <LI>共有フォルダーのシャドウコピーからファイルを削除することはできません。<BR><BR>
> <LI><a href="https://docs.microsoft.com/windows-server/administration/windows-commands/diskshadow" data-raw-source="[Diskshadow](https://docs.microsoft.com/windows-server/administration/windows-commands/diskshadow)">Diskshadow</a>ユーティリティを使用して作成されたシャドウコピーからファイルを削除することはできますが、 <a href="https://docs.microsoft.com/windows-server/administration/windows-commands/vssadmin" data-raw-source="[Vssadmin](https://docs.microsoft.com/windows-server/administration/windows-commands/vssadmin)">Vssadmin</a>ユーティリティを使用して作成されたシャドウコピーからファイルを削除することはできません。<BR><BR>
> <LI>ファイルは、ベストエフォート方式でシャドウコピーから削除されます。 つまり、削除されることは保証されていません。<BR><BR></LI></UL>


詳細については、MSDN の「[シャドウコピーからのファイルの除外](http://go.microsoft.com/fwlink/?linkid=180904)」 (http://go.microsoft.com/fwlink/?LinkId=180904) を参照してください。

### <a name="my-non-microsoft-backup-program-failed-with-a-vss-error-what-can-i-do"></a>Microsoft 以外のバックアッププログラムが VSS エラーのために失敗しました。 どうすればいいんでしょうか。

バックアッププログラムを作成した会社の Web サイトの製品サポートセクションを確認します。 この問題を解決するには、ダウンロードしてインストールできる製品の更新プログラムがある可能性があります。 それ以外の場合は、会社の製品サポート部門にお問い合わせください。

システム管理者は、次の Microsoft TechNet ライブラリ Web サイトにある VSS のトラブルシューティング情報を使用して、VSS 関連の問題に関する診断情報を収集できます。

詳細については、TechNet[の「](http://go.microsoft.com/fwlink/?linkid=180905)ボリュームシャドウコピーサービス http://go.microsoft.com/fwlink/?LinkId=180905)」を参照してください。

### <a name="what-is-the-diff-area"></a>"Diff area" とは何ですか?

シャドウコピーの記憶域 (または "diff area") は、システムソフトウェアプロバイダーによって作成されたシャドウコピーのデータが格納される場所です。

### <a name="where-is-the-diff-area-located"></a>差分領域はどこにありますか。

差分領域は、任意のローカルボリュームに配置できます。 ただし、それを格納するのに十分な領域がある NTFS ボリュームに配置する必要があります。

### <a name="how-is-the-diff-area-location-determined"></a>差分領域の場所はどのように決定されますか。

次の条件がこの順序で評価され、差分領域の場所が決定されます。

  - ボリュームに既存のシャドウコピーが既に存在する場合は、その場所が使用されます。  
      
  - 元のボリュームとシャドウコピーボリュームの場所の間に事前に構成された手動の関連付けがある場合は、その場所が使用されます。  
      
  - 前の2つの条件で場所が指定されていない場合、シャドウコピーサービスは使用可能な空き領域に基づいて場所を選択します。 複数のボリュームがシャドウコピーされている場合、シャドウコピーサービスは、空き領域のサイズに基づいて、使用可能なスナップショットの場所の一覧を降順で作成します。 指定された場所の数は、シャドウコピーされているボリュームの数と同じです。  
      
  - シャドウコピー対象のボリュームが、可能な場所の1つである場合は、ローカルの関連付けが作成されます。 それ以外の場合は、使用可能な領域が最も多いボリュームとの関連付けが作成されます。  
      

### <a name="can-vss-create-shadow-copies-of-non-ntfs-volumes"></a>VSS では、NTFS 以外のボリュームのシャドウコピーを作成できますか。

[はい]。 ただし、永続的なシャドウコピーは NTFS ボリュームに対してのみ作成できます。 また、システムにマウントされた少なくとも1つのボリュームが NTFS ボリュームである必要があります。

### <a name="whats-the-maximum-number-of-shadow-copies-i-can-create-at-one-time"></a>一度に作成できるシャドウコピーの最大数は何ですか。

1つのシャドウコピーセットでシャドウコピーされるボリュームの最大数は64です。 これはシャドウコピーの数と同じではないことに注意してください。

### <a name="whats-the-maximum-number-of-software-shadow-copies-created-by-the-system-provider-that-i-can-maintain-for-a-volume"></a>ボリュームに対して保持できるシステムプロバイダーによって作成されるソフトウェアシャドウコピーの最大数は何ですか。

各ボリュームのソフトウェアシャドウコピーの最大数は512です。 ただし、既定では、共有フォルダーのシャドウコピー機能によって使用される64シャドウコピーのみを保持できます。 共有フォルダーのシャドウコピー機能の制限を変更するには、次のレジストリキーを使用します: **MaxShadowCopies**。

### <a name="how-can-i-control-the-space-that-is-used-for-shadow-copy-storage-space"></a>シャドウコピーの記憶域スペースに使用する領域は、どのようにして制御できますか。

**Vssadmin resize shadowstorage**コマンドを入力します。

詳細については、TechNet の「 [Vssadmin resize shadowstorage](http://go.microsoft.com/fwlink/?linkid=180906) (http://go.microsoft.com/fwlink/?LinkId=180906)」を参照してください。

### <a name="what-happens-when-i-run-out-of-space"></a>領域が不足した場合はどうなりますか。

ボリュームのシャドウコピーは、最も古いシャドウコピーから削除されます。

## <a name="volume-shadow-copy-service-tools"></a>ボリュームシャドウコピーサービスツール

Windows オペレーティングシステムには、VSS を操作するための次のツールが用意されています。

  - [DiskShadow](http://go.microsoft.com/fwlink/?linkid=180907) (http://go.microsoft.com/fwlink/?LinkId=180907)  
      
  - [VssAdmin](http://go.microsoft.com/fwlink/?linkid=84008) (http://go.microsoft.com/fwlink/?LinkId=84008)  
      

### <a name="diskshadow"></a>DiskShadow

DiskShadow は、システム上で使用できるすべてのハードウェアおよびソフトウェアのスナップショットを管理するために使用できる VSS 要求者です。 DiskShadow には、次のようなコマンドが含まれています。

  - **一覧**: vss ライター、vss プロバイダー、シャドウコピーを一覧表示します。  
      
  - **作成**: 新しいシャドウコピーを作成します。  
      
  - **インポート**: 転送可能なシャドウコピーをインポートします。  
      
  - **公開**: 永続的なシャドウコピー (たとえば、ドライブ文字) を公開します。  
      
  - **元に戻す**: 指定したシャドウコピーにボリュームを戻します。  
      

このツールは IT プロフェッショナルによる使用を目的としていますが、開発者は VSS ライターまたは VSS プロバイダーをテストする際にも役立つことがあります。

DiskShadow は、Windows Server オペレーティングシステムでのみ使用できます。 Windows クライアントオペレーティングシステムでは使用できません。

### <a name="vssadmin"></a>VssAdmin

VssAdmin は、シャドウコピーに関する情報を作成、削除、および一覧表示するために使用されます。 また、シャドウコピーのストレージ領域のサイズを変更するためにも使用できます ("diff area")。

VssAdmin には、次のようなコマンドが含まれています。

  - **シャドウの作成**: 新しいシャドウコピーを作成します。  
      
  - シャドウの**削除**: シャドウコピーを削除します  
      
  - **リストプロバイダー**: 登録されているすべての VSS プロバイダーを一覧表示します  
      
  - **リストライター**: サブスクライブされているすべての VSS ライターの一覧表示  
      
  - **shadowstorage のサイズ**変更: シャドウコピーの記憶域領域の最大サイズを変更します。  
      

VssAdmin は、システムソフトウェアプロバイダーによって作成されたシャドウコピーの管理にのみ使用できます。

VssAdmin は、Windows クライアントおよび Windows Server オペレーティングシステムのバージョンで使用できます。

## <a name="volume-shadow-copy-service-registry-keys"></a>レジストリキーのボリュームシャドウコピーサービス

VSS では、次のレジストリキーを使用できます。

  - **VssAccessControl**  
      
  - **MaxShadowCopies**  
      
  - **Mindiffgram**  
      

### <a name="vssaccesscontrol"></a>VssAccessControl

このキーは、シャドウコピーにアクセスできるユーザーを指定するために使用されます。

詳細については、MSDN Web サイトの次のエントリを参照してください。

  - [ライターのセキュリティに関する考慮事項](http://go.microsoft.com/fwlink/?linkid=157739)(http://go.microsoft.com/fwlink/?LinkId=157739)  
      
  - [依頼者向けのセキュリティに関する考慮事項](http://go.microsoft.com/fwlink/?linkid=180908)(http://go.microsoft.com/fwlink/?LinkId=180908)  
      

### <a name="maxshadowcopies"></a>MaxShadowCopies

このキーは、コンピューターの各ボリュームに保存できる、クライアントがアクセスできるシャドウコピーの最大数を指定します。 クライアントがアクセスできるシャドウコピーは、共有フォルダーのシャドウコピーによって使用されます。

詳細については、MSDN Web サイトの次のエントリを参照してください。

[バックアップと復元のレジストリキーの下の](http://go.microsoft.com/fwlink/?linkid=180909) **MaxShadowCopies** (http://go.microsoft.com/fwlink/?LinkId=180909)

### <a name="mindiffareafilesize"></a>Mindiffgram

このキーは、シャドウコピーの記憶域領域の最小初期サイズを MB 単位で指定します。

詳細については、MSDN Web サイトの次のエントリを参照してください。

[バックアップと復元のためのレジストリキーの下に](http://go.microsoft.com/fwlink/?linkid=180910)ある**minのサイズ**(http://go.microsoft.com/fwlink/?LinkId=180910)

`##`# ' サポートされているオペレーティングシステムのバージョン

次の表は、VSS 機能でサポートされるオペレーティングシステムの最小バージョンを示しています。


<table>
<colgroup>
<col style="width: 33%" />
<col style="width: 33%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr class="header">
<th>VSS 機能</th>
<th>サポートされている最小のクライアント</th>
<th>サポートされている最小のサーバー</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p>LUN の再同期</p></td>
<td><p>サポートなし</p></td>
<td><p>Windows Server 2008 R2</p></td>
</tr>
<tr class="even">
<td><p><strong>Filesnottosnapshot</strong>レジストリキー</p></td>
<td><p>Windows Vista</p></td>
<td><p>Windows Server 2008</p></td>
</tr>
<tr class="odd">
<td><p>転送可能シャドウコピー</p></td>
<td><p>サポートなし</p></td>
<td><p>Windows Server 2003 SP1</p></td>
</tr>
<tr class="even">
<td><p>ハードウェアシャドウコピー</p></td>
<td><p>サポートなし</p></td>
<td><p>Windows Server 2003</p></td>
</tr>
<tr class="odd">
<td><p>以前のバージョンの Windows Server</p></td>
<td><p>Windows Vista</p></td>
<td><p>Windows Server 2003</p></td>
</tr>
<tr class="even">
<td><p>LUN スワップを使用した高速回復</p></td>
<td><p>サポートなし</p></td>
<td><p>Windows Server 2003 SP1</p></td>
</tr>
<tr class="odd">
<td><p>ハードウェアシャドウコピーの複数のインポート</p>
<div class="alert">
<table>
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="header">
<th><img src="media/volume-shadow-copy-service/Dd560667.note(WS.10).gif" />注</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>これは、シャドウコピーを複数回インポートする機能です。 一度に実行できるインポート操作は1つだけです。
<p></p></td>
</tr>
</tbody>
</table>
<p></p>
</div></td>
<td><p>サポートなし</p></td>
<td><p>Windows Server 2008</p></td>
</tr>
<tr class="even">
<td><p>共有フォルダーのシャドウ コピー</p></td>
<td><p>サポートなし</p></td>
<td><p>Windows Server 2003</p></td>
</tr>
<tr class="odd">
<td><p>転送可能な自動回復されたシャドウコピー</p></td>
<td><p>サポートなし</p></td>
<td><p>Windows Server 2008</p></td>
</tr>
<tr class="even">
<td><p>同時バックアップセッション (最大 64)</p></td>
<td><p>Windows XP</p></td>
<td><p>Windows Server 2003</p></td>
</tr>
<tr class="odd">
<td><p>バックアップと同時に実行される単一の復元セッション</p></td>
<td><p>Windows Vista</p></td>
<td><p>Windows Server 2003 SP2</p></td>
</tr>
<tr class="even">
<td><p>バックアップと同時に最大8つの復元セッション</p></td>
<td><p>Windows 7</p></td>
<td><p>Windows Server 2003 R2</p></td>
</tr>
</tbody>
</table>

## <a name="see-also"></a>関連項目

[Windows デベロッパーセンターのボリュームシャドウコピーサービス](https://docs.microsoft.com/windows/desktop/vss/volume-shadow-copy-service-overview)