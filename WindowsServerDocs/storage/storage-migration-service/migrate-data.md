---
title: 記憶域移行サービスを使用してファイルサーバーを移行する
description: 検索エンジンの結果に関するトピックの簡単な説明
author: jasongerend
ms.author: jgerend
manager: elizapo
ms.date: 03/25/2020
ms.topic: article
ms.prod: windows-server
ms.technology: storage
ms.openlocfilehash: e012706eeb9d483f19eff6f4ba2e1f57e0c0852d
ms.sourcegitcommit: 771db070a3a924c8265944e21bf9bd85350dd93c
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 06/27/2020
ms.locfileid: "85475329"
---
# <a name="use-storage-migration-service-to-migrate-a-server"></a>Storage Migration Service を使用してサーバーを移行する

このトピックでは、[記憶域移行サービス](overview.md)と Windows 管理センターを使用して、サーバー (ファイルや構成を含む) を別のサーバーに移行する方法について説明します。 サービスをインストールし、必要なファイアウォールポートを開いたら、3つの手順を実行します。サーバーのインベントリを作成し、データを転送して、新しいサーバーにカットオーバーします。

## <a name="step-0-install-storage-migration-service-and-check-firewall-ports"></a>手順 0: Storage Migration Service をインストールし、ファイアウォールポートを確認する

作業を開始する前に、Storage Migration Service をインストールし、必要なファイアウォールポートが開いていることを確認してください。

1. [ストレージ移行サービスの要件](overview.md#requirements)を確認し、PC または管理サーバーに[Windows 管理センター](../../manage/windows-admin-center/understand/windows-admin-center.md)をインストールします (まだインストールしていない場合)。 ドメインに参加しているソースコンピューターを移行する場合は、移行元コンピューターと同じドメインまたはフォレストに参加しているサーバーに、記憶域移行サービスをインストールして実行する必要があります。
2. Windows 管理センターで、Windows Server 2019 を実行している orchestrator サーバーに接続します。 <br>これは、記憶域移行サービスをインストールし、移行の管理に使用するサーバーです。 1台のサーバーのみを移行する場合は、Windows Server 2019 を実行している限り、移行先サーバーを使用できます。 複数のサーバーを移行する場合は、別のオーケストレーションサーバーを使用することをお勧めします。
3. (Windows 管理センターの)**サーバーマネージャー**に移動して、**記憶域移行サービス**> し、[**インストール**] を選択して、記憶域移行サービスとその必須コンポーネントをインストールします (図1を参照)。
    ![[インストール] ボタンが表示されている [記憶域移行サービス] ページのスクリーンショット ](media/migrate/install.png) **図 1: Storage migration Service のインストール**
4. Windows Server 2019 を実行しているすべての移行先サーバーに、記憶域移行サービスプロキシをインストールします。 これにより、移行先サーバーにインストールするときの転送速度が倍増します。 <br>これを行うには、Windows 管理センターで移行先サーバーに接続し、**サーバーマネージャー** (Windows 管理センター) に移動して、[**役割と機能**]、[> の**機能**] の順に >、[記憶域の移行] [**サービスプロキシ**] の順に選択し、[**インストール**] を選択します。
5. Windows Failver クラスターへの移行を予定している場合は、orchestrator サーバーにフェールオーバークラスタリングツールをインストールします。 <br>これを行うには、Windows 管理センターで orchestrator サーバーに接続し、**サーバーマネージャー** (Windows 管理センター >) にアクセスして、[**役割と機能**]、[> の**機能**]、[>**リモートサーバー管理ツール**]、[>**機能管理ツール**] の順**に選択し**、[**インストール**] を選択します。
6. すべての移行元サーバーと、windows server 2012 R2 または windows server 2016 を実行しているすべての移行先サーバーで、windows 管理センターで各サーバーに接続し、**サーバーマネージャー** (Windows 管理センター内) に移動して、**ファイアウォール**の受信規則 > して、  >  **Incoming rules**次の規則が有効になっていることを確認します。
    - ファイルとプリンターの共有 (SMB 受信)
    - Netlogon サービス (NP 受信)
    - DCOM-In (Windows Management Instrumentation)
    - WMI-In (Windows Management Instrumentation)

   サードパーティのファイアウォールを使用している場合は、開く受信ポート範囲は TCP/445 (SMB)、TCP/135 (RPC/DCOM エンドポイントマッパー)、および TCP 1025-65535 (RPC/DCOM 一時ポート) です。 Storage Migration service のポートは、TCP/28940 (Orchestrator) と TCP/28941 (プロキシ) です。

7. Orchestrator サーバーを使用して移行を管理していて、転送するデータのイベントまたはログをダウンロードする場合は、そのサーバーで [ファイルとプリンターの共有 (SMB 受信)] ファイアウォール規則が有効になっていることを確認します。

## <a name="step-1-create-a-job-and-inventory-your-servers-to-figure-out-what-to-migrate"></a>手順 1: ジョブを作成してサーバーのインベントリを作成し、移行対象を把握する

この手順では、移行するサーバーを指定し、スキャンして、ファイルと構成に関する情報を収集します。

1. [**新しいジョブ**] を選択し、ジョブに名前を指定して、Windows サーバーと、Samba を使用する Linux サーバーを移行するかどうかを選択します。 **[OK]** をクリックします。
2. [**資格情報の入力**] ページで、移行元のサーバーで動作する管理者の資格情報を入力し、[**次へ**] を選択します。 <br>Linux サーバーから移行する場合は、代わりに、SSH パスワードまたは秘密キーを含む、 **Samba 資格**情報と**Linux 資格情報**のページに資格情報を入力します。

3. [**デバイスの追加**] を選択し、ソースサーバーの名前またはクラスター化されたファイルサーバーの名前を入力して、[ **OK]** を選択します。 <br>インベントリを作成する他のすべてのサーバーについて、この手順を繰り返します。

4. [**スキャンの開始**] を選択します。<br>ページが更新されると、スキャンが完了したことが示されます。
    ![スキャンの準備ができているサーバーを示すスクリーンショット ](media/migrate/inventory.png) **図 2: サーバーのインベントリ**
5. 各サーバーを選択して、インベントリされた共有、構成、ネットワークアダプター、およびボリュームを確認します。 <br><br>記憶域移行サービスは、Windows の操作に干渉する可能性があるファイルまたはフォルダーを転送しません。そのため、このリリースでは、Windows システムフォルダーにあるすべての共有に対して警告が表示されます。 転送フェーズでは、これらの共有をスキップする必要があります。 詳細については、「[転送から除外するファイルとフォルダー](faq.md#what-files-and-folders-are-excluded-from-transfers)」を参照してください。
6. [**次**へ] を選択して、データの転送に移動します。

## <a name="step-2-transfer-data-from-your-old-servers-to-the-destination-servers"></a>手順 2: 古いサーバーから移行先サーバーにデータを転送する

この手順では、移行先サーバーに配置する場所を指定した後、データを転送します。

1. [**データの転送**  >  **Enter credentials** ] ページで、移行先サーバーで機能する管理者の資格情報を入力し、[**次へ**] を選択します。
2. [**変換先のデバイスとマッピングの追加**] ページに、最初の移行元サーバーが表示されます。 移行先のサーバーまたはクラスター化されたファイルサーバーの名前を入力し、[**デバイスのスキャン**] を選択します。 ドメインに参加しているソースコンピューターから移行する場合は、移行先サーバーを同じドメインに参加させる必要があります。 [新しい Azure VM の作成] をクリックし、ウィザードを使用して Azure に新しい移行先サーバーをデプロイすることもできます。 これにより、VM のサイズの変更、記憶域のプロビジョニング、ディスクのフォーマット、ドメインへの参加、および Storage Migration Service プロキシの Windows Server 2019 の宛先への追加が自動的に実行されます。 任意のサイズの Windows Server 2019 (推奨)、Windows Server 2016、および Windows Server 2012 R2 の Vm を選択して、管理ディスクを使用することができます。

    > [!NOTE]
    > "新しい Azure VM の作成" を使用するには、次のものが必要です。
    > - 有効な Azure サブスクリプション。
    > - 作成権限を持つ既存の Azure コンピューティングリソースグループ。
    > - 既存の Azure Virtual Network とサブネット。
    > - Virtual Network とサブネットに関連付けられた Azure Express Route または VPN ソリューション。この Azure IaaS VM からオンプレミスクライアント、ドメインコントローラー、Storage Migration Service orchestrator コンピューター、Windows 管理センターコンピューター、移行元コンピューターへの接続を可能にします。

    Storage Migration Service を使用して Azure Vm に移行する方法を示すビデオを次に示します。
    > [!VIDEO https://www.youtube-nocookie.com/embed/k8Z9LuVL0xQ]

3. ソースボリュームを移行先ボリュームにマップし、転送しない共有 (Windows システムフォルダーにあるすべての管理共有を含む) の [**含める**] チェックボックスをオフにして、[**次へ**] を選択します。
   ![移行元サーバーとそのボリュームと共有を示すスクリーンショットと、転送先の転送先 ](media/migrate/transfer.png) **図 3: 移行元サーバーとそのストレージが**転送される場所
4. 移行元サーバーの移行先サーバーとマッピングを追加し、[**次へ**] を選択します。
5. [**転送設定の調整**] ページで、移行元サーバー上のローカルユーザーとグループを移行するかどうかを指定し、[**次へ**] を選択します。 これにより、ローカルユーザーとグループに設定されたファイルまたは共有のアクセス許可が失われないように、移行先サーバー上のローカルユーザーとグループを再作成することができます。 ローカルユーザーとグループを移行する場合のオプションは次のとおりです。

    - 既定では、**同じ名前のアカウント名を変更**し、移行元サーバー上のすべてのローカルユーザーとグループを移行します。 移行元と移行先で同じ名前のローカルユーザーまたはグループが検出された場合は、それらが組み込みの場合 (管理者ユーザーや管理者グループなど)、その名前が変更されます。 移行元または移行先のサーバーがドメインコントローラーである場合は、この設定を使用しないでください。
    - **同じ名前のアカウントを再利用**すると、移行元と移行先のユーザーおよびグループと同じ名前になります。 移行元または移行先のサーバーがドメインコントローラーである場合は、この設定を使用しないでください。
    - **[ユーザーとグループを転送しない**] ローカルユーザーとグループの移行をスキップします。これは、移行元または移行先がドメインコントローラーの場合、または DFS レプリケーション (DFS レプリケーションローカルグループとユーザーをサポートしていない場合) の場合に必要です。

   > [!NOTE]
   > 移行されたユーザーアカウントは、移行先で無効になっていて、127文字のパスワードが割り当てられています。このパスワードは複雑でランダムなものです。そのため、これらを有効にした後で、新しいパスワードを割り当てる必要があります。 これにより、ソースのパスワードを忘れた場合や脆弱なパスワードを持っている古いアカウントが、移行先でセキュリティ上の問題となることを防ぐことができます。 ローカル管理者のパスワードを管理する方法として、[ローカル管理者パスワードソリューション (LAPS)](https://www.microsoft.com/download/details.aspx?id=46899)を確認することもできます。

6. [**検証**] を選択し、[**次へ**] を選択します。
7. [**転送の開始**] を選択して、データの転送を開始します。<br>最初に転送するときに、コピー先の既存のファイルをバックアップフォルダーに移動します。 その後の転送では、既定では、先にバックアップしないで宛先を更新します。 <br>また、記憶域移行サービスは、重複する共有を処理するのに十分なスマートです。同じジョブで同じフォルダーを2回コピーすることはありません。
8. 転送が完了したら、移行先サーバーを調べて、すべてが正常に転送されたことを確認します。 転送されなかったファイルのログをダウンロードする場合にのみ、[**エラーログ**] を選択します。

   > [!NOTE]
   > 転送の監査証跡を保持する場合、またはジョブで複数の転送を実行する場合は、[**ログの転送**] またはその他のログ保存オプションをクリックして CSV コピーを保存します。 後続のすべての転送では、前回の実行のデータベース情報が上書きされます。

この時点で、次の3つのオプションがあります。

- 移行先サーバーが移行元サーバーの id を採用するように、**次の手順に進み**ます。
- 移行元サーバーの id を引き継がず**に移行を完了することを検討してください**。
- **もう一度転送**し、最後の転送以降に更新されたファイルのみをコピーします。

ファイルを Azure と同期することが目的である場合は、ファイルを転送した後、または移行先サーバーに移動した後に、Azure File Sync を使用して移行先サーバーを設定できます (「 [Azure File Sync の展開の計画](https://docs.microsoft.com/azure/storage/files/storage-sync-files-planning)」を参照してください)。

## <a name="step-3-cut-over-to-the-new-servers"></a>手順 3: 新しいサーバーにカットオーバーする

このステップでは、移行元サーバーから移行先サーバーに移行し、IP アドレスとコンピューター名を移行先サーバーに移動します。 この手順が完了すると、アプリとユーザーは、から移行したサーバーの名前とアドレスを使用して、新しいサーバーにアクセスできるようになります。

1. 移行ジョブから移動したことがある場合は、Windows 管理センターで、[**サーバーマネージャー**  >  **Storage migration Service** ] に移動して、完了するジョブを選択します。
2. [**新しいサーバーの**  >  **資格情報を入力してください**] ページで、前に入力した資格情報を使用するには [**次へ**] を選択します。

   移行先がクラスター化されたファイルサーバーの場合は、ドメインからクラスターを削除するためのアクセス許可を持つ資格情報を指定し、新しい名前で追加し直す必要がある場合があります。

3. [**カットオーバーの構成**] ページで、ソースの各アダプターから設定を引き継ぐネットワークアダプターを指定します。 これにより、移行元サーバーに新しい DHCP または静的 IP アドレスが与えられ、移行元サーバーから移行先に IP アドレスが移動します。 すべてのネットワーク移行または特定のインターフェイスをスキップするオプションがあります。
4. 切り替え後に移行元サーバーに使用する IP アドレスを指定して、そのアドレスを移行先に移動します。 DHCP または静的アドレスを使用できます。 静的アドレスを使用する場合、新しいサブネットは古いサブネットと同じである必要があります。同じでないと、カットオーバーは失敗します。
    ![移行元サーバーとその IP アドレスとコンピューター名、および移行 ](media/migrate/cutover.png) **元サーバーとそのネットワーク構成を移行先に移行**した後に、それらがどのように置き換えられるかを示すスクリーンショット
5. 移行先サーバーの名前を変更した後、移行元サーバーの名前を変更する方法を指定します。 ランダムに生成された名前を使用することも、自分で入力することもできます。 **[次へ]** を選択します。
6. [**カットオーバーの設定の調整**] ページで [**次へ**] を選択します。
7. [**ソースとターゲットのデバイスの検証**] ページで [**検証**] を選択し、[**次へ**] を選択します。
8. カットオーバーを実行する準備ができたら、[**カットオーバーの開始**] を選択します。 <br>ユーザーとアプリは、アドレスと名前を移動し、サーバーをそれぞれ数回再起動しても、移行の影響を受けないように、中断が発生する可能性があります。 カットオーバーの所要時間は、サーバーの再起動の速度と、Active Directory および DNS のレプリケーション時間によって異なります。

## <a name="additional-references"></a>その他のリファレンス

- [記憶域移行サービスの概要](overview.md)
- [記憶域移行サービスに関してよく寄せられる質問 (FAQ)](faq.md)
- [Azure File Sync のデプロイの計画](https://docs.microsoft.com/azure/storage/files/storage-sync-files-planning)
