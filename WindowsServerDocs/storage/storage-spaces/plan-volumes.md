---
ms.assetid: 342173ca-4e10-44f4-b2c9-02a6c26f7a4a
title: 記憶域スペース ダイレクトのボリュームの計画
ms.prod: windows-server
ms.author: cosdar
ms.manager: eldenc
ms.technology: storage-spaces
ms.topic: article
author: cosmosdarwin
ms.date: 06/28/2019
ms.localizationpriority: medium
ms.openlocfilehash: 52c600068d5dd447ff9faa7c40788664e222a83a
ms.sourcegitcommit: 6aff3d88ff22ea141a6ea6572a5ad8dd6321f199
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 09/27/2019
ms.locfileid: "71366892"
---
# <a name="planning-volumes-in-storage-spaces-direct"></a>記憶域スペース ダイレクトのボリュームの計画

> 適用対象: Windows Server 2019、Windows Server 2016

このトピックでは、ファイルシステム、回復性の種類、サイズの選択など、ワークロードのパフォーマンスや容量のニーズを満たすように記憶域スペース ダイレクトでボリュームを計画する方法について説明します。

## <a name="review-what-are-volumes"></a>復習: ボリュームとは

ボリュームは、ワークロードに必要なファイル (Hyper-v 仮想マシンの VHD ファイルや VHDX ファイルなど) を配置する場所です。 ボリュームでは、記憶域スペース ダイレクトのフォールト トレランス、スケーラビリティ、パフォーマンス上のメリットを活かすため、記憶域プール内のドライブが組み合わされます。

   >[!NOTE]
   > 記憶域スペース ダイレクトのドキュメント全体で、"ボリューム" という用語は、クラスター共有ボリューム (CSV) や ReFS など、他の組み込み Windows 機能により提供される機能を含む、ボリュームとその下の仮想ディスクを総称して使われます。 記憶域スペース ダイレクトを正しく計画して展開するために、これらの実装レベルの違いを理解する必要はありません。

![ボリュームとはvolumes](media/plan-volumes/what-are-volumes.png)

すべてのボリュームには、クラスター内のすべてのサーバーが同時にアクセスできます。 作成されると、すべてのサーバー上の**C:\ clusterstorage\\** に表示されます。

![csv フォルダーのスクリーンショット](media/plan-volumes/csv-folder-screenshot.png)

## <a name="choosing-how-many-volumes-to-create"></a>作成するボリュームの数の選択

ボリュームの数は、クラスター内のサーバーの数の倍数にすることをお勧めします。 たとえば、4台のサーバーがある場合、3または5よりも合計4つのボリュームでパフォーマンスの一貫性が向上します。 これにより、クラスターはボリュームの "所有権" (1 台のサーバーが各ボリュームのメタデータ オーケストレーションを処理) をサーバー間に均等に分散できます。

ボリュームの合計数を次のように制限することをお勧めします。

| Windows Server 2016          | Windows Server 2019          |
|------------------------------|------------------------------|
| クラスターあたり最大32ボリューム | クラスターあたり最大64ボリューム |

## <a name="choosing-the-filesystem"></a>ファイルシステムの選択

記憶域スペース ダイレクトには新しい [Resilient File System (ReFS)](../refs/refs-overview.md) を使うことをお勧めします。 ReFS は、仮想化に特化して構築された高度なファイルシステムであり、大幅なパフォーマンス向上やデータ破損に対する組み込みの保護など、多くのメリットがあります。 Windows Server のデータ重複除去、バージョン1709以降を含む、ほぼすべての重要な NTFS 機能をサポートしています。 詳細については、「ReFS[機能の比較表](../refs/refs-overview.md#feature-comparison)」を参照してください。

ReFS がまだサポートしていない機能がワークロードに必要な場合、代わりに NTFS を使うことができます。

   > [!TIP]
   > ファイル システムの異なるボリュームが同じクラスター内に共存することができます。

## <a name="choosing-the-resiliency-type"></a>回復性の種類の選択

記憶域スペース ダイレクト内のボリュームには、ドライブやサーバーの障害などのハードウェアの問題から保護し、ソフトウェア更新などのサーバー メンテナンス時に継続的な可用性を確保できる回復性が備わっています。

   > [!NOTE]
   > どの回復性を選ぶかは、使うドライブの種類とは関係ありません。

### <a name="with-two-servers"></a>サーバーが 2 台の場合

クラスター内に2つのサーバーがある場合は、双方向のミラーリングを使用できます。 Windows Server 2019 を実行している場合は、入れ子になった回復性を使用することもできます。

双方向のミラーリングでは、すべてのデータのコピーが2つ保持されます。各サーバーのドライブに1つのコピーがあります。 記憶域の効率性は50% で、1 TB のデータを書き込むには、記憶域プールに少なくとも 2 TB の物理記憶域容量が必要です。 双方向のミラーリングでは、一度に1つのハードウェア障害が発生する可能性があります (1 台のサーバーまたはドライブ)。

![双方向ミラー](media/plan-volumes/two-way-mirror.png)

入れ子になった回復性 (Windows Server 2019 でのみ利用可能) では、双方向のミラーリングを使用するサーバー間でデータの回復性が提供されます。その後、双方向のミラーリングまたはミラーアクセラレータパリティを使用するサーバー内に回復性が加わります。 入れ子にすると、1台のサーバーが再起動または使用できなくなった場合でも、データの復元が可能 そのストレージ効率は、入れ子になった双方向ミラーリングでは25%、入れ子になったミラーアクセラレータパリティでは約35-40% です。 入れ子になった回復性では、同時に2つのハードウェア障害が発生する可能性があります (2 台のドライブ、またはサーバーと残りのサーバーのドライブ)。 この追加のデータ回復性により、Windows Server 2019 を実行している場合は、2台のサーバークラスターの運用環境のデプロイで、入れ子になった回復性を使用することをお勧めします。 詳細については、「[入れ子になった回復性](nested-resiliency.md)」を参照してください。

![入れ子になったミラーアクセラレータパリティ](media/nested-resiliency/nested-mirror-accelerated-parity.png)

### <a name="with-three-servers"></a>サーバーが 3 台の場合

サーバーが 3 台の場合は、3 方向ミラーリングを使って、フォールト トレランスとパフォーマンスを向上させてください。 3 方向ミラーリングでは、すべてのデータのコピーが 3 つ保持されます (各サーバーのドライブ上にコピー 1 つずつ)。 その記憶域の効率は 33.3% です。つまり、1 TB のデータを書き込むには、記憶域プールに少なくとも 3 TB の物理的な記憶域の容量が必要になります。 3 方向ミラーリングでは、[一度に少なくとも 2 件のハードウェア問題 (ドライブやサーバー)](storage-spaces-fault-tolerance.md#examples) に安全に対処できます。 2つのノードが使用できなくなった場合、記憶域プールはクォーラムを失います。これは、ディスクの2/3 が使用できず、仮想ディスクがアクセスできなくになるためです。 ただし、ノードがダウンし、別のノード上の1つまたは複数のディスクで障害が発生し、仮想ディスクがオンラインのままになる場合があります。 たとえば、あるサーバーを再起動しているときに別のドライブやサーバーで突然障害が発生した場合、すべてのデータの安全性が保たれ、アクセスし続けることができます。

![3 方向ミラー](media/plan-volumes/three-way-mirror.png)

### <a name="with-four-or-more-servers"></a>サーバーが 4 台以上の場合

4つ以上のサーバーがある場合は、3方向ミラーリングを使用するか ("消去コード" と呼ばれることも多い)、各ボリュームに対して、2つのパリティをミラーアクセラレータパリティとミックスするかを選択できます。

デュアル パリティでは、3 方向ミラーリングと同じフォールト トレランスが実現されますが、記憶域の効率はより優れています。 4台のサーバーで、記憶域の効率性は50.0% です。 2 TB のデータを格納するには、記憶域プールに 4 TB の物理記憶域容量が必要です。 サーバーが 7 台の場合、記憶域の効率は 66.7% に上昇し、記憶域の効率は最大 80.0% まで上昇します。 ただし、トレードオフとしてパリティ エンコーディングは負荷が高く、パフォーマンスが低下する可能性があります。

![デュアル パリティ](media/plan-volumes/dual-parity.png)

どの回復性の種類を使うかは、ワークロードのニーズに応じて判断してください。 回復性の種類ごとに最適なワークロードと、各回復性の種類のパフォーマンスと記憶域の効率をまとめた表を次に示します。

| 回復性の種類 | 容量の効率 | 速度 | ワークロード |
| ------------------- | ----------------------  | --------- | ------------- |
| **ミラー**         | ![33% を示すストレージの効率性](media/plan-volumes/3-way-mirror-storage-efficiency.png)<br>3方向ミラー: 33% <br>双方向ミラー: 50%     |![100% を示すパフォーマンス](media/plan-volumes/three-way-mirror-perf.png)<br> 最高のパフォーマンス  | 仮想化されたワークロード<br> データベース<br>その他の高パフォーマンスワークロード |
| **ミラーリングによって高速化されたパリティ** |![約50% を表示するストレージの効率性](media/plan-volumes/mirror-accelerated-parity-storage-efficiency.png)<br> ミラーとパリティの比率に依存 | ![約20% のパフォーマンス](media/plan-volumes/mirror-accelerated-parity-perf.png)<br>ミラーよりもはるかに低速ですが、デュアルパリティと比べて最大2倍の速度で動作します。<br> 大規模なシーケンシャル書き込みと読み取りに最適 | アーカイブとバックアップ<br> 仮想デスクトップインフラストラクチャ     |
| **デュアルパリティ**               | ![約80% を表示するストレージの効率性](media/plan-volumes/dual-parity-storage-efficiency.png)<br>4台のサーバー: 50% <br>16台のサーバー: 最大80% | ![約10% のパフォーマンス](media/plan-volumes/dual-parity-perf.png)<br>書き込み時の CPU 使用率 & 最大の i/o 待機時間<br> 大規模なシーケンシャル書き込みと読み取りに最適 | アーカイブとバックアップ<br> 仮想デスクトップインフラストラクチャ  |

#### <a name="when-performance-matters-most"></a>パフォーマンスが最も重要な場合

SQL Server データベースやパフォーマンスが重視される Hyper-V 仮想マシンなど、待ち時間要件が高いワークロードまたは混合ランダム IOPS を必要とするワークロードは、パフォーマンスが最大限に高めるため、ミラーリングを使うボリュームで実行してください。

   >[!TIP]
   > ミラーリングは、他の種類の回復性よりも高速です。 Microsoft では、パフォーマンスが重要なほぼすべての例でミラーリングを使っています。

#### <a name="when-capacity-matters-most"></a>容量が最も重要な場合

データ ウェアハウスや "コールド" 記憶域など、書き込み頻度が低いワークロードは、記憶域の効率を最大限に高めるため、デュアル パリティを使うボリュームで実行してください。 従来型のファイル サーバー、仮想デスクトップ インフラストラクチャ (VDI)、高速ドリフト ランダム IO トラフィックを多く生成しないワークロード、最高のパフォーマンスを必要としないワークロードなど、他の特定のワークロードでも、各自の判断でデュアル パリティを使うことができます。 パリティでは、特に書き込みにおいて、必然的にミラーリングと比較して CPU 使用率と IO 待機時間が上昇します。

#### <a name="when-data-is-written-in-bulk"></a>データが一括で書き込まれる場合

アーカイブ対象やバックアップ対象などの大規模なシーケンシャル パスで書き込むワークロードの場合、Windows Server 2016 の新しいオプションとして、1 つのボリュームにミラーリングとデュアル パリティを混在させることができます。 書き込みはまずミラーリングされた部分に行われ、徐々にパリティ部分に移行していきます。 これにより、負荷の高いパリティ エンコーディングを長時間実行できるようになるため、大規模な書き込み時に取り込みが高速化されてリソース使用率が低下します。 各部分のサイズを設定する場合、一度に発生する書き込みの量 (毎日行うバックアップ 1 回分のサイズなど) がミラーリング部分に十分に収まるようにしてください。 たとえば、1 日に 1 回 100 GB を取り込む場合は、ミラーリング用に 150 GB ～ 200 GB を使い、残りをデュアル パリティに使うことを検討してください。

最終的な記憶率の効率は、選んだ比率によって決まります。 例については、[このデモ](https://www.youtube.com/watch?v=-LK2ViRGbWs&t=36m55s)をご覧ください。

   > [!TIP]
   > データインジェストの途中で書き込みパフォーマンスが急激に低下した場合は、ミラーの部分が十分でないか、ミラーアクセラレータのパリティがユースケースに適していないことを示している可能性があります。 たとえば、書き込みパフォーマンスが 400 MB/秒から 40 MB/秒に低下した場合は、ミラーの部分を拡張するか、3方向ミラーに切り替えることを検討してください。

### <a name="about-deployments-with-nvme-ssd-and-hdd"></a>NVMe、SSD、HDD を使った展開について

2 種類のドライブが展開に存在する場合、速い方のドライブがキャッシングに使用され、遅い方のドライブがデータ格納用として使用されます。 これは、自動的に行われます。詳しくは、「[記憶域スペース ダイレクトのキャッシュについて](understand-the-cache.md)」をご覧ください。 このような展開では、最終的にすべてのボリュームが同じ種類のドライブ (データ格納用ドライブ) が存在することになります。

3 種類のドライブがすべて存在する展開の場合、最も速いドライブ (NVMe) だけがキャッシュに使用され、残りの 2 種類のドライブ (SSD と HDD) がデータ格納用として使用されます。 ボリュームごとに、すべて SSD 階層に配置する、すべて HDD 階層に配置する、または 2 つの階層にまたがって配置するかを選ぶことができます。

   > [!IMPORTANT]
   > SSD 階層を使って、パフォーマンスを最も重視するワークロードをオールフラッシュに配置することをお勧めします。

## <a name="choosing-the-size-of-volumes"></a>ボリュームのサイズの選択

各ボリュームのサイズは次のように制限することをお勧めします。

| Windows Server 2016 | Windows Server 2019 |
| ------------------- | ------------------- |
| 最大 32 TB         | 最大 64 TB         |

   > [!TIP]
   > ファイルサーバーのワークロードに共通するように、ボリュームシャドウコピーサービス (VSS) と Volsnap ソフトウェアプロバイダーに依存するバックアップソリューションを使用する場合は、ボリュームサイズを 10 TB に制限すると、パフォーマンスと信頼性が向上します。 新しい Hyper-V RCT API、ReFS のブロックの複製、ネイティブ SQL バックアップ API を使うバックアップ ソリューションは、最大 32 TB 以上で適切に動作します。

### <a name="footprint"></a>フットプリント

ボリュームのサイズとは、使用可能な容量、つまり格納可能なデータの量を指します。 これは、**New-Volume** コマンドレットの **-Size** パラメーターにより示され、**Get-Volume** コマンドレットを実行すると **Size** プロパティに表示されます。

サイズは、ボリュームの*フットプリント*とは異なります。フットプリントは、記憶域プールにおいてボリュームが占める物理的な記憶域の最大容量です。 フットプリントは、その回復性の種類によって異なります。 たとえば、3 方向ミラーリングを使うボリュームのフットプリントはサイズの 3 倍です。

ボリュームのフットプリントは、記憶域プールに収まる必要があります。

![サイズとフットプリントの違い](media/plan-volumes/size-versus-footprint.png)

### <a name="reserve-capacity"></a>容量の予約

記憶域プール内の一部の容量を未割り当てのままにすると、ドライブで障害が発生した後、ボリューム領域が "インプレース" で修復され、データの安全性とパフォーマンスが向上します。 容量が十分ある場合、インプレースの即時並行修復を行うと、障害が発生したドライブを交換する前でもボリュームが完全回復状態になります。 これは自動的に行われます。

サーバー (ドライブが最大 4 台) あたりドライブ 1 台分に相当する容量を予約することをお勧めします。 各自の判断でさらに多く予約することができますが、この最小推奨容量で、ドライブの障害発生後インプレースの即時並行修復が正常に行われます。

![予約](media/plan-volumes/reserve.png)

たとえば、サーバーが 2 台あって容量が 1 TB のドライブを使っている場合、2 x 1 = 2 TB のプールを予約として取っておきます。 サーバーが 3 台あって容量が 1 TB のドライブを使っている場合、3 x 1 = 3 TB を予約として取っておきます。 サーバーが 4 台以上あって容量が 1 TB のドライブを使っている場合、4 x 1 = 4 TB を予約として取っておきます。

   >[!NOTE]
   > 3 種類のドライブ (NVMe + SSD + HDD) がすべてあるクラスターでは、サーバー (それぞれドライブが最大 4 台) あたり SSD + HDD 1 台分に相当する容量を予約することをお勧めします。

## <a name="example-capacity-planning"></a>例: 容量計画

サーバーが 4 台存在するクラスターが 1 つあるとします。 各サーバーには、いくつかのキャッシュ ドライブと、データ格納用に 16 台の 2 TB ドライブがあります。

```
4 servers x 16 drives each x 2 TB each = 128 TB
```

記憶域プール内のこの 128 TB から、障害後ドライブを急いで交換しなくてもインプレースの修復が行われるように 4 台のドライブ (つまり 8 TB) を取っておきます。 こうすると、ボリュームを作成可能な 120 TB の物理容量がプール内に残ります。

```
128 TB – (4 x 2 TB) = 120 TB
```

展開でかなりアクティブな Hyper-V 仮想マシンをホストする必要があるが、コールド記憶域 (保持する必要がある古いファイルやバックアップ) も多くあるとします。 サーバーが 4 台あるため、ボリュームを 4 つ作成しましょう。

仮想マシンは、最初の 2 つのボリューム (*Volume1* および *Volume2*) に置きます。 ファイルシステムとして ReFS を選び (すばやい作成とチェックポイントのため)、パフォーマンスを最大限に高めるため回復性として 3 方向ミラーリングを選びます。 コールド記憶域は、別の 2 つのボリューム (*Volume 3* および *Volume 4*) に置きます。 ファイルシステムとして NTFS を選び (データ重複除去のため)、容量を最大限に大きくするため回復性としてデュアル パリティを選びます。

すべてのボリュームを同じサイズにする必要はありませんが、簡潔にするため、たとえばすべてのボリュームを 12 TB にすることができます。

*Volume1* と *Volume2*は、それぞれ 33.3% の効率で 12 TB 専有するため、記憶域の合計容量は 36 TB になります。

*Volume3* と *Volume4*は、それぞれ 50.0% の効率で 12 TB 専有するため、記憶域の合計容量は 24 TB になります。

```
36 TB + 36 TB + 24 TB + 24 TB = 120 TB
```

4 つのボリュームは、プール内で使用できる物理的な記憶域の容量とまったく同じになります。 よくできました。

![例](media/plan-volumes/example.png)

   >[!TIP]
   > すべてのボリュームをすぐに作成する必要はありません。 ボリュームはいつでも拡張できますし、新しいボリュームを後で作成することもできます。

簡潔にするため、この例を通じて 10 進法の単位を使っています (つまり、1 TB = 1,000,000,000,000 バイト)。 しかし、Windows の記憶域の数量は 2 進法の単位で表示されます。 たとえば、2 TB の各ドライブは Windows では 1.82 TiB と表示されます。 同様に、128 TB の記憶域プールは 116.41 TiB と表示されます。 これは正常な動作です。

## <a name="usage"></a>使用方法

「[記憶域スペース ダイレクトのボリュームの作成](create-volumes.md)」をご覧ください。

### <a name="see-also"></a>関連項目

- [記憶域スペースダイレクトの概要](storage-spaces-direct-overview.md)
- [記憶域スペースダイレクトのドライブの選択](choosing-drives.md)
- [フォールト トレランスと記憶域の効率](storage-spaces-fault-tolerance.md)
