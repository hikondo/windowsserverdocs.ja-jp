---
title: クラスターとプール クォーラムの概要
description: クラスターとプールのクォーラムについて理解する」を参照してください。
keywords: 記憶域スペースダイレクト、クォーラム、監視、S2D、クラスタークォーラム、プールクォーラム、クラスター、プール
ms.prod: windows-server
ms.author: adagashe
ms.manager: eldenc
ms.technology: storage-spaces
ms.topic: article
author: adagashe
ms.date: 01/18/2019
ms.localizationpriority: medium
ms.openlocfilehash: 8950e9d09e3bd07dc02228c295ab223ead969ea6
ms.sourcegitcommit: 6aff3d88ff22ea141a6ea6572a5ad8dd6321f199
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 09/27/2019
ms.locfileid: "71366014"
---
# <a name="understanding-cluster-and-pool-quorum"></a>クラスターとプール クォーラムの概要

>適用対象:Windows Server 2019、Windows Server 2016

[Windows Server フェールオーバークラスタリング](../../failover-clustering/failover-clustering-overview.md)は、ワークロードの高可用性を実現します。 リソースをホストするノードが稼働している場合、これらのリソースは高可用性と見なされます。ただし、クラスターは一般に、ノードの半分以上の実行を必要とします。これは*クォーラム*を持つことを知らせています。

クォーラムは、ネットワーク内にパーティションが存在し、ノードのサブセットが相互に通信できない場合に発生する*スプリットブレイン*シナリオを防ぐように設計されています。 これにより、ノードの両方のサブセットがワークロードを所有し、同じディスクに書き込まれるため、多くの問題が発生する可能性があります。 ただし、フェールオーバークラスタリングのクォーラムの概念では、これらのノードグループのうちの1つだけが実行を継続するため、これらのグループのうち1つだけがオンラインのままになります。

クォーラムは、クラスターが引き続きオンラインのままで維持できるエラーの数を決定します。 クォーラムは、クラスターノードのサブセット間の通信に問題がある場合のシナリオを処理するように設計されています。これにより、複数のサーバーが同時にリソースグループをホストして同じディスクに書き込みを行うことがなくなります。 クォーラムの概念を実現することで、クラスターは、特定のリソースグループの真の所有者が1つだけであることを確認するために、ノードのいずれかのサブセットでクラスターサービスを強制的に停止します。 停止したノードは、ノードのメイングループと再び通信すると、自動的にクラスターに再度参加し、クラスターサービスを開始します。

Windows Server 2019 と Windows Server 2016 には、独自のクォーラムメカニズムを持つシステムのコンポーネントが2つあります。

- **クラスタークォーラム**:これはクラスターレベルで動作します (つまり、ノードが失われ、クラスターが稼働状態を維持できます)。
- **プールクォーラム**:これは、記憶域スペースダイレクトが有効になっている場合 (つまり、ノードとドライブが失われ、プールが維持される場合があります) に、プールレベルで動作します。 記憶域プールは、クラスター化と非クラスター化の両方のシナリオで使用するように設計されており、クォーラムメカニズムが異なるためです。

## <a name="cluster-quorum-overview"></a>クラスタークォーラムの概要

次の表は、シナリオごとのクラスタークォーラムの結果の概要を示しています。

| サーバーノード | 1つのサーバーノードの障害が発生する可能性があります | 1つのサーバーノードの障害が発生しても、 | 同時に2つのサーバーノード障害が発生する可能性があります |
|--------------|-------------------------------------|---------------------------------------------------|----------------------------------------------------|
| 2            | 50/50                               | いいえ                                                | いいえ                                                 |
| 2 + ミラーリング監視  | はい                                 | いいえ                                                | いいえ                                                 |
| 3            | はい                                 | 50/50                                             | いいえ                                                 |
| 3 + ミラーリング監視  | はい                                 | [はい]                                               | いいえ                                                 |
| 4            | はい                                 | はい                                               | 50/50                                              |
| 4 + ミラーリング監視  | はい                                 | [はい]                                               | はい                                                |
| 5以上  | はい                                 | [はい]                                               | はい                                                |

### <a name="cluster-quorum-recommendations"></a>クラスタークォーラムに関する推奨事項

- 2つのノードがある場合は、ミラーリング監視サーバーが**必要**です。
- ノードが3つまたは4つある場合は、ミラーリング監視サーバーを使用する**ことを強くお勧め**します。
- インターネットにアクセスできる場合は、 **[クラウド監視](../../failover-clustering/deploy-cloud-witness.md)を使用します。**
- 他のコンピューターやファイル共有を使用している IT 環境の場合は、ファイル共有監視を使用します。

## <a name="how-cluster-quorum-works"></a>クラスタークォーラムのしくみ

ノードで障害が発生した場合、または一部のノードが別のサブセットとの接続を失った場合、残っているノードは、クラスターの*過半数*がオンラインのままになっていることを確認する必要があります。 検証できない場合は、オフラインになります。

しかし、*過半数*の概念は、クラスター内のノードの合計数が奇数の場合にのみ正常に機能します (たとえば、5ノードクラスター内の3つのノード)。 では、ノード数が偶数のクラスター (たとえば、4ノードクラスター) についてはどうでしょうか。

クラスターでは、次の2つの方法で*投票の合計数*を奇数にすることができます。

1. まず、追加の投票で*ミラーリング監視* *サーバーを追加*します。 これにはユーザー設定が必要です。
2.  または、1つの unlucky ノードの投票 (必要に応じて自動的に発生) をゼロにすると、1つ*下*に移動できます。

残っているノードが*過半数*であることが正常に確認されると、*過半数*の定義が残存オブジェクトのみに更新されます。 これにより、クラスターは1つのノード、別のノード、別のノードを失うことができます。 連続して失敗した後に適合する*投票の合計数*の概念は、***動的クォーラム***と呼ばれます。  

### <a name="dynamic-witness"></a>動的ミラーリング監視

動的ミラーリング監視サーバーは、*投票の合計数*が奇数であることを確認するために、ミラーリング監視サーバーの投票を切り替えます。 投票の数が奇数の場合、ミラーリング監視サーバーは投票を持ちません。 投票の数が偶数の場合、ミラーリング監視サーバーには投票があります。 動的ミラーリング監視サーバーは、ミラーリング監視サーバーの障害によってクラスターがダウンするリスクを大幅に軽減します。 クラスターでは、クラスターで使用できる投票ノードの数に基づいて、監視の投票を使用するかどうかを決定します。

動的クォーラムは、以下で説明する方法で動的監視と連携します。

### <a name="dynamic-quorum-behavior"></a>動的なクォーラムの動作

- ノード数が**偶数**で、ミラーリング監視サーバーがない場合、 *1 つのノードで投票ゼロが取得*されます。 たとえば、4つのノードのうち3つだけが投票を受けるので、*投票の合計数*は3で、投票を含む2つの残存オブジェクトは過半数と見なされます。
- ノード数が**奇数**で、ミラーリング監視サーバーがない場合は、すべてのノードが*投票を受け*ます。
- ノードとミラーリング監視サーバーの数が**偶数**の場合は、*ミラーリング監視*サーバーによって投票されるので、合計は奇数になります。
- ノードとミラーリング監視サーバーの数が**奇数**の場合、*ミラーリング監視サーバーは投票しません*。

動的クォーラムを使用すると、ノードに投票を動的に割り当てることができます。これにより、投票の大半が失われたり、クラスターを1つのノードで実行できるようになります (最後のノードとして知られています)。 4ノードクラスターを例として考えてみましょう。 クォーラムに3票が必要であると仮定します。 

この場合、2つのノードが失われた場合、クラスターはダウンします。

![4つのクラスターノードを示す図 (それぞれが投票を取得)](media/understand-quorum/dynamic-quorum-base.png)

ただし、動的クォーラムによってこの問題が発生することはありません。 クォーラムに必要な*投票の合計数*は、使用可能なノードの数に基づいて決定されるようになりました。 動的クォーラムでは、3つのノードが失われてもクラスターは稼働したままになります。

![ノードが一度に1つずつ失敗する4つのクラスターノードと、各障害の発生後に必要な投票の数を示す図](media/understand-quorum/dynamic-quorum-step-through.png)

上記のシナリオは、記憶域スペースダイレクトが有効になっていない一般的なクラスターに適用されます。 ただし、記憶域スペースダイレクトが有効になっている場合、クラスターは2つのノードの障害のみをサポートできます。 詳細については、[プールクォーラム](#pool-quorum-overview)に関するセクションを参照してください。

### <a name="examples"></a>使用例

#### <a name="two-nodes-without-a-witness"></a>ミラーリング監視サーバーを使用しない2つのノード。 
1つのノードの投票がゼロになるため、*ほとんど*の投票は合計**1 票**から決定されます。 非投票ノードが予期せず停止した場合、保持には1/1 とクラスターが残ります。 投票ノードが予期せず停止した場合、保持には0/1 があり、クラスターはダウンします。 投票ノードの電源が正常に切断されている場合、投票は他のノードに転送され、クラスターはそのまま残ります。 ***このため、ミラーリング監視サーバーを構成することが重要です。***

![ミラーリング監視サーバーを使用しない2つのノードがある場合のクォーラム](media/understand-quorum/2-node-no-witness.png)

- 1つのサーバーの障害が発生する可能性があります。**50 の確率**。
- サーバー障害が発生しても、別のサーバーエラーが発生する可能性があります。**No**:
- は、2つのサーバーエラーを一度に保持できます。**No**: 

#### <a name="two-nodes-with-a-witness"></a>ミラーリング監視サーバーがある2つのノード。 
両方のノードで投票が行われ、ミラーリング監視サーバーに投票があるため、*過半数*は合計**3 票**から決定されます。 いずれかのノードがダウンした場合、保持には2/3 とクラスターが残ります。

![ミラーリング監視サーバーを使用する2つのノードがある場合のクォーラム](media/understand-quorum/2-node-witness.png)

- 1つのサーバーの障害が発生する可能性があります。**Yes**。
- サーバー障害が発生しても、別のサーバーエラーが発生する可能性があります。**No**:
- は、2つのサーバーエラーを一度に保持できます。**No**: 

#### <a name="three-nodes-without-a-witness"></a>ミラーリング監視サーバーのない3つのノード。
すべてのノードが投票するので、*過半数*は合計**3 票**から決定されます。 いずれかのノードがダウンした場合、残存オブジェクトは2/3 であり、クラスターは残ります。 クラスターはミラーリング監視サーバーを使用しない2つのノードになります。この時点では、シナリオ1になります。

![ミラーリング監視サーバーを使用せずに3つのノードがある場合のクォーラム](media/understand-quorum/3-node-no-witness.png)

- 1つのサーバーの障害が発生する可能性があります。**Yes**。
- サーバー障害が発生しても、別のサーバーエラーが発生する可能性があります。**50 の確率**。
- は、2つのサーバーエラーを一度に保持できます。**No**: 

#### <a name="three-nodes-with-a-witness"></a>ミラーリング監視サーバーを持つ3つのノード。
すべてのノードが投票するので、ミラーリング監視サーバーは最初に投票しません。 *多く*の投票は、合計で**3 つの投票**によって決定されます。 1つの障害が発生した後、クラスターにミラーリング監視サーバーを持つ2つのノードがあります。これはシナリオ2に戻ります。 ここで、2つのノードとミラーリング監視サーバーに投票しました。

![ミラーリング監視サーバーを使用する3つのノードがある場合に説明するクォーラム](media/understand-quorum/3-node-witness.png)

- 1つのサーバーの障害が発生する可能性があります。**Yes**。
- サーバー障害が発生しても、別のサーバーエラーが発生する可能性があります。**Yes**。
- は、2つのサーバーエラーを一度に保持できます。**No**: 

#### <a name="four-nodes-without-a-witness"></a>ミラーリング監視サーバーを使用しない4つのノード
1つのノードの投票がゼロになるため、*大部分*は合計**3 票**から決定されます。 1つの障害が発生すると、クラスターは3つのノードになり、シナリオ3になります。

![ミラーリング監視サーバーを使用せずに4つのノードがある場合のクォーラム](media/understand-quorum/4-node-no-witness.png)

- 1つのサーバーの障害が発生する可能性があります。**Yes**。
- サーバー障害が発生しても、別のサーバーエラーが発生する可能性があります。**Yes**。
- は、2つのサーバーエラーを一度に保持できます。**50 の確率**。 

#### <a name="four-nodes-with-a-witness"></a>ミラーリング監視サーバーを備えた4つのノード。
すべてのノードに投票とミラーリング監視サーバーの投票があるので、*過半数*は合計**5 票**から決定されます。 1つの障害が発生した後、シナリオ4になります。 2つの同時エラーが発生したら、シナリオ2に進みます。

![ミラーリング監視サーバーで4つのノードがある場合に説明するクォーラム](media/understand-quorum/4-node-witness.png)

- 1つのサーバーの障害が発生する可能性があります。**Yes**。
- サーバー障害が発生しても、別のサーバーエラーが発生する可能性があります。**Yes**。
- は、2つのサーバーエラーを一度に保持できます。**Yes**。 

#### <a name="five-nodes-and-beyond"></a>5ノード以上。
すべてのノードが投票します。または、合計が奇数になるすべての投票を行います。 記憶域スペースダイレクトでは、3つ以上のノードを停止することはできません。そのため、この時点でミラーリング監視サーバーは不要です。

![クォーラムは、5つ以上のノードがある場合に説明します。](media/understand-quorum/5-nodes.png)

- 1つのサーバーの障害が発生する可能性があります。**Yes**。
- サーバー障害が発生しても、別のサーバーエラーが発生する可能性があります。**Yes**。
- は、2つのサーバーエラーを一度に保持できます。**Yes**。 

クォーラムのしくみを理解したところで、クォーラム監視サーバーの種類を見てみましょう。

### <a name="quorum-witness-types"></a>クォーラム監視の種類

フェールオーバークラスタリングでは、次の3種類のクォーラム監視サーバーがサポートされています。

- **[クラウド監視](../../failover-clustering/deploy-cloud-witness.md)** -Azure の Blob storage は、クラスターのすべてのノードからアクセスできます。 クラスター化情報はミラーリング監視サーバーログファイルに保持されますが、クラスターデータベースのコピーは保存されません。
- **ファイル共有監視**-Windows server を実行しているファイルサーバー上に構成されている SMB ファイル共有。 クラスター化情報はミラーリング監視サーバーログファイルに保持されますが、クラスターデータベースのコピーは保存されません。
- **ディスク監視**-クラスターの使用可能記憶域グループにある小規模のクラスター化されたディスク。 このディスクは高可用性であり、ノード間でフェールオーバーできます。 クラスターデータベースのコピーが含まれています。  ***記憶域スペースダイレクトでは、ディスク監視はサポートされていません***。

## <a name="pool-quorum-overview"></a>プールクォーラムの概要

クラスタークォーラムはクラスターレベルで動作します。 プールクォーラムを見てみましょう。これはプールレベルで動作します (つまり、ノードとドライブが失われ、プールが維持される可能性があります)。 記憶域プールは、クラスター化と非クラスター化の両方のシナリオで使用するように設計されており、クォーラムメカニズムが異なるためです。

次の表は、シナリオごとのプールクォーラムの結果の概要を示しています。

| サーバーノード | 1つのサーバーノードの障害が発生する可能性があります | 1つのサーバーノードの障害が発生しても、 | 同時に2つのサーバーノード障害が発生する可能性があります |
|--------------|-------------------------------------|---------------------------------------------------|----------------------------------------------------|
| 2            | いいえ                                  | いいえ                                                | いいえ                                                 |
| 2 + ミラーリング監視  | はい                                 | いいえ                                                | いいえ                                                 |
| 3            | はい                                 | いいえ                                                | いいえ                                                 |
| 3 + ミラーリング監視  | はい                                 | いいえ                                                | いいえ                                                 |
| 4            | はい                                 | いいえ                                                | いいえ                                                 |
| 4 + ミラーリング監視  | はい                                 | [はい]                                               | はい                                                |
| 5以上  | はい                                 | [はい]                                               | はい                                                |

## <a name="how-pool-quorum-works"></a>プールクォーラムのしくみ

ドライブに障害が発生した場合、または一部のドライブが別のサブセットと通信できなかった場合、残りのドライブは、プールの*過半数*がオンラインのままになるように構成されていることを確認する必要があります。 検証できない場合は、オフラインになります。 プールは、クォーラム用に十分なディスク (50% + 1) があるかどうかに基づいて、オフラインまたはオンラインのままになるエンティティです。 プールリソース所有者 (アクティブなクラスターノード) は + 1 にすることができます。

ただし、プールクォーラムは次の点でクラスタークォーラムとは動作が異なります。

- プールは、半分のドライブ (プールリソースの所有者であるこのノード) を維持するための対応ブレーカーとして、クラスター内の1つのノードをミラーリング監視サーバーとして使用します。
- プールに動的クォーラムがない
- プールには、投票を削除する独自のバージョンが実装されていません

### <a name="examples"></a>使用例

#### <a name="four-nodes-with-a-symmetrical-layout"></a>対称レイアウトの4つのノード。 
16の各ドライブには1つの投票があり、ノード2にも1票 (プールリソース所有者であるため) があります。 *過半数*は、合計で**16 票**によって決定されます。 ノード3と4がダウンした場合、残りのサブセットには8個のドライブとプールリソース所有者 (9/16 票) があります。 そのため、プールは存続します。

![プールクォーラム1](media/understand-quorum/pool-1.png)

- 1つのサーバーの障害が発生する可能性があります。**Yes**。
- サーバー障害が発生しても、別のサーバーエラーが発生する可能性があります。**Yes**。
- は、2つのサーバーエラーを一度に保持できます。**Yes**。 

#### <a name="four-nodes-with-a-symmetrical-layout-and-drive-failure"></a>レイアウトが対称でドライブが故障している4ノード。 
16の各ドライブには1つの投票があり、ノード2にも1票 (プールリソース所有者であるため) があります。 *過半数*は、合計で**16 票**によって決定されます。 まず、ドライブ7がダウンします。 ノード3と4がダウンした場合、残りのサブセットには7個のドライブとプールリソース所有者 (8/16 票) があります。 そのため、プールには過半数がなく、ダウンします。

![プールクォーラム2](media/understand-quorum/pool-2.png)

- 1つのサーバーの障害が発生する可能性があります。**Yes**。
- サーバー障害が発生しても、別のサーバーエラーが発生する可能性があります。**No**:
- は、2つのサーバーエラーを一度に保持できます。**No**: 

#### <a name="four-nodes-with-a-non-symmetrical-layout"></a>対称でないレイアウトの4つのノード。 
24の各ドライブには1つの投票があり、ノード2にも1票 (プールリソース所有者であるため) があります。 *過半数*は、合計で**24 の投票**から決定されます。 ノード3と4がダウンした場合、残りのサブセットには8個のドライブとプールリソース所有者 (9/24 票) があります。 そのため、プールには過半数がなく、ダウンします。

![プールクォーラム3](media/understand-quorum/pool-3.png)

- 1つのサーバーの障害が発生する可能性があります。**Yes**。
- 1つのサーバーの障害が発生しても、別の: * * が依存している * * (両方のノードが3と4の両方のノードがダウンしても、その他すべてのシナリオに対応できる場合)。
- は、2つのサーバーエラーを一度に発生させることができます。 * * 依存する * * (両方のノードが3と4の両方のノードがダウンしても、その他のすべてのシナリオを維持できる場合)。

### <a name="pool-quorum-recommendations"></a>プールクォーラムに関する推奨事項

- クラスター内の各ノードが対称であることを確認します (各ノードには同じ数のドライブがあります)。
- ノード障害が許容され、仮想ディスクをオンラインに保つことができるように、3方向ミラーまたはデュアルパリティを有効にします。 詳細については、[ボリュームのガイダンスページ](plan-volumes.md)を参照してください。
- 2つ以上のノードがダウンしている場合、または別のノードの2つのノードとディスクがダウンしている場合、ボリュームはデータの3つのコピーすべてにアクセスできないため、オフラインになり、使用できなくなります。 ボリューム内のすべてのデータの回復性を最大限に高めるには、サーバーを戻すかディスクを迅速に交換することをお勧めします。

## <a name="more-information"></a>詳細情報

- [クォーラムを構成および管理する](../../failover-clustering/manage-cluster-quorum.md)
- [クラウド監視を展開する](../../failover-clustering/deploy-cloud-witness.md)
