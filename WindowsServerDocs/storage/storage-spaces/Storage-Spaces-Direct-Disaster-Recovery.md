---
title: ハイパー集約型インフラストラクチャのディザスターリカバリーシナリオ
ms.prod: windows-server
ms.manager: eldenc
ms.technology: storage-spaces
ms.topic: article
author: johnmarlin-msft
ms.date: 03/29/2018
description: この記事では、Microsoft HCI (記憶域スペースダイレクト) のディザスターリカバリーのために現在利用できるシナリオについて説明します。
ms.localizationpriority: medium
ms.openlocfilehash: 8e6372ec7b4759f672c13f4bd822172afaf3faf3
ms.sourcegitcommit: 6aff3d88ff22ea141a6ea6572a5ad8dd6321f199
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 09/27/2019
ms.locfileid: "71393753"
---
# <a name="disaster-recovery-with-storage-spaces-direct"></a>記憶域スペースダイレクトを使用したディザスターリカバリー

> 適用対象:Windows Server 2019、Windows Server 2016

このトピックでは、ディザスターリカバリー用にハイパー集約インフラストラクチャ (HCI) を構成するシナリオについて説明します。

多くの企業では、ハイパー集約型ソリューションを実行しています。災害を計画している場合は、障害が発生した場合でも、運用環境にとどまることができます。 ディザスターリカバリー用に HCI を構成するには、いくつかの方法があります。このドキュメントでは、今日で利用できるオプションについて説明しています。

障害が発生した場合の可用性の復元に関するディスカッションは、目標復旧時間 (RTO) と呼ばれています。 これは、ビジネスに対する許容できない結果を回避するためにサービスを復元する必要がある期間です。 場合によっては、運用環境がほぼ即座に復元されると、このプロセスが自動的に実行されることがあります。 それ以外の場合は、サービスを復元するために、管理者の手動操作が必要になります。

現時点では、次のようなディザスターリカバリーオプションが使用されています。

1. 記憶域レプリカを利用する複数のクラスター
2. クラスター間での hyper-v レプリカ
3. バックアップと復元

## <a name="multiple-clusters-utilizing-storage-replica"></a>記憶域レプリカを利用する複数のクラスター

[記憶域レプリカ](../storage-replica/storage-replica-overview.md)は、ボリュームのレプリケーションを有効にし、同期レプリケーションと非同期レプリケーションの両方をサポートします。 同期レプリケーションと非同期レプリケーションのどちらを使用するかを選択する場合は、目標復旧時点 (RPO) を考慮する必要があります。 回復ポイントの目標は、大きな損失と見なされる前に発生する可能性があるデータ損失の可能性を示します。 同期レプリケーションを使用する場合は、同時に両方のエンドに順次書き込みが行われます。 非同期にすると、書き込みは非常に高速にレプリケートされますが、失われる可能性があります。 アプリケーションまたはファイルの使用状況を考慮して、最適な動作を確認する必要があります。

記憶域レプリカは、ブロックレベルのコピーメカニズムであり、ファイルレベルです。つまり、どのような種類のデータがレプリケートされるかは関係ありません。 これにより、ハイパー集約型インフラストラクチャのための一般的なオプションになります。 また、記憶域レプリカはレプリケーションパートナー間でさまざまな種類のドライブを利用できるので、1つの HCI 上のすべての種類の記憶域ともう一方の種類の記憶域を完全に問題なく使用できます。 

記憶域レプリカの重要な機能の1つとして、Azure とオンプレミスの両方で実行できることが挙げられます。 オンプレミスからオンプレミスへのセットアップ、Azure から Azure への設定、またはオンプレミスから Azure への設定 (またはその逆) を行うことができます。

このシナリオでは、独立したクラスターが2つあります。 HCI 間での記憶域レプリカの構成については、「クラスター間の[ストレージレプリケーション](../storage-replica/cluster-to-cluster-storage-replication.md)」の手順に従ってください。

![ストレージレプリケーションの図](media/storage-spaces-direct-disaster-recovery/Disaster-Recovery-Figure1.png)

記憶域レプリカを展開する場合は、次の考慮事項が適用されます。 

1.  レプリケーションの構成は、フェールオーバークラスタリングの外部で行われます。 
2.  レプリケーション方法の選択は、ネットワークの待機時間と RPO の要件によって異なります。 同期は、障害発生時にデータが失われないようにするために、クラッシュ整合性がある低待機時間のネットワーク上のデータをレプリケートします。 非同期は待機時間の長いネットワーク経由でデータをレプリケートしますが、障害が発生したときに各サイトに同一のコピーが含まれていない可能性があります。 
3.  障害が発生した場合、クラスター間のフェールオーバーは自動的には行われず、記憶域レプリカの PowerShell コマンドレットを使用して手動で調整する必要があります。 上の図では、Clustera.contoso.com 内はプライマリで、ClusterB はセカンダリです。 Clustera.contoso.com 内がダウンした場合は、リソースをアップする前に ClusterB をプライマリとして手動で設定する必要があります。 Clustera.contoso.com 内がバックアップされたら、セカンダリにする必要があります。 すべてのデータが同期されたら、変更を行い、ロールを最初に設定した方法に戻します。
4.  記憶域レプリカはデータをレプリケートするだけであるため、このデータを使用している新しい仮想マシンまたは Scale Out ファイルサーバー (SOFS) は、レプリカパートナーのフェールオーバークラスターマネージャー内に作成する必要があります。

記憶域レプリカは、クラスターで仮想マシンまたは SOFS が実行されている場合に使用できます。 PowerShell スクリプトを使用すると、レプリカ HCI のリソースをオンラインにすることができます。

## <a name="hyper-v-replica"></a>Hyper-V レプリカ

Hyper-v[レプリカ](https://docs.microsoft.com/windows-server/virtualization/hyper-v/manage/set-up-hyper-v-replica)は、ハイパー集約型インフラストラクチャでのディザスターリカバリーのための仮想マシンレベルのレプリケーションを提供します。 Hyper-v レプリカでは、仮想マシンを取得して、セカンダリサイトまたは Azure (レプリカ) にレプリケートすることができます。 次に、セカンダリサイトから、Hyper-v レプリカが3番目の (拡張レプリカ) に仮想マシンをレプリケートできるようになります。

![Hyper-v レプリケーションの図](media/storage-spaces-direct-disaster-recovery/Disaster-Recovery-Figure2.png)

Hyper-v レプリカを使用すると、レプリケーションは Hyper-v によって処理されます。 レプリケーションのために仮想マシンを初めて有効にする場合、最初のコピーを対応するレプリカクラスターに送信する方法には、3つの選択肢があります。

1.  ネットワーク経由での初期コピーの送信
2.  初期コピーを外部メディアに送信して、サーバーに手動でコピーできるようにする
3.  レプリカホストで既に作成されている既存の仮想マシンを使用する

もう1つのオプションは、この初期レプリケーションを実行するタイミングです。

1.  レプリケーションをすぐに開始する
2.  初期レプリケーションが行われる時刻をスケジュールします。 

その他に必要な考慮事項は次のとおりです。

- レプリケートする VHD/VHDX を選んでください。 これらのすべてをレプリケートするか、そのうちの1つだけをレプリケートするかを選択できます。
- 保存する回復ポイントの数。 復元する特定の時点についていくつかのオプションが必要な場合は、必要な数を指定します。 復元ポイントが1つだけ必要な場合は、それも選択できます。
- ボリュームシャドウコピーサービス (VSS) で増分シャドウコピーをレプリケートする頻度を設定します。
- 変更がレプリケートされる頻度 (30 秒、5分、15分)。

HCI が Hyper-v レプリカに参加する場合、各クラスターに[Hyper-v Replica Broker](https://blogs.technet.microsoft.com/virtualization/2012/03/27/why-is-the-hyper-v-replica-broker-required/)リソースが作成されている必要があります。 このリソースにはいくつかの処理があります。

1.  は、Hyper-v レプリカを接続するクラスターごとに1つの名前空間を提供します。
2.  レプリカ (または拡張レプリカ) が最初にコピーを受信したときにそのクラスター内のどのノードが配置されるかを決定します。
3.  仮想マシンが別のノードに移動した場合に、レプリカ (または拡張レプリカ) を所有しているノードを追跡します。 レプリケーションが行われると、情報を適切なノードに送信できるように、これを追跡する必要があります。

## <a name="backup-and-restore"></a>バックアップと復元

あまり重要ではない従来のディザスターリカバリーオプションの1つは、クラスター全体またはクラスター内のノードで障害が発生した場合です。 このシナリオのいずれのオプションでも、Windows NT バックアップを使用します。 

常に、ハイパー集約型インフラストラクチャの定期的なバックアップを作成することをお勧めします。 クラスターサービスが実行されている間、システム状態のバックアップを作成すると、クラスターレジストリデータベースがそのバックアップの一部になります。 クラスターまたはデータベースの復元には、2つの異なる方法があります (権限のないと権限があります)。

### <a name="non-authoritative"></a>権限のない

権限のない復元は、Windows NT バックアップを使用して行うことができ、クラスターノード自体の完全な復元に相当します。 クラスターノード (およびクラスターレジストリデータベース) と現在のすべてのクラスター情報を復元するだけでよい場合は、権限のないを使用して復元します。 権限のない復元は、Windows NT バックアップインターフェイスまたはコマンドライン WBADMIN を使用して実行できます。EXCEL.EXE.

ノードを復元したら、クラスターに参加させます。 実行されるのは、既存の実行中のクラスターに対して行われ、すべての情報が現在のもので更新されるからです。

### <a name="authoritative"></a>関し

一方、クラスター構成の権限のある復元では、クラスター構成が時間内に戻されます。 この種類の復元は、クラスター情報が失われ、復元が必要な場合にのみ実行してください。 たとえば、1000の共有に含まれているファイルサーバーを誤って削除した場合、それらのファイルが必要になります。 クラスターの権限のある復元を完了するには、コマンドラインからバックアップを実行する必要があります。

クラスターノードで権限のある復元が開始されると、クラスタービュー内の他のすべてのノードでクラスターサービスが停止し、クラスター構成が固定されます。 このため、復元が実行されたノードのクラスターサービスを最初に開始することが重要であるため、クラスターはクラスター構成の新しいコピーを使用して形成されます。

権限のある復元を実行するには、次の手順を実行します。

1.  WBADMIN を実行します。管理コマンドプロンプトから EXE を実行して、インストールするバックアップの最新バージョンを取得し、システム状態が復元可能なコンポーネントの1つであることを確認します。

    ```powershell
    Wbadmin get versions
    ```

2.  使用しているバージョンのバックアップに、クラスターレジストリ情報がコンポーネントとして含まれているかどうかを確認します。 このコマンドには、手順3で使用するために必要な、バージョンとアプリケーション/コンポーネントの2つの項目があります。 たとえば、バージョンでは、バックアップが2018年1月3日に実行され、これが復元する必要があるとします。

    ```powershell
    wbadmin get items -backuptarget:\\backupserver\location
    ```

3.  権限のある復元を開始して、必要なクラスターレジストリのバージョンのみを回復します。 

    ```powershell
    wbadmin start recovery -version:01/03/2018-02:04 -itemtype:app -items:cluster
    ```

復元が完了したら、このノードが最初にクラスターサービスを開始し、クラスターを形成する必要があります。 その他のすべてのノードを起動し、クラスターに参加させる必要があります。

## <a name="summary"></a>まとめ 

これを合計するために、ハイパー集約されたディザスターリカバリーは、慎重に計画する必要があるものです。 ニーズに最適なシナリオがいくつかあり、十分にテストする必要があります。 注意すべき1つの項目は、過去にフェールオーバークラスターを使い慣れている場合、ストレッチクラスターは長年にわたって非常に人気のあるオプションでした。 ハイパー集約型ソリューションでは、設計に多少の変更があり、回復性に基づいています。 ハイパー収束クラスター内の2つのノードが失われた場合、クラスター全体が停止します。 この場合、ハイパー収束環境では、ストレッチシナリオはサポートされていません。


