---
title: 移動ユーザー プロファイルの展開
TOCTitle: Deploying Roaming User Profiles
ms.prod: windows-server
ms.technology: storage
ms.topic: article
author: JasonGerend
manager: brianlic
ms.date: 06/07/2019
ms.author: jgerend
ms.openlocfilehash: 514dd9be3f7f634cf021a8a154f4b64c9018743e
ms.sourcegitcommit: d5e27c1f2f168a71ae272bebf8f50e1b3ccbcca3
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 07/23/2020
ms.locfileid: "86961634"
---
# <a name="deploying-roaming-user-profiles"></a>移動ユーザー プロファイルの展開

>適用先:Windows 10、Windows 8.1、Windows 8、Windows 7、Windows Server 2019、Windows Server 2016、Windows Server (半期チャネル)、Windows Server 2012 R2、Windows Server 2012、Windows Server 2008 R2

このトピックでは、Windows Server を使用して[移動ユーザー プロファイル](folder-redirection-rup-overview.md)を Windows クライアント コンピューターに展開する方法について説明します。 移動ユーザー プロファイルでは、ユーザー プロファイルがファイル共有にリダイレクトされ、ユーザーが複数のコンピューター上で同一のオペレーティング システムとアプリケーションの設定を利用できるようになります。

このトピックに対する最近の変更については、「[変更履歴](#change-history)」のセクションを参照してください。

> [!IMPORTANT]
> [MS16-072](https://support.microsoft.com/help/3163622/ms16-072-security-update-for-group-policy-june-14%2c-2016) で行われたセキュリティの変更により、このトピックの「[手順 4:オプションで移動ユーザー プロファイルの GPO を作成する](#step-4-optionally-create-a-gpo-for-roaming-user-profiles)」を更新して、Windows によって移動ユーザー プロファイル ポリシーを適切に適用できるようにしました (影響を受ける PC 上のローカル ポリシーには戻されません)。

> [!IMPORTANT]
>  次の構成で OS のインプレース アップグレードを実行すると、スタート画面に対するユーザーのカスタマイズが失われます。
> - ユーザーが移動プロファイル用に構成されている
> - ユーザーがスタート画面に対する変更を許可されている
>
> その結果、OS のインプレース アップグレード後に、スタート メニューが新しい OS バージョンの既定値にリセットされます。 回避策については、「[付録 C:アップグレード後にスタート メニューのレイアウトのリセットを回避する](#appendix-c-working-around-reset-start-menu-layouts-after-upgrades)」を参照してください。

## <a name="prerequisites"></a>前提条件

### <a name="hardware-requirements"></a>ハードウェア要件

移動ユーザー プロファイルには x64 ベースまたは x86 ベースのコンピューターが必要です。これは Windows RT ではサポートされていません。

### <a name="software-requirements"></a>ソフトウェア要件

移動ユーザー プロファイルには次のソフトウェア要件があります。

- 既存のローカル ユーザー プロファイルのある環境に、フォルダー リダイレクトと共に移動ユーザー プロファイルを展開する場合、移動ユーザー プロファイルの前にフォルダー リダイレクトを展開して、移動プロファイルのサイズを最小にします。 既存のユーザー フォルダーが正しくリダイレクトされたら、移動ユーザー プロファイルを展開できます。
- 移動ユーザー プロファイルを管理するには、Domain Administrators セキュリティ グループ、Enterprise Administrators セキュリティ グループ、または Group Policy Creator Owners セキュリティ グループのメンバーとしてサインインする必要があります。
- クライアント コンピューターでは、Windows 10、Windows 8.1、Windows 8、Windows 7、Windows Vista、Windows Server 2012 R2、Windows Server 2012、Windows Server 2008 R2、または Windows Server 2008 を実行する必要があります。
- クライアント コンピューターは、管理している Active Directory ドメイン サービス (AD DS) に参加している必要があります。
- グループ ポリシー管理および Active Directory 管理センターがインストールされたコンピューターが使用できる必要があります。
- 移動ユーザー プロファイルをホストするためにファイル サーバーが使用できる必要があります。

    - ファイル共有で DFS 名前空間を使用している場合、ユーザーのさまざまなサーバーへの編集の競合を防ぐため、DFS フォルダー (リンク) のターゲットは 1 つである必要があります。
    - ファイル共有で DFS レプリケーションを使用して、コンテンツを別のサーバーにレプリケートする場合、ユーザーのさまざまなサーバーへの編集の競合を防ぐため、ユーザーはソース サーバーにのみアクセスできる必要があります。
    - ファイル共有がクラスター化されている場合は、パフォーマンスの問題を回避するため、ファイル共有での継続的可用性を無効にします。
- 移動ユーザー プロファイル内でプライマリ コンピューター サポートを使用するには、クライアント コンピューターと Active Directory スキーマの追加の要件があります。 詳細については、「[フォルダー リダイレクトと移動ユーザー プロファイル用のプライマリ コンピューターを展開する](deploy-primary-computers.md)」を参照してください。
- ユーザーが複数の PC、リモート デスクトップ セッション ホスト、または仮想デスクトップ インフラストラクチャ (VDI) サーバーを使用している場合、Windows 10、Windows Server 2019、または Windows Server 2016 上ではそのユーザーのスタート メニューのレイアウトが移動されません。 回避策として、このトピックで説明するように、スタート画面のレイアウトを指定できます。 または、ユーザー プロファイル ディスクを使用できます。これにより、リモート デスクトップ セッション ホスト サーバーまたは VDI サーバーと共に使用するときにスタート メニューの設定が適切に移動されます。 詳細については、「[Windows Server 2012 でユーザー プロファイル ディスクを使用してユーザー データ管理を簡単にする](https://techcommunity.microsoft.com/t5/microsoft-security-and/easier-user-data-management-with-user-profile-disks-in-windows/ba-p/247555)」を参照してください。

### <a name="considerations-when-using-roaming-user-profiles-on-multiple-versions-of-windows"></a>複数の Windows のバージョンで移動ユーザー プロファイルを使用する場合の考慮事項

複数の Windows のバージョン間で移動ユーザー プロファイルを使用する場合、次の対策を講じることをお勧めします。

- オペレーティング システムのバージョンごとに、個別のプロファイル バージョンを維持するように Windows を構成します。 これにより、プロファイルの破損など望ましくない予測不能な問題を回避します。
- フォルダー リダイレクトを使用して、ドキュメントやピクチャなどのユーザー ファイルをユーザー プロファイルとは別に保存します。 これにより、ユーザーがオペレーティング システムのバージョンの違いに関係なく、同じファイルを使用できます。 さらに、プロファイルが小さく維持され、サインインが速くなります。
- 移動ユーザー プロファイルに十分な記憶域を割り当てます。 2 つのオペレーティング システムのバージョンをサポートする場合、オペレーティング システム バージョンごとに個別のプロファイルを維持するため、プロファイルの数 (したがって消費される合計の領域) が倍になります。
- Windows Vista/Windows Server 2008 と Windows 7/Windows Server 2008 R2 を実行するコンピューター間で移動ユーザー プロファイルを使用しないでください。 これらのオペレーティング システム バージョン間での移動は、それらのプロファイル バージョンに互換性がないためサポートされていません。
- ユーザーに、一方のオペレーティング システム バージョンで行った変更は他方のオペレーティング システム バージョンに移動されないことを通知してください。
- 別のプロファイル バージョンを使用している Windows のバージョンに環境を移動する場合 (Windows 10 から Windows 10、バージョン 1607 など。一覧については「[付録 B:プロファイル バージョン参照情報](#appendix-b-profile-version-reference-information)」を参照)、ユーザーは新しい空の移動ユーザー プロファイルを受け取ります。 フォルダー リダイレクトを使用して共通フォルダーをリダイレクトすることによって、新しいプロファイルの取得による影響を最小限に抑えることができます。 移動ユーザー プロファイルをあるプロファイル バージョンから別のバージョンに移行するためにサポートされている方法はありません。

## <a name="step-1-enable-the-use-of-separate-profile-versions"></a>手順 1:個別のプロファイル バージョンの使用を有効にする

Windows 8.1、Windows 8、Windows Server 2012 R2、または Windows Server 2012 を実行するコンピューターに移動ユーザー プロファイルを展開する場合、展開の前に、使用する Windows 環境にいくつかの変更を行うことをお勧めします。 これらの変更により、将来のオペレーティング システムのアップグレードがスムーズに進み、移動ユーザー プロファイルによって、複数の Windows のバージョンを同時に実行できるようになります。

これらの変更を行うには、次の手順に従います。

1. 移動、固定、スーパー固定、またはドメインの既定のプロファイルを使用するすべてのコンピューターに、適切なソフトウェア更新をダウンロードしてインストールします。

    - Windows 8.1 または Windows Server 2012 R2: Microsoft サポート技術情報の記事 [2887595](https://support.microsoft.com/kb/2887595) で説明されているソフトウェア更新プログラムをインストールします (リリースされている場合)。
    - Windows 8 または Windows Server 2012: Microsoft サポート技術情報の記事 [2887239](https://support.microsoft.com/kb/2887239) で説明されているソフトウェア更新プログラムをインストールします。

2. 移動ユーザー プロファイルを使用する Windows 8.1、Windows 8、Windows Server 2012 R2、または Windows Server 2012 を実行するすべてのコンピューターで、レジストリ エディターまたはグループ ポリシーを使用して、次のレジストリ キー DWORD 値を作成し、それを `1` に設定します。 グループ ポリシーを使用してレジストリ キーを作成する方法については、「 [[レジストリ] 項目を構成する](<https://docs.microsoft.com/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/cc753092(v=ws.11)>)」を参照してください。

    ```
    HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\ProfSvc\Parameters\UseProfilePathExtensionVersion
    ```

    > [!WARNING]
    > レジストリを正しく編集しないと、システムが正常に動作しなくなる場合があります。 レジストリを変更する前に、コンピューター上の重要なデータのバックアップを作成する必要があります。
3. コンピューターを再起動します。

## <a name="step-2-create-a-roaming-user-profiles-security-group"></a>手順 2:移動ユーザー プロファイルのセキュリティ グループを作成する

環境に移動ユーザー プロファイルをまだ設定していない場合、最初の手順は、移動ユーザー プロファイル ポリシー設定を適用するすべてのユーザーやコンピューターを含むセキュリティ グループを作成することです。

- 汎用移動ユーザー プロファイル展開の管理者は一般にユーザーのセキュリティ グループを作成します。
- リモート デスクトップ サービスまたは仮想デスクトップ展開の管理者は一般にユーザーと共有コンピューターのセキュリティ グループを使用します。

移動ユーザー プロファイルのセキュリティ グループを作成する方法を次に示します:

1. Active Directory 管理センターがインストールされたコンピューターでサーバー マネージャーを開きます。
2. **[ツール]** メニューの **[Active Directory 管理センター]** を選択します。 Active Directory 管理センターが表示されます。
3. 適切なドメインまたは OU を右クリックし、 **[新規作成]** を選択して、 **[グループ]** を選択します。
4. **[グループの作成]** ウィンドウの **[グループ]** で、次の設定を指定します。

    - **[グループ名]** に、セキュリティ グループの名前を入力します。たとえば、**Roaming User Profiles Users and Computers** のようになります。
    - **[グループのスコープ]** で **[セキュリティ]** を選択し、 **[グローバル]** を選択します。

5. **[メンバー]** セクションの **[追加]** を選択します。 [ユーザー、連絡先、コンピューター、サービス アカウントまたはグループの選択] ダイアログ ボックスが表示されます。
6. セキュリティ グループにコンピューター アカウントを含める場合は、 **[オブジェクトの種類]** を選択し、 **[コンピューター]** チェック ボックスをオンにしてから、 **[OK]** を選択します。
7. 移動ユーザー プロファイルを展開するユーザー、グループ、またはコンピューターの名前を入力し、 **[OK]** を選択し、さらに **[OK]** を選択します。

## <a name="step-3-create-a-file-share-for-roaming-user-profiles"></a>手順 3:移動ユーザー プロファイルのファイル共有を作成する

移動ユーザー プロファイル用の個別のファイル共有 (移動プロファイル フォルダーの誤ったキャッシュを回避するため、リダイレクトされたフォルダー用の共有から独立した) がまだない場合は、次の手順に従って、Windows Server を実行するサーバー上にファイル共有を作成します。

> [!NOTE]
> 使用している Windows Server のバージョンによっては、一部の機能が異なる場合や使用できない場合があります。

Windows Server 上でファイル共有を作成する方法を次に示します:

1. サーバー マネージャーのナビゲーション ウィンドウで **[ファイル サービスと記憶域サービス]** を選択し、 **[共有]** を選択して共有のページを表示します。
2. [共有] タイルで、 **[タスク]** を選択してから **[新しい共有]** を選択します。 新しい共有ウィザードが表示されます。
3. **[プロファイルの選択]** ページで、 **[SMB 共有 – 簡易]** を選択します。 ファイル サーバー リソース マネージャーをインストールしており、フォルダー管理プロパティを使用している場合は、代わりに **[SMB 共有 - 高度]** を選択します。
4. **[共有の場所]** ページで、共有を作成するサーバーとボリュームを選択します。
5. **[共有名]** ページで、 **[共有名]** ボックスに共有の名前 ( **User Profiles$** など) を入力します。

    > [!TIP]
    > 共有を作成する場合、共有名の後ろに ```$``` を付けて共有を非表示にします。 これにより、共有が通常のブラウザーから非表示になります。

6. **[他の設定]** ページで、 **[継続的可用性を有効にする]** チェック ボックスをオフにし (ある場合)、必要に応じて **[アクセスベースの列挙を有効にする]** および **[データ アクセスの暗号化]** チェック ボックスをオンにします。
7. **[アクセス許可]** ページで、 **[アクセス許可をカスタマイズする]** を選択します。 [セキュリティの詳細設定] ダイアログ ボックスが表示されます。
8. **[継承の無効化]** を選択し、 **[継承されたアクセス許可をこのオブジェクトの明示的なアクセス許可に変換します]** を選択します。
9. 「[移動ユーザー プロファイルをホストするファイル共有に必要なアクセス許可](#required-permissions-for-the-file-share-hosting-roaming-user-profiles)」で説明し、次のスクリーン ショットに示すように、アクセス許可を設定し、一覧にないグループとアカウントのアクセス許可を削除し、手順 1 で作成した Roaming User Profiles Users and Computers グループに特殊なアクセス許可を追加します。
    
    ![表 1 で説明されているアクセス許可を示す [セキュリティの詳細設定] ウィンドウ](media/advanced-security-user-profiles.jpg)
    
    **図 1** 移動ユーザー プロファイル共有のアクセス許可の設定
10. **[SMB 共有 - 高度]** プロファイルを選択した場合、 **[管理プロパティ]** ページで、 **[ユーザー ファイル]** フォルダーの使用法値を選択します。
11. **[SMB 共有 - 高度]** プロファイルを選択した場合、 **[クォータ]** ページで、オプションで共有のユーザーに適用するクォータを選択します。
12. **[確認]** ページで、 **[作成]** を選択します。

### <a name="required-permissions-for-the-file-share-hosting-roaming-user-profiles"></a>移動ユーザー プロファイルをホストするファイル共有に必要なアクセス許可

| ユーザー アカウント | アクセス権 | 適用対象 |
|   -   |   -   |   -   |
|   System    |  フル コントロール     |  このフォルダー、サブフォルダー、およびファイル     |
|  Administrators     |  フル コントロール     |  このフォルダーのみ     |
|  作成者/所有者     |  フル コントロール     |  サブフォルダーとファイルのみ     |
| データを共有に置く必要があるユーザーのセキュリティ グループ (Roaming User Profiles Users and Computers)      |  フォルダーの一覧表示/データの読み取り *(高度なアクセス許可)* <br />フォルダーの作成/データの追加 *(高度なアクセス許可)* |  このフォルダーのみ     |
| その他のグループおよびアカウント   |  なし (削除)     |       |

## <a name="step-4-optionally-create-a-gpo-for-roaming-user-profiles"></a>手順 4:オプションで移動ユーザー プロファイルの GPO を作成する

移動ユーザー プロファイル設定用の GPO をまだ作成していない場合、次の手順に従って、移動ユーザー プロファイルに使用する空の GPO を作成します。 この GPO は、移動ユーザー プロファイル設定 (別途説明するプライマリ コンピューターのサポートなど) を構成することができ、さらに、一般に仮想デスクトップ環境内やリモート デスクトップ サービスによって展開する場合に行うように、コンピューターで移動ユーザー プロファイルを有効にするためにも使用できます。

移動ユーザー プロファイルの GPO を作成する方法を次に示します:

1. グループ ポリシー管理がインストールされたコンピューターでサーバー マネージャーを開きます。
2. **[ツール]** メニューの **[グループ ポリシー管理]** を選択します。 グループ ポリシー管理が表示されます。
3. 移動ユーザー プロファイルを設定するドメインまたは OU を右クリックし、 **[このドメインに GPO を作成し、このコンテナーにリンクする]** を選択します。
4. **[新しい GPO]** ダイアログ ボックスで、GPO の名前 (**Roaming User Profile Settings** など) を入力し、 **[OK]** を選択します。
5. 新しく作成した GPO を右クリックし、 **[リンクの有効化]** チェックボックスをオフにします。 これにより、GPO の構成が完了するまで、それが適用されるのを防ぎます。
6. GPO を選択します。 **[スコープ]** タブの **[セキュリティ フィルター]** セクションで、 **[Authenticated Users]** を選択した後に **[削除]** を選択して、GPO がすべてのユーザーに適用されないようにします。
7. **[セキュリティ フィルター処理]** セクションで **[追加]** を選択します。
8. **[ユーザー、コンピューター、またはグループの選択]** ダイアログ ボックスで、手順 1 で作成したセキュリティ グループの名前 (**Roaming User Profiles Users and Computers** など) を入力して、 **[OK]** を選択します。
9. **[委任]** タブを選択して **[追加]** を選択し、「**Authenticated Users**」と入力して **[OK]** を選択します。もう一度 **[OK]** を選択して、既定の読み取りアクセス許可を受け入れます。
    
    この手順が必要なのは、[MS16-072](https://support.microsoft.com/help/3163622/ms16-072-security-update-for-group-policy-june-14%2c-2016) でセキュリティが変更されたためです。

>[!IMPORTANT]
>[MS16-072A](https://support.microsoft.com/help/3163622/ms16-072-security-update-for-group-policy-june-14%2c-2016) で行われたセキュリティの変更により、現在は「Authenticated Users」グループに GPO への読み取りアクセス許可を委任する必要があります。そうしないと、GPO がユーザーに適用されないか、GPO が既に適用されている場合はその GPO が削除され、ユーザー プロファイルがローカル PC にリダイレクトされます。 詳細については、「[グループ ポリシーのセキュリティの更新 MS16-072 の展開](/archive/blogs/askds/deploying-group-policy-security-update-ms16-072-kb3163622)」を参照してください。

## <a name="step-5-optionally-set-up-roaming-user-profiles-on-user-accounts"></a>手順 5:オプションでユーザー アカウントに移動ユーザー プロファイルを設定する

移動ユーザー プロファイルをユーザー アカウントに展開する場合、次の手順を使用して、Active Directory Domain Services でユーザー アカウントに移動ユーザー プロファイルを指定します。 リモート デスクトップ サービスや仮想デスクトップの展開で一般に行われるように、移動ユーザー プロファイルをコンピューターに展開する場合は、代わりに「[手順 6:オプションでコンピューターに移動ユーザー プロファイルを設定する](#step-6-optionally-set-up-roaming-user-profiles-on-computers)」で説明する手順に従います。

> [!NOTE]
> 移動ユーザー プロファイルを Active Directory を使用してユーザー アカウントに設定し、さらにグループ ポリシーを使用してコンピューターに設定した場合、コンピューターベースのポリシー設定が優先されます。

ユーザー アカウントに移動ユーザー プロファイルを設定する方法を次に示します:

1. Active Directory 管理者センターで、適切なドメインの **[Users]** コンテナー (または OU) に移動します。
2. 移動ユーザー プロファイルを割り当てるすべてのユーザーを選択し、ユーザーを右クリックして、 **[プロパティ]** を選択します。
3. **[プロファイル]** セクションで、 **[プロファイル パス:]** チェックボックスをオンにし、ユーザーの移動ユーザー プロファイルを保存するファイル共有のパスを、後ろに `%username%` (これはユーザーが初めてサインインしたときに、自動的にユーザー名に置換される) を付けて入力します。 たとえば、次のように入力します。
    
    `\\fs1.corp.contoso.com\User Profiles$\%username%`
    
    固定移動ユーザー プロファイルを指定するには、以前に作成した NTuser.man ファイルのパスを指定します。たとえば、`fs1.corp.contoso.comUser Profiles$default` のようになります。 詳細については、「[固定ユーザー プロファイルの作成](/windows/client-management/mandatory-user-profile)」を参照してください。
4. **[OK]** を選択します。

> [!NOTE]
> 既定で、移動ユーザー プロファイルを使用する場合、すべての Windows® ランタイムベース (Windows ストア) アプリの展開が許可されます。 ただし、特殊なプロファイルを使用する場合、アプリは既定で展開されません。 特殊なプロファイルは、ユーザーがサインアウトした後に変更が破棄されるユーザー プロファイルです。
> <br><br>特殊なプロファイルのアプリの展開の制限を削除するには、 **Allow deployment operations in special profiles** ポリシー設定 (コンピューターの構成\ポリシー\管理用テンプレート\Windows コンポーネント\アプリ パッケージの展開にある) をオンにします。 ただし、このシナリオで展開されたアプリでは、コンピューターに一部のデータが保存されたままになり、単一のコンピューターに数百のユーザーがいる場合に、蓄積される可能性があります。 アプリをクリーンアップするには、コンピューターにプロファイルがなくなったユーザーのために [CleanupPackageForUserAsync](/uwp/api/Windows.Management.Deployment.PackageManager?view=winrt-19041#windows_management_deployment_packagemanager_cleanuppackageforuserasync_system_string_system_string_) API を使用してアプリ パッケージをクリーンアップするツールを探すか開発します。
> <br><br>Windows ストア アプリの追加の背景情報については、「 [Windows ストアへのクライアント アクセスの管理](<https://docs.microsoft.com/previous-versions/windows/it-pro/windows-8.1-and-8/hh832040(v=ws.11)>)」を参照してください。

## <a name="step-6-optionally-set-up-roaming-user-profiles-on-computers"></a>手順 6:オプションでコンピューターに移動ユーザー プロファイルを設定する

一般に、リモート デスクトップ サービスや仮想デスクトップの展開で行われるように、移動ユーザー プロファイルをコンピューターに展開する場合は、次の手順に従います。 移動ユーザー プロファイルをユーザー アカウントに展開する場合は、このトピックの「[手順 5:オプションでユーザー アカウントに移動ユーザー プロファイルを設定する](#step-5-optionally-set-up-roaming-user-profiles-on-user-accounts)」で説明した手順に従います。

グループ ポリシーを使用して、Windows 8.1、Windows 8、Windows 7、Windows Vista、Windows Server 2019、Windows Server 2016、Windows Server 2012 R2、Windows Server 2012、Windows Server 2008 R2、または Windows Server 2008 を実行するコンピューターに移動ユーザー プロファイルを適用できます。

> [!NOTE]
> 移動ユーザー プロファイルをグループ ポリシーを使用してコンピューターに設定し、さらに Active Directory を使用してユーザー アカウントに設定した場合、コンピューターベースのポリシー設定が優先されます。

コンピューターに移動ユーザー プロファイルを設定する方法を次に示します:

1. グループ ポリシー管理がインストールされたコンピューターでサーバー マネージャーを開きます。
2. **[ツール]** メニューの **[グループ ポリシー管理]** を選択します。 グループ ポリシー管理が表示されます。
3. グループ ポリシー管理で、手順 3 で作成した GPO (**Roaming User Profiles Settings** など) を右クリックし、 **[編集]** を選択します。
4. グループ ポリシー管理エディター ウィンドウで、 **コンピューターの構成**、次に **ポリシー**、次に **管理用テンプレート**、次に **システム**、次に **ユーザー プロファイル** に移動します。
5. **[このコンピューターにログオンしているすべてユーザーの移動プロファイル パスを設定する]** を右クリックし、 **[編集]** を選択します。
    > [!TIP]
    > ユーザーのホーム フォルダーは、構成されている場合、Windows PowerShell などの一部のプログラムによって使用される既定のフォルダーです。 AD DS のユーザー アカウントのプロパティーの **[ホーム フォルダー]** セクションを使用して、ユーザー単位で、代替のローカルまたはネットワークの場所を構成できます。 仮想デスクトップ環境で Windows 8.1、Windows 8、Windows Server 2019、Windows Server 2016、Windows Server 2012 R2、または Windows Server 2012 を実行するコンピューターのすべてのユーザーのホーム フォルダーの場所を構成するには、 **[ユーザー ホーム フォルダーを設定する]** ポリシー設定を有効にし、ファイル共有とマップするドライブ文字を指定 (またはローカルの場所を指定) します。 環境変数や省略記号を使用しないでください。 ユーザーのサインオン時に指定されたパスの最後にユーザーのエイリアスが追加されます。
6. **[プロパティ]** ダイアログ ボックスで、 **[有効]** を選択します
7. **[このコンピューターにログオンしているユーザーは、この移動プロファイル パスを使用]** ボックスに、ユーザーの移動ユーザー プロファイルを保存するファイル共有のパスを、後ろに `%username%` (これはユーザーが初めてサインインしたときに、自動的にユーザー名に置換される) を付けて入力します。 たとえば、次のように入力します。

    `\\fs1.corp.contoso.com\User Profiles$\%username%`

    ユーザーが完全には変更することができない (変更はユーザーのサインアウト時にリセットされる) 事前構成済みのプロファイルである固定移動ユーザー プロファイルを指定するには、以前に作成した NTuser.man ファイルのパスを指定します。たとえば `\\fs1.corp.contoso.com\User Profiles$\default` のようになります。 詳細については、「 [Creating a Mandatory User Profile (固定ユーザー プロファイルの作成)](/windows/client-management/mandatory-user-profile)」を参照してください。
8. **[OK]** を選択します。

## <a name="step-7-optionally-specify-a-start-layout-for-windows-10-pcs"></a>手順 7:必要に応じて Windows 10 PC のスタート画面のレイアウトを指定する

グループ ポリシーを使用すると、ユーザーがすべての PC 上で同じスタート画面のレイアウトを表示できるように特定のスタート メニューのレイアウトを適用することができます。 ユーザーが複数の PC にサインインし、PC 間で一貫したスタート画面のレイアウトを使用したい場合は、GPO がすべての PC に適用されていることを確認します。

スタート画面のレイアウトを指定するには、以下を行います。

1. Windows 10 PC を Windows 10 バージョン 1607 (Anniversary Update とも呼ばれます) 以降に更新し、2017 年 3 月 14 日の累積的な更新プログラム ([KB4013429](https://support.microsoft.com/kb/4013429)) 以降をインストールします。
2. 完全または部分的なスタート メニューのレイアウトの XML ファイルを作成します。 これを行うには、「[スタート画面のレイアウトのカスタマイズとエクスポート](/windows/configuration/customize-and-export-start-layout)」を参照してください。
    * "*完全*" なスタート画面のレイアウトを指定した場合、ユーザーはスタート メニューのどの部分もカスタマイズできません。 "*部分的*" なスタート画面のレイアウトを指定した場合、ユーザーは、指定したタイルのロックされたグループ以外のすべてのものをカスタマイズできます。 ただし、部分的なスタート画面のレイアウトでは、スタート メニューに対するユーザーのカスタマイズは、他の PC に移動されません。
3. グループ ポリシーを使用して、カスタマイズされたスタート画面のレイアウトを、移動ユーザー プロファイル用に作成した GPO に適用します。 これを行うには、「[グループ ポリシーを使ってカスタマイズしたスタート画面のレイアウトをドメインに適用する](/windows/configuration/customize-windows-10-start-screens-by-using-group-policy#bkmk-domaingpodeployment)」を参照してください。
4. グループ ポリシーを使用して、Windows 10 PC 上で次のレジストリ値を設定します。 これを行うには、「[[レジストリ] 項目を構成する](<https://docs.microsoft.com/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/cc753092(v=ws.11)>)」を参照してください。

| **操作**   | **Update**                  |
| ------------ | ------------                |
| ［ハイブ］         | **HKEY_LOCAL_MACHINE**      |
| キーのパス     | **Software\Microsoft\Windows\CurrentVersion\Explorer** |
| 値の名前   | **SpecialRoamingOverrideAllowed** |
| 値の種類   | **REG_DWORD**               |
| [値] に   | **1** (無効にするには **0**) |
| ベース         | **10 進数**                 |

5. (オプション) 初回ログオンの最適化を有効にすると、ユーザーによるサインインが高速になります。 これを行うには、「[ポリシーを適用してサインイン時間を改善する](/windows/client-management/mandatory-user-profile#apply-policies-to-improve-sign-in-time)」を参照してください。
6. (オプション) クライアント PC の展開に使用する Windows 10 基本イメージから不要なアプリを削除することで、サインイン時間をさらに短縮します。 Windows Server 2019 および Windows Server 2016 には事前にプロビジョニングされたアプリがないため、サーバー イメージ上でこの手順をスキップできます。
    - アプリを削除するには、Windows PowerShell で [Remove-AppxProvisionedPackage](/powershell/module/dism/remove-appxprovisionedpackage?view=win10-ps) コマンドレットを使用して、次のアプリケーションをアンインストールします。 PC が既に展開されている場合は、[Remove-AppxPackage](/powershell/module/appx/remove-appxpackage?view=win10-ps) を使用して、これらのアプリの削除をスクリプト化できます。
    
      - Microsoft.windowscommunicationsapps\_8wekyb3d8bbwe
      - Microsoft.BingWeather\_8wekyb3d8bbwe
      - Microsoft.DesktopAppInstaller\_8wekyb3d8bbwe
      - Microsoft.Getstarted\_8wekyb3d8bbwe
      - Microsoft.Windows.Photos\_8wekyb3d8bbwe
      - Microsoft.WindowsCamera\_8wekyb3d8bbwe
      - Microsoft.WindowsFeedbackHub\_8wekyb3d8bbwe
      - Microsoft.WindowsStore\_8wekyb3d8bbwe
      - Microsoft.XboxApp\_8wekyb3d8bbwe
      - Microsoft.XboxIdentityProvider\_8wekyb3d8bbwe
      - Microsoft.ZuneMusic\_8wekyb3d8bbwe

>[!NOTE]
>これらのアプリをアンインストールすると、サインイン時間が短縮されますが、これらのいずれかが展開に必要な場合はインストールしたままにすることができます。

## <a name="step-8-enable-the-roaming-user-profiles-gpo"></a>手順 8:移動ユーザー プロファイル GPO を有効にする

グループ ポリシーを使用して、コンピューターに移動ユーザー プロファイルを設定しているか、グループ ポリシーを使用して、他の移動ユーザー プロファイルをカスタマイズした場合、次の手順は、GPO を有効にし、影響のあるユーザーへの適用を許可することです。

>[!TIP]
>プライマリ コンピューターのサポートを実装する予定がある場合は、GPO を有効にする前に、ここでそれらを実行してください。 これにより、プライマリ コンピューターのサポートが有効にされる前に、ユーザー データがプライマリでないコンピューターにコピーされることを防ぎます。 具体的なポリシー設定については、「[フォルダー リダイレクトと移動ユーザー プロファイル用のプライマリ コンピューターを展開する](deploy-primary-computers.md)」を参照してください。

移動ユーザー プロファイル GPO を有効にする方法を次に示します:

1. グループ ポリシーの管理を開きます。
2. 作成した GPO を右クリックし、 **[リンクの有効化]** を選択します。 メニュー項目の横にチェックボックスが表示されます。

## <a name="step-9-test-roaming-user-profiles"></a>手順 9:移動ユーザー プロファイルをテストする

移動ユーザー プロファイルをテストするには、移動ユーザー プロファイル用に構成されたユーザー アカウントでコンピューターにサインインするか、移動ユーザー プロファイル用に構成されたコンピューターにサインインします。 次に、プロファイルがリダイレクトされることを確認します。

移動ユーザー プロファイルをテストする方法を次に示します:

1. 移動ユーザー プロファイルを有効にしているユーザー アカウントでプライマリ コンピューターにサインインします (プライマリ コンピューターのサポートを有効にしている場合)。 特定のコンピューターで移動ユーザー プロファイルを有効にしている場合、これらのいずれかのコンピューターにサインインします。
2. ユーザーが以前にコンピューターにサインインしている場合、管理者特権でコマンド プロンプトを開き、次のコマンドを入力して、クライアント コンピューターに最新のグループ ポリシー設定が適用されるようにします。
    
    ```PowerShell
    GpUpdate /Force
    ```
3. ユーザー プロファイルが移動であることを確認するには、 **[コントロール パネル]** を開き、 **[システムとセキュリティ]** 、 **[システム]** 、 **[システムの詳細設定]** の順に選択し、[ユーザー プロファイル] セクションの **[設定]** を選択して、 **[種類]** 列で **[移動]** を探します。

## <a name="appendix-a-checklist-for-deploying-roaming-user-profiles"></a>付録 A:移動ユーザー プロファイルの展開のチェックリスト

| 状態                     | 操作                                                |
| ---                        | ------                                                |
| ☐<br>☐<br>☐<br>☐<br>☐   | 1.ドメインを準備する<br>- コンピューターをドメインに参加させる<br>- 個別のプロファイル バージョンの使用を有効にする<br>- ユーザー アカウントを作成する<br>- (オプション) フォルダー リダイレクトを展開する |
| ☐<br><br><br>             | 2.移動ユーザー プロファイルのセキュリティ グループを作成する<br>- グループ名:<br>- メンバー: |
| ☐<br><br>                 | 3.移動ユーザー プロファイルのファイル共有を作成する<br>- ファイル共有名: |
| ☐<br><br>                 | 4.移動ユーザー プロファイルの GPO を作成する<br>- GPO 名:|
| ☐                         | 5.移動ユーザー プロファイル ポリシー設定を構成する    |
| ☐<br>☐<br>☐              | 6.移動ユーザー プロファイルを有効にする<br>- AD DS でユーザー アカウントに対して有効にするか?<br>- グループ ポリシーでコンピューター アカウントに対して有効にするか?<br> |
| ☐                         | 7.(オプション) Windows 10 PC の固定のスタート画面のレイアウトを指定する |
| ☐<br>☐<br><br>☐<br><br>☐ | 8.(オプション) プライマリ コンピューターのサポートを有効にする<br>- ユーザーのプライマリ コンピューターを指定する<br>- ユーザーとプライマリ コンピューターの場所のマッピング:<br>- (オプション) フォルダー リダイレクトに対してプライマリ コンピューターのサポートを有効にする<br>- コンピューター ベースかユーザー ベースか?<br>- (オプション) 移動ユーザー プロファイルに対してプライマリ コンピューターのサポートを有効にする |
| ☐                        | 9.移動ユーザー プロファイル GPO を有効にする                |
| ☐                        | 10.移動ユーザー プロファイルをテストする                         |

## <a name="appendix-b-profile-version-reference-information"></a>付録 B:プロファイル バージョン参照情報

各プロファイルには、プロファイルが使用されている Windows のバージョンにほぼ対応するプロファイル バージョンがあります。 たとえば、Windows 10、バージョン 1703 とバージョン 1607 では、どちらも .V6 プロファイル バージョンを使用します。 Microsoft では、互換性を維持するために必要な場合にのみ、新しいプロファイル バージョンを作成します。そのため、Windows のすべてのバージョンに新しいプロファイル バージョンが含まれているわけではありません。

次の表に、各種 Windows バージョンでの移動ユーザー プロファイルの場所を一覧表示します。

| オペレーティング システムのバージョン | 移動ユーザー プロファイルの場所 |
| --- | --- |
| Windows XP と Windows Server 2003 | ```\\<servername>\<fileshare>\<username>``` |
| Windows Vista と Windows Server 2008 | ```\\<servername>\<fileshare>\<username>.V2``` |
| Windows 7 と Windows Server 2008 R2 | ```\\<servername>\<fileshare>\<username>.V2``` |
| Windows 8 と Windows Server 2012 | ```\\<servername>\<fileshare>\<username>.V3``` (ソフトウェア更新およびレジストリ キーの適用後)<br>```\\<servername>\<fileshare>\<username>.V2``` (ソフトウェア更新およびレジストリ キーの適用前) |
| Windows 8.1 および Windows Server 2012 R2 | ```\\<servername>\<fileshare>\<username>.V4``` (ソフトウェア更新およびレジストリ キーの適用後)<br>```\\<servername>\<fileshare>\<username>.V2``` (ソフトウェア更新およびレジストリ キーの適用前) |
| Windows 10 | ```\\<servername>\<fileshare>\<username>.V5``` |
| Windows 10、バージョン 1703 およびバージョン 1607 | ```\\<servername>\<fileshare>\<username>.V6``` |

## <a name="appendix-c-working-around-reset-start-menu-layouts-after-upgrades"></a>付録 C:アップグレード後にスタート メニューのレイアウトのリセットを回避する

ここでは、インプレース アップグレード後にスタート メニューのレイアウトがリセットされるのを回避する方法をいくつか紹介します。

- 1 人のユーザーのみがデバイスを使用し、IT 管理者が Configuration Manager などのマネージド OS 展開戦略を使用している場合は、以下を実行できます。
    
  1. アップグレード前に Export-Startlayout を使用してスタート メニューのレイアウトをエクスポートします 
  2. OOBE の後、ユーザーがサインインする前に、Import-StartLayout を使用してスタート メニューのレイアウトをインポートします  
 
     > [!NOTE] 
     > StartLayout をインポートすると、既定のユーザー プロファイルが変更されます。 インポート後に作成されたすべてのユーザー プロファイルでは、インポートされた Start-Layout が取得されます。
 
- IT 管理者は、グループ ポリシーを使用してスタート画面のレイアウトを管理することを選択できます。 グループ ポリシーを使用すると、標準化されたスタート画面のレイアウトをユーザーに適用するための一元的な管理ソリューションが提供されます。 スタート画面の管理にグループ ポリシーを使用するモードには、2 つのモードがあります。 完全ロックダウンと部分ロックダウンです。 完全ロックダウンのシナリオでは、ユーザーは、スタート画面のレイアウトを変更できません。 部分ロックダウンのシナリオでは、ユーザーがスタート画面の特定の領域に変更を加えることができます。 詳細については、「[スタート画面のレイアウトのカスタマイズとエクスポート](/windows/configuration/customize-and-export-start-layout)」を参照してください。
        
   > [!NOTE]
   > 部分ロックダウン シナリオでユーザーが行った変更も、アップグレード時に失われます。

- スタート画面のレイアウをリセットし、エンド ユーザーがスタート画面を再構成できるようにします。 OS をアップグレードした後にスタート画面のレイアウトのリセットが予想されることを示す通知電子メールまたはその他の通知をエンド ユーザーに送信して、影響を最小限に抑えることができます。 

## <a name="change-history"></a>変更履歴

次の表に、このトピックの最も重要な変更をいくつかまとめています。

| 日付 | 説明 |原因|
| --- | ---         | ---   |
| 2019 年 5 月 1 日 | Windows Server 2019 の更新プログラムが追加されました |
| 2018 年 4 月 10 日 | OS のインプレース アップグレード後にスタート画面に対するユーザーのカスタマイズが失われるタイミングについての説明が追加されました|既知の問題のコールアウト。 |
| 2018 年 3 月 13 日 | Windows Server 2016 用に更新されました | 以前のバージョンのライブラリから移行し、最新バージョンの Windows Server 用に更新されました。 |
| 2017 年 4 月 13 日 | Windows 10、バージョン 1703 のプロファイル情報が追加され、オペレーティング システムのアップグレード時に移動プロファイルのバージョンがどのように動作するかが明確にされました。「[複数の Windows のバージョンで移動ユーザー プロファイルを使用する場合の考慮事項](#considerations-when-using-roaming-user-profiles-on-multiple-versions-of-windows)」を参照してください。 | お客様からのフィードバック。 |
| 2017 年 3 月 14 日 | 「[付録 A:移動ユーザー プロファイルの展開のチェックリスト](#appendix-a-checklist-for-deploying-roaming-user-profiles)」に Windows 10 PC の固定のスタート画面のレイアウトを指定するための省略可能な手順が追加されました。 |最新の Windows update での機能の変更。 |
| 2017 年 1 月 23 日 | 「[手順 4:オプションで移動ユーザー プロファイルの GPO を作成する](#step-4-optionally-create-a-gpo-for-roaming-user-profiles)」に、Authenticated Users に読み取りアクセス許可を委任する手順が追加されました。これは、グループ ポリシーのセキュリティが更新されたため必要になりました。|グループ ポリシー処理に対するセキュリティの変更。 |
| 2016 年 12 月 29 日 | 「[手順 8:移動ユーザー プロファイル GPO を有効にする](#step-8-enable-the-roaming-user-profiles-gpo)」に、プライマリ コンピューターのグループ ポリシーを設定する方法に関する情報を簡単に取得するためのリンクが追加されました。 また、番号が間違っていた手順 5 と 6 への参照がいくつか修正されました。|お客様からのフィードバック。 |
| 2016 年 12 月 5 日 | スタート メニューの設定の移動に関する問題を説明する情報が追加されました。 | お客様からのフィードバック。 |
| 2016 年 7 月 6 日 | 「[付録 B:プロファイル バージョン参照情報](#appendix-b-profile-version-reference-information)」に、Windows 10 プロファイル バージョンのサフィックスが追加されました。 また、サポートされているオペレーティング システムの一覧から、Windows XP および Windows Server 2003 が削除されました。 | Windows の新しいバージョンの更新プログラムと、サポートされなくなった Windows のバージョンに関する情報の削除。 |
| 2015 年 7 月 7 日 | クラスター化されたファイル サーバーを使用するときに継続的可用性を無効にする要件と手順を追加しました。 | 継続的可用性が無効になっていると、クラスター化されたファイル共有は小さい書き込み (移動ユーザー プロファイルでは一般的) でのパフォーマンスが向上します。 |
| 2014 年 3 月 19 日 | 「[付録 B:プロファイル バージョン参照情報](#appendix-b-profile-version-reference-information)」で、プロファイル バージョンのサフィックス (.V2、.V3、.V4) が大文字にされました。 | Windows では大文字と小文字が区別されませんが、ファイル共有のある NFS を使用する場合、プロファイルのサフィックスに正しい (大文字) 大文字/小文字を指定することが重要です。 |
| 2013 年 10 月 9 日 | Windows Server 2012 R2 および Windows 8.1 について改訂し、いくつかのことを明確にして、「[複数の Windows のバージョンで移動ユーザー プロファイルを使用する場合の考慮事項](#considerations-when-using-roaming-user-profiles-on-multiple-versions-of-windows)」と「[付録 B:プロファイル バージョン参照情報](#appendix-b-profile-version-reference-information)」セクションを追加しました。 | 新しいバージョンの更新、お客様からのフィードバック。 |

## <a name="more-information"></a>説明を見る

- [フォルダー リダイレクト、オフライン ファイルおよび移動ユーザー プロファイルを展開する](deploy-folder-redirection.md)
- [フォルダー リダイレクトと移動ユーザー プロファイル用のプライマリ コンピューターを展開する](deploy-primary-computers.md)
- [ユーザー状態管理の実装](<https://docs.microsoft.com/previous-versions/windows/it-pro/windows-server-2003/cc784645(v=ws.10)>)
- [レプリケートされたユーザー プロファイル データに関する Microsoft のサポート表明](/archive/blogs/askds/microsofts-support-statement-around-replicated-user-profile-data)
- [DISM を使用したアプリのサイドローディング](<https://docs.microsoft.com/previous-versions/windows/it-pro/windows-8.1-and-8/hh852635(v=win.10)>)
- [Windows ランタイムベース アプリのパッケージ化、展開、クエリのトラブルシューティング](/windows/win32/appxpkg/troubleshooting)
